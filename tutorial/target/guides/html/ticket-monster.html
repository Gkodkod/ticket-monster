<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Marius Bogoevici, Pete Muir, Burr Sutter">
<title>Ticket Monster Tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ticket Monster Tutorial</h1>
<div class="details">
<span id="author" class="author">Marius Bogoevici, Pete Muir, Burr Sutter</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_what_is_ticketmonster">What is TicketMonster?</a>
<ul class="sectlevel1">
<li><a href="#_preamble">Preamble</a></li>
<li><a href="#_use_cases">Use cases</a>
<ul class="sectlevel2">
<li><a href="#_what_can_end_users_do">What can end users do?</a></li>
<li><a href="#_what_can_administrators_do">What can administrators do?</a></li>
</ul>
</li>
<li><a href="#_architecture">Architecture</a></li>
<li><a href="#_how_can_you_run_it">How can you run it?</a>
<ul class="sectlevel2">
<li><a href="#_building_ticketmonster">Building TicketMonster</a></li>
<li><a href="#_running_ticketmonster">Running TicketMonster</a></li>
</ul>
</li>
<li><a href="#_learn_more">Learn more</a></li>
</ul>
</li>
<li><a href="#_introduction_getting_started">Introduction &amp; Getting Started</a>
<ul class="sectlevel1">
<li><a href="#_purpose_and_target_audience">Purpose and Target Audience</a></li>
<li><a href="#_installation">Installation</a></li>
<li><a href="#_creating_a_new_java_ee_6_project_with_maven">Creating a new Java EE 6 project with Maven</a></li>
<li><a href="#_exploring_the_newly_generated_project">Exploring the newly generated project</a></li>
<li><a href="#_adding_a_new_entity_using_forge">Adding a new entity using Forge</a></li>
<li><a href="#_reviewing_persistence_xml_updating_import_sql">Reviewing persistence.xml &amp; updating import.sql</a></li>
<li><a href="#_adding_a_new_entity_using_jboss_developer_studio">Adding a new entity using JBoss Developer Studio</a></li>
<li><a href="#_deployment">Deployment</a></li>
<li><a href="#_adding_a_jax_rs_restful_web_service">Adding a JAX-RS RESTful web service</a></li>
<li><a href="#_adding_a_jquery_mobile_client_application">Adding a jQuery Mobile client application</a></li>
<li><a href="#_conclusion">Conclusion</a>
<ul class="sectlevel2">
<li><a href="#_cleaning_up_the_generated_code">Cleaning up the generated code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_building_the_persistence_layer_with_jpa2_and_bean_validation">Building the persistence layer with JPA2 and Bean Validation</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here">What will you learn here?</a></li>
<li><a href="#YourFirstEntity">Your first entity</a></li>
<li><a href="#_database_design_relationships">Database design &amp; relationships</a>
<ul class="sectlevel2">
<li><a href="#_media_items">Media items</a></li>
<li><a href="#_events">Events</a></li>
<li><a href="#_venue">Venue</a></li>
<li><a href="#_sections">Sections</a></li>
<li><a href="#_shows">Shows</a></li>
<li><a href="#_ticketprices">TicketPrices</a></li>
<li><a href="#_performances">Performances</a></li>
<li><a href="#_booking_ticket_seat">Booking, Ticket &amp; Seat</a></li>
<li><a href="#_sectionallocation_and_seatallocationexception">SectionAllocation and SeatAllocationException</a></li>
</ul>
</li>
<li><a href="#_connecting_to_the_database">Connecting to the database</a></li>
<li><a href="#_populating_test_data">Populating test data</a></li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#BuildingBusinessServices">Building The Business Services With JAX-RS</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_2">What Will You Learn Here?</a></li>
<li><a href="#_business_services_and_their_relationships">Business Services And Their Relationships</a></li>
<li><a href="#_preparations">Preparations</a>
<ul class="sectlevel2">
<li><a href="#_adding_jackson_core">Adding Jackson Core</a></li>
<li><a href="#_verifying_the_versions_of_the_jboss_boms">Verifying the versions of the JBoss BOMs</a></li>
<li><a href="#_enabling_cdi">Enabling CDI</a></li>
<li><a href="#_adding_utility_classes">Adding utility classes</a></li>
</ul>
</li>
<li><a href="#_internal_services">Internal Services</a>
<ul class="sectlevel2">
<li><a href="#_the_media_manager">The Media Manager</a></li>
<li><a href="#_the_seat_allocation_service">The Seat Allocation Service</a></li>
</ul>
</li>
<li><a href="#_jax_rs_services">JAX-RS Services</a>
<ul class="sectlevel2">
<li><a href="#_initializing_jax_rs">Initializing JAX-RS</a></li>
<li><a href="#_a_base_service_for_read_operations">A Base Service For Read Operations</a></li>
<li><a href="#_retrieving_venues">Retrieving Venues</a></li>
<li><a href="#_retrieving_events">Retrieving Events</a></li>
<li><a href="#_retrieving_shows">Retrieving Shows</a></li>
<li><a href="#_creating_and_deleting_bookings">Creating and deleting bookings</a></li>
</ul>
</li>
<li><a href="#_testing_the_services">Testing the services</a>
<ul class="sectlevel2">
<li><a href="#_adding_shrinkwrap_resolvers">Adding ShrinkWrap Resolvers</a></li>
<li><a href="#_a_basic_deployment_class">A Basic Deployment Class</a></li>
<li><a href="#_writing_restful_service_tests">Writing RESTful service tests</a></li>
<li><a href="#_running_the_tests">Running the tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_building_the_user_ui_using_html5">Building The User UI Using HTML5</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_3">What Will You Learn Here?</a></li>
<li><a href="#_first_the_basics">First, the basics</a>
<ul class="sectlevel2">
<li><a href="#_client_side_mvc_support">Client-side MVC Support</a></li>
<li><a href="#_modularity">Modularity</a></li>
<li><a href="#_templating">Templating</a></li>
<li><a href="#_mobile_and_desktop_versions">Mobile and desktop versions</a></li>
</ul>
</li>
<li><a href="#_setting_up_the_structure">Setting up the structure</a>
<ul class="sectlevel2">
<li><a href="#_routing">Routing</a></li>
</ul>
</li>
<li><a href="#_setting_up_the_initial_views">Setting up the initial views</a></li>
<li><a href="#_displaying_events">Displaying Events</a>
<ul class="sectlevel2">
<li><a href="#_the_event_model">The Event model</a></li>
<li><a href="#_the_events_collection">The Events collection</a></li>
<li><a href="#_the_eventsview_view">The EventsView view</a></li>
</ul>
</li>
<li><a href="#_viewing_a_single_event">Viewing a single event</a></li>
<li><a href="#_creating_bookings">Creating Bookings</a></li>
<li><a href="#_mobile_view">Mobile view</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_structure_2">Setting up the structure</a></li>
<li><a href="#_the_landing_page">The landing page</a></li>
<li><a href="#_the_events_view">The events view</a></li>
<li><a href="#_displaying_an_individual_event">Displaying an individual event</a></li>
<li><a href="#_booking_tickets">Booking tickets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_building_the_administration_ui_using_forge">Building the Administration UI using Forge</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_4">What Will You Learn Here?</a></li>
<li><a href="#_setting_up_forge">Setting up Forge</a>
<ul class="sectlevel2">
<li><a href="#_jboss_developer_studio">JBoss Developer Studio</a></li>
</ul>
</li>
<li><a href="#_getting_started_with_forge">Getting started with Forge</a></li>
<li><a href="#_generating_the_crud_ui">Generating the CRUD UI</a>
<ul class="sectlevel2">
<li><a href="#_scaffold_the_angularjs_ui_from_the_jpa_entities">Scaffold the AngularJS UI from the JPA entities</a></li>
</ul>
</li>
<li><a href="#_test_the_crud_ui">Test the CRUD UI</a></li>
<li><a href="#_make_some_changes_to_the_ui">Make some changes to the UI</a>
<ul class="sectlevel2">
<li><a href="#_fixing_the_landing_page_of_the_administration_site">Fixing the landing page of the Administration site</a></li>
</ul>
</li>
<li><a href="#_updating_the_shrinkwrap_deployment_for_the_test_suite">Updating the ShrinkWrap deployment for the test suite</a></li>
</ul>
</li>
<li><a href="#_building_the_statistics_dashboard_using_html5_and_javascript">Building The Statistics Dashboard Using HTML5 and JavaScript</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_5">What Will You Learn Here?</a></li>
<li><a href="#_implementing_the_metrics_api">Implementing the Metrics API</a></li>
<li><a href="#_creating_the_bot_service">Creating the Bot service</a></li>
<li><a href="#_displaying_metrics">Displaying Metrics</a>
<ul class="sectlevel2">
<li><a href="#_the_metrics_model">The Metrics model</a></li>
<li><a href="#_the_metrics_collection">The Metrics collection</a></li>
<li><a href="#_the_metricsview_view">The MetricsView view</a></li>
</ul>
</li>
<li><a href="#_displaying_the_bot_interface">Displaying the Bot interface</a>
<ul class="sectlevel2">
<li><a href="#_the_bot_model">The Bot model</a></li>
<li><a href="#_the_botview_view">The BotView view</a></li>
</ul>
</li>
<li><a href="#_creating_the_dashboard">Creating the dashboard</a>
<ul class="sectlevel2">
<li><a href="#_creating_a_composite_monitor_view">Creating a composite Monitor view</a></li>
<li><a href="#_configure_the_router">Configure the router</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_creating_hybrid_mobile_versions_of_the_application_with_apache_cordova">Creating hybrid mobile versions of the application with Apache Cordova</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_6">What will you learn here?</a></li>
<li><a href="#_what_are_hybrid_mobile_applications">What are hybrid mobile applications?</a></li>
<li><a href="#_tweak_your_application_for_remote_access">Tweak your application for remote access</a></li>
<li><a href="#_install_hybrid_mobile_tools_and_cordovasim">Install Hybrid Mobile Tools and CordovaSim</a></li>
<li><a href="#_creating_a_hybrid_mobile_project">Creating a Hybrid Mobile project</a></li>
<li><a href="#_run_the_hybrid_mobile_application">Run the hybrid mobile application</a>
<ul class="sectlevel2">
<li><a href="#_run_on_an_android_device_or_emulator">Run on an Android device or emulator</a></li>
<li><a href="#_run_on_an_ios_simulator">Run on an iOS Simulator</a></li>
<li><a href="#_run_on_cordovasim">Run on CordovaSim</a></li>
</ul>
</li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#_appendix_a_deploying_to_jboss_eap_locally">Appendix A - Deploying to JBoss EAP locally</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_7">What Will You Learn Here?</a></li>
<li><a href="#_pre_requisites">Pre-requisites</a></li>
<li><a href="#_import_the_project_source_code">Import the Project source code</a></li>
<li><a href="#_deploying_to_jboss_eap_using_jboss_developer_studio">Deploying to JBoss EAP using JBoss Developer Studio</a></li>
<li><a href="#_deploying_to_jboss_eap_using_the_command_line">Deploying to JBoss EAP using the command-line</a></li>
<li><a href="#_using_mysql_as_the_database">Using MySQL as the database</a></li>
<li><a href="#_using_postgresql_as_the_database">Using PostgreSQL as the database</a></li>
</ul>
</li>
<li><a href="#_appendix_b_deploying_to_openshift">Appendix B - Deploying to OpenShift</a>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here_8">What Will You Learn Here?</a></li>
<li><a href="#_import_the_project_source_code_2">Import the Project source code</a></li>
<li><a href="#_pre_requisites_2">Pre-requisites</a></li>
<li><a href="#_deploying_to_openshift_using_jboss_developer_studio">Deploying to OpenShift using JBoss Developer Studio</a></li>
<li><a href="#_deploying_to_openshift_using_the_command_line">Deploying to OpenShift using the command-line</a>
<ul class="sectlevel2">
<li><a href="#_create_an_openshift_account_and_domain">Create an OpenShift Account and Domain</a></li>
<li><a href="#_create_the_openshift_application">Create the OpenShift Application</a></li>
</ul>
</li>
<li><a href="#_using_mysql_as_the_database_2">Using MySQL as the database</a></li>
<li><a href="#_using_postgresql_as_the_database_2">Using PostgreSQL as the database</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="_what_is_ticketmonster" class="sect0">What is TicketMonster?</h1>
<div class="sect1">
<h2 id="_preamble">Preamble</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TicketMonster is an example application that focuses on Java EE6 - JPA 2, CDI, EJB 3.1 and JAX-RS along with HTML5 and jQuery Mobile.  It is a moderately complex application that demonstrates how to build modern web applications optimized for mobile &amp; desktop. TicketMonster is representative of an online ticketing broker - providing access to events (e.g. concerts, shows, etc) with an online booking application.</p>
</div>
<div class="paragraph">
<p>Apart from being a demo, TicketMonster provides an already existing application structure that you can use as a starting point for your app. You could try out your use cases, test your own ideas, or, contribute improvements back to the community.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/octocat_social.png" alt="octocat social">
</div>
</div>
<div class="paragraph">
<p><a href="http://github.com/jboss-jdf/ticket-monster">Fork us on GitHub!</a></p>
</div>
<div class="paragraph">
<p>The accompanying tutorials walk you through the various tools &amp; technologies needed to build TicketMonster on your own. Alternatively you can download TicketMonster as a completed application and import it into your favorite IDE.</p>
</div>
<div class="paragraph">
<p>Before we dive into the code, let&#8217;s discuss the requirements for the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_cases">Use cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have grouped the current use cases in two major categories: end user oriented, and administrative.</p>
</div>
<div class="sect2">
<h3 id="_what_can_end_users_do">What can end users do?</h3>
<div class="paragraph">
<p>The end users of the application want to attend some cool events. They will try to find shows, create bookings, or cancel bookings. The use cases are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>look for current events;</p>
</li>
<li>
<p>look for venues;</p>
</li>
<li>
<p>select shows (events taking place at specific venues) and choose a performance time;</p>
</li>
<li>
<p>book tickets;</p>
</li>
<li>
<p>view current bookings;</p>
</li>
<li>
<p>cancel bookings;</p>
</li>
</ul>
</div>
<div id="end-user-use-cases-image" class="imageblock">
<div class="content">
<img src="gfx/ticket-monster-user-use-cases.png" alt="ticket monster user use cases">
</div>
<div class="title">Figure 1. End user use cases</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_can_administrators_do">What can administrators do?</h3>
<div class="paragraph">
<p>Administrators are more concerned the operation of the business. They will manage the <em>master data</em>: information about venues, events and shows, and will want to see how many tickets have been sold. The use cases are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add, remove and update events;</p>
</li>
<li>
<p>add, remove and update venues (including venue layouts);</p>
</li>
<li>
<p>add, remove and update shows and performances;</p>
</li>
<li>
<p>monitor ticket sales for current shows;</p>
</li>
</ul>
</div>
<div id="administration-use-cases-image" class="imageblock">
<div class="content">
<img src="gfx/ticket-monster-administration-use-cases.png" alt="ticket monster administration use cases">
</div>
<div class="title">Figure 2. Administration use cases</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">Architecture</h2>
<div class="sectionbody">
<div id="architecture-image" class="imageblock">
<div class="content">
<img src="gfx/ticket-monster-architecture.png" alt="ticket monster architecture">
</div>
<div class="title">Figure 3. TicketMonster architecture</div>
</div>
<div class="paragraph">
<p>The application uses Java EE 6 services to provide business logic and persistence, utilizing technologies such as CDI, EJB 3.1 and JAX-RS, JPA 2. These services back the user-facing booking process, which is implemented using HTML5 and JavaScript, with support for mobile devices through jQuery Mobile.</p>
</div>
<div class="paragraph">
<p>The administration site is centered around CRUD use cases, so instead of writing everything manually, the business layer and UI are generated by Forge, using EJB 3.1, CDI and JAX-RS. For a better user experience, Twitter Bootstrap is used.</p>
</div>
<div class="paragraph">
<p>Monitoring sales requires staying in touch with the latest changes on the server side, so this part of the application will be developed in HTML5 and JavaScript using a polling solution.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_can_you_run_it">How can you run it?</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_building_ticketmonster">Building TicketMonster</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>In order to build the application, you will need you to
configure Maven to use the JBoss Enterprise Maven repositories. For instructions on
configure the Maven repositories, visit the <a href="https://access.redhat.com/site/documentation/en-US/JBoss_Enterprise_Application_Platform/6.3/html-single/Development_Guide/index.html#Install_the_JBoss_Enterprise_Application_Platform_6_Maven_Repository">JBoss Enterprise Application Platform 6.3 documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TicketMonster can be built from Maven, by runnning the following Maven command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package</pre>
</div>
</div>
<div class="paragraph">
<p>This prepares a WAR file that you can deploy right away in a JBoss Enterprise Application Platform instance. It would use the in-built H2 database.</p>
</div>
<div class="paragraph">
<p>If you want to run the Arquillian tests as part of the build, you can enable one of the two available Arquillian profiles.</p>
</div>
<div class="paragraph">
<p>For running the tests in an <em>already running</em> application server instance, use the <code>arq-jbossas-remote</code> profile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Parq-jbossas-remote</pre>
</div>
</div>
<div class="paragraph">
<p>If you want the test runner to <em>start</em> an application server instance, use the <code>arq-jbossas-managed</code> profile. You must set up the <code>JBOSS_HOME</code> property to point to the server location, or update the <code>src/main/test/resources/arquillian.xml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Parq-jbossas-managed</pre>
</div>
</div>
<div class="paragraph">
<p>If you intend to deploy into <a href="http://openshift.com">OpenShift</a> with the PostgreSQL cartridge, you can use the <code>postgresql-openshift</code> profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Ppostgresql-openshift</pre>
</div>
</div>
<div class="paragraph">
<p>If you intend to deploy into <a href="http://openshift.com">OpenShift</a> with the MySQL cartridge, you can use the <code>mysql-openshift</code> profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Pmysql-openshift</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_ticketmonster">Running TicketMonster</h3>
<div class="paragraph">
<p>You can run TicketMonster into a local JBoss EAP 6.3 instance or on OpenShift.</p>
</div>
<div class="sect3">
<h4 id="_running_ticketmonster_locally">Running TicketMonster locally</h4>
<div class="paragraph">
<p><em>Start JBoss Enterprise Application Platform 6.3</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command line and navigate to the root of the JBoss server directory.</p>
</li>
<li>
<p>The following shows the command line to start the server with the web profile:</p>
<div class="listingblock">
<div class="content">
<pre>For Linux:   JBOSS_HOME/bin/standalone.sh
For Windows: JBOSS_HOME\bin\standalone.bat</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, <em>deploy TicketMonster</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have started the JBoss Server as described above.</p>
</li>
<li>
<p>Type this command to build and deploy the archive into a running server instance.</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy</pre>
</div>
</div>
<div class="paragraph">
<p>(You can use the <code>arq-jbossas-remote</code> profile for running tests as well)</p>
</div>
</li>
<li>
<p>This will deploy <code>target/ticket-monster.war</code> to the running instance of the server.</p>
</li>
<li>
<p>Now you can see the application running at <a href="http://localhost:8080/ticket-monster" class="bare">http://localhost:8080/ticket-monster</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_running_ticketmonster_in_openshift">Running TicketMonster in OpenShift</h4>
<div class="paragraph">
<p>First, <em>create an OpenShift project</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that you have an OpenShift domain and you have created an application using the <code>jbosseap-6</code> cartridge (for more details, get started <a href="https://openshift.redhat.com/app/getting_started">here</a>). If you want to use PostgreSQL, add the <code>postgresql-9.2</code> cartridge too. Or for MySQL, add the <code>mysql-5.5</code> cartridge.</p>
</li>
<li>
<p>Ensure that the Git repository of the project is checked out.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, <em>build and deploy it</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build TicketMonster using either:</p>
<div class="ulist">
<ul>
<li>
<p>the default profile (with H2 database support)</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package</pre>
</div>
</div>
</li>
<li>
<p>the <code>postgresql-openshift</code> profile (with PostgreSQL support) if the PostgreSQL cartrdige is enabled in OpenShift.</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Ppostgresql-openshift</pre>
</div>
</div>
</li>
<li>
<p>the <code>mysql-openshift</code> profile (with MySQL support) if the MySQL cartrdige is enabled in OpenShift.</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package -Pmysql-openshift</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Copy the <code>target/ticket-monster.war</code> file in the OpenShift Git repository (located at <code>&lt;root-of-openshift-application-git-repository&gt;</code>).</p>
<div class="listingblock">
<div class="content">
<pre>cp target/ticket-monster.war &lt;root-of-openshift-application-git-repository&gt;/deployments/ROOT.war</pre>
</div>
</div>
</li>
<li>
<p>Navigate to <code>&lt;root-of-openshift-application-git-repository&gt;</code> folder.</p>
</li>
<li>
<p>Remove the existing <code>src</code> folder and <code>pom.xml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre>git rm -r src
git rm pom.xml</pre>
</div>
</div>
</li>
<li>
<p>Add the copied file to the repository, commit and push to Openshift</p>
<div class="listingblock">
<div class="content">
<pre>git add deployments/ROOT.war
git commit -m "Deploy TicketMonster"
git push</pre>
</div>
</div>
</li>
<li>
<p>Now you can see the application running at at <code><a href="http://&lt;app-name&gt;-&lt;domain-name&gt;.rhcloud.com" class="bare">http://&lt;app-name&gt;-&lt;domain-name&gt;.rhcloud.com</a></code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_learn_more">Learn more</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The example is accompanied by a series of tutorials that will walk you through the process of
creating the TicketMonster application from end to end.</p>
</div>
<div class="paragraph">
<p>After reading this series you will understand how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set up your project;</p>
</li>
<li>
<p>define the persistence layer of the application;</p>
</li>
<li>
<p>design and implement the business layer and expose it to the front-end via RESTful endpoints;</p>
</li>
<li>
<p>implement a mobile-ready front-end using HTML 5, JSON, JavaScript and jQuery Mobile;</p>
</li>
<li>
<p>develop a HTML5-based administration interface rapidly using JBoss Forge;</p>
</li>
<li>
<p>thoroughly test your project using JUnit and Arquillian;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Throughout the series, you will be shown how to achieve these goals using JBoss Developer Studio.</p>
</div>
</div>
</div>
<h1 id="_introduction_getting_started" class="sect0">Introduction &amp; Getting Started</h1>
<div class="sect1">
<h2 id="_purpose_and_target_audience">Purpose and Target Audience</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The target audience for this tutorial are those individuals who do not yet have a great deal of experience with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eclipse + JBoss Tools (JBoss Developer Studio)</p>
</li>
<li>
<p>JBoss Enterprise Application Platform 6.3</p>
</li>
<li>
<p>Java EE 6 features like JAX-RS</p>
</li>
<li>
<p>HTML5 &amp; jQuery for building an mobile web front-end.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This tutorial sets the stage for the creation of TicketMonster - our sample application that illustrates how to bring together the best features of <strong>Java EE 6 + HTML5 + JBoss</strong> to create a rich, mobile-optimized and dynamic application.</p>
</div>
<div class="paragraph">
<p>TicketMonster is developed as an open source application, and you can find it <a href="https://github.com/jboss-jdf/ticket-monster">at github</a>.</p>
</div>
<div class="paragraph">
<p>If you prefer to watch instead of read, a large portion of this content is also covered in <a href="http://docs.jboss.org/tools/movies/">video form</a>.</p>
</div>
<div class="paragraph">
<p>In this tutorial, we will cover the following topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Working with JBoss Developer Studio (Eclipse + JBoss Tools)</p>
</li>
<li>
<p>Creating of a Java EE 6 project via a Maven archetype</p>
</li>
<li>
<p>Leveraging m2e and m2e-wtp</p>
</li>
<li>
<p>Using Forge to create a JPA entity</p>
</li>
<li>
<p>Using Hibernate Tools</p>
</li>
<li>
<p>Database Schema Generation</p>
</li>
<li>
<p>Deployment to a local JBoss Server</p>
</li>
<li>
<p>Adding a JAX-RS endpoint</p>
</li>
<li>
<p>Adding a jQuery Mobile client</p>
</li>
<li>
<p>Using the Mobile BrowserSim</p>
</li>
</ul>
</div>
<div id="jbds5_mobile_browsersim_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jbds8_mobile_browsersim.png" alt="jbds8 mobile browsersim">
</div>
<div class="title">Figure 4. JBoss Developer Studio 8 with Mobile BrowserSim</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first order of business is to get your development environment setup and JBoss Developer Studio v8 installed. JBoss Developer Studio is Eclipse Luna (e4.4) for Java EE Developers plus select JBoss Tools and is available for free. Visit <a href="http://www.jboss.org/products/devstudio/download" class="bare">http://www.jboss.org/products/devstudio/download</a> to download it.  You may also choose to install JBoss Tools 4.2 into your existing Eclipse for Java EE Developers installation. This document uses screenshots depicting JBoss Developer Studio.</p>
</div>
<div class="paragraph">
<p>You must have a Java Development Kit (JDK) installed. Java 7 JDK is recommended - whilst a JVM runtime will work for most use cases, for a developer environment it is normally best to have the full JDK.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you prefer to see JBoss Developer Studio being installed,
then check out <a href="http://vimeo.com/39606090">this video</a>.</p>
</div>
<div class="paragraph">
<p>To see JBoss Tools being installed into Eclipse, see
<a href="http://vimeo.com/39743315">this video</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The JBoss Developer Studio installer has a (very long!) name such as <code>jboss-devstudio-8.0.0.GA-v20141020-1042-B317-installer-standalone.jar</code>
where the latter portion of the file name relates to build date and version information and the text near the front related to the target operating system. The "universal" installer is for any operating system.  To launch the installer you may simply be able to double-click on the .jar file name or you may need to issue the following from the operating system command line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java -jar jboss-devstudio-8.0.0.GA-v20141020-1042-B317-installer-standalone.jar</pre>
</div>
</div>
<div class="paragraph">
<p>We recommend using the "universal" installer as it handles Windows, Mac OS X and Linux - 32-bit and 64-bit versions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Even if you are installing on a 64-bit OS, you may still wish
to use the 32-bit JVM for the JBoss Developer Studio (or
Eclipse + JBoss Tools). Only the 32-bit version provides a
supported version of the Visual Page Editor - a split-pane
editor that gives you a glimpse of what your HTML/XHTML (JSF,
 JSP, etc) will look like.
Also, the 32-bit version uses less memory than the 64-bit
version. You may still run your application server in 64-bit
JVMs if needed to insure compatibility with the production
environment whilst keeping your IDE in 32-bit mode.
Visual Page Editor has experimental support for 64-bit JVMs in JBoss
Developer Studio 8. Please refer <a href="https://community.jboss.org/wiki/JBosstoolsVisualEditorFAQ">the JBoss Tools Visual Editor FAQ</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="installer-wizard_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/installer_wizard_page1.png" alt="installer wizard page1">
</div>
<div class="title">Figure 5. Installation Wizard, Step 1 of 9</div>
</div>
<div class="paragraph">
<p>The rest of the steps are fairly self explanatory.  If you run into trouble, please consult the videos above as they explore a few troubleshooting tips related to JRE/JDK setup.</p>
</div>
<div class="paragraph">
<p>You can skip the step in the installation wizard that allows you to install JBoss Enterprise Application Platform 6.3 as we will do this in the next step.</p>
</div>
<div class="paragraph">
<p>Once installed, launch JBoss Developer Studio. Please make sure to say <strong>Yes</strong> to the prompt that says "Will you allow JBoss Tools team to receive anonymous usage statistics for this Eclipse instance with JBoss Tools?".  This information is very helpful to us when it comes to prioritizing our QA efforts in terms of operating system platforms. More information concerning our usage tracking can be found at <a href="http://www.jboss.org/tools/usage" class="bare">http://www.jboss.org/tools/usage</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_new_java_ee_6_project_with_maven">Creating a new Java EE 6 project with Maven</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>For a deeper dive into the world of Maven and how it is used with
JBoss Developer Studio and JBoss Enterprise Application
Platform 6 review <a href="http://vimeo.com/39796236">this video</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that everything is properly installed, configured, running and verified to work, let&#8217;s build something "from scratch".</p>
</div>
<div class="paragraph">
<p>We recommend that you switch to the JBoss Perspective if you have not already.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you close JBoss Central, it is only a click away - simply
click on the JBoss icon in the Eclipse toolbar - it is normally
the last icon, on the last row - assuming you are in the JBoss
Perspective.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, select <strong>Start from scratch &#8594; Java EE Web Project</strong> in JBoss Central. Under the covers, this uses a Maven archetype which creates a Java EE 6 web application (.war), based around Maven.  The project can be built outside of the IDE, and in continuous integration solutions like Hudson/Jenkins.</p>
</div>
<div id="jboss-central_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jboss_dev_studio_jboss_central.png" alt="jboss dev studio jboss central">
</div>
<div class="title">Figure 6. JBoss Central</div>
</div>
<div class="paragraph">
<p>You will be prompted with a dialog box that verifies that JBoss Developer Studio is configured correctly. If you are in a brand new workspace, the application server will not be configured yet and you will notice the lack of a check mark on the server/runtime row.</p>
</div>
<div id="new-project-wizard_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/new_project_wizard.png" alt="new project wizard">
</div>
<div class="title">Figure 7. New Project Wizard</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>There are several ways to add JBoss Enterprise Application
Platform 6 to JBoss Developer Studio. The
<strong>Install&#8230;&#8203;</strong> button on the new project wizard is probably the
easiest, but you can use any of the methods you are familiar
with!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add JBoss Enterprise Application Platform, click on the <strong>Install&#8230;&#8203;</strong> button, or if you have not yet downloaded and unzipped the server, click on the <strong>Download and Install&#8230;&#8203;</strong> button.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>The download option only works with the community application
server. Although the enterprise application server is listed, it
still needs to be manually downloaded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Selecting <strong>Install&#8230;&#8203;</strong> will pop up the JBoss Runtime Detection section of Preferences.  You can always get back to this dialog by selecting <strong>Preferences &#8594; JBoss Tools &#8594; JBoss Tools Runtime Detection</strong>.</p>
</div>
<div id="jboss_tools_runtime_detection_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jboss_tools_runtime_detection.png" alt="jboss tools runtime detection">
</div>
<div class="title">Figure 8. JBoss Tools Runtime Detection</div>
</div>
<div class="paragraph">
<p>Select the <strong>Add</strong> button which will take you to a file browser dialog where you should locate your unzipped JBoss server.</p>
</div>
<div id="runtime_open_dialog_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/runtime_open_dialog.png" alt="runtime open dialog">
</div>
<div class="title">Figure 9. Runtime Open Dialog</div>
</div>
<div class="paragraph">
<p>Select <strong>Open</strong> and JBoss Developer Studio will pop up the <strong>Searching for runtimes&#8230;&#8203;</strong> window.</p>
</div>
<div id="searching_for_runtimes_dialog_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/searching_for_runtimes_dialog.png" alt="searching for runtimes dialog">
</div>
<div class="title">Figure 10. Searching for runtimes window</div>
</div>
<div class="paragraph">
<p>Simply select <strong>OK</strong>. You should see the added runtime in the Paths list.</p>
</div>
<div id="jboss_tools_runtime_detection_after_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jboss_tools_runtime_detection_after.png" alt="jboss tools runtime detection after">
</div>
<div class="title">Figure 11. JBoss Tools Runtime Detection Completed</div>
</div>
<div class="paragraph">
<p>Select <strong>OK</strong> to close the <strong>Preferences</strong> dialog, and you will be returned to the <strong>New Project Example</strong> dialog, with the the server/runtime found.</p>
</div>
<div id="as_eap_found_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/as_eap_found.png" alt="as eap found">
</div>
<div class="title">Figure 12. JBoss AS 7.0/7.1 or EAP 6 Found</div>
</div>
<div class="paragraph">
<p>The <strong>Target Runtime</strong> allows you to choose between JBoss Enterprise Application Platform and JBoss AS 7. If it is left empty, JBoss AS 7 will be elected.</p>
</div>
<div class="paragraph">
<p>Proceed to select the EAP 6.3 runtime, you just created.</p>
</div>
<div id="eap_selected_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/as_eap_selected.png" alt="as eap selected">
</div>
<div class="title">Figure 13. JBoss EAP 6 runtime selected</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>Choosing an enterprise application server as the runtime will require you to
configure Maven to use the JBoss Enterprise Maven repositories. For detailed instructions on
configure the Maven repositories, visit the <a href="https://access.redhat.com/site/documentation/en-US/JBoss_Enterprise_Application_Platform/6.3/html-single/Development_Guide/index.html#Install_the_JBoss_Enterprise_Application_Platform_6_Maven_Repository">JBoss Enterprise Application Platform 6.3 documentation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may see a warning (like the one in the screenshot), if you do not have the JBoss Enterprise Maven repository configured in your environment. Should this be the case, select the <strong>repository</strong> link in the warning, to open the JBoss Maven Integration wizard. The wizard dialog will prompt you to add the JBoss Enterprise Maven repository.</p>
</div>
<div id="add_jboss_maven_repo_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jboss_maven_repository.png" alt="jboss maven repository">
</div>
<div class="title">Figure 14. Add the JBoss Enterprise Maven repository</div>
</div>
<div class="paragraph">
<p>Click <strong>Ok</strong>.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll now be shown the proposed changes to your Maven settings.xml file. Click <strong>Finish</strong> after reviewing the proposed updates.</p>
</div>
<div id="update_settings_xml_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jboss_maven_repo_settings_xml.png" alt="jboss maven repo settings xml">
</div>
<div class="title">Figure 15. Update the Maven settings.xml file</div>
</div>
<div class="paragraph">
<p>You&#8217;ll be prompted to confirm the update. Click <strong>Yes</strong>.</p>
</div>
<div id="confirm_update_settings_xml_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/prompt_update_settings_xml.png" alt="prompt update settings xml">
</div>
<div class="title">Figure 16. Confirm the changes to the Maven settings.xml file</div>
</div>
<div class="paragraph">
<p>The updates will now be persisted, and you&#8217;ll be returned to the original wizard.</p>
</div>
<div class="paragraph">
<p>Now, select <strong>Next</strong> in the <strong>New Project</strong> wizard to proceed to the next step.</p>
</div>
<div id="new-project-wizard-step_2_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/new_project_example_step_2.png" alt="new project example step 2">
</div>
<div class="title">Figure 17. New Project Wizard Step 2</div>
</div>
<div class="paragraph">
<p>The default <strong>Project name</strong> is <code>jboss-javaee6-webapp</code>. If this field appears blank, it is because your workspace already contains a "jboss-javaee6-webapp" in which case just provide another name for your project. Change the project name to <code>ticket-monster</code>, and the package name to <code>org.jboss.examples.ticketmonster</code>.</p>
</div>
<div class="paragraph">
<p>Select <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p>JBoss Tools/JBoss Developer Studio will now generate the template project and import it into the workspace.  You will see it pop up into the Project Explorer and a message that asks if you would like to open the cheatsheet file associated with the project.</p>
</div>
<div id="prompt_for_readme_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/prompt_for_cheatsheet.png" alt="prompt for cheatsheet">
</div>
<div class="title">Figure 18. New Project Wizard Step 3</div>
</div>
<div class="paragraph">
<p>Select <strong>Finish</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exploring_the_newly_generated_project">Exploring the newly generated project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the <strong>Project Explorer</strong>, open up the generated project, and double-click on the <code>pom.xml</code>.</p>
</div>
<div class="paragraph">
<p>The generated project is a Maven-based project with a <code>pom.xml</code> in its root directory.</p>
</div>
<div id="newly_generated_project_explorer_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/newly_generated_project_explorer.png" alt="newly generated project explorer">
</div>
<div class="title">Figure 19. Project Explorer</div>
</div>
<div class="paragraph">
<p>JBoss Developer Studio and JBoss Tools include m2e and m2e-wtp. m2e is the Maven Eclipse plug-in and provides a graphical editor for editing <code>pom.xml</code> files, along with the ability to run maven goals directly from within Eclipse.  m2e-wtp allows you to deploy your Maven-based project directly to any Web Tools Project (WTP) compliant application server.  This means you can drag &amp; drop, use <strong>Run As &#8594; Run on Server</strong> and other mechanisms to have the IDE deploy your application.</p>
</div>
<div class="paragraph">
<p>The <code>pom.xml</code> editor has several tabs along its bottom edge.</p>
</div>
<div id="pom_xml_tabs_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/pom_xml_tabs.png" alt="pom xml tabs">
</div>
<div class="title">Figure 20. pom.xml Editor Tabs</div>
</div>
<div class="paragraph">
<p>For this tutorial, we do not need to edit the <code>pom.xml</code> as it already provides the Java EE 6 APIs that we will need (e.g. JPA, JAX-RS, CDI). You should spend some time exploring the <strong>Dependencies</strong> and the <strong>pom.xml</strong> (source view) tabs.</p>
</div>
<div class="paragraph">
<p>One key element to make note of is <code>&lt;version.jboss.bom.eap&gt;6.3.2.GA&lt;/version.jboss.bom.eap&gt;</code> which establishes the version of the JBoss Enterprise Application Platform dependencies. The BOM (Bill of Materials) specifies the versions of the Java EE (and other) APIs defined in the dependency section.</p>
</div>
<div class="paragraph">
<p>If you are using community version of the JBoss Application Server and you selected that as your Target Runtime, you will find a different property as the version string.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>The specific version of the BOM (e.g. <code>6.3.2.GA</code>) is likely to change, so do not
be surprised if the version is slightly different.</p>
</div>
<div class="paragraph">
<p>The recommended version of the BOM for a runtime (EAP 6) can be
obtained by visiting <a href="https://www.jboss.org/developer-materials/#!keyword=Java%20EE&amp;formats=jbossdeveloper_archetype%20jbossdeveloper_bom">the JBoss Stacks site</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="project_explorer_java_packages_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/project_explorer_java_packages.png" alt="project explorer java packages">
</div>
<div class="title">Figure 21. Project Explorer Java Packages</div>
</div>
<div class="paragraph">
<p>Using the <strong>Project Explorer</strong>, drill-down into <code>src/main/java</code> under <strong>Java Resources</strong>.</p>
</div>
<div class="paragraph">
<p>The initial project includes the following Java packages:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>.controller</code></dt>
<dd>
<p>contains the backing beans for <code><mark>{newMember}</code> and <code></mark>{memberRegistration}</code> in the JSF page <code>index.xhtml</code></p>
</dd>
<dt class="hdlist1"><code>.data</code></dt>
<dd>
<p>contains a class which uses <code>@Produces</code> and <code>@Named</code> to return the list of members for <code>index.xhtml</code></p>
</dd>
<dt class="hdlist1"><code>.model</code></dt>
<dd>
<p>contains the JPA entity class, a POJO annotated with <code>@Entity</code>, annotated with Bean Validation (JSR 303) constraints</p>
</dd>
<dt class="hdlist1"><code>.rest</code></dt>
<dd>
<p>contains the JAX-RS endpoints, POJOs annotated with <code>@Path</code></p>
</dd>
<dt class="hdlist1"><code>.service</code></dt>
<dd>
<p>handles the registration transaction for new members</p>
</dd>
<dt class="hdlist1"><code>.util</code></dt>
<dd>
<p>contains Resources.java which sets up an alias for <code>@PersistenceContext</code> to be injectable via <code>@Inject</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Now, let&#8217;s explore the resources in the project.</p>
</div>
<div id="project_explorer_resources_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/project_explorer_resources.png" alt="project explorer resources">
</div>
<div class="title">Figure 22. Project Explorer Resources</div>
</div>
<div class="paragraph">
<p>Under src you will find:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>main/resources/import.sql</code></dt>
<dd>
<p>contains insert statements that provides initial database data.  This is particularly useful when <code>hibernate.hbm2dll.auto=create-drop</code> is set in <code>persistence.xml</code>.  <code>hibernate.hbm2dll.auto=create-drop</code> causes the schema to be recreated each time the application is deployed.</p>
</dd>
<dt class="hdlist1"><code>main/resources/META-INF/persistence.xml</code></dt>
<dd>
<p>establishes that this project contains JPA entities and it identifies the datasource, which is deployed alongside the project. It also includes the <code>hibernate.hbm2dll.auto</code> property set to <code>create-drop</code> by default.</p>
</dd>
<dt class="hdlist1"><code>test/java/test</code></dt>
<dd>
<p>provides the <code>.test</code> package that contains <code>MemberRegistrationTest.java</code>, an Arquillian based test that runs both from within JBoss Developer Studio via <strong>Run As &#8594; JUnit Test</strong> and at the command line:</p>
<div class="paragraph">
<p><code>mvn test Parq-jbossas-remote</code></p>
</div>
<div class="paragraph">
<p>Note that you will need to start the JBoss Enterprise Application Platform 6.3 server before running the test.</p>
</div>
</dd>
<dt class="hdlist1"><code>src/main/webapp</code></dt>
<dd>
<p>contains <code>index.xhtml</code>, the JSF-based user interface for the sample application.  If you double-click on that file you will see Visual Page Editor allows you to visually navigate through the file and see the source simultaneously. Changes to the source are immediately reflected in the visual pane.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In <code>src/main/webapp/WEB-INF</code>, you will find three key files:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>beans.xml</code></dt>
<dd>
<p>is an empty file that indicates this is a CDI capable EE6 application</p>
</dd>
<dt class="hdlist1"><code>faces-config.xml</code></dt>
<dd>
<p>is an empty file that indicates this is a JSF capable EE6 application</p>
</dd>
<dt class="hdlist1"><code>ticket-monster-ds.xml</code></dt>
<dd>
<p>when deployed, creates a new datasource within the JBoss container</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_new_entity_using_forge">Adding a new entity using Forge</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several ways to add a new JPA entity to your project:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Starting from scratch</dt>
<dd>
<p>Right-click on the <code>.model</code> package and select <strong>New &#8594; Class</strong>.  JPA entities are annotated POJOs so starting from a simple class is a common approach.</p>
</dd>
<dt class="hdlist1">Reverse Engineering</dt>
<dd>
<p>Right-click on the "model" package and select New &#8594; JPA Entities from Tables.  For more information on this technique see <a href="https://vimeo.com/39608294">this video</a></p>
</dd>
<dt class="hdlist1">Using Forge</dt>
<dd>
<p>to create a new entity for your project using a CLI (we will explore this in more detail below)</p>
</dd>
<dt class="hdlist1">Reverse Engineering with Forge</dt>
<dd>
<p>Forge has a Hibernate Tools plug-in that allows you to script the conversion of RDBMS schema into JPA entities.  For more information on this technique see <a href="https://vimeo.com/39608326">this video</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For the purposes of this tutorial, we will take advantage of Forge to add a new JPA entity. This requires the least keystrokes, and we do not yet have a RDBMS schema to reverse engineer.  There is also an optional section for adding an entity using <strong>New &#8594; Class</strong>.</p>
</div>
<div class="paragraph">
<p>Select the project in the <strong>Project Navigator</strong> view of JBoss Developer Studio and enter the <strong>Ctrl + 4</strong> (in Windows/Linux) or <strong>Cmd + 4</strong> (Mac) key combination.
This will launch Forge if it is not started already.</p>
</div>
<div id="starting_forge_for_first_time_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_is_starting.png" alt="forge is starting">
</div>
<div class="title">Figure 23. Starting Forge for the first time</div>
</div>
<div class="paragraph">
<p>The list of commands that you can execute in Forge will be visible in the Forge quick action menu.</p>
</div>
<div id="forge_action_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_action_menu.png" alt="forge action menu">
</div>
<div class="title">Figure 24. Forge action menu</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not see a lot of commands in the quick action menu, then you may not have selected the project.
The Forge quick action menu is contextual in nature, and therefore, it displays commands relevant to the current selection in the project explorer.</p>
</div>
<div class="paragraph">
<p>When nothing is selected, then fewer commands are shown.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>An alternative method to activate Forge is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Window &#8594; Show View &#8594; Forge Console</strong>. Click the <strong>Start</strong> button in the view.</p>
</li>
</ul>
</div>
<div id="show_view_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/show_forge_view.png" alt="show forge view">
</div>
<div class="title">Figure 25. Launch the <strong>Show View</strong> dialog</div>
</div>
<div id="select_forge_view_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/select_forge_view.png" alt="select forge view">
</div>
<div class="title">Figure 26. Select the Forge Console view</div>
</div>
<div class="paragraph">
<p>Note: Activating Forge this way displays the Forge console that allows you to
execute the same commands via a shell interface.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can always start Forge using the green arrow (or
stop via the red square) in the Forge Console tab.</p>
</div>
<div id="forge_start_stop_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_console_tab.png" alt="forge console tab">
</div>
<div class="title">Figure 27. Show Forge Start/Stop</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Forge is a multi-faceted rapid application development tool that allows you to enter commands that generate classes and code. You could use either a GUI within your IDE that offers a familar wizard and dialog based UI, or a shell-like interface to perform operations. It will automatically update the IDE for you. A key feature is "contentual command activation", launched by running the Forge shortcut (<strong>Ctrl + 4</strong> or <strong>Cmd + 4</strong>). For instance, launching Forge on a selected project activates different commands, than launching it in isolation, or for that matter launching Forge with a selected Java source file.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll generate an entity using the Forge GUI. Let&#8217;s work through this, step by step.</p>
</div>
<div class="paragraph">
<p>We start by selecting the TicketMonster project. Launch Forge through the shortcut (<strong>Ctrl + 4</strong> or <strong>Cmd + 4</strong>).
Type <code>jpa</code> in the command filter textbox located in the menu. The menu will filter out irrelevant entries, leaving you with JPA-specific commands.</p>
</div>
<div id="filter_commands_in_forge_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_quick_action_menu_filter_jpa.png" alt="forge quick action menu filter jpa">
</div>
<div class="title">Figure 28. Filter commands in the Forge menu</div>
</div>
<div class="paragraph">
<p>Select the "JPA: New Entity" entry in the menu. Click it or hit the <code>Enter</code> key to execute the command. You will be presented with a dialog where you can provide certain inputs that control how the new entity would be generated, like the package where the entity would be created, the name of the JPA entity/class, the primary-key strategy used for the entity etc.</p>
</div>
<div id="jpa_new_entity_forge_command_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_entity.png" alt="forge jpa new entity">
</div>
<div class="title">Figure 29. The new JPA entity command in Forge</div>
</div>
<div class="paragraph">
<p>Specify the value of the entity as <code>Event</code> and click <code>Finish</code>. The defaults for other values are sufficient - note how Forge intelligently constructs the value for the package field from the Maven group Id and artifact Id values of the project.</p>
</div>
<div id="create_event_entity_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_entity_event.png" alt="forge jpa new entity event">
</div>
<div class="title">Figure 30. Create the Event entity in Forge</div>
</div>
<div class="paragraph">
<p>You should see a notification bubble in Eclipse when Forge completes the action.</p>
</div>
<div id="create_event_entity_image_bubble" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_entity_created.png" alt="forge jpa new entity created">
</div>
<div class="title">Figure 31. The Forge notification bubble in Eclipse</div>
</div>
<div class="paragraph">
<p>Forge would have created a JPA entity as instructed, and it would also open the Java source file in Eclipse. Note that it would have created not only a new class with the <code>@Entity</code> annotation, but also created a primary-key field named <code>id</code>, a <code>version</code> field, along with getters and setters for both, in addition to <code>equals</code>, <code>hashCode</code> and <code>toString</code> methods.</p>
</div>
<div id="event_entity_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_event_entity_source.png" alt="forge event entity source">
</div>
<div class="title">Figure 32. The newly created Event entity</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a new field to this entity. Select the <code>Event</code> class in the project navigator and launch the Forge menu once again. Filter on <code>jpa</code> as usual, and launch the "JPA: New Field" command.
Specify the field name as <code>name</code>, to store the name of the event. The defaults are sufficient for other input fields. Click <code>Finish</code> or hit the <code>Enter</code> button as usual.</p>
</div>
<div id="jpa_new_field_wizard_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_field_name.png" alt="forge jpa new field name">
</div>
<div class="title">Figure 33. The JPA field wizard in Forge</div>
</div>
<div class="paragraph">
<p>You will now notice that the <code>Event</code> class is enhanced with a <code>name</code> field of type <code>String</code>, as well as a getter and setter, along with modifications to the <code>toString</code> method.</p>
</div>
<div id="jpa_newly_created_field_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_added_name.png" alt="forge added name">
</div>
<div class="title">Figure 34. The newly created field in the Event class</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now add Bean Validation (JSR-303) capabilities to the project. Launch the Forge menu, and filter for the "Constraint: Setup" command. Execute the command.</p>
</div>
<div id="filter_constraint_commands_in_forge_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_quick_action_menu_filter_constraint.png" alt="forge quick action menu filter constraint">
</div>
<div class="title">Figure 35. Filter for constraint commands in the Forge menu</div>
</div>
<div class="paragraph">
<p>You&#8217;ll be presented with a choice on what Bean Validation providers you&#8217;d like to setup in the project. The defaults are sufficient - we&#8217;ll use the Bean Validation provider supplied by the Java EE application. Click <code>Finish</code> or hit <code>Enter</code> to setup Bean valdiation.</p>
</div>
<div id="setup_bean_validation_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_setup_constraint_wizard.png" alt="forge setup constraint wizard">
</div>
<div class="title">Figure 36. Setup Bean Validation</div>
</div>
<div class="paragraph">
<p>We&#8217;ll now add a constraint on the newly added <code>name</code> field in the <code>Event</code> class. Select the <code>Event</code> class in the project navigator and proceed to launch the "Constraint: Add" command from the Forge menu. Note that selecting the <code>Event</code> class allows Forge to provide commands relevant to this class in the action menu, as well as populating this class in input fields where it is fit to populate them.</p>
</div>
<div id="launch_add_constraint_wizard_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_add_constraint_on_event.png" alt="forge add constraint on event">
</div>
<div class="title">Figure 37. Select the Event class and launch the "Constraint: Add" wizard</div>
</div>
<div class="paragraph">
<p>This launches a wizard where one can add Bean Validation constraints. The class to operate on will default to the currently selected class, i.e. <code>Event</code>. If you want to switch to a different class, you can do so in the wizard. There is no need to re-launch the wizard.</p>
</div>
<div id="default_value_for_constraint_add_command_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_select_event_entity_for_constraint.png" alt="forge select event entity for constraint">
</div>
<div class="title">Figure 38. The constraint is added to the selected class</div>
</div>
<div class="paragraph">
<p>Proceed to select the <code>name</code> field, on which we add a <code>NotNull</code> constraint. Click <code>Finish</code> or hit <code>Enter</code>.</p>
</div>
<div id="add_notnull_constraint_event_name_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_constraint_add_notnull_on_name.png" alt="forge constraint add notnull on name">
</div>
<div class="title">Figure 39. Add a NotNull constraint on Event name</div>
</div>
<div class="paragraph">
<p>Similarly, add a <code>Size</code> constraint with <code>min</code> and <code>max</code> values of 5 and 50 respectively on the <code>name</code> field.</p>
</div>
<div id="add_size_constraint_event_name_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_constraint_add_size_on_name.png" alt="forge constraint add size on name">
</div>
<div class="title">Figure 40. Add a Size constraint on Event name</div>
</div>
<div id="attribute_values_size_constraint_on_name_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_constraint_add_set_size_attributes_on_name.png" alt="forge constraint add set size attributes on name">
</div>
<div class="title">Figure 41. Specify attribute values for the Size constraint</div>
</div>
<div class="paragraph">
<p>From this point forward, we will assume you have the basics of using Forge&#8217;s menu and the commands executed thus far. Add a new field <code>description</code> to the Event class.</p>
</div>
<div id="add_description_field_to_event_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_field_description.png" alt="forge jpa new field description">
</div>
<div class="title">Figure 42. Add the description field to Event</div>
</div>
<div class="paragraph">
<p>Add a <code>Size</code> constraint on the description field to the event class, with <code>min</code> and <code>max</code> values of 20 and 1000 respectively.</p>
</div>
<div id="add_size_constraint_event_description_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_constraint_add_size_on_description.png" alt="forge constraint add size on description">
</div>
<div class="title">Figure 43. Add a Size constraint on Event name</div>
</div>
<div id="attribute_values_size_constraint_on_description_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_constraint_add_set_size_attributes_on_description.png" alt="forge constraint add set size attributes on description">
</div>
<div class="title">Figure 44. Specify attribute values for the Size constraint</div>
</div>
<div class="paragraph">
<p>Add a new <code>boolean</code> field <code>major</code>. Note - you will need to change the type to <code>boolean</code> from the default value of <code>String</code>.</p>
</div>
<div id="add_major_field_to_event_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_field_major.png" alt="forge jpa new field major">
</div>
<div class="title">Figure 45. Add the major field to Event</div>
</div>
<div class="paragraph">
<p>Add another field <code>picture</code> to the Event class.</p>
</div>
<div id="add_picture_field_to_event_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/forge_jpa_new_field_picture.png" alt="forge jpa new field picture">
</div>
<div class="title">Figure 46. Add the picture field to Event</div>
</div>
<div class="paragraph">
<p>The easiest way to see the results of Forge operating on the <code>Event.java</code> JPA Entity is to use the <strong>Outline View</strong> of JBoss Developer Studio. It is normally on the right-side of the IDE when using the JBoss Perspective.</p>
</div>
<div id="outline_of_event_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/outline_of_event.png" alt="outline of event">
</div>
<div class="title">Figure 47. Outline View</div>
</div>
<div class="paragraph">
<p>Alternatively, you could perform the same sequence of operations in the Forge Console, using these commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="fsh" class="language-fsh hljs">jpa-new-entity --named Event --targetPackage org.jboss.examples.ticketmonster.model ;
jpa-new-field --named name ;
constraint-setup ;
constraint-add --onProperty name --constraint NotNull ;
constraint-add --onProperty name --constraint Size --min 5 --max 50 --message "An event's name must contain between 5 and 50 characters" ;
jpa-new-field --named description ;
constraint-add --onProperty description --constraint Size --min 20 --max 1000 --message "An event's description must contain between 20 and 1000 characters" ;
jpa-new-field --named major --type boolean ;
jpa-new-field --named picture ;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reviewing_persistence_xml_updating_import_sql">Reviewing persistence.xml &amp; updating import.sql</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the entity classes generate the database schema, and is controlled by <code>src/main/resources/persistence.xml</code>.</p>
</div>
<div class="paragraph">
<p>The two key settings are the <code>&lt;jta-data-source&gt;</code> and the <code>hibernate.hbm2ddl.auto</code> property.  The datasource maps to the datasource defined in <code>src\main\webapp\ticket-monsterds.xml</code>.</p>
</div>
<div class="paragraph">
<p>The <code>hibernate.hbm2ddl.auto=create-drop</code> property indicates that all database tables will be dropped when an application is undeployed, or redeployed, and created when the application is deployed.</p>
</div>
<div class="paragraph">
<p>The <code>import.sql</code> file contains SQL statements that will inject sample data into your initial database structure.  Add the following insert statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">insert into Event (id, name, description, major, picture, version) values (1, 'Shane''s Sock Puppets', 'This critically acclaimed masterpiece...', true, 'http://dl.dropbox.com/u/65660684/640px-Carnival_Puppets.jpg', 1);
insert into Event (id, name, description, major, picture, version) values (2, 'Rock concert of the decade', 'Get ready to rock...', true, 'http://dl.dropbox.com/u/65660684/640px-Weir%2C_Bob_(2007)_2.jpg', 1);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_new_entity_using_jboss_developer_studio">Adding a new entity using JBoss Developer Studio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Alternatively, we can add an entity with JBoss Developer Studio or JBoss Tools.</p>
</div>
<div class="paragraph">
<p>First, right-click on the <code>.model</code> package and select <strong>New &#8594; Class</strong>.  Enter the class name as <code>Venue</code> - our concerts &amp; shows happen at particular stadiums, concert halls and theaters.</p>
</div>
<div class="paragraph">
<p>First, add some private fields representing the entities properties, which translate to the columns in the database table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.model;

public class Venue {
	private Long id;
	private String name;
	private String description;
	private int capacity;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, right-click on the editor itself, and from the pop-up, context menu select <strong>Source &#8594; Generate Getters and Setters</strong>.</p>
</div>
<div id="generate_getters_setters_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/generate_getters_setters.png" alt="generate getters setters">
</div>
<div class="title">Figure 48. Generate Getters and Setters Menu</div>
</div>
<div class="paragraph">
<p>This will create accessor and mutator methods for all your fields, making them accessible properties for the entity class.</p>
</div>
<div id="generate_getters_setters_dialog_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/getter_setter_dialog.png" alt="getter setter dialog">
</div>
<div class="title">Figure 49. Generate Getters and Setters Dialog</div>
</div>
<div class="paragraph">
<p>Click <strong>Select All</strong> and then <strong>OK</strong>.</p>
</div>
<div id="venue_after_getters_setters_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/venue_after_getters_setters.png" alt="venue after getters setters">
</div>
<div class="title">Figure 50. Venue.java with gets/sets</div>
</div>
<div class="paragraph">
<p>Now, right-click on the editor, from the pop-up context menu select <strong>Source &#8594; Generate Hibernate/JPA Annotations</strong>.</p>
</div>
<div class="paragraph">
<p>If you are prompted to save <code>Venue.java</code>, simply select OK.</p>
</div>
<div id="save_modified_resources_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/save_modified_resources.png" alt="save modified resources">
</div>
<div class="title">Figure 51. Save Modified Resources</div>
</div>
<div class="paragraph">
<p>The <strong>Hibernate: add JPA annotations</strong> wizard will start up. First, verify that <code>Venue</code> is the class you are working on.</p>
</div>
<div id="hibernate_add_jpa_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/hibernate_add_jpa_annotations.png" alt="hibernate add jpa annotations">
</div>
<div class="title">Figure 52. Hibernate: add JPA annotations</div>
</div>
<div class="paragraph">
<p>Select <strong>Next</strong>.</p>
</div>
<div class="paragraph">
<p>The next step in the wizard will provide a sampling of the refactored sources  describing the basic changes that are being made to <code>Venue</code>.</p>
</div>
<div id="hibernate_add_jpa_annotations_step2_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/hibernate_add_jpa_annotations_step2.png" alt="hibernate add jpa annotations step2">
</div>
<div class="title">Figure 53. Hibernate: add JPA annotations Step 2</div>
</div>
<div class="paragraph">
<p>Select <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p>Now you may wish to add the Bean Validation constraint annotations, such as <code>@NotNull</code> to the fields.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment">Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, if you have not already deployed the application, right click on the project name in the Project Explorer and select <strong>Run As &#8594; Run on Server</strong>.  If needed, this will startup the application server instance, compile &amp; build the application and push the application into the <code>JBOSS_HOME/standalone/deployments</code> directory.  This directory is scanned for new deployments, so simply placing your war in the directory will cause it to be deployed.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you have been using another application server or web server
such as Tomcat, shut it down now to avoid any port conflicts.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="run_as_run_on_server_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/run_as_run_on_server.png" alt="run as run on server">
</div>
<div class="title">Figure 54. Run As &#8594; Run on Server</div>
</div>
<div class="paragraph">
<p>Now, deploy the h2console webapp. It can be found in the JBoss EAP quickstarts. You can read more on how to do this in the <a href="http://www.jboss.org/quickstarts/eap/h2-console/">h2console quickstart</a>.</p>
</div>
<div id="h2_console_app_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/quickstarts_directory_layout.png" alt="quickstarts directory layout">
</div>
<div class="title">Figure 55. Obtain the H2 console app for deployment</div>
</div>
<div class="paragraph">
<p>You need to deploy the <code>h2console.war</code> application, located in the quickstarts, to the JBoss Application Server. You can deploy this application by copying the WAR file to the <code>$JBOSS_HOME/standalone/deployments</code> directory.</p>
</div>
<div id="deploy_h2_console_app_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/h2console_deployments.png" alt="h2console deployments">
</div>
<div class="title">Figure 56. Deploy the H2 console app</div>
</div>
<div class="paragraph">
<p>The <strong>Run As &#8594; Run on Server</strong> option will also launch the internal Eclipse browser with the appropriate URL so that you can immediately begin interacting with the application.</p>
</div>
<div id="result_run_on_server_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/result_run_on_server.png" alt="result run on server">
</div>
<div class="title">Figure 57. Eclipse Browser after Run As &#8594; Run on Server</div>
</div>
<div class="paragraph">
<p>Now, go to <a href="http://localhost:8080/h2console" class="bare">http://localhost:8080/h2console</a> to start up the h2 console.</p>
</div>
<div id="h2console_in_browser_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/h2console_in_browser.png" alt="h2console in browser">
</div>
<div class="title">Figure 58. h2console in browser</div>
</div>
<div class="paragraph">
<p>Use <code>jdbc:h2:mem:ticket-monster</code> as the JDBC URL (this is defined in <code>src/main/webapp/WEB-INF/ticket-monster-ds.xml</code>), <code>sa</code> as the username and <code>sa</code> as the password.</p>
</div>
<div class="paragraph">
<p>Click <strong>Connect</strong></p>
</div>
<div class="paragraph">
<p>You will see both the <code>EVENT</code> table, the <code>VENUE</code> table and the <code>MEMBER</code> tables have been added to the H2 schema.</p>
</div>
<div class="paragraph">
<p>And if you enter the SQL statement: <code>select * from event</code> and select the <strong>Run</strong> (Ctrl-Enter) button, it will display the data you entered in the <code>import.sql</code> file in a previous step.  With these relatively simple steps, you have verified that your new EE 6 JPA entities have been added to the system and deployed successfully, creating the supporting RDBMS schema as needed.</p>
</div>
<div id="h2console_select_from_event.png" class="imageblock">
<div class="content">
<img src="gfx/introduction/h2console_select_from_event.png" alt="h2console select from event">
</div>
<div class="title">Figure 59. h2console Select * from Event</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_jax_rs_restful_web_service">Adding a JAX-RS RESTful web service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this section of the tutorial is to walk you through the creation of a POJO with the JAX-RS annotations.</p>
</div>
<div class="paragraph">
<p>Right-click on the <code>.rest</code> package, select <strong>New &#8594; Class</strong> from the context menu, and enter <code>EventService</code> as the class name.</p>
</div>
<div id="new_class_eventservice_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/new_class_eventservice.png" alt="new class eventservice">
</div>
<div class="title">Figure 60. New Class EventService</div>
</div>
<div class="paragraph">
<p>Select <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p>Replace the contents of the class with this sample code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

@Path("/events")
@RequestScoped
public class EventService {
	@Inject
	private EntityManager em;

	@GET
	@Produces(MediaType.APPLICATION_JSON)
	public List&lt;Event&gt; getAllEvents() {
		final List&lt;Event&gt; results =
			em.createQuery(
			"select e from Event e order by e.name").getResultList();
		return results;
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class is a JAX-RS endpoint that returns all Events.</p>
</div>
<div id="event_service_copy_paste_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/event_service_copy_paste.png" alt="event service copy paste">
</div>
<div class="title">Figure 61. EventService after Copy and Paste</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice a lot of errors, relating to missing imports. The easiest way to solve this is to right-click inside the editor and select <strong>Source &#8594; Organize Imports</strong> from the context menu.</p>
</div>
<div id="source_organize_imports_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/source_organize_imports.png" alt="source organize imports">
</div>
<div class="title">Figure 62. Source &#8594; Organize &#8594; Imports</div>
</div>
<div class="paragraph">
<p>Some of the class names are not unique. Eclipse will prompt you with any decisions around what class is intended. Select the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>javax.ws.rs.core.MediaType</code></p>
</li>
<li>
<p><code>org.jboss.examples.ticketmonster.model.Event</code></p>
</li>
<li>
<p><code>javax.ws.rs.Produces</code></p>
</li>
<li>
<p><code>java.util.List</code></p>
</li>
<li>
<p><code>java.inject.Inject</code></p>
</li>
<li>
<p><code>java.enterprise.context.RequestScoped</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following screenshots illustrate how you handle these decisions. The Figure description indicates the name of the class you should select.</p>
</div>
<div id="organize_imports_1_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_1.png" alt="organize imports 1">
</div>
<div class="title">Figure 63. javax.ws.rs.core.MediaType</div>
</div>
<div id="organize_imports_2_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_2.png" alt="organize imports 2">
</div>
<div class="title">Figure 64. org.jboss.examples.ticketmonster.model.Event</div>
</div>
<div id="organize_imports_3_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_3.png" alt="organize imports 3">
</div>
<div class="title">Figure 65. javax.ws.rs.Produces</div>
</div>
<div id="organize_imports_4_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_4.png" alt="organize imports 4">
</div>
<div class="title">Figure 66. java.util.List</div>
</div>
<div id="organize_imports_5_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_5.png" alt="organize imports 5">
</div>
<div class="title">Figure 67. javax.inject.Inject</div>
</div>
<div id="organize_imports_6_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/organize_imports_6.png" alt="organize imports 6">
</div>
<div class="title">Figure 68. javax.enterprise.context.RequestScoped</div>
</div>
<div class="paragraph">
<p>You should end up with these imports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import java.util.List;

import javax.enterprise.context.RequestScoped;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import org.jboss.examples.ticketmonster.model.Event;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once these import statements are in place you should have no more compilation errors. When you save <code>EventService.java</code>, you will see it listed in JAX-RS REST Web Services in the Project Explorer.</p>
</div>
<div id="project_explorer_jax_rs_services_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/project_explorer_jax_rs_services.png" alt="project explorer jax rs services">
</div>
<div class="title">Figure 69. Project Explorer JAX-RS Services</div>
</div>
<div class="paragraph">
<p>This feature of JBoss Developer Studio and JBoss Tools provides a nice visual indicator that you have successfully configured your JAX-RS endpoint.</p>
</div>
<div class="paragraph">
<p>You should now redeploy your project via <strong>Run As &#8594; Run on Server</strong>, or by right clicking on the project in the <strong>Servers</strong> tab and select <strong>Full Publish</strong>.</p>
</div>
<div id="full_publish_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/full_publish.png" alt="full publish">
</div>
<div class="title">Figure 70. Full Publish</div>
</div>
<div class="paragraph">
<p>Using a browser, visit <a href="http://localhost:8080/ticket-monster/rest/events" class="bare">http://localhost:8080/ticket-monster/rest/events</a> to see the results of the query, formatted as JSON (JavaScript Object Notation).</p>
</div>
<div id="json_event_results_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/json_event_results.png" alt="json event results">
</div>
<div class="title">Figure 71. JSON Response</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>rest</code> prefix is setup in a file called <code>JaxRsActivator.java</code> which contains
a small bit of code that sets up the application for JAX-RS endpoints.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_jquery_mobile_client_application">Adding a jQuery Mobile client application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, it is time to add a HTML5, jQuery based client application that is optimized for the mobile web experience.</p>
</div>
<div class="paragraph">
<p>There are numerous JavaScript libraries that help you optimize the end-user experience on a mobile web browser. We have found that jQuery Mobile is one of the easier ones to get started with but as your skills mature, you might investigate solutions like Sencha Touch, Zepto or Jo.  This tutorial focuses on jQuery Mobile as the basis for creating the UI layer of the application.</p>
</div>
<div class="paragraph">
<p>The UI components interact with the JAX-RS RESTful services (e.g. <code>EventService.java</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>For more information on building HTML5 + REST applications with JBoss technologies, check
out <a href="http://www.jboss.org/aerogear">Aerogear</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These next steps will guide you through the creation of a file called <code>mobile.html</code> that provides a mobile friendly version of the application, using jQuery Mobile.</p>
</div>
<div class="paragraph">
<p>First, using the Project Explorer, navigate to <code>src/main/webapp</code>, and right-click on <code>webapp</code>, and choose <strong>New HTML file</strong>.</p>
</div>
<div id="new_html_file_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/new_html_file.png" alt="new html file">
</div>
<div class="title">Figure 72. New HTML File</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>In certain versions of JBoss Developer Studio, the New HTML File Wizard may start
off with your target location being <code>m2e-wtp/web-resources</code>, this is an
incorrect location and it is a bug, <a href="https://issues.jboss.org/browse/JBIDE-11472">JBIDE-11472</a>.</p>
</div>
<div class="paragraph">
<p>This issue has been corrected in JBoss Developer Studio 6.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Change directory to <code>ticket-monster/src/main/webapp</code> and enter name the file <code>mobile.html</code>.</p>
</div>
<div id="new_html_file_correct_location_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/new_html_file_correct_location.png" alt="new html file correct location">
</div>
<div class="title">Figure 73. New HTML File src/main/webapp</div>
</div>
<div class="paragraph">
<p>Select <strong>Next</strong>.</p>
</div>
<div class="paragraph">
<p>On the <strong>Select HTML Template</strong> page of the <strong>New HTML File</strong> wizard, select <strong>New HTML File (5)</strong>.  This template will get you started with a boilerplate HTML5 document.</p>
</div>
<div id="select_html_template" class="imageblock">
<div class="content">
<img src="gfx/introduction/select_html_template.png" alt="select html template">
</div>
<div class="title">Figure 74. Select New HTML File (5) Template</div>
</div>
<div class="paragraph">
<p>Select <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p>The document must start with <code>&lt;!DOCTYPE html&gt;</code> as this identifies the page as HTML 5 based. For this particular phase of the tutorial, we are not introducing a bunch of HTML 5 specific concepts like the new form fields (type=email), websockets or the new CSS capabilities.  For now, we simply wish to get our mobile application completed as soon as possible.  The good news is that jQuery and jQuery Mobile make the consumption of a RESTful endpoint very simple.</p>
</div>
<div class="paragraph">
<p>You will now notice the Palette View visible in the JBoss perspective. This view contains a collection of popular jQuery Mobile widgets that can be dragged and dropped into the HTML pages to speed up construction of jQuery Mobile pages.</p>
</div>
<div id="jquery_mobile_palette" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_palette.png" alt="jquery mobile palette">
</div>
<div class="title">Figure 75. The jQuery Mobile Palette</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>For a deeper dive into the jQuery Mobile palette feature in
JBoss Developer Studio review <a href="http://vimeo.com/67480300">this video</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us first set the title of the HTML5 document as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;title&gt;TicketMonster&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now add the jQuery and jQuery Mobile JavaScript and CSS files to the HTML document. Luckily for us we can do this by clicking the <em>JS/CSS</em> widget in the palette.</p>
</div>
<div id="js_css_widget" class="imageblock">
<div class="content">
<img src="gfx/introduction/js_css_widget.png" alt="js css widget">
</div>
<div class="title">Figure 76. Click the JS/CSS widget</div>
</div>
<div id="js_css_versions" class="imageblock">
<div class="content">
<img src="gfx/introduction/js_css_widget_library_versions.png" alt="js css widget library versions">
</div>
<div class="title">Figure 77. Select the versions of libraries to add</div>
</div>
<div class="paragraph">
<p>This results in the following document with the jQuery JavaScript file and the jQuery Mobile JavaScript and CSS files being added to the <em>head</em> element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
	&lt;link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" /&gt;
	&lt;script src="http://code.jquery.com/jquery-2.0.3.min.js"&gt;&lt;/script&gt;
	&lt;script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"&gt;&lt;/script&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;TicketMonster&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now proceed to setup the page layout. Click the <em>page</em> widget in the palette to do so. Ensure that the cursor is in the <code>&lt;body&gt;</code> element of the document when you do so.</p>
</div>
<div id="jquery_mobile_page_widget" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_page_widget.png" alt="jquery mobile page widget">
</div>
<div class="title">Figure 78. Click the page widget</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>When you click some of the widgets in the palette, it is important
to have the cursor in the right element of the document.
Failing to observe this will result in the widget being added in
undesired locations. Alternatively, you can drag and drop the
widget to the desired location in the document.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This opens a dialog to configure the jQuery Mobile page.</p>
</div>
<div id="jquery_mobile_page" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_page.png" alt="jquery mobile page">
</div>
<div class="title">Figure 79. Create a new jQuery Mobile page</div>
</div>
<div class="paragraph">
<p>Set the page title as "TicketMonster", footer as blank, and the ID as "page1". Click <strong>Finish</strong> to add a new jQuery Mobile page to the document. The layout is now established.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
	&lt;link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" /&gt;
	&lt;script src="http://code.jquery.com/jquery-2.0.3.min.js"&gt;&lt;/script&gt;
	&lt;script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"&gt;&lt;/script&gt;
	&lt;meta charset="UTF-8"&gt;
	&lt;title&gt;TicketMonster&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div data-role="page" id="page1"&gt;
		&lt;div data-role="header"&gt;
			&lt;h1&gt;TicketMonster&lt;/h1&gt;
		&lt;/div&gt;
		&lt;div data-role="content"&gt;
			&lt;p&gt;Page content goes here.&lt;/p&gt;
		&lt;/div&gt;
		&lt;div data-role="footer"&gt;
			&lt;h4&gt;&lt;/h4&gt;
		&lt;/div&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To populate the page content, remove the paragraph element: <code>&lt;p&gt;Page content goes here.&lt;/p&gt;</code> to start with a blank content section. Click the <em>Listview</em> widget in the palette to start populating the content section.</p>
</div>
<div id="jquery_mobile_listview_widget" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_listview_widget.png" alt="jquery mobile listview widget">
</div>
<div class="title">Figure 80. Click the Listview widget</div>
</div>
<div class="paragraph">
<p>This opens a new dialog to configure the jQuery Mobile listview widget.</p>
</div>
<div id="jquery_mobile_listview" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_listview.png" alt="jquery mobile listview">
</div>
<div class="title">Figure 81. Add a jQuery Mobile Listview widget</div>
</div>
<div class="paragraph">
<p>Select the inset checkbox to display the list as an inset list. Inset lists do not span the entire widget of the display. Set the ID as "listOfItems". Retain the number of items in the list as three, modify the label values to <code>One</code>, <code>Two</code> and <code>Three</code> respectively, and finally, set the URL values to '#'. Retain the default values for the other fields, and click <strong>Finish</strong>. This will create a listview widget with 3 item entries in the list. The jQuery Mobile page is now structurally complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
	&lt;link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" /&gt;
	&lt;script src="http://code.jquery.com/jquery-2.0.3.min.js"&gt;&lt;/script&gt;
	&lt;script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"&gt;&lt;/script&gt;
	&lt;meta charset="UTF-8"&gt;
	&lt;title&gt;TicketMonster&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div data-role="page" id="page1"&gt;
		&lt;div data-role="header"&gt;
			&lt;h1&gt;TicketMonster&lt;/h1&gt;
		&lt;/div&gt;
		&lt;div data-role="content"&gt;
			&lt;ul data-role="listview" id="listOfItems" data-inset="true"&gt;
				&lt;li&gt;&lt;a href="#"&gt;One&lt;/a&gt;&lt;/li&gt;
				&lt;li&gt;&lt;a href="#"&gt;Two&lt;/a&gt;&lt;/li&gt;
				&lt;li&gt;&lt;a href="#"&gt;Three&lt;/a&gt;&lt;/li&gt;
			&lt;/ul&gt;
		&lt;/div&gt;
		&lt;div data-role="footer"&gt;
			&lt;h4&gt;&lt;/h4&gt;
		&lt;/div&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might notice that in the <strong>Visual Page Editor</strong>, the visual portion is not that attractive, this is because the majority of jQuery Mobile magic happens at runtime and our visual page editor simply displays the HTML without embellishment.</p>
</div>
<div class="paragraph">
<p>Visit <a href="http://localhost:8080/ticket-monster/mobile.html" class="bare">http://localhost:8080/ticket-monster/mobile.html</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note: Normally HTML files are deployed automatically, if you find it missing,
just use Full Publish or Run As Run on Server as demonstrated in previous steps.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As soon as the page loads, you can view the jQuery Mobile enhanced page.</p>
</div>
<div id="jquery_mobile_template_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_template.png" alt="jquery mobile template">
</div>
<div class="title">Figure 82. jQuery Mobile Template</div>
</div>
<div class="paragraph">
<p>One side benefit of using a HTML5 + jQuery-based front-end to your application is that it allows for fast turnaround in development.  Simply edit the HTML file, save the file and refresh your browser.</p>
</div>
<div class="paragraph">
<p>Now the secret sauce to connecting your front-end to your back-end is simply observing the jQuery Mobile <em>pageinit</em> JavaScript event and including an invocation of the previously created Events JAX-RS service.</p>
</div>
<div class="paragraph">
<p>Insert the following block of code as the last item in the <code>&lt;head&gt;</code> element</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;head&gt;
    ...
    &lt;title&gt;TicketMonster&lt;/title&gt;
    &lt;script type="text/javascript"&gt;
        $(document).on("pageinit", "#page1", function(event){
            $.getJSON("rest/events", function(events) {
                // console.log("returned are " + events);
                var listOfEvents = $("#listOfItems");
                listOfEvents.empty();
                $.each(events, function(index, event) {
                    // console.log(event.name);
                    listOfEvents.append("&lt;li&gt;&lt;a href='#'&gt;" + event.name + "&lt;/a&gt;");
                });
                listOfEvents.listview("refresh");
            });
        });
    &lt;/script&gt;
&lt;/head&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On triggering <em>pageinit</em> on the page having id "page1"</p>
</li>
<li>
<p>using <code>$.getJSON("rest/events")</code> to hit the <code>EventService.java</code></p>
</li>
<li>
<p>a commented out <code>// console.log</code>, causes problems in IE</p>
</li>
<li>
<p>Getting a reference to <code>listOfItems</code> which is declared in the HTML using an <code>id</code> attribute</p>
</li>
<li>
<p>Calling <code>.empty</code> on that list - removing the exiting <code>One, Two, Three</code> items</p>
</li>
<li>
<p>For each event - based on what is returned in step 1<br></p>
</li>
<li>
<p>another commented out <code>// console.log</code></p>
</li>
<li>
<p><code>append</code> the found event to the UL in the HTML</p>
</li>
<li>
<p><code>refresh</code> the <code>listOfItems</code><br></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You may find the <code>.append("&lt;li&gt;&#8230;&#8203;")</code> syntax unattractive, embedding HTML inside
of the JS .append method, this can be corrected using various JS templating
techniques.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The result is ready for the average mobile phone. Simply refresh your browser to see the results.</p>
</div>
<div id="jquery_mobile_results_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/jquery_mobile_results.png" alt="jquery mobile results">
</div>
<div class="title">Figure 83. jQuery Mobile REST Results</div>
</div>
<div class="paragraph">
<p>JBoss Developer Studio and JBoss Tools includes BrowerSim to help you better understand what your mobile application will look like. Look for a "phone" icon in the toolbar, visible in the JBoss Perspective.</p>
</div>
<div id="mobile_browsersim_in_toolbar_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim_in_toolbar.png" alt="mobile browsersim in toolbar">
</div>
<div class="title">Figure 84. Mobile BrowserSim icon in Eclipse Toolbar</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The BrowserSim tool takes advantage of a locally installed Safari (Mac &amp; Windows)
on your workstation.  It does not package a whole browser by itself.  You will
need to install Safari on Windows to leverage this feature  but that is more
economical than having to purchase a MacBook to quickly look at your mobile-web
focused application!</p>
</div>
</td>
</tr>
</table>
</div>
<div id="mobile_browsersim_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim.png" alt="mobile browsersim">
</div>
<div class="title">Figure 85. Mobile BrowserSim</div>
</div>
<div class="paragraph">
<p>The Mobile BrowserSim has a Devices menu, on Mac it is in the top menu bar and on Windows it is available via right-click as a pop-up menu.   This menu allows you to change user-agent and dimensions of the browser, plus change the orientation of the device.</p>
</div>
<div id="mobile_browsersim_devices_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim_devices_menu.png" alt="mobile browsersim devices menu">
</div>
<div class="title">Figure 86. Mobile BrowserSim Devices Menu</div>
</div>
<div id="mobile_browsersim_windows_menu_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim_windows_menu.png" alt="mobile browsersim windows menu">
</div>
<div class="title">Figure 87. Mobile BrowserSim on Windows 7</div>
</div>
<div class="paragraph">
<p>You can also add your own custom device/browser types.</p>
</div>
<div id="mobile_browsersim_custom_devices_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim_custom_devices.png" alt="mobile browsersim custom devices">
</div>
<div class="title">Figure 88. Mobile BrowserSim Custom Devices Window</div>
</div>
<div class="paragraph">
<p>Under the <strong>File</strong> menu, you will find a <strong>View Page Source</strong> option that will open up the mobile-version of the website&#8217;s source code inside of JBoss Developer Studio.  This is a very useful feature for learning how other developers are creating their mobile web presence.</p>
</div>
<div id="mobile_browsersim_bofa_source_image" class="imageblock">
<div class="content">
<img src="gfx/introduction/mobile_browsersim_bofa_source.png" alt="mobile browsersim bofa source">
</div>
<div class="title">Figure 89. Mobile BrowserSim View Source</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This concludes our introduction to building HTML5 Mobile Web applications using Java EE 6 with Forge and JBoss Developer Studio. At this point, you should feel confident enough to tackle any of the additional exercises to learn how the TicketMonster sample application is constructed.</p>
</div>
<div class="sect2">
<h3 id="_cleaning_up_the_generated_code">Cleaning up the generated code</h3>
<div class="paragraph">
<p>Before we proceed with the tutorial and implement TicketMonster, we need to clean up some of the archetype-generated code. The Member management code, while useful for illustrating the general setup of a Java EE 6 web application, will not be part of TicketMonster, so we can safely remove some packages, classes, and resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All the Member-related persistence and business code:</p>
<div class="ulist">
<ul>
<li>
<p><code>src/main/java/org/jboss/examples/ticketmonster/controller/</code></p>
</li>
<li>
<p><code>src/main/java/org/jboss/examples/ticketmonster/data/</code></p>
</li>
<li>
<p><code>src/main/java/org/jboss/examples/ticketmonster/model/Member.java</code></p>
</li>
<li>
<p><code>src/main/java/org/jboss/examples/ticketmonster/rest/MemberResourceRESTService.java</code></p>
</li>
<li>
<p><code>src/main/java/org/jboss/examples/ticketmonster/service/MemberRegistration.java</code></p>
</li>
<li>
<p><code>src/test/java/org/jboss/examples/ticketmonster/test/MemberRegistrationTest.java</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Generated web content</p>
<div class="ulist">
<ul>
<li>
<p><code>src/main/webapp/index.html</code></p>
</li>
<li>
<p><code>src/main/webapp/index.xhtml</code></p>
</li>
<li>
<p><code>src/main/webapp/WEB-INF/templates/</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>JSF configuration</p>
<div class="ulist">
<ul>
<li>
<p><code>src/main/webapp/WEB-INF/faces-config.xml</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Prototype mobile application (we will generate a proper mobile interface)</p>
<div class="ulist">
<ul>
<li>
<p><code>src/main/webapp/mobile.html</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, we will update the <code>src/main/resources/import.sql</code> file and remove the <code>Member</code> entity insertion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">insert into Member (id, name, email, phone_number) values (0, 'John Smith', 'john.smith@mailinator.com', '2125551212'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data file should contain only the Event data import:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="sql" class="language-sql hljs">insert into Event (id, name, description, major, picture, version) values (1, 'Shane''s Sock Puppets', 'This critically acclaimed masterpiece...', true, 'http://dl.dropbox.com/u/65660684/640px-Carnival_Puppets.jpg', 1);
insert into Event (id, name, description, major, picture, version) values (2, 'Rock concert of the decade', 'Get ready to rock...', true, 'http://dl.dropbox.com/u/65660684/640px-Weir%2C_Bob_(2007)_2.jpg', 1);</code></pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="_building_the_persistence_layer_with_jpa2_and_bean_validation" class="sect0">Building the persistence layer with JPA2 and Bean Validation</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here">What will you learn here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You have set up your project successfully. Now it is time to begin working on the TicketMonster
application, and the first step is adding the persistence layer. After reading this guide,
you&#8217;ll understand what design and implementation choices to make. Topics covered include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RDBMS design using JPA entity beans</p>
</li>
<li>
<p>How to validate your entities using Bean Validation</p>
</li>
<li>
<p>How to populate test data</p>
</li>
<li>
<p>Basic unit testing using JUnit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll round out the guide by revealing the required, yet short and sweet, configuration.</p>
</div>
<div class="paragraph">
<p>The tutorial will show you how to perform all these steps in JBoss Developer Studio, including
screenshots that guide you through. For those of you who prefer to watch and learn, the included
videos show you how we performed all the steps.</p>
</div>
<div class="paragraph">
<p>TicketMonster contains 14 entities, of varying complexity. In the introduction, you have seen
the basic steps for creating a couple of entities (<code>Event</code> and <code>Venue</code>) and interacting with them.
In this  tutorial we&#8217;ll go deeper into domain model design, we&#8217;ll classify the entities, and
walk through designing and creating one of each group.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="YourFirstEntity">Your first entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest kind of entities are often those representing lookup tables. <code>TicketCategory</code> is a classic lookup table that defines the ticket types available (e.g. Adult, Child, Pensioner). A ticket category has one property - <em>description</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">What&#8217;s in a name?</div>
<div class="paragraph">
<p>Using a consistent naming scheme for your entities can help another developer get up
to speed with your code base. We&#8217;ve named all our lookup tables XXXCategory to allow
us to easily spot them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s start by creating a JavaBean to represent the ticket category:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class TicketCategory {

    /* Declaration of fields */

    /**
     * &lt;p&gt;
     * The description of the of ticket category.
     * &lt;/p&gt;
     *
     */
    private String description;

    /* Boilerplate getters and setters */

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    @Override
    public String toString() {
        return description;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re going to want to keep the ticket category in collections (for example, to present it as part of drop down in the UI), so it&#8217;s important that we properly implement <code>equals()</code> and <code>hashCode()</code>.  At this point, we need to define a property (or group of properties) that uniquely identifies the ticket category. We refer to these properties as the "entity&#8217;s natural identity".</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Defining an entity&#8217;s natural identity</div>
<div class="paragraph">
<p>Using an ORM introduces additional constraints on object identity. Defining the
properties that make up an entity&#8217;s natural identity can be tricky, but is very
important. Using the object&#8217;s identity, or the synthetic identity (database generated
primary key) identity can introduce unexpected bugs into your application, so you
should always ensure you use a natural identity. You can read more about the issue at
<a href="https://community.jboss.org/wiki/EqualsAndHashCode" class="bare">https://community.jboss.org/wiki/EqualsAndHashCode</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For ticket category, the choice of natural identity is easy and obvious - it must be the one property, <em>description</em> that the entity has! Having identified the natural identity, adding an <code>equals()</code> and <code>hashCode()</code> method is easy. In Eclipse, choose <em>Source &#8594; Generate hashCode() and equals()&#8230;&#8203;</em></p>
</div>
<div id="eclipse-generate-hashcode-equals" class="imageblock">
<div class="content">
<img src="gfx/eclipse-generate-hashcode-equals.png" alt="eclipse generate hashcode equals">
</div>
<div class="title">Figure 90. Generate hashCode() and equals() in Eclipse</div>
</div>
<div class="paragraph">
<p>Now, select the properties to include:</p>
</div>
<div id="eclipse-generate-hashcode-equals-2" class="imageblock">
<div class="content">
<img src="gfx/eclipse-generate-hashcode-equals-2.png" alt="eclipse generate hashcode equals 2">
</div>
<div class="title">Figure 91. Generate hashCode() and equals() in Eclipse</div>
</div>
<div class="paragraph">
<p>Now that we have a JavaBean, let&#8217;s proceed to make it an entity. First, add the <code>@Entity</code> annotation to the class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class TicketCategory {

   ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, add the synthetic id:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class TicketCategory {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    ...

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we decided that our natural identifier was the <code>description</code>, we should introduce a unique constraint on the property:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class TicketCategory {

    /* Declaration of fields */

    ...

    /**
     * &lt;p&gt;
     * The description of the of ticket category.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The description forms the natural id of the ticket category, and so must be unique.
     * &lt;/p&gt;
     *
     */
    @Column(unique = true)
    private String description;

    ...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s very important that any data you place in the database is of the highest quality - this data is probably one of your organisations most valuable assets! To ensure that bad data doesn&#8217;t get saved to the database by mistake, we&#8217;ll use Bean Validation to enforce constraints on our properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">What is Bean Validation?</div>
<div class="paragraph">
<p>Bean Validation (JSR 303) is a Java EE specification which:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>provides a unified way of declaring and defining constraints on an object model.</p>
</li>
<li>
<p>defines a runtime engine to validate objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bean Validation includes integration with other Java EE specifications, such as JPA.
Bean Validation constraints are automatically applied before data is persisted to the
database, as a last line of defence against bad data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>description</em> of the ticket category should not be empty for two reasons. Firstly, an empty ticket category description is no use to a person trying to book a ticket - it doesn&#8217;t convey any information. Secondly, as the description forms the natural identity, we need to make sure the property is always populated.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add the Bean Validation constraint <code>@NotEmpty</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class TicketCategory {

    /* Declaration of fields */

    ...

    /**
     * &lt;p&gt;
     * The description of the of ticket category.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The description forms the natural id of the ticket category, and so must be unique.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The description must not be null and must be one or more characters, the Bean Validation constraint &lt;code&gt;@NotEmpty&lt;/code&gt;
     * enforces this.
     * &lt;/p&gt;
     *
     */
    @Column(unique = true)
    @NotEmpty
    private String description;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that is our first entity! Here is the complete entity:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketCategory.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * A lookup table containing the various ticket categories. E.g. Adult, Child, Pensioner, etc.
 * &lt;/p&gt;
 */
@Entity
public class TicketCategory {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The description of the of ticket category.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The description forms the natural id of the ticket category, and so must be unique.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The description must not be null and must be one or more characters, the Bean Validation constraint &lt;code&gt;@NotEmpty&lt;/code&gt;
     * enforces this.
     * &lt;/p&gt;
     *
     */
    @Column(unique = true)
    @NotEmpty
    private String description;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    /* toString(), equals() and hashCode() for TicketCategory, using the natural identity of the object */

    @Override
    public String toString() {
        return description;
    }

    @Override
    public int hashCode() {
        final int prime = 31;
        int result = 1;
        result = prime * result
                + ((description == null) ? 0 : description.hashCode());
        return result;
    }

    @Override
    public boolean equals(Object obj) {
        if (this == obj)
            return true;
        if (obj == null)
            return false;
        if (!(obj instanceof TicketCategory))
            return false;
        TicketCategory other = (TicketCategory) obj;
        if (description == null) {
            if (other.description != null)
                return false;
        } else if (!description.equals(other.description))
            return false;
        return true;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>TicketMonster contains another lookup tables, <code>EventCategory</code>. It&#8217;s pretty much identical to <code>TicketCategory</code>, so we leave it as an exercise to the reader to investigate, and understand. If you are building the application whilst following this tutorial, copy the source over from the TicketMonster example.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_design_relationships">Database design &amp; relationships</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s understand the the entity design.</p>
</div>
<div class="paragraph">
<p>An <code>Event</code> may occur at any number of venues, on various days and at various times. The intersection between an event and a venue is a <code>Show</code>, and each show can have a <code>Performance</code> which is associated with a date and time.</p>
</div>
<div class="paragraph">
<p>Venues are a separate grouping of entities, which, as mentioned, intersect with events via shows. Each venue consists of groupings of seats, each known as a <code>Section</code>.</p>
</div>
<div class="paragraph">
<p>Every section, in every show is associated with a ticket category via the <code>TicketPrice</code> entity.</p>
</div>
<div class="paragraph">
<p>Users must be able to book tickets for performances. A <code>Booking</code> is associated with a performance, and contains a collection of tickets.</p>
</div>
<div class="paragraph">
<p>Finally, both events and venues can have "media items", such as images or videos attached.</p>
</div>
<div id="database-design" class="imageblock">
<div class="content">
<img src="gfx/database-design.png" alt="database design">
</div>
<div class="title">Figure 92. Entity-Relationship Diagram</div>
</div>
<div class="sect2">
<h3 id="_media_items">Media items</h3>
<div class="paragraph">
<p>Storing large binary objects, such as images or videos in the database isn&#8217;t advisable (as it can lead to performance issues), and playback of videos can also be tricky, as it depends on browser capabilities. For TicketMonster, we decided to make use of existing services to host images and videos, such as YouTube or Flickr. All we store in the database is the URL the application should use to access the media item, and the type of the media item (note that the URL forms a media items natural identifier). We need to know the type of the media item in order to render the media correctly in the view layer.</p>
</div>
<div class="paragraph">
<p>In order for a view layer to correctly render the media item (e.g. display an image, embed a media player), it&#8217;s likely that special code has had to have been added. For this reason we represent the types of media that TicketMonster understands as a closed set, unmodifiable at runtime. An enum is perfect for this!</p>
</div>
<div class="paragraph">
<p>Luckily, JPA has native support for enums, all we need to do is add the <code>@Enumerated</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/MediaItem.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * The type of the media, required to render the media item correctly.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The media type is a &lt;em&gt;closed set&lt;/em&gt; - as each different type of media requires support coded into the view layers, it
     * cannot be expanded upon without rebuilding the application. It is therefore represented by an enumeration. We instruct
     * JPA to store the enum value using it's String representation, so that we can later reorder the enum members, without
     * changing the data. Of course, this does mean we can't change the names of media items once the app is put into
     * production.
     * &lt;/p&gt;
     */
    @Enumerated(STRING)
    private MediaType mediaType;

    ...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">@Enumerated(STRING) or @Enumerated(ORDINAL)?</div>
<div class="paragraph">
<p>JPA can store an enum value using it&#8217;s ordinal (position in the list of declared enums)
or it&#8217;s STRING (the name it is given). If you choose to store an ordinal, you musn&#8217;t alter
the order of the list. If you choose to store the name, you musn&#8217;t change the enum name.
The choice is yours!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rest of <code>MediaItem</code> shouldn&#8217;t present a challenge to you. If you are building the application whilst following this tutorial, copy both <code>MediaItem</code> and <code>MediaType</code> from the TicketMonster project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_events">Events</h3>
<div class="paragraph">
<p>In the section <a href="#YourFirstEntity">Your first entity</a>, we saw how to build simple entities with properties, identify and apply constraints using Bean Validation, identify the natural id and add a synthetic id. From now on we&#8217;ll assume you know how to build simple entities - for each new entity that we build, we will start with it&#8217;s basic structure and properties filled in.</p>
</div>
<div class="paragraph">
<p>So, here we modify the Event class (from where we left at the end of the introduction). The below listing also includes some comments reflecting the explanations above. We will remove a few fields - <code>version</code>, <code>major</code> and <code>picture</code>, update the annotations on the <code>id</code> field, and update the <code>toString</code>, <code>equals</code> and <code>hashCode</code> methods to use the natural key of the object):</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Event.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Entity
public class Event {

    /* Declaration of fields */

    /**
     * The synthetic ID of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The name of the event.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The name of the event forms it's natural identity and cannot be shared between events.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Two constraints are applied using Bean Validation
     * &lt;/p&gt;
     *
     * &lt;ol&gt;
     * &lt;li&gt;&lt;code&gt;@NotNull&lt;/code&gt; &amp;mdash; the name must not be null.&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;@Size&lt;/code&gt; &amp;mdash; the name must be at least 5 characters and no more than 50 characters. This allows for
     * better formatting consistency in the view layer.&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @Column(unique = true)
    @NotNull
    @Size(min = 5, max = 50, message = "An event's name must contain between 5 and 50 characters")
    private String name;

    /**
     * &lt;p&gt;
     * A description of the event.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Two constraints are applied using Bean Validation
     * &lt;/p&gt;
     *
     * &lt;ol&gt;
     * &lt;li&gt;&lt;code&gt;@NotNull&lt;/code&gt; &amp;mdash; the description must not be null.&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;@Size&lt;/code&gt; &amp;mdash; the name must be at least 20 characters and no more than 1000 characters. This allows for
     * better formatting consistency in the view layer, and also ensures that event organisers provide at least some description
     * - a classic example of a business constraint.&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @NotNull
    @Size(min = 20, max = 1000, message = "An event's description must contain between 20 and 1000 characters")
    private String description;


    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    /* toString(), equals() and hashCode() for Event, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Event event = (Event) o;

        if (name != null ? !name.equals(event.name) : event.name != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        return name != null ? name.hashCode() : 0;
    }

    @Override
    public String toString() {
        return name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, let&#8217;s add a media item to <code>Event</code>. As multiple events (or venues) could share the same media item, we&#8217;ll model the relationship as <em>many-to-one</em> - many events can reference the same media item.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Relationships supported by JPA</div>
<div class="paragraph">
<p>JPA can model four types of relationship between entities - one-to-one, one-to-many,
many-to-one and many-to-many. A relationship may be bi-directional (both sides of the
relationship know about each other) or uni-directional (only one side knows about the
relationship).</p>
</div>
<div class="paragraph">
<p>Many database models are hierarchical (parent-child), as is TicketMonster&#8217;s. As a result,
you&#8217;ll probably find you mostly use one-to-many and many-to-one relationships, which
allow building parent-child models.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Creating a many-to-one relationship is very easy in JPA. Just add the <code>@ManyToOne</code> annotation to the field. JPA will take care of the rest. Here&#8217;s the property for <code>Event</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Event.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * A media item, such as an image, which can be used to entice a browser to book a ticket.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Media items can be shared between events, so this is modeled as a &lt;code&gt;@ManyToOne&lt;/code&gt; relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Adding a media item is optional, and the view layer will adapt if none is provided.
     * &lt;/p&gt;
     *
     */
    @ManyToOne
    private MediaItem mediaItem;

    ...

    public MediaItem getMediaItem() {
        return mediaItem;
    }

    public void setMediaItem(MediaItem picture) {
        this.mediaItem = picture;
    }

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no need for a media item to know who references it (in fact, this would be a poor design, as it would reduce the reusability of <code>MediaItem</code>), so we can leave this as a uni-directional relationship.</p>
</div>
<div class="paragraph">
<p>An event will also have a category. Once again, many events can belong to the same event category, and there is no need for an event category to know what events are in it. To add this relationship, we add the <code>eventCategory</code> property, and annotate it with <code>@ManyToOne</code>, just as we did for <code>MediaItem</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Event.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * The category of the event
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Event categories are used to ease searching of available of events, and hence this is modeled as a relationship
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The Bean Validation constraint &lt;code&gt;@NotNull&lt;/code&gt; indicates that the event category must be specified.
     */
    @ManyToOne
    @NotNull
    private EventCategory category;

    ...

    public EventCategory getCategory() {
        return category;
    }

    public void setCategory(EventCategory category) {
        this.category = category;
    }

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s Event created. Here is the full source:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Event.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * Represents an event, which may have multiple performances with different dates and venues.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * Event's principal members are it's relationship to {@link EventCategory} - specifying the type of event it is - and
 * {@link MediaItem} - providing the ability to add media (such as a picture) to the event for display. It also contains
 * meta-data about the event, such as it's name and a description.
 * &lt;/p&gt;
 *
 */
@Entity
public class Event {

    /* Declaration of fields */

    /**
     * The synthetic ID of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The name of the event.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The name of the event forms it's natural identity and cannot be shared between events.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Two constraints are applied using Bean Validation
     * &lt;/p&gt;
     *
     * &lt;ol&gt;
     * &lt;li&gt;&lt;code&gt;@NotNull&lt;/code&gt; &amp;mdash; the name must not be null.&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;@Size&lt;/code&gt; &amp;mdash; the name must be at least 5 characters and no more than 50 characters. This allows for
     * better formatting consistency in the view layer.&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @Column(unique = true)
    @NotNull
    @Size(min = 5, max = 50, message = "An event's name must contain between 5 and 50 characters")
    private String name;

    /**
     * &lt;p&gt;
     * A description of the event.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Two constraints are applied using Bean Validation
     * &lt;/p&gt;
     *
     * &lt;ol&gt;
     * &lt;li&gt;&lt;code&gt;@NotNull&lt;/code&gt; &amp;mdash; the description must not be null.&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;@Size&lt;/code&gt; &amp;mdash; the name must be at least 20 characters and no more than 1000 characters. This allows for
     * better formatting consistency in the view layer, and also ensures that event organisers provide at least some description
     * - a classic example of a business constraint.&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @NotNull
    @Size(min = 20, max = 1000, message = "An event's name must contain between 20 and 1000 characters")
    private String description;

    /**
     * &lt;p&gt;
     * A media item, such as an image, which can be used to entice a browser to book a ticket.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Media items can be shared between events, so this is modeled as a &lt;code&gt;@ManyToOne&lt;/code&gt; relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Adding a media item is optional, and the view layer will adapt if none is provided.
     * &lt;/p&gt;
     *
     */
    @ManyToOne
    private MediaItem mediaItem;

    /**
     * &lt;p&gt;
     * The category of the event
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Event categories are used to ease searching of available of events, and hence this is modeled as a relationship
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The Bean Validation constraint &lt;code&gt;@NotNull&lt;/code&gt; indicates that the event category must be specified.
     */
    @ManyToOne
    @NotNull
    private EventCategory category;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public MediaItem getMediaItem() {
        return mediaItem;
    }

    public void setMediaItem(MediaItem picture) {
        this.mediaItem = picture;
    }

    public EventCategory getCategory() {
        return category;
    }

    public void setCategory(EventCategory category) {
        this.category = category;
    }

    /* toString(), equals() and hashCode() for Event, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Event event = (Event) o;

        if (name != null ? !name.equals(event.name) : event.name != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        return name != null ? name.hashCode() : 0;
    }

    @Override
    public String toString() {
        return name;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_venue">Venue</h3>
<div class="paragraph">
<p>Now, let&#8217;s build out the entities to represent the venue.</p>
</div>
<div class="paragraph">
<p>We start by adding an entity to represent the venue. A venue needs to have a name, a description,
a capacity, an address, an associated media item and a set of sections in which people can sit.  If
you completed the introduction chapter, you should already have some of these properties set, so
we will update the <code>Venue</code> class to look like in the definition below.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Venue.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * Represents a single venue
 * &lt;/p&gt;
 *
 */
@Entity
public class Venue {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The name of the event.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The name of the event forms it's natural identity and cannot be shared between events.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The name must not be null and must be one or more characters, the Bean Validation
     * constraint &lt;code&gt;@NotEmpty&lt;/code&gt; enforces this.
     * &lt;/p&gt;
     */
    @Column(unique = true)
    @NotEmpty
    private String name;

    /**
     * The address of the venue
     */
    @Embedded
    private Address address = new Address();

    /**
     * A description of the venue
     */
    private String description;

    /**
     * &lt;p&gt;
     * A set of sections in the venue
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship.
     * Collection members are fetched eagerly, so that they can be accessed even after the
     * entity has become detached. This relationship is bi-directional (a section knows which
     * venue it is part of), and the &lt;code&gt;mappedBy&lt;/code&gt; attribute establishes this. We
     * cascade all persistence operations to the set of performances, so, for example if a venue
     * is removed, then all of it's sections will also be removed.
     * &lt;/p&gt;
     */
    @OneToMany(cascade = ALL, fetch = EAGER, mappedBy = "venue")
    private Set&lt;Section&gt; sections = new HashSet&lt;Section&gt;();

    /**
     * The capacity of the venue
     */
    private int capacity;

    /**
     * An optional media item to entice punters to the venue. The &lt;code&gt;@ManyToOne&lt;/code&gt; establishes the relationship.
     */
    @ManyToOne
    private MediaItem mediaItem;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Address getAddress() {
        return address;
    }

    public void setAddress(Address address) {
        this.address = address;
    }

    public MediaItem getMediaItem() {
        return mediaItem;
    }

    public void setMediaItem(MediaItem description) {
        this.mediaItem = description;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public Set&lt;Section&gt; getSections() {
        return sections;
    }

    public void setSections(Set&lt;Section&gt; sections) {
        this.sections = sections;
    }

    public int getCapacity() {
        return capacity;
    }

    public void setCapacity(int capacity) {
        this.capacity = capacity;
    }

    /* toString(), equals() and hashCode() for Venue, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Venue venue = (Venue) o;

        if (address != null ? !address.equals(venue.address) : venue.address != null)
            return false;
        if (name != null ? !name.equals(venue.name) : venue.name != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = name != null ? name.hashCode() : 0;
        result = 31 * result + (address != null ? address.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In creating this entity, we&#8217;ve followed all the design and implementation decisions previously discussed, with one new concept. Rather than add the properties for street, city, postal code etc. to this object, we&#8217;ve extracted them into the <code>Address</code> object, and included it in the <code>Venue</code> object using composition. This would allow us to reuse the Address object in other places (such as a customer&#8217;s address).</p>
</div>
<div class="paragraph">
<p>A RDBMS doesn&#8217;t have a similar concept to composition, so we need to choose whether to represent the address as a separate entity, and create a relationship between the venue and the address, or whether to map the properties from <code>Address</code> to the table for the owning entity, in this case <code>Venue</code>. It doesn&#8217;t make much sense for an address to be a full entity - we&#8217;re not going to want to run queries against the address in isolation, nor do we want to be able to delete or update an address in isolation - in essence, the address doesn&#8217;t have a standalone identity outside of the object into which it is composed.</p>
</div>
<div class="paragraph">
<p>To <em>embed</em> the <code>Address</code> into <code>Venue</code> we add the <code>@Embeddable</code> annotation to the <code>Address</code> class. However, unlike a full entity, there is no need to add an identifier. Here&#8217;s the source for <code>Address</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Address.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * A reusable representation of an address.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * Addresses are used in many places in an application, so to observe the DRY principle, we model Address as an embeddable
 * entity. An embeddable entity appears as a child in the object model, but no relationship is established in the RDBMS..
 * &lt;/p&gt;
 */
@Embeddable
public class Address {

    /* Declaration of fields */
    private String street;
    private String city;
    private String country;

    /* Declaration of boilerplate getters and setters */

    public String getStreet() {
        return street;
    }

    public void setStreet(String street) {
        this.street = street;
    }

    public String getCity() {
        return city;
    }

    public void setCity(String city) {
        this.city = city;
    }

    public String getCountry() {
        return country;
    }

    public void setCountry(String country) {
        this.country = country;
    }

    /* toString(), equals() and hashCode() for Address, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Address address = (Address) o;

        if (city != null ? !city.equals(address.city) : address.city != null)
            return false;
        if (country != null ? !country.equals(address.country) : address.country != null)
            return false;
        if (street != null ? !street.equals(address.street) : address.street != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = street != null ? street.hashCode() : 0;
        result = 31 * result + (city != null ? city.hashCode() : 0);
        result = 31 * result + (country != null ? country.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return street + ", " + city + ", " + country;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sections">Sections</h3>
<div class="paragraph">
<p>A venue consists of a number of seating sections. Each seating section has a name, a description, the number of rows in the section, and the number of seats in a row. It&#8217;s natural identifier is the name of section combined with the venue (a venue can&#8217;t have two sections with the same name). <code>Section</code> doesn&#8217;t introduce any new concepts, so go ahead and copy the source from the below listing:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Section.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SuppressWarnings("serial")
@Entity
@Table(uniqueConstraints=@UniqueConstraint(columnNames={"name", "venue_id"}))
public class Section implements Serializable {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The short name of the section, may be a code such as A12, G7, etc.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The
     * &lt;code&gt;@NotEmpty&lt;code&gt; Bean Validation constraint means that the section name must be at least 1 character.
     * &lt;/p&gt;
     */
    @NotEmpty
    private String name;

    /**
     * &lt;p&gt;
     * The description of the section, such as 'Rear Balcony', etc.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The
     * &lt;code&gt;@NotEmpty&lt;code&gt; Bean Validation constraint means that the section description must be at least 1 character.
     * &lt;/p&gt;
     */
    @NotEmpty
    private String description;

    /**
     * &lt;p&gt;
     * The venue to which this section belongs. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the venue must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Venue venue;

    /**
     * The number of rows that make up the section.
     */
    private int numberOfRows;

    /**
     * The number of seats in a row.
     */
    private int rowCapacity;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public int getNumberOfRows() {
        return numberOfRows;
    }

    public void setNumberOfRows(int numberOfRows) {
        this.numberOfRows = numberOfRows;
    }

    public int getRowCapacity() {
        return rowCapacity;
    }

    public void setRowCapacity(int rowCapacity) {
        this.rowCapacity = rowCapacity;
    }

    public int getCapacity() {
        return this.rowCapacity * this.numberOfRows;
    }

    public Venue getVenue() {
        return venue;
    }

    public void setVenue(Venue venue) {
        this.venue = venue;
    }

    /* toString(), equals() and hashCode() for Section, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Section section = (Section) o;

        if (venue != null ? !venue.equals(section.venue) : section.venue != null)
            return false;
        if (name != null ? !name.equals(section.name) : section.name != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = name != null ? name.hashCode() : 0;
        result = 31 * result + (venue != null ? venue.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return name;
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shows">Shows</h3>
<div class="paragraph">
<p>A show is an event at a venue. It consists of a set of performances of the show. A show also contains the list of ticket prices available.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start building Show. Here&#8217;s is our starting point:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * A show is an instance of an event taking place at a particular venue. A show can have multiple performances.
 * &lt;/p&gt;
 */
@Entity
public class Show {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The event of which this show is an instance. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the event must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Event event;

    /**
     * &lt;p&gt;
     * The venue where this show takes place. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the venue must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Venue venue;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Event getEvent() {
        return event;
    }

    public void setEvent(Event event) {
        this.event = event;
    }

    public Venue getVenue() {
        return venue;
    }

    public void setVenue(Venue venue) {
        this.venue = venue;
    }

    /* toString(), equals() and hashCode() for Show, using the natural identity of the object */
    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Show show = (Show) o;

        if (event != null ? !event.equals(show.event) : show.event != null)
            return false;
        if (venue != null ? !venue.equals(show.venue) : show.venue != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = event != null ? event.hashCode() : 0;
        result = 31 * result + (venue != null ? venue.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return event + " at " + venue;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve been paying attention, you&#8217;ll notice that there is a problem here. We&#8217;ve identified that the natural identity of this entity is formed of two properties - the <em>event</em> and the <em>venue</em>, and we&#8217;ve correctly coded the <code>equals()</code> and <code>hashCode()</code> methods (or had them generated for us!). However, we haven&#8217;t told JPA that these two properties, in combination, must be unique. As there are two properties involved, we can no longer use the <code>@Column</code> annotation (which operates on a single property/table column), but now must use the class level <code>@Table</code> annotation (which operates on the whole entity/table). Change the class definition to read:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...

@Entity
@Table(uniqueConstraints = @UniqueConstraint(columnNames = { "event_id", "venue_id" }))
public class Show {

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that JPA requires us to use the column names, rather than property names here. The column names used in the <code>@UniqueConstraint</code> annotation are those generated by default for properties called <code>event</code> and <code>venue</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, <code>Show</code> is a reserved word in certain databases, most notable MySQL. We&#8217;ll specify a different table name as a result, so that Hibernate will generate correct DDL statements:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...

@Entity
@Table(name="Appearance", uniqueConstraints = @UniqueConstraint(columnNames = { "event_id", "venue_id" }))
public class Show {

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s add the set of performances to the event. Unlike previous relationships we&#8217;ve seen, the relationship between a show and it&#8217;s performances is bi-directional. We chose to model this as a bi-directional relationship in order to improve the generated database schema (otherwise you end with complicated mapping tables which makes updates to collections hard). Let&#8217;s add the set of performances:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * The set of performances of this show.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship. Collection members
     * are fetched eagerly, so that they can be accessed even after the entity has become detached.
     * This relationship is bi-directional (a performance knows which show it is part of), and the &lt;code&gt;mappedBy&lt;/code&gt;
     * attribute establishes this.
     * &lt;/p&gt;
     *
     */
    @OneToMany(fetch=EAGER, mappedBy = "show", cascade = ALL)
    @OrderBy("date")
    private Set&lt;Performance&gt; performances = new HashSet&lt;Performance&gt;();

    ...

    public Set&lt;Performance&gt; getPerformances() {
        return performances;
    }

    public void setPerformances(Set&lt;Performance&gt; performances) {
        this.performances = performances;
    }

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the relationship is bi-directional, we specify the <code>mappedBy</code> attribute on the <code>@OneToMany</code> annotation, which informs JPA to create a bi-directional relationship. The value of the attribute is name of property which forms the other side of the relationship - in this case, not unsuprisingly <code>show</code>!</p>
</div>
<div class="paragraph">
<p>As <code>Show</code> is the owner of <code>Performance</code> (and without a show, a performance cannot exist), we add the <code>cascade = ALL</code> attribute to the <code>@OneToMany</code> annotation. As a result, any persistence operation that occurs on a show, will be propagated to it&#8217;s performances. For example, if a show is removed, any associated performances will be removed as well.</p>
</div>
<div class="paragraph">
<p>When retrieving a show, we will also retrieve its associated performances by adding the <code>fetch = EAGER</code> attribute to the <code>@OneToMany</code> annotation. This is a design decision which required careful consideration. In general, you should favour the default lazy initialization of collections: their content should be accessible on demand. However, in this case we intend to marshal the contents of the collection and pass it across the wire in the JAX-RS layer, after the entity has become detached, and cannot initialize its members on demand.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also need to add the set of ticket prices available for this show. Once more, this is a bi-directional relationship, owned by the show. It looks just like the set of performances:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * The set of ticket prices available for this show.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship.
     * This relationship is bi-directional (a ticket price category knows which show it is part of), and the &lt;code&gt;mappedBy&lt;/code&gt;
     * attribute establishes this. We cascade all persistence operations to the set of performances, so, for example if a show
     * is removed, then all of it's ticket price categories are also removed.
     * &lt;/p&gt;
     */
    @OneToMany(mappedBy = "show", cascade = CascadeType.ALL, fetch = FetchType.EAGER)
    private Set&lt;TicketPrice&gt; ticketPrices = new HashSet&lt;TicketPrice&gt;();

    ...

    public Set&lt;TicketPrice&gt; getTicketPrices() {
        return ticketPrices;
    }

    public void setTicketPrices(Set&lt;TicketPrice&gt; ticketPrices) {
        this.ticketPrices = ticketPrices;
    }

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the full source for <code>Show</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Show.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * A show is an instance of an event taking place at a particular venue. A show can have multiple performances.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * A show contains a set of performances, and a set of ticket prices for each section of the venue for this show.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The event and venue form the natural id of this entity, and therefore must be unique. JPA requires us to use the class level
 * &lt;code&gt;@Table&lt;/code&gt; constraint.
 * &lt;/p&gt;
 *
 */
/*
 * We suppress the warning about not specifying a serialVersionUID, as we are still developing this app, and want the JVM to
 * generate the serialVersionUID for us. When we put this app into production, we'll generate and embed the serialVersionUID
 */
@SuppressWarnings("serial")
@Entity
@Table(name="Appearance", uniqueConstraints = @UniqueConstraint(columnNames = { "event_id", "venue_id" }))
public class Show implements Serializable {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The event of which this show is an instance. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the event must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Event event;

    /**
     * &lt;p&gt;
     * The event of which this show is an instance. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the event must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Venue venue;

    /**
     * &lt;p&gt;
     * The set of performances of this show.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship. TODO Explain EAGER fetch.
     * This relationship is bi-directional (a performance knows which show it is part of), and the &lt;code&gt;mappedBy&lt;/code&gt;
     * attribute establishes this. We cascade all persistence operations to the set of performances, so, for example if a show
     * is removed, then all of it's performances will also be removed.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Normally a collection is loaded from the database in the order of the rows, but here we want to make sure that
     * performances are ordered by date - we let the RDBMS do the heavy lifting. The
     * &lt;code&gt;@OrderBy&lt;code&gt; annotation instructs JPA to do this.
     * &lt;/p&gt;
     */
    @OneToMany(fetch = EAGER, mappedBy = "show", cascade = ALL)
    @OrderBy("date")
    private Set&lt;Performance&gt; performances = new HashSet&lt;Performance&gt;();

    /**
     * &lt;p&gt;
     * The set of ticket prices available for this show.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship.
     * This relationship is bi-directional (a ticket price category knows which show it is part of), and the &lt;code&gt;mappedBy&lt;/code&gt;
     * attribute establishes this. We cascade all persistence operations to the set of performances, so, for example if a show
     * is removed, then all of it's ticket price categories are also removed.
     * &lt;/p&gt;
     */
    @OneToMany(mappedBy = "show", cascade = ALL, fetch = EAGER)
    private Set&lt;TicketPrice&gt; ticketPrices = new HashSet&lt;TicketPrice&gt;();

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Event getEvent() {
        return event;
    }

    public void setEvent(Event event) {
        this.event = event;
    }

    public Venue getVenue() {
        return venue;
    }

    public void setVenue(Venue venue) {
        this.venue = venue;
    }

    public Set&lt;Performance&gt; getPerformances() {
        return performances;
    }

    public void setPerformances(Set&lt;Performance&gt; performances) {
        this.performances = performances;
    }

    public Set&lt;TicketPrice&gt; getTicketPrices() {
        return ticketPrices;
    }

    public void setTicketPrices(Set&lt;TicketPrice&gt; ticketPrices) {
        this.ticketPrices = ticketPrices;
    }

    /* toString(), equals() and hashCode() for Show, using the natural identity of the object */
    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Show show = (Show) o;

        if (event != null ? !event.equals(show.event) : show.event != null)
            return false;
        if (venue != null ? !venue.equals(show.venue) : show.venue != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = event != null ? event.hashCode() : 0;
        result = 31 * result + (venue != null ? venue.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return event + " at " + venue;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ticketprices">TicketPrices</h3>
<div class="paragraph">
<p>The <code>Show</code> entity references two classes - <code>TicketPrice</code> and <code>Performance</code>, that are not yet created. Let&#8217;s first create the <code>TicketPrice</code> class which represents the price for a ticket in a particular <code>Section</code> at a <code>Show</code> for a specific <code>TicketCategory</code>. It does not introduce any new concepts, so go ahead and copy the source from the below listing:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketPrice.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * Contains price categories - each category represents the price for a ticket in a particular section at a particular venue for
 * a particular event, for a particular ticket category.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The section, show and ticket category form the natural id of this entity, and therefore must be unique. JPA requires us to use the class level
 * &lt;code&gt;@Table&lt;/code&gt; constraint
 * &lt;/p&gt;
 *
 */
/*
 * We suppress the warning about not specifying a serialVersionUID, as we are still developing this app, and want the JVM to
 * generate the serialVersionUID for us. When we put this app into production, we'll generate and embed the serialVersionUID
 */
@SuppressWarnings("serial")
@Entity
@Table(uniqueConstraints = @UniqueConstraint(columnNames = { "section_id", "show_id", "ticketcategory_id" }))
public class TicketPrice implements Serializable {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The show to which this ticket price category belongs. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the show must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Show show;

    /**
     * &lt;p&gt;
     * The section to which this ticket price category belongs. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the section must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Section section;

    /**
     * &lt;p&gt;
     * The ticket category to which this ticket price category belongs. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The &lt;code&gt;@NotNull&lt;/code&gt; Bean Validation constraint means that the ticket category must be specified.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private TicketCategory ticketCategory;

    /**
     * The price for this category of ticket.
     */
    private float price;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Show getShow() {
        return show;
    }

    public void setShow(Show show) {
        this.show = show;
    }

    public Section getSection() {
        return section;
    }

    public void setSection(Section section) {
        this.section = section;
    }

    public TicketCategory getTicketCategory() {
        return ticketCategory;
    }

    public void setTicketCategory(TicketCategory ticketCategory) {
        this.ticketCategory = ticketCategory;
    }

    public float getPrice() {
        return price;
    }

    public void setPrice(float price) {
        this.price = price;
    }

    /* equals() and hashCode() for TicketPrice, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        TicketPrice that = (TicketPrice) o;

        if (section != null ? !section.equals(that.section) : that.section != null)
            return false;
        if (show != null ? !show.equals(that.show) : that.show != null)
            return false;
        if (ticketCategory != null ? !ticketCategory.equals(that.ticketCategory) : that.ticketCategory != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = show != null ? show.hashCode() : 0;
        result = 31 * result + (section != null ? section.hashCode() : 0);
        result = 31 * result + (ticketCategory != null ? ticketCategory.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return "$ " + price + " for " + ticketCategory + " in " + section;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_performances">Performances</h3>
<div class="paragraph">
<p>Finally, let&#8217;s create the <code>Performance</code> class, which represents an instance of a <code>Show</code>. Performance is pretty straightforward. It contains the date and time of the performance, and the show of which it is a performance. Together, the show, and the date and time, make up the natural identity of the performance. Here&#8217;s the source for <code>Performance</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Performance.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * A performance represents a single instance of a show.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The show and date form the natural id of this entity, and therefore must be unique. JPA requires us to use the class level
 * &lt;code&gt;@Table&lt;/code&gt; constraint.
 * &lt;/p&gt;
 *
 */
@SuppressWarnings("serial")
@Entity
@Table(uniqueConstraints = @UniqueConstraint(columnNames = { "date", "show_id" }))
public class Performance implements Serializable {

    /* Declaration of fields */

    /**
     * The synthetic id of the object.
     */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * &lt;p&gt;
     * The date and start time of the performance.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * A Java {@link Date} object represents both a date and a time, whilst an RDBMS splits out Date, Time and Timestamp.
     * Therefore we instruct JPA to store this date as a timestamp using the &lt;code&gt;@Temporal(TIMESTAMP)&lt;/code&gt; annotation.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The date and time of the performance is required, and the Bean Validation constraint &lt;code&gt;@NotNull&lt;/code&gt; enforces this.
     * &lt;/p&gt;
     */
    @Temporal(TIMESTAMP)
    @NotNull
    private Date date;

    /**
     * &lt;p&gt;
     * The show of which this is a performance. The &lt;code&gt;@ManyToOne&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The show of which this is a performance is required, and the Bean Validation constraint &lt;code&gt;@NotNull&lt;/code&gt; enforces
     * this.
     * &lt;/p&gt;
     */
    @ManyToOne
    @NotNull
    private Show show;

    /* Boilerplate getters and setters */

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public void setShow(Show show) {
        this.show = show;
    }

    public Show getShow() {
        return show;
    }

    public Date getDate() {
        return date;
    }

    public void setDate(Date date) {
        this.date = date;
    }

    /* equals() and hashCode() for Performance, using the natural identity of the object */

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        Performance that = (Performance) o;

        if (date != null ? !date.equals(that.date) : that.date != null)
            return false;
        if (show != null ? !show.equals(that.show) : that.show != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = date != null ? date.hashCode() : 0;
        result = 31 * result + (show != null ? show.hashCode() : 0);
        return result;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of interest here is the storage of the date and time.</p>
</div>
<div class="paragraph">
<p>A Java <code>Date</code> represents "a specific instance in time, with millisecond precision" and is the recommended construct for representing date and time in the JDK. A RDBMS&#8217;s <em>DATE</em> type typically has day precision only, and uses the <em>DATETIME</em> or <em>TIMESTAMP</em> types to represent an instance in time, and often only to second precision.</p>
</div>
<div class="paragraph">
<p>As the mapping between Java date and time, and database date and time isn&#8217;t straightforward, JPA requires us to use the <code>@Temporal</code> annotation on any property of type <code>Date</code>, and to specify whether the <code>Date</code> should be stored as a date, a time or a timestamp (date and time).</p>
</div>
</div>
<div class="sect2">
<h3 id="_booking_ticket_seat">Booking, Ticket &amp; Seat</h3>
<div class="paragraph">
<p>There aren&#8217;t many new concepts to explore in <code>Booking</code>, <code>Ticket</code> and <code>Seat</code>, so if you are following along with the tutorial, you should copy in the <code>Booking</code>, <code>Ticket</code> and <code>Seat</code> classes.</p>
</div>
<div class="paragraph">
<p>Once the user has selected an event, identified the venue, and selected a performance, they have the opportunity to request a number of seats in a given section, and select the category of tickets required. Once they&#8217;ve chosen their seats, and entered their email address, a <code>Booking</code> is created.</p>
</div>
<div class="paragraph">
<p>A booking consists of the date the booking was created, an email address (as TicketMonster doesn&#8217;t yet have fully fledged user management), a set of tickets and the associated performance. The set of tickets shows us how to create a uni-directional one-to-many relationship:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Booking.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    /**
     * &lt;p&gt;
     * The set of tickets contained within the booking. The &lt;code&gt;@OneToMany&lt;code&gt; JPA mapping establishes this relationship.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The set of tickets is eagerly loaded because FIXME . All operations are cascaded to each ticket, so for example if a
     * booking is removed, then all associated tickets will be removed.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * This relationship is uni-directional, so we need to inform JPA to create a foreign key mapping. The foreign key mapping
     * is not visible in the {@link Ticket} entity despite being present in the database.
     * &lt;/p&gt;
     *
     */
    @OneToMany(fetch = EAGER, cascade = ALL)
    @JoinColumn
    @NotEmpty
    @Valid
    private Set&lt;Ticket&gt; tickets = new HashSet&lt;Ticket&gt;();

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add the <code>@JoinColumn</code> annotation, which sets up a foreign key in <code>Ticket</code>, but doesn&#8217;t expose the booking on Ticket. This prevents the use of messy mapping tables, whilst preserving the integrity of the entity model.</p>
</div>
<div class="paragraph">
<p>A ticket embeds the seat allocated, and contains a reference to the category under which it was sold. It also contains the price at which it was sold.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sectionallocation_and_seatallocationexception">SectionAllocation and SeatAllocationException</h3>
<div class="paragraph">
<p>Finally, we&#8217;d like to track the seats to be allocated from a section during the course of booking tickets. We&#8217;ll use the <code>SectionAllocation</code> entity to track the allocations in every section for every performance. You can copy in the <code>SectionAllocation</code> class from the project sources.</p>
</div>
<div class="paragraph">
<p>The notable member in this class is the two-dimensional array, named <code>allocated</code>. It tracks the state of the section - the first dimension represents the rows in the section, and the second represents the state of every seat in the row. A typical RDBMS would have to store such a structure as a LOB (Large Object) or a BLOB (Binary Large Object), since a n-dimensional array does not map easily to a native data type supported by the database. Thus, we denote the field as a <code>@Lob</code> using the JPA annotation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/SectionAllocation.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    ...

    @Lob
    private long[][] allocated;

    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the class contains business logic to update the state of the <code>allocated</code> field. These methods will come in handy later, when we write the business services.</p>
</div>
<div class="paragraph">
<p>Remember to also copy the <code>SeatAllocationException</code> class, that is referenced in this class, from the project sources. This class represents an Application exception that will be recognized by the EJB container as one that should force a transaction rollback. When this exception is thrown by the business logic in the <code>SectionAllocation</code> entity, and propagated to the EJB container, it will implcitly cause the current transaction to roll back. It is to be noted that, this exception class is not a checked exception (it extends <code>RuntimeException</code>), and thus the compiler does not complain when it is uncaught in the business services that will consume the methods in the <code>SectionAllocation</code> entity.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_to_the_database">Connecting to the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this example, we are using the in-memory H2 database, which is very easy to set up on JBoss AS. JBoss AS allows you deploy a datasource inside your application&#8217;s <code>WEB-INF</code> directory. You can locate the source in <code>src/main/webapp/WEB-INF/ticket-monster-ds.xml</code> (which should have been created in the previous chapter):</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/ticket-monster-ds.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;datasources xmlns="http://www.jboss.org/ironjacamar/schema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.jboss.org/ironjacamar/schema http://docs.jboss.org/ironjacamar/schema/datasources_1_0.xsd"&gt;
    &lt;!-- The datasource is bound into JNDI at this location. We reference
        this in META-INF/persistence.xml --&gt;
    &lt;datasource jndi-name="java:jboss/datasources/ticket-monsterDS"
        pool-name="ticket-monster" enabled="true" use-java-context="true"&gt;
        &lt;connection-url&gt;
            jdbc:h2:mem:ticket-monster;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1
        &lt;/connection-url&gt;
        &lt;driver&gt;h2&lt;/driver&gt;
        &lt;security&gt;
            &lt;user-name&gt;sa&lt;/user-name&gt;
            &lt;password&gt;sa&lt;/password&gt;
        &lt;/security&gt;
    &lt;/datasource&gt;
&lt;/datasources&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The datasource configures an H2 in-memory database, called <em>ticket-monster</em>, and registers a datasource in JNDI at the address:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java:jboss/datasources/ticket-monsterDS</pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to configure JPA to use the datasource. This is done in <code>src/main/resources/META-INF/persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/persistence.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;persistence version="2.0"
   xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="
        http://java.sun.com/xml/ns/persistence
        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;
   &lt;persistence-unit name="primary"&gt;
      &lt;!-- If you are running in a production environment, add a managed
         data source, this example data source is just for development and testing! --&gt;
      &lt;!-- The datasource is deployed as WEB-INF/ticket-monster-ds.xml, you
         can find it in the source at src/main/webapp/WEB-INF/ticket-monster-ds.xml --&gt;
      &lt;jta-data-source&gt;java:jboss/datasources/ticket-monsterDS&lt;/jta-data-source&gt;
      &lt;properties&gt;
         &lt;!-- Properties for Hibernate --&gt;
         &lt;property name="hibernate.hbm2ddl.auto" value="create-drop" /&gt;
         &lt;property name="hibernate.show_sql" value="false" /&gt;
      &lt;/properties&gt;
   &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As our application has only one datasource, and hence one persistence unit, the name given to the persistence unit doesn&#8217;t really matter. We call ours <code>primary</code>, but you can change this as you like. We tell JPA about the datasource bound in JNDI.</p>
</div>
<div class="paragraph">
<p>Hibernate includes the ability to generate tables from entities, which we have configured here. We don&#8217;t recommend using this outside of development. Updates to databases in production should be done in a staged manner by a database administrator.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_populating_test_data">Populating test data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whilst we develop our application, it&#8217;s useful to be able to populate the database with test data. Luckily, Hibernate makes this easy. Just add a file called <code>import.sql</code> onto the classpath of your application (we keep it in <code>src/main/resources/import.sql</code>). In it, we just write standard sql statements suitable for the database we are using. To do this, you need to know the generated column and table names for your entities. The best way to work these out is to look at the h2console.</p>
</div>
<div class="paragraph">
<p>The h2console is included in the JBoss AS quickstarts, along with instructions on how to use it. For more information, see <a href="http://www.jboss.org/quickstarts/eap/h2-console/" class="bare">http://www.jboss.org/quickstarts/eap/h2-console/</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Where do I look for my data?</div>
<div class="paragraph">
<p>The database URL is <code>jdbc:h2:mem:ticket-monster</code>. After
you have downloaded <code>h2console.war</code> and deployed it on the server, make sure that the
application is running on the server and use this value to connect to your running application&#8217;s
database.</p>
</div>
<div id="h2console_settings" class="imageblock">
<div class="content">
<img src="gfx/h2console_settings.png" alt="h2console settings">
</div>
<div class="title">Figure 93. h2console settings</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should copy over the <code>import.sql</code> file from the project sources, to populate the database with the same data, as the one used in the OpenShift-hosted TicketMonster application. The contents of this file already account for the generated table and column names.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You now have a working data model for your TicketMonster application, our next tutorial will show you how to create the business services layer or something like that - it seems to end abruptly.</p>
</div>
</div>
</div>
<h1 id="BuildingBusinessServices" class="sect0">Building The Business Services With JAX-RS</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_2">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve just defined the domain model of the application and created its persistence layer. Now we need to define the services that implement the business logic of the application and expose them to the front-end. After reading this, you&#8217;ll understand how to design the business layer and what choices to make while developing it. Topics covered include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encapsulating business logic in services and integrating with the persistence tier</p>
</li>
<li>
<p>Using CDI for integrating individual services</p>
</li>
<li>
<p>Integration testing using Arquillian</p>
</li>
<li>
<p>Exposing RESTful services via JAX-RS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tutorial will show you how to perform all these steps in JBoss Developer Studio, including screenshots that guide you through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_business_services_and_their_relationships">Business Services And Their Relationships</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TicketMonster&#8217;s business logic is implemented by a number of classes, with different responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>managing media items</p>
</li>
<li>
<p>allocating tickets</p>
</li>
<li>
<p>handling information on ticket availability</p>
</li>
<li>
<p>remote access through a RESTful interface</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The services are consumed by various other layers of the application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the media management and ticket allocation services encapsulate complex functionality, which in turn is exposed externally by RESTful services that wrap them</p>
</li>
<li>
<p>RESTful services are mainly used by the HTML5 view layer</p>
</li>
<li>
<p>the ticket availability service is used by the HTML5 and JavaScript based monitor</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Where to draw the line?</div>
<div class="paragraph">
<p>A business service is an encapsulated, reusable logical component that groups
together a number of well-defined cohesive business operations. Business services
perform business operations, and may coordinate infrastructure services such as
persistence units, or even other business services as well. The boundaries drawn
between them should take into account whether the newly created services represent
, potentially reusable components.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, some of the services are intended to be consumed within the business layer of the application, while others provide an external interface as JAX-RS services. We will start by implementing the former, and we&#8217;ll finish up with the latter. During this process, you will
discover how CDI, EJB and JAX-RS make it easy to define and wire together our services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparations">Preparations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_adding_jackson_core">Adding Jackson Core</h3>
<div class="paragraph">
<p>The first step for setting up our service architecture is to add Jackson Core as a dependency in the project. Adding Jackson Core as a provided dependency will enable you to use the Jackson annotations in the project. This is necessary to obtain a certain degree of control over the content of the JSON responses. We can bring in the same version of Jackson Core as the one used in RESTEasy, by adding <code>org.jboss.resteasy:resteasy-jackson-provider</code> and <code>org.jboss.resteasy:resteasy-jaxrs</code> as provided-scope dependencies, through the <code>org.jboss.bom.eap:jboss-javaee-6.0-with-resteasy</code> BOM. The versions of these dependencies would depend on the version of the JBoss BOMs we use in our project. Using the same version of the JBoss BOM as the one we will deploy to production, will ensure that we use the right dependencies during compilation and build.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...

    &lt;dependencyManagement&gt;
        ...

        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.bom.eap&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-javaee-6.0-with-resteasy&lt;/artifactId&gt;
            &lt;version&gt;${version.jboss.bom.eap}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;

    &lt;dependencies&gt;

        ...

        &lt;!-- RESTEasy dependencies that bring in Jackson Core and RESTEasy APIs+SPIs, which we use for
            fine tuning the content of the JSON responses --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.resteasy&lt;/groupId&gt;
            &lt;artifactId&gt;resteasy-jackson-provider&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.resteasy&lt;/groupId&gt;
            &lt;artifactId&gt;resteasy-jaxrs&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Why do you need the Jackson annotations?</div>
<div class="paragraph">
<p>JAX-RS does not specify mediatype-agnostic annotations for certain use cases. You will
encounter atleast one of them in the project. The object graph contains
cyclic/bi-directional relationships among entities like <code>Venue</code>, <code>Section</code>, <code>Show</code>,
<code>Performance</code> and <code>TicketPrice</code>. JSON representations for these objects will need
tweaking to avoid stack oVerflow errors and the like, at runtime.</p>
</div>
<div class="paragraph">
<p>JBoss Enterprise Application 6 uses Jackson to perform serialization and
dserialization of objects, thus requiring use of Jackson annotations to modify this
behavior. <code>@JsonIgnoreProperties</code> from Jackson will be used to suppress serialization
and deserialization of one of the fields involved in the cycle.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_verifying_the_versions_of_the_jboss_boms">Verifying the versions of the JBoss BOMs</h3>
<div class="paragraph">
<p>The next step is to verify if we&#8217;re using the right version of the JBoss BOMs in the project.
Using the right versions of the BOMs ensures that you work against a known set of tested dependencies.
Verify that the property <code>version.jboss.bom.eap</code> contains the value <code>6.3.2.GA</code> or higher:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...
    &lt;properties&gt;
        ...
        &lt;version.jboss.bom.eap&gt;6.3.2.GA&lt;/version.jboss.bom.eap&gt;
        ...
    &lt;/properties&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_cdi">Enabling CDI</h3>
<div class="paragraph">
<p>The next step is to enable CDI in the deployment by creating a <code>beans.xml</code> file in the <code>WEB-INF</code> folder of the web application.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/beans.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;beans xmlns="http://java.sun.com/xml/ns/javaee"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
	                       http://java.sun.com/xml/ns/javaee/beans_1_0.xsd"&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">If you used the Maven archetype</div>
<div class="paragraph">
<p>If you used the Maven archetype to create the project, this file will exist already
in the project - it is added automatically.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may wonder why the file is empty! Whilst <code>beans.xml</code> can specify various deployment-time configuration (e.g. activation of interceptors,
decorators or alternatives), it can also act as a marker file, telling the container to enable CDI for the deployment (which it doesn&#8217;t do, unless <code>beans.xml</code> is present).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Contexts and Dependency Injection (CDI)</div>
<div class="paragraph">
<p>As it&#8217;s name suggests, CDI is the contexts and dependency injection standard for Java
EE. By enabling CDI in your application, deployed classes become managed components
and their lifecycle and wiring becomes the responsibility of the Java EE server.</p>
</div>
<div class="paragraph">
<p>In this way, we can reduce coupling between components, which is a requirement o a
well-designed architecture. Now, we can focus on implementing the responsibilities of
the components and describing their dependencies in a declarative fashion. The
runtime will do the rest for you: instantiating and wiring them together, as well as
disposing of them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_utility_classes">Adding utility classes</h3>
<div class="paragraph">
<p>Next, we add some helper classes providing low-level utilities for the application. We won&#8217;t get in their implementation details here, but you can study their source code for details.</p>
</div>
<div class="paragraph">
<p>Copy the following classes from the original example to <code>src/main/java/org/jboss/examples/ticketmonster/util</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Base64</code></p>
</li>
<li>
<p><code>CircularBuffer</code></p>
</li>
<li>
<p><code>ForwardingMap</code></p>
</li>
<li>
<p><code>MultivaluedHashMap</code></p>
</li>
<li>
<p><code>Reflections</code></p>
</li>
<li>
<p><code>Resources</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internal_services">Internal Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We begin the service implementation by implementing some helper services.</p>
</div>
<div class="sect2">
<h3 id="_the_media_manager">The Media Manager</h3>
<div class="paragraph">
<p>First, let&#8217;s add support for managing media items, such as images. The persistence layer simply stores URLs, referencing media items stored by online services. The URL look like <a href="http://dl.dropbox.com/u/65660684/640px-Roy_Thomson_Hall_Toronto.jpg" class="bare">http://dl.dropbox.com/u/65660684/640px-Roy_Thomson_Hall_Toronto.jpg</a>.</p>
</div>
<div class="paragraph">
<p>Now, we could use the URLs in our application, and retrieve these media items from the provider. However, we would prefer to cache these media items in order to improve application performance and increase resilience to external failures - this will allow us to run the application
successfully even if the provider is down. The <code>MediaManager</code> is a good illustration of a business service; it performs the retrieval and caching of media objects, encapsulating the operation from the rest of the application.</p>
</div>
<div class="paragraph">
<p>We begin by creating <code>MediaManager</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaManager.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * The media manager is responsible for taking a media item, and returning either the URL
 * of the cached version (if the application cannot load the item from the URL), or the
 * original URL.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The media manager also transparently caches the media items on first load.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The computed URLs are cached for the duration of a request. This provides a good balance
 * between consuming heap space, and computational time.
 * &lt;/p&gt;
 *
 */
public class MediaManager {

    /**
     * Locate the tmp directory for the machine
     */
    private static final File tmpDir;

    static {
        String dataDir = System.getenv("OPENSHIFT_DATA_DIR");
        String parentDir = dataDir != null ? dataDir : System.getProperty("java.io.tmpdir");
        tmpDir = new File(parentDir, "org.jboss.examples.ticket-monster");
        if (tmpDir.exists()) {
            if (tmpDir.isFile())
                throw new IllegalStateException(tmpDir.getAbsolutePath() + " already exists, and is a file. Remove it.");
        } else {
            tmpDir.mkdir();
        }
    }

    /**
     * A request scoped cache of computed URLs of media items.
     */
    private final Map&lt;MediaItem, MediaPath&gt; cache;

    public MediaManager() {

        this.cache = new HashMap&lt;MediaItem, MediaPath&gt;();
    }

    /**
     * Load a cached file by name
     *
     * @param fileName
     * @return
     */
    public File getCachedFile(String fileName) {
        return new File(tmpDir, fileName);
    }

    /**
     * Obtain the URL of the media item. If the URL h has already been computed in this
	 * request, it will be looked up in the request scoped cache, otherwise it will be
	 * computed, and placed in the request scoped cache.
     */
    public MediaPath getPath(MediaItem mediaItem) {
        if (cache.containsKey(mediaItem)) {
            return cache.get(mediaItem);
        } else {
            MediaPath mediaPath = createPath(mediaItem);
            cache.put(mediaItem, mediaPath);
            return mediaPath;
        }
    }

    /**
     * Compute the URL to a media item. If the media item is not cacheable, then, as long
	 * as the resource can be loaded, the original URL is returned. If the resource is not
	 * available, then a placeholder image replaces it. If the media item is cachable, it
	 * is first cached in the tmp directory, and then path to load it is returned.
     */
    private MediaPath createPath(MediaItem mediaItem) {
        if(mediaItem == null) {
            return createCachedMedia(Reflections.getResource("not_available.jpg").toExternalForm(), IMAGE);
        } else if (!mediaItem.getMediaType().isCacheable()) {
            if (checkResourceAvailable(mediaItem)) {
                return new MediaPath(mediaItem.getUrl(), false, mediaItem.getMediaType());
            } else {
                return createCachedMedia(Reflections.getResource("not_available.jpg").toExternalForm(), IMAGE);
            }
        } else {
            return createCachedMedia(mediaItem);
        }
    }

    /**
     * Check if a media item can be loaded from it's URL, using the JDK URLConnection classes.
     */
    private boolean checkResourceAvailable(MediaItem mediaItem) {
        URL url = null;
        try {
            url = new URL(mediaItem.getUrl());
        } catch (MalformedURLException e) {
        }

        if (url != null) {
            try {
                URLConnection connection = url.openConnection();
                if (connection instanceof HttpURLConnection) {
                    return ((HttpURLConnection) connection).getResponseCode() == HttpURLConnection.HTTP_OK;
                } else {
                    return connection.getContentLength() &gt; 0;
                }
            } catch (IOException e) {
            }
        }
        return false;
    }

    /**
     * The cached file name is a base64 encoded version of the URL. This means we don't need to maintain a database of cached
     * files.
     */
    private String getCachedFileName(String url) {
        return Base64.encodeToString(url.getBytes(), false);
    }

    /**
     * Check to see if the file is already cached.
     */
    private boolean alreadyCached(String cachedFileName) {
        File cache = getCachedFile(cachedFileName);
        if (cache.exists()) {
            if (cache.isDirectory()) {
                throw new IllegalStateException(cache.getAbsolutePath() + " already exists, and is a directory. Remove it.");
            }
            return true;
        } else {
            return false;
        }
    }

    /**
     * To cache a media item we first load it from the net, then write it to disk.
     */
    private MediaPath createCachedMedia(String url, MediaType mediaType) {
        String cachedFileName = getCachedFileName(url);
        if (!alreadyCached(cachedFileName)) {
            URL _url = null;
            try {
                _url = new URL(url);
            } catch (MalformedURLException e) {
                throw new IllegalStateException("Error reading URL " + url);
            }

            try {
                InputStream is = null;
                OutputStream os = null;
                try {
                    is = new BufferedInputStream(_url.openStream());
                    os = new BufferedOutputStream(getCachedOutputStream(cachedFileName));
                    while (true) {
                        int data = is.read();
                        if (data == -1)
                            break;
                        os.write(data);
                    }
                } finally {
                    if (is != null)
                        is.close();
                    if (os != null)
                        os.close();
                }
            } catch (IOException e) {
                throw new IllegalStateException("Error caching " + mediaType.getDescription(), e);
            }
        }
        return new MediaPath(cachedFileName, true, mediaType);
    }

    private MediaPath createCachedMedia(MediaItem mediaItem) {
        return createCachedMedia(mediaItem.getUrl(), mediaItem.getMediaType());
    }

    private OutputStream getCachedOutputStream(String fileName) {
        try {
            return new FileOutputStream(getCachedFile(fileName));
        } catch (FileNotFoundException e) {
            throw new IllegalStateException("Error creating cached file", e);
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service delegates to a number of internal methods that do the heavy lifting, but exposes a simple API, to the external observer it simply converts the <code>MediaItem</code> entities into <code>MediaPath</code> data structures, that can be used by the application to load the binary data of the media item. The service will retrieve and cache the data locally in the filesystem, if possible (e.g. streamed videos aren&#8217;t cacheable!).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaPath.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MediaPath {

    private final String url;
    private final boolean cached;
    private final MediaType mediaType;

    public MediaPath(String url, boolean cached, MediaType mediaType) {
        this.url = url;
        this.cached = cached;
        this.mediaType = mediaType;
    }

    public String getUrl() {
        return url;
    }

    public boolean isCached() {
        return cached;
    }

    public MediaType getMediaType() {
        return mediaType;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service can be injected by type into the components that depend on it.</p>
</div>
<div class="paragraph">
<p>We should also control the lifecycle of this service. The <code>MediaManager</code> stores request-specific state, so should be scoped to the web request, the CDI <code>@RequestScoped</code> is perfect.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaManager.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
@RequestScoped
public class MediaManager {
   ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_seat_allocation_service">The Seat Allocation Service</h3>
<div class="paragraph">
<p>The seat allocation service finds free seats at booking time, in a given section of the venue. It is a good example of how a service can coordinate infrastructure services (using the injected persistence unit to get access to the <code>SeatAllocation</code> instance) and domain objects (by invoking the <code>allocateSeats</code> method on a concrete allocation instance).</p>
</div>
<div class="paragraph">
<p>Isolating this functionality in a service class makes it possible to write simpler, self-explanatory code in the layers above and opens the possibility of replacing this code at a later date with a more advanced implementation (for example one using an in-memory cache).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/SeatAllocationService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SuppressWarnings("serial")
public class SeatAllocationService implements Serializable {

    @Inject
    EntityManager entityManager;

    public AllocatedSeats allocateSeats(Section section, Performance performance, int seatCount, boolean contiguous) {
        SectionAllocation sectionAllocation = retrieveSectionAllocationExclusively(section, performance);
        List&lt;Seat&gt; seats = sectionAllocation.allocateSeats(seatCount, contiguous);
        return new AllocatedSeats(sectionAllocation, seats);
    }

    public void deallocateSeats(Section section, Performance performance, List&lt;Seat&gt; seats) {
        SectionAllocation sectionAllocation = retrieveSectionAllocationExclusively(section, performance);
        for (Seat seat : seats) {
            if (!seat.getSection().equals(section)) {
                throw new SeatAllocationException("All seats must be in the same section!");
            }
            sectionAllocation.deallocate(seat);
        }
    }

    private SectionAllocation retrieveSectionAllocationExclusively(Section section, Performance performance) {
        SectionAllocation sectionAllocationStatus = null;
        try {
            sectionAllocationStatus = (SectionAllocation) entityManager.createQuery(
                "select s from SectionAllocation s where " +
                    "s.performance.id = :performanceId and " +
                    "s.section.id = :sectionId")
                .setParameter("performanceId", performance.getId())
                .setParameter("sectionId", section.getId())
                .getSingleResult();
        } catch (NoResultException noSectionEx) {
            // Create the SectionAllocation since it doesn't exist
            sectionAllocationStatus = new SectionAllocation(performance, section);
            entityManager.persist(sectionAllocationStatus);
            entityManager.flush();
        }
        entityManager.lock(sectionAllocationStatus, LockModeType.PESSIMISTIC_WRITE);
        return sectionAllocationStatus;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we define the <code>AllocatedSeats</code> class that we use for storing seat reservations for a booking, before they are made persistent.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/AllocatedSeats.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class AllocatedSeats {

    private final SectionAllocation sectionAllocation;

    private final List&lt;Seat&gt; seats;

    public AllocatedSeats(SectionAllocation sectionAllocation, List&lt;Seat&gt; seats) {
        this.sectionAllocation = sectionAllocation;
        this.seats = seats;
    }

    public SectionAllocation getSectionAllocation() {
        return sectionAllocation;
    }

    public List&lt;Seat&gt; getSeats() {
        return seats;
    }

    public void markOccupied() {
        sectionAllocation.markOccupied(seats);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jax_rs_services">JAX-RS Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The majority of services in the application are JAX-RS web services. They are critical part of the design, as they next service is used for provide communication with the HTML5 view layer. The JAX-RS services range from simple CRUD to processing bookings and media items.</p>
</div>
<div class="paragraph">
<p>To pass data across the wire we use JSON as the data marshalling format, as it is less verbose and easier to process than XML by the JavaScript client-side framework.</p>
</div>
<div class="sect2">
<h3 id="_initializing_jax_rs">Initializing JAX-RS</h3>
<div class="paragraph">
<p>We shall ensure that the required dependencies are present in the project POM, to setup JAX-RS in the project:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
    ...
    &lt;dependencies&gt;
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.spec.javax.ws.rs&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-jaxrs-api_1.1_spec&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.spec.javax.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-servlet-api_3.0_spec&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of these may already be present in the project POM, and should not be added again.</p>
</div>
<div class="paragraph">
<p>To activate JAX-RS we add the class below, which instructs the container to look for JAX-RS
annotated classes and install them as endpoints. This class should exist already in your
project, as it is generated by the archetype, so make sure that it is there and it contains the
code below:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/JaxRsActivator.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ApplicationPath("/rest")
public class JaxRsActivator extends Application {
   /* class body intentionally left blank */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the JAX-RS services are mapped relative to the <code>/rest</code> path, as defined by the <code>@ApplicationPath</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_base_service_for_read_operations">A Base Service For Read Operations</h3>
<div class="paragraph">
<p>Most JAX-RS services must provide both a (filtered) list of entities or individual entity (e.g. events, venues and bookings). Instead of duplicating the implementation into each individual service we create a base service class and wire the helper objects in.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *   A number of RESTful services implement GET operations on a particular type of entity. For
 *   observing the DRY principle, the generic operations are implemented in the &lt;code&gt;BaseEntityService&lt;/code&gt;
 *   class, and the other services can inherit from here.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 *    Subclasses will declare a base path using the JAX-RS {@link Path} annotation, for example:
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 * &lt;code&gt;
 * &amp;#064;Path("/widgets")
 * public class WidgetService extends BaseEntityService&lt;Widget&gt; {
 * ...
 * }
 * &lt;/code&gt;
 * &lt;/pre&gt;
 *
 * &lt;p&gt;
 *   will support the following methods:
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 * &lt;code&gt;
 *   GET /widgets
 *   GET /widgets/:id
 *   GET /widgets/count
 * &lt;/code&gt;
 * &lt;/pre&gt;
 *
 *  &lt;p&gt;
 *     Subclasses may specify various criteria for filtering entities when retrieving a list of them, by supporting
 *     custom query parameters. Pagination is supported by default through the query parameters &lt;code&gt;first&lt;/code&gt;
 *     and &lt;code&gt;maxResults&lt;/code&gt;.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 *     The class is abstract because it is not intended to be used directly, but subclassed by actual JAX-RS
 *     endpoints.
 * &lt;/p&gt;
 *
 */
public abstract class BaseEntityService&lt;T&gt; {

    @Inject
    private EntityManager entityManager;

    private Class&lt;T&gt; entityClass;

    public BaseEntityService() {}

    public BaseEntityService(Class&lt;T&gt; entityClass) {
        this.entityClass = entityClass;
    }

    public EntityManager getEntityManager() {
        return entityManager;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we add a method to retrieve all entities of a given type:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *   A method for retrieving all entities of a given type. Supports the query parameters
     *  &lt;code&gt;first&lt;/code&gt;
     *   and &lt;code&gt;maxResults&lt;/code&gt; for pagination.
     * &lt;/p&gt;
     *
     *  @param uriInfo application and request context information (see {@see UriInfo} class
     *  information for more details)
     *  @return
     */
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public List&lt;T&gt; getAll(@Context UriInfo uriInfo) {
        return getAll(uriInfo.getQueryParameters());
    }

    public List&lt;T&gt; getAll(MultivaluedMap&lt;String, String&gt; queryParameters) {
        final CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        final CriteriaQuery&lt;T&gt; criteriaQuery = criteriaBuilder.createQuery(entityClass);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        Predicate[] predicates = extractPredicates(queryParameters, criteriaBuilder, root);
        criteriaQuery.select(criteriaQuery.getSelection()).where(predicates);
        criteriaQuery.orderBy(criteriaBuilder.asc(root.get("id")));
        TypedQuery&lt;T&gt; query = entityManager.createQuery(criteriaQuery);
        if (queryParameters.containsKey("first")) {
        	Integer firstRecord = Integer.parseInt(queryParameters.getFirst("first"))-1;
        	query.setFirstResult(firstRecord);
        }
        if (queryParameters.containsKey("maxResults")) {
        	Integer maxResults = Integer.parseInt(queryParameters.getFirst("maxResults"));
        	query.setMaxResults(maxResults);
        }
		return query.getResultList();
    }

    /**
     * &lt;p&gt;
     *     Subclasses may choose to expand the set of supported query parameters (for adding more filtering
     *     criteria) by overriding this method.
     * &lt;/p&gt;
     * @param queryParameters - the HTTP query parameters received by the endpoint
     * @param criteriaBuilder - @{link CriteriaBuilder} used by the invoker
     * @param root  @{link Root} used by the invoker
     * @return a list of {@link Predicate}s that will added as query parameters
     */
    protected Predicate[] extractPredicates(MultivaluedMap&lt;String, String&gt; queryParameters,
                                             CriteriaBuilder criteriaBuilder, Root&lt;T&gt; root) {
        return new Predicate[]{};
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly added method <code>getAll</code> is annotated with <code>@GET</code> which instructs JAX-RS to call it when a <code>GET</code> HTTP requests on the JAX-RS' endpoint base URL '/rest/&lt;entityRoot&gt;' is performed. But remember, this is not a true JAX-RS endpoint. It is an abstract class and it is not mapped to a path. The classes that extend it are JAX-RS endpoints, and will have to be mapped to a path, and are able to process requests.</p>
</div>
<div class="paragraph">
<p>The <code>@Produces</code> annotation defines that the response sent back by the server is in JSON format. The JAX-RS implementation will automatically convert the result returned by the method (a list of entities) into JSON format.</p>
</div>
<div class="paragraph">
<p>As well as configuring the marshaling strategy, the annotation affects content negotiation and method resolution. If the client requests JSON content specifically, this method will be invoked.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Even though it is not shown in this example, you may have multiple methods that
handle a specific URL and HTTP method, whilst consuming and producing different types
of content (JSON, HTML, XML or others).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Subclasses can also override the <code>extractPredicates</code> method and add own support for additional query parameters to <code>GET /rest/&lt;entityRoot&gt;</code> which can act as filter criteria.</p>
</div>
<div class="paragraph">
<p>The <code>getAll</code> method supports retrieving a range of entities, which is especially useful when we need to handle very large sets of data, and use pagination. In those cases, we need to support counting entities as well, so we add a method that retrieves the entity count:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *   A method for counting all entities of a given type
     * &lt;/p&gt;
     *
     * @param uriInfo application and request context information (see {@see UriInfo} class information for more details)
     * @return
     */
    @GET
    @Path("/count")
    @Produces(MediaType.APPLICATION_JSON)
    public Map&lt;String, Long&gt; getCount(@Context UriInfo uriInfo) {
        CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        CriteriaQuery&lt;Long&gt; criteriaQuery = criteriaBuilder.createQuery(Long.class);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        criteriaQuery.select(criteriaBuilder.count(root));
        Predicate[] predicates = extractPredicates(uriInfo.getQueryParameters(), criteriaBuilder, root);
        criteriaQuery.where(predicates);
        Map&lt;String, Long&gt; result = new HashMap&lt;String, Long&gt;();
        result.put("count", entityManager.createQuery(criteriaQuery).getSingleResult());
        return result;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>@Path</code> annotation to map the new method to a sub-path of '/rest/&lt;entityRoot&gt;. Now all the JAX-RS endpoints that subclass <code>BaseEntityService</code> will be able to get entity counts from '/rest/&lt;entityRoot&gt;/count'. Just like <code>getAll</code>, this method also delegates to <code>extractPredicates</code>, so any customizations done there by subclasses</p>
</div>
<div class="paragraph">
<p>Next, we add a method for retrieving individual entities.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *     A method for retrieving individual entity instances.
     * &lt;/p&gt;
     * @param id entity id
     * @return
     */
    @GET
    @Path("/{id:[0-9][0-9]*}")
    @Produces(MediaType.APPLICATION_JSON)
    public T getSingleInstance(@PathParam("id") Long id) {
        final CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        final CriteriaQuery&lt;T&gt; criteriaQuery = criteriaBuilder.createQuery(entityClass);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        Predicate condition = criteriaBuilder.equal(root.get("id"), id);
        criteriaQuery.select(criteriaBuilder.createQuery(entityClass).getSelection()).where(condition);
        return entityManager.createQuery(criteriaQuery).getSingleResult();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is similar to <code>getAll</code> and <code>getCount</code>, and we use the <code>@Path</code> annotation to map it to a sub-path of '/rest/&lt;entityRoot&gt;'. The annotation attribute identifies the expected format of the URL (here, the last segment has to be a number) and binds a  portion of the URL to a variable (here named <code>id</code>). The <code>@PathParam</code> annotation allows the value of the variable to be passed as a method argument. Data conversion is performed automatically.</p>
</div>
<div class="paragraph">
<p>Now, all the JAX-RS endpoints that subclass <code>BaseEntityService</code> will get two operations for free:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>GET /rest/&lt;entityRoot&gt;</code></dt>
<dd>
<p>retrieves all entities of a given type</p>
</dd>
<dt class="hdlist1"><code>GET /rest/&lt;entityRoot&gt;/&lt;id&gt;</code></dt>
<dd>
<p>retrieves an entity with a given id</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_venues">Retrieving Venues</h3>
<div class="paragraph">
<p>Adding support for retrieving venues is now extremely simple. We refactor the class we created during the introduction, and make it extend <code>BaseEntityService</code>, passing the entity type to the superclass constructor. We remove the old retrieval code, which is not needed anymore.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/VenueService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Venue}s. Inherits the actual
 *     methods from {@link BaseEntityService}.
 * &lt;/p&gt;
 */
@Path("/venues")
/**
 * &lt;p&gt;
 *     This is a stateless service, so a single shared instance can be used in this case.
 * &lt;/p&gt;
 */
@Stateless
public class VenueService extends BaseEntityService&lt;Venue&gt; {

    public VenueService() {
        super(Venue.class);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add the <code>@Path</code> annotation to the class, to indicate that this is a JAX-RS resource which can serve URLs starting with <code>/rest/venues</code>.</p>
</div>
<div class="paragraph">
<p>We define this service (along with all the other JAX-RS services) as an EJB (see how simple is that in Java EE 6!) to benefit from automatic transaction enrollment. Since the service is fundamentally stateless, we take advantage of the new EJB 3.1 singleton feature.</p>
</div>
<div class="paragraph">
<p>Before we proceed, . Retrieving shows from URLs like <code>/rest/venues</code> or <code>/rest/venues/1</code> almost always results in invalid JSON responses.
The root cause is the presence of a bi-directional relationship in the <code>Venue</code> entity. A <code>Venue</code> contains a 1:M relationship with <code>Section</code> s that also links back to a <code>Venue</code>. JSON serialiers like Jackson (the one used in JBoss Enterprise Application Platform) need to be instructed on how to handle such cycles in object graphs, failing which the serializer will traverse between the entities in the cycle, resulting in an infinite loop (and often an <code>OutOfMemoryError</code> or a <code>StackOverflowError</code>). We&#8217;ll address this, by instructing Jackson to not serialize the <code>venue</code> field in a <code>Section</code>, through the <code>@JsonIgnoreProperties</code> annotation on the <code>Section</code> entity:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Section.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("venue")
public class Section implements Serializable {

...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can retrieve venues from URLs like <code>/rest/venues</code> or <code>rest/venues/1</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_events">Retrieving Events</h3>
<div class="paragraph">
<p>Just like <code>VenueService</code>, the <code>EventService</code> implementation we use for TicketMonster is a direct subclass of <code>BaseEntityService</code>. Refactor the existing class, remove the old retrieval code and make it extend <code>BaseEntityService</code>.</p>
</div>
<div class="paragraph">
<p>One additional functionality we will implement is querying events by category. We can use URLs like <code>/rest/events?category=1</code> to retrieve all concerts, for example (<code>1</code> is the category id of concerts). This is done by overriding the <code>extractPredicates</code> method to handle any query parameters (in this case, the <code>category</code> parameter).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/EventService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Event}s. Inherits the actual
 *     methods from {@link BaseEntityService}, but implements additional search
 *     criteria.
 * &lt;/p&gt;
 */
@Path("/events")
/**
 * &lt;p&gt;
 *     This is a stateless service, we declare it as an EJB for transaction demarcation
 * &lt;/p&gt;
 */
@Stateless
public class EventService extends BaseEntityService&lt;Event&gt; {

    public EventService() {
        super(Event.class);
    }

    /**
     * &lt;p&gt;
     *    We override the method from parent in order to add support for additional search
     *    criteria for events.
     * &lt;/p&gt;
     * @param queryParameters - the HTTP query parameters received by the endpoint
     * @param criteriaBuilder - @{link CriteriaBuilder} used by the invoker
     * @param root  @{link Root} used by the invoker
     * @return
     */
    @Override
    protected Predicate[] extractPredicates(
            MultivaluedMap&lt;String, String&gt; queryParameters,
            CriteriaBuilder criteriaBuilder,
            Root&lt;Event&gt; root) {
        List&lt;Predicate&gt; predicates = new ArrayList&lt;Predicate&gt;() ;

        if (queryParameters.containsKey("category")) {
            String category = queryParameters.getFirst("category");
            predicates.add(criteriaBuilder.equal(root.get("category").get("id"), category));
        }

        return predicates.toArray(new Predicate[]{});
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_shows">Retrieving Shows</h3>
<div class="paragraph">
<p>The <code>ShowService</code> follows the same pattern and we leave the implementation as an exercise to the reader (knowing that its contents can always be copied over to the appropriate folder).</p>
</div>
<div class="paragraph">
<p>Just like the <code>Venue</code> entity, a <code>Show</code> also contains bi-directional relationships that need to be handled as a special case for the JSON serializer. A <code>Show</code> contains a 1:M relationship with <code>Performance</code> s that also links back to a <code>Show</code>; a <code>Show</code> also contains a 1:M relationship with <code>TicketPrice</code> s that also links back to a <code>Show</code>. We&#8217;ll address this, by instructing Jackson to not serialize the <code>show</code> field in a <code>Performance</code>, through the <code>@JsonIgnoreProperties</code> annotation on the <code>Performance</code> entity:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Performance.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("show")
public class Performance implements Serializable {

...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, we&#8217;ll also instruct Jackson to not serialize the <code>Show</code> in a <code>TicketPrice</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketPrice.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("show")
public class TicketPrice implements Serializable {

...

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_and_deleting_bookings">Creating and deleting bookings</h3>
<div class="paragraph">
<p>Of course, we also want to change data with our services - we want to create and delete bookings as well!</p>
</div>
<div class="paragraph">
<p>To create a booking, we add a new method, which handles <code>POST</code> requests to <code>/rest/bookings</code>. This is not a simple CRUD method, as the client does not send a booking, but a booking request. It is the responsibility of the service to process the request, reserve the seats and return the full booking details to the invoker.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BookingService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Booking}s. Inherits the GET
 *     methods from {@link BaseEntityService}, and implements additional REST methods.
 * &lt;/p&gt;
 */
@Path("/bookings")
/**
 * &lt;p&gt;
 *     This is a stateless service, we declare it as an EJB for transaction demarcation
 * &lt;/p&gt;
 */
@Stateless
public class BookingService extends BaseEntityService&lt;Booking&gt; {

    @Inject
    SeatAllocationService seatAllocationService;

    @Inject @Created
    private Event&lt;Booking&gt; newBookingEvent;

    public BookingService() {
        super(Booking.class);
    }

   /**
     * &lt;p&gt;
     *   Create a booking. Data is contained in the bookingRequest object
     * &lt;/p&gt;
     * @param bookingRequest
     * @return
     */
    @SuppressWarnings("unchecked")
    @POST
    /**
     * &lt;p&gt; Data is received in JSON format. For easy handling, it will be unmarshalled in the support
     * {@link BookingRequest} class.
     */
    @Consumes(MediaType.APPLICATION_JSON)
    public Response createBooking(BookingRequest bookingRequest) {
        try {
            // identify the ticket price categories in this request
            Set&lt;Long&gt; priceCategoryIds = bookingRequest.getUniquePriceCategoryIds();

            // load the entities that make up this booking's relationships
            Performance performance = getEntityManager().find(Performance.class, bookingRequest.getPerformance());

            // As we can have a mix of ticket types in a booking, we need to load all of them that are relevant,
            // id
            Map&lt;Long, TicketPrice&gt; ticketPricesById = loadTicketPrices(priceCategoryIds);

            // Now, start to create the booking from the posted data
            // Set the simple stuff first!
            Booking booking = new Booking();
            booking.setContactEmail(bookingRequest.getEmail());
            booking.setPerformance(performance);
            booking.setCancellationCode("abc");

            // Now, we iterate over each ticket that was requested, and organize them by section and category
            // we want to allocate ticket requests that belong to the same section contiguously
            Map&lt;Section, Map&lt;TicketCategory, TicketRequest&gt;&gt; ticketRequestsPerSection
                    = new TreeMap&lt;Section, java.util.Map&lt;TicketCategory, TicketRequest&gt;&gt;(SectionComparator.instance());
            for (TicketRequest ticketRequest : bookingRequest.getTicketRequests()) {
                final TicketPrice ticketPrice = ticketPricesById.get(ticketRequest.getTicketPrice());
                if (!ticketRequestsPerSection.containsKey(ticketPrice.getSection())) {
                    ticketRequestsPerSection
                            .put(ticketPrice.getSection(), new HashMap&lt;TicketCategory, TicketRequest&gt;());
                }
                ticketRequestsPerSection.get(ticketPrice.getSection()).put(
                        ticketPricesById.get(ticketRequest.getTicketPrice()).getTicketCategory(), ticketRequest);
            }

            // Now, we can allocate the tickets
            // Iterate over the sections, finding the candidate seats for allocation
            // The process will acquire a write lock for a given section and performance
            // Use deterministic ordering of sections to prevent deadlocks
            Map&lt;Section, AllocatedSeats&gt; seatsPerSection =
			       new TreeMap&lt;Section, org.jboss.examples.ticketmonster.service.AllocatedSeats&gt;(SectionComparator.instance());
            List&lt;Section&gt; failedSections = new ArrayList&lt;Section&gt;();
            for (Section section : ticketRequestsPerSection.keySet()) {
                int totalTicketsRequestedPerSection = 0;
                // Compute the total number of tickets required (a ticket category doesn't impact the actual seat!)
                final Map&lt;TicketCategory, TicketRequest&gt; ticketRequestsByCategories = ticketRequestsPerSection.get(section);
                // calculate the total quantity of tickets to be allocated in this section
                for (TicketRequest ticketRequest : ticketRequestsByCategories.values()) {
                    totalTicketsRequestedPerSection += ticketRequest.getQuantity();
                }
                // try to allocate seats

                AllocatedSeats allocatedSeats =
				      seatAllocationService.allocateSeats(section, performance, totalTicketsRequestedPerSection, true);
                if (allocatedSeats.getSeats().size() == totalTicketsRequestedPerSection) {
                    seatsPerSection.put(section, allocatedSeats);
                } else {
                    failedSections.add(section);
                }
            }
            if (failedSections.isEmpty()) {
                for (Section section : seatsPerSection.keySet()) {
                    // allocation was successful, begin generating tickets
                    // associate each allocated seat with a ticket, assigning a price category to it
                    final Map&lt;TicketCategory, TicketRequest&gt; ticketRequestsByCategories = ticketRequestsPerSection.get(section);
                    AllocatedSeats allocatedSeats = seatsPerSection.get(section);
                    allocatedSeats.markOccupied();
                    int seatCounter = 0;
                    // Now, add a ticket for each requested ticket to the booking
                    for (TicketCategory ticketCategory : ticketRequestsByCategories.keySet()) {
                        final TicketRequest ticketRequest = ticketRequestsByCategories.get(ticketCategory);
                        final TicketPrice ticketPrice = ticketPricesById.get(ticketRequest.getTicketPrice());
                        for (int i = 0; i &lt; ticketRequest.getQuantity(); i++) {
                            Ticket ticket =
							      new Ticket(allocatedSeats.getSeats().get(seatCounter + i), ticketCategory, ticketPrice.getPrice());
                            // getEntityManager().persist(ticket);
                            booking.getTickets().add(ticket);
                        }
                        seatCounter += ticketRequest.getQuantity();
                    }
                }
                // Persist the booking, including cascaded relationships
                booking.setPerformance(performance);
                booking.setCancellationCode("abc");
                getEntityManager().persist(booking);
                newBookingEvent.fire(booking);
                return Response.ok().entity(booking).type(MediaType.APPLICATION_JSON_TYPE).build();
            } else {
                Map&lt;String, Object&gt; responseEntity = new HashMap&lt;String, Object&gt;();
                responseEntity.put("errors", Collections.singletonList("Cannot allocate the requested number of seats!"));
                return Response.status(Response.Status.BAD_REQUEST).entity(responseEntity).build();
            }
        } catch (ConstraintViolationException e) {
            // If validation of the data failed using Bean Validation, then send an error
            Map&lt;String, Object&gt; errors = new HashMap&lt;String, Object&gt;();
            List&lt;String&gt; errorMessages = new ArrayList&lt;String&gt;();
            for (ConstraintViolation&lt;?&gt; constraintViolation : e.getConstraintViolations()) {
                errorMessages.add(constraintViolation.getMessage());
            }
            errors.put("errors", errorMessages);
            // A WebApplicationException can wrap a response
            // Throwing the exception causes an automatic rollback
            throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).entity(errors).build());
        } catch (Exception e) {
            // Finally, handle unexpected exceptions
            Map&lt;String, Object&gt; errors = new HashMap&lt;String, Object&gt;();
            errors.put("errors", Collections.singletonList(e.getMessage()));
            // A WebApplicationException can wrap a response
            // Throwing the exception causes an automatic rollback
            throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).entity(errors).build());
        }
    }

    /**
     * Utility method for loading ticket prices
     * @param priceCategoryIds
     * @return
     */
    private Map&lt;Long, TicketPrice&gt; loadTicketPrices(Set&lt;Long&gt; priceCategoryIds) {
        List&lt;TicketPrice&gt; ticketPrices = (List&lt;TicketPrice&gt;) getEntityManager()
                .createQuery("select p from TicketPrice p where p.id in :ids")
                .setParameter("ids", priceCategoryIds).getResultList();
        // Now, map them by id
        Map&lt;Long, TicketPrice&gt; ticketPricesById = new HashMap&lt;Long, TicketPrice&gt;();
        for (TicketPrice ticketPrice : ticketPrices) {
            ticketPricesById.put(ticketPrice.getId(), ticketPrice);
        }
        return ticketPricesById;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should also copy over the <code>BookingRequest</code>, <code>TicketRequest</code> and <code>SectionComparator</code> classes referenced in these methods, from the project sources.</p>
</div>
<div class="paragraph">
<p>We won&#8217;t get into the details of the inner workings of the method - it implements a fairly complex algorithm - but we&#8217;d like to draw attention to a few particular items.</p>
</div>
<div class="paragraph">
<p>We use the <code>@POST</code> annotation to indicate that this method is executed on inbound HTTP POST requests. When implementing a set of RESTful services, it is important that the semantic of HTTP methods are observed in the mappings. Creating new resources (e.g. bookings) is typically associated with HTTP POST invocations. The <code>@Consumes</code> annotation indicates that the type of the request content is JSON and identifies the correct unmarshalling strategy, as well as content negotiation.</p>
</div>
<div class="paragraph">
<p>The <code>BookingService</code> delegates to the <code>SeatAllocationService</code> to find seats in the requested section, the required <code>SeatAllocationService</code> instance is initialized and supplied by the container as needed. The only thing that our service does is to specify the dependency in form
of an injection point - the field annotated with <code>@Inject</code>.</p>
</div>
<div class="paragraph">
<p>We would like other parts of the application to be aware of the fact that a new booking has been created, therefore we use the CDI to fire an event. We do so by injecting an <code>Event&lt;Booking&gt;</code> instance into the service (indicating that its payload will be a booking). In order to individually identify this event as referring to event creation, we use a CDI qualifier, which we need to add:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/util/qualifier/Created.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * {@link Qualifier} to mark a Booking as new (created).
 */
@Qualifier
@Target({ElementType.FIELD,ElementType.PARAMETER,ElementType.METHOD,ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Created {

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">What are qualifiers?</div>
<div class="paragraph">
<p>CDI uses a type-based resolution mechanism for injection and observers. In order to
distinguish between implementations of an interface, you can use qualifiers, a type
of annotations, to disambiguate. Injection points and event observers can use
qualifiers to narrow down the set of candidates</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also need allow the removal of bookings, so we add a method:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BookingService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Singleton
public class BookingService extends BaseEntityService&lt;Booking&gt; {
	...

    @Inject @Cancelled
    private Event&lt;Booking&gt; cancelledBookingEvent;
    ...
    /**
     * &lt;p&gt;
     * Delete a booking by id
     * &lt;/p&gt;
     * @param id
     * @return
     */
    @DELETE
    @Path("/{id:[0-9][0-9]*}")
    public Response deleteBooking(@PathParam("id") Long id) {
        Booking booking = getEntityManager().find(Booking.class, id);
        if (booking == null) {
            return Response.status(Response.Status.NOT_FOUND).build();
        }
        getEntityManager().remove(booking);
        cancelledBookingEvent.fire(booking);
        return Response.noContent().build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>@DELETE</code> annotation to indicate that it will be executed as the result of an HTTP DELETE request (again, the use of the DELETE HTTP verb is a matter of convention).</p>
</div>
<div class="paragraph">
<p>We need to notify the other components of the cancellation of the booking, so we fire an event, with a different qualifier.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/util/qualifier/Cancelled.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * {@link Qualifier} to mark a Booking as cancelled.
 */
@Qualifier
@Target({ElementType.FIELD,ElementType.PARAMETER,ElementType.METHOD,ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Cancelled {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other services, including the <code>MediaService</code> that handles media items follow roughly the same patterns as above, so we leave them as an exercise to the reader.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_services">Testing the services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve now finished implementing the services and there is a significant amount of functionality in the application. Before taking any step forward, you need to make sure the services work correctly: we need to test them.</p>
</div>
<div class="paragraph">
<p>Testing enterprise services be a complex task as the implementation is based on services provided by a container: dependency injection, access to infrastructure services such as persistence, transactions etc. Unit testing frameworks, whilst offering a valuable infrastructure for running tests, do not provide these capabilities.</p>
</div>
<div class="paragraph">
<p>One of the traditional approaches has been the use of mocking frameworks to simulate 'what will happen' in the runtime environment. While certainly providing a solution mocking brings its own set of problems (e.g.  the additional effort required to provide a proper simulation or the risk of introducing errors in the test suite by incorrectly implemented mocks.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">What to test?</div>
<div class="paragraph">
<p>A common asked question is: how much application functionality should we test? The
truth is, you can never test too much. That being said, resources are always limited
and tradeoffs are part of an engineer&#8217;s work. Generally speaking, trivial
functionality (setters/getters/toString methods) is a big concern compared to  the
actual business code, so you probably want to focus your efforts on the business
code. Testing should include individual parts (unit testing), as well as
aggregates (integration testing).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fortunately, Arquillian provides the means to testing your application code within the container, with access to all the services and container features. In this section we will show you how to create a few Arquillian tests for your business services.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">New to Arquillian?</div>
<div class="paragraph">
<p>The Arquillian project site contains several tutorials to help you get started.
If you&#8217;re new to Arquillian and Shrinkwrap, we recommend going through the
<a href="http://arquillian.org/guides/">beginner-level Arquillian guides</a>, at the very least.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_adding_shrinkwrap_resolvers">Adding ShrinkWrap Resolvers</h3>
<div class="paragraph">
<p>We&#8217;ll need to use an updated version of the ShrinkWrap Resolvers project, that is not provided by the existing <code>org.jboss.bom.eap:jboss-javaee-6.0-with-tools</code> BOM. Fortunately, the JBoss WFK project provides this for us. It provides us with the <code>shrinkwrap-resolver-depchain</code> module, which allows us to use ShrinkWrap resolvers in our project through a single dependency. We can bring in the required version of ShrinkWrap Resolvers, by merely using the <code>org.jboss.bom.wfk:jboss-javaee-6.0-with-tools</code> BOM instead of the pre-existing tools BOM from EAP:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...
	&lt;properties&gt;
		...
		&lt;version.jboss.bom.wfk&gt;2.7.0-redhat-1&lt;/version.jboss.bom.wfk&gt;
		...
	&lt;/properties&gt;


    &lt;dependencyManagement&gt;
        ...

        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.bom.wfk&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-javaee-6.0-with-resteasy&lt;/artifactId&gt;
            &lt;version&gt;${version.jboss.bom.wfk}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;

	...

    &lt;dependencies&gt;
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.shrinkwrap.resolver&lt;/groupId&gt;
            &lt;artifactId&gt;shrinkwrap-resolver-depchain&lt;/artifactId&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to remove the original Tools BOM with the <code>org.jboss.bom.eap</code> groupId.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_basic_deployment_class">A Basic Deployment Class</h3>
<div class="paragraph">
<p>In order to create Arquillian tests, we need to define the deployment. The code under test, as well as its dependencies is packaged and deployed in the container.</p>
</div>
<div class="paragraph">
<p>Much of the deployment contents is common for all tests, so we create a helper class with a method that creates the base deployment with all the general content.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/TicketMonsterDeployment.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class TicketMonsterDeployment {

    public static WebArchive deployment() {
        return ShrinkWrap
                .create(WebArchive.class, "test.war")
                .addPackage(Resources.class.getPackage())
                .addAsResource("META-INF/test-persistence.xml", "META-INF/persistence.xml")
                .addAsResource("import.sql")
                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml")
                // Deploy our test datasource
                .addAsWebInfResource("test-ds.xml");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to copy over the <code>test-persistence.xml</code> file into the <code>src/test/resources</code> directory of your project.</p>
</div>
<div class="paragraph">
<p>Arquillian uses Shrinkwrap to define the contents of the deployment. At runtime, when the test executes, Arquillian employs Shrinkwrap to create a WAR file that will be deployed to a running instance of JBoss Enterprise Application Platform. The WAR file would be composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all classes from the <code>org.jboss.examples.ticketmonster.util</code> package,</p>
</li>
<li>
<p>the test <code>persistence.xml</code> file that defines a JPA persistence unit against a test datasource,</p>
</li>
<li>
<p>the <code>import.sql</code> file,</p>
</li>
<li>
<p>an empty <code>beans.xml</code> file to activate CDI</p>
</li>
<li>
<p>and, a test data source definition.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We use a separate data source for our integration tests, and we recommend the same for real applications. This would allow you to run your tests against a pristine test environment, without having to clean your development, or worse, your production environment!</p>
</div>
</div>
<div class="sect2">
<h3 id="_writing_restful_service_tests">Writing RESTful service tests</h3>
<div class="paragraph">
<p>For testing our JAX-RS RESTful services, we need to add the corresponding application classes to the deployment. Since we need to do that for each test we create, we abide by the DRY principles and create a utility class.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/RESTDeployment.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class RESTDeployment {

    public static WebArchive deployment() {
        return TicketMonsterDeployment.deployment()
                .addPackage(Booking.class.getPackage())
                .addPackage(BaseEntityService.class.getPackage())
                .addPackage(MultivaluedHashMap.class.getPackage())
                .addPackage(SeatAllocationService.class.getPackage());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we create the first test to validate the proper retrieval of individual events.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/VenueServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RunWith(Arquillian.class)
public class VenueServiceTest {

    @Deployment
    public static WebArchive deployment() {
        return RESTDeployment.deployment();
    }

    @Inject
    private VenueService venueService;

    @Test
    public void testGetVenueById() {

        // Test loading a single venue
        Venue venue = venueService.getSingleInstance(1l);
        assertNotNull(venue);
        assertEquals("Roy Thomson Hall", venue.getName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the class above we specify the deployment, and we define the test method. The test supports CDI injection - one of the strengths of Arquillian is the ability to inject the object being tested.</p>
</div>
<div class="paragraph">
<p>Now, we test a more complicated use cases, query parameters for pagination.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/VenueServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@RunWith(Arquillian.class)
public class VenueServiceTest {

    ...

    @Test
    public void testPagination() {

        // Test pagination logic
        MultivaluedMap&lt;String, String&gt; queryParameters = new MultivaluedHashMap&lt;String, String&gt;();

        queryParameters.add("first", "2");
        queryParameters.add("maxResults", "1");

        List&lt;Venue&gt; venues = venueService.getAll(queryParameters);
        assertNotNull(venues);
        assertEquals(1, venues.size());
        assertEquals("Sydney Opera House", venues.get(0).getName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add another test method (<code>testPagination</code>), which tests the retrieval of all venues, passing the
search criteria as parameters. We use a Map to simulate the passing of query parameters.</p>
</div>
<div class="paragraph">
<p>Now, we test more advanced use cases such as the creation of a new booking. We do so by adding a new test for bookings</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/BookingServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RunWith(Arquillian.class)
public class BookingServiceTest {

    @Deployment
    public static WebArchive deployment() {
        return RESTDeployment.deployment();
    }

    @Inject
    private BookingService bookingService;

    @Inject
    private ShowService showService;

    @Test
    @InSequence(1)
    public void testCreateBookings() {
        BookingRequest br = createBookingRequest(1l, 0, new int[]{4, 1}, new int[]{1,1}, new int[]{3,1});
        bookingService.createBooking(br);

        BookingRequest br2 = createBookingRequest(2l, 1, new int[]{6,1}, new int[]{8,2}, new int[]{10,2});
        bookingService.createBooking(br2);

        BookingRequest br3 = createBookingRequest(3l, 0, new int[]{4,1}, new int[]{2,1});
        bookingService.createBooking(br3);
    }

    @Test
    @InSequence(10)
    public void testGetBookings() {
        checkBooking1();
        checkBooking2();
        checkBooking3();
    }

    private void checkBooking1() {
        Booking booking = bookingService.getSingleInstance(1l);
        assertNotNull(booking);
        assertEquals("Roy Thomson Hall", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        // Test the ticket requests created

        assertEquals(3 + 2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("A @ 219.5 (Adult)");
        requiredTickets.add("A @ 219.5 (Adult)");
        requiredTickets.add("D @ 149.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");

        checkTickets(requiredTickets, booking);
    }

    private void checkBooking2() {
        Booking booking = bookingService.getSingleInstance(2l);
        assertNotNull(booking);
        assertEquals("Sydney Opera House", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        assertEquals(3 + 2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("S2 @ 197.75 (Adult)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S4 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S4 @ 145.0 (Child 0-14yrs)");

        checkTickets(requiredTickets, booking);
    }

    private void checkBooking3() {
        Booking booking = bookingService.getSingleInstance(3l);
        assertNotNull(booking);
        assertEquals("Roy Thomson Hall", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Shane's Sock Puppets", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        assertEquals(2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("B @ 199.5 (Adult)");
        requiredTickets.add("D @ 149.5 (Adult)");
        requiredTickets.add("B @ 199.5 (Adult)");

        checkTickets(requiredTickets, booking);
    }

    @Test
    @InSequence(10)
    public void testPagination() {

        // Test pagination logic
        MultivaluedMap&lt;String, String&gt; queryParameters = new MultivaluedHashMap&lt;java.lang.String, java.lang.String&gt;();

        queryParameters.add("first", "2");
        queryParameters.add("maxResults", "1");

        List&lt;Booking&gt; bookings = bookingService.getAll(queryParameters);
        assertNotNull(bookings);
        assertEquals(1, bookings.size());
        assertEquals("Sydney Opera House", bookings.get(0).getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", bookings.get(0).getPerformance().getShow().getEvent().getName());
    }

    @Test
    @InSequence(20)
    public void testDelete() {
        bookingService.deleteBooking(2l);
        checkBooking1();
        checkBooking3();
        try {
            bookingService.getSingleInstance(2l);
        } catch (Exception e) {
            if (e.getCause() instanceof NoResultException) {
                return;
            }
        }
        fail("Expected NoResultException did not occur.");
    }

    private BookingRequest createBookingRequest(Long showId, int performanceNo, int[]... sectionAndCategories) {
        Show show = showService.getSingleInstance(showId);

        Performance performance = new ArrayList&lt;Performance&gt;(show.getPerformances()).get(performanceNo);

        BookingRequest bookingRequest = new BookingRequest(performance, "bob@acme.com");

        List&lt;TicketPrice&gt; possibleTicketPrices = new ArrayList&lt;TicketPrice&gt;(show.getTicketPrices());
        int i = 1;
        for (int[] sectionAndCategory : sectionAndCategories) {
            for (TicketPrice ticketPrice : possibleTicketPrices) {
                int sectionId = sectionAndCategory[0];
                int categoryId = sectionAndCategory[1];
                if(ticketPrice.getSection().getId() == sectionId &amp;&amp; ticketPrice.getTicketCategory().getId() == categoryId) {
                    bookingRequest.addTicketRequest(new TicketRequest(ticketPrice, i));
                    i++;
                    break;
                }
            }
        }

        return bookingRequest;
    }

    private void checkTickets(List&lt;String&gt; requiredTickets, Booking booking) {
        List&lt;String&gt; bookedTickets = new ArrayList&lt;String&gt;();
        for (Ticket t : booking.getTickets()) {
            bookedTickets.add(new StringBuilder().append(t.getSeat().getSection()).append(" @ ").append(t.getPrice()).append(" (").append(t.getTicketCategory()).append(")").toString());
        }
        System.out.println(bookedTickets);
        for (String requiredTicket : requiredTickets) {
            Assert.assertTrue("Required ticket not present: " + requiredTicket, bookedTickets.contains(requiredTicket));
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First we test booking creation in a test method of its own (<code>testCreateBookings</code>). Then, we test that the previously created bookings
are retrieved correctly (<code>testGetBookings</code> and <code>testPagination</code>). Finally, we test that deletion takes place correctly (<code>testDelete</code>).</p>
</div>
<div class="paragraph">
<p>The other tests in the application follow roughly the same pattern and are left as an exercise to the reader. You could in fact copy over the <code>EventServiceTest</code> and <code>ShowServiceTest</code> classes from the project sources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_tests">Running the tests</h3>
<div class="paragraph">
<p>If you have followed the instructions in the introduction and used the Maven archetype to generate the project structure, you should have two profiles already defined in your application.</p>
</div>
<div class="listingblock">
<div class="title">/pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

        ...
        &lt;profile&gt;
            &lt;!-- An optional Arquillian testing profile that executes tests
                in your JBoss AS instance --&gt;
            &lt;!-- This profile will start a new JBoss AS instance, and execute
                the test, shutting it down when done --&gt;
            &lt;!-- Run with: mvn clean test -Parq-jbossas-managed --&gt;
            &lt;id&gt;arq-jbossas-managed&lt;/id&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;
                    &lt;artifactId&gt;jboss-as-arquillian-container-managed&lt;/artifactId&gt;
                    &lt;scope&gt;test&lt;/scope&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/profile&gt;

        &lt;profile&gt;
            &lt;!-- An optional Arquillian testing profile that executes tests
                in a remote JBoss AS instance --&gt;
            &lt;!-- Run with: mvn clean test -Parq-jbossas-remote --&gt;
            &lt;id&gt;arq-jbossas-remote&lt;/id&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;
                    &lt;artifactId&gt;jboss-as-arquillian-container-remote&lt;/artifactId&gt;
                    &lt;scope&gt;test&lt;/scope&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/profile&gt;

    &lt;/profiles&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you haven&#8217;t used the archetype, or the profiles don&#8217;t exist, create them.</p>
</div>
<div class="paragraph">
<p>Each profile defines a different Arquillian container. In both cases the tests execute in an application server instance. In one case (<code>arq-jbossas-managed</code>) the server instance is started and stopped by the test suite, while in the other (<code>arq-jbossas-remote</code>), the test suite expects an already started server instance.</p>
</div>
<div class="paragraph">
<p>Once these profiles are defined, we can execute the tests in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>from the command-line build</p>
</li>
<li>
<p>from an IDE</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_executing_tests_from_the_command_line">Executing tests from the command line</h4>
<div class="paragraph">
<p>You can now execute the test suite from the command line by running the Maven build with the appropriate target and profile, as in one of the following examples.</p>
</div>
<div class="paragraph">
<p>After ensuring that the <code>JBOSS_HOME</code> environment variable is set to a valid JBoss EAP 6.2 installation directory), you can run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-managed</pre>
</div>
</div>
<div class="paragraph">
<p>Or, after starting a JBoss EAP 6.2 instance, you can run the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-remote</pre>
</div>
</div>
<div class="paragraph">
<p>These tests execute as part of the Maven build and can be easily included in an automated build and test harness.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_arquillian_tests_from_within_eclipse">Running Arquillian tests from within Eclipse</h4>
<div class="paragraph">
<p>Running the entire test suite as part of the build is an important part of the development process - you may want to make sure that everything is working fine before releasing a new milestone, or just before committing new code. However, running the entire test suite all the time
can be a productivity drain, especially when you&#8217;re trying to focus on a particular problem. Also, when debugging, you don&#8217;t want to leave the comfort of your IDE for running the tests.</p>
</div>
<div class="paragraph">
<p>Running Arquillian tests from JBoss Developer Studio or JBoss tools is very simple as Arquillian builds on JUnit (or TestNG).</p>
</div>
<div class="paragraph">
<p>First enable one of the two profiles in the project. In Eclipse, select the project, right-click on it to open the context menu, drill down into the <em>Maven</em> sub-menu:</p>
</div>
<div id="eclipse-select-maven-profiles" class="imageblock">
<div class="content">
<img src="gfx/eclipse-project-maven-profiles.png" alt="eclipse project maven profiles">
</div>
<div class="title">Figure 94. Select the Maven profiles for the project</div>
</div>
<div class="paragraph">
<p>Activate the profile as shown in the picture below.</p>
</div>
<div id="eclipse-update-profiles" class="imageblock">
<div class="content">
<img src="gfx/eclipse-maven-profile-update.png" alt="eclipse maven profile update">
</div>
<div class="title">Figure 95. Update Maven profiles in Eclipse</div>
</div>
<div class="paragraph">
<p>The project configuration will be updated automatically.</p>
</div>
<div class="paragraph">
<p>Now, you can click right on one of your test classes, and select <strong>Run As &#8594; JUnit Test</strong>.</p>
</div>
<div class="paragraph">
<p>The test suite will run, deploying the test classes to the application server, executing the tests and finally producing the much coveted green bar.</p>
</div>
<div id="eclipse-green-bar" class="imageblock">
<div class="content">
<img src="gfx/eclipse-green-bar.png" alt="eclipse green bar">
</div>
<div class="title">Figure 96. Running the tests</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="_building_the_user_ui_using_html5" class="sect0">Building The User UI Using HTML5</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_3">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve just implemented the business services of our application, and exposed them through RESTful endpoints. Now we need to implement a flexible user interface that can be easily used with both desktop and mobile clients. After reading this tutorial, you will understand our front-end design and the choices that we made in its implementation. Topics covered include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating single-page applications using HTML5, JavaScript and JSON</p>
</li>
<li>
<p>Using JavaScript frameworks for invoking RESTful endpoints and manipulating page content</p>
</li>
<li>
<p>Feature and device detection</p>
</li>
<li>
<p>Implementing a version of the user interface that is optimized for mobile clients using JavaScript frameworks such as jQuery mobile</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tutorial will show you how to perform all these steps in JBoss Developer Studio, including screenshots that guide you through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_the_basics">First, the basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we will build a single-page application. All the necessary code: HTML, CSS and JavaScript is retrieved within a single page load. Rather than refreshing the page every time the user changes a view, the content of the page will be redrawn by manipulating the DOM in JavaScript. The application uses REST calls to retrieve data from the server.</p>
</div>
<div id="single-page-app_image" class="imageblock">
<div class="content">
<img src="gfx/single-page-app.png" alt="single page app">
</div>
<div class="title">Figure 97. Single page application</div>
</div>
<div class="sect2">
<h3 id="_client_side_mvc_support">Client-side MVC Support</h3>
<div class="paragraph">
<p>Because this is a moderately complex example, which involves multiple views and different types of data, we will use a client-side MVC framework to structure the application, which provides amongst others:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing support within the single page application;</p>
</li>
<li>
<p>event-driven interaction between views and data;</p>
</li>
<li>
<p>simplified CRUD invocations on RESTful services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this application we use the client-side MVC framework "backbone.js".</p>
</div>
<div id="use-of-backbone_image" class="imageblock">
<div class="content">
<img src="gfx/backbone-usage.png" alt="backbone usage">
</div>
<div class="title">Figure 98. Backbone architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_modularity">Modularity</h3>
<div class="paragraph">
<p>In order to provide good separation of concerns, we split the JavaScript code into modules.  Ensuring that all the modules of the application are loaded properly at runtime becomes a complex task, as the application size increases. To conquer this complexity, we use the Asynchronous Module Definition mechanism as implemented by the "require.js" library.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Asynchronous Module Definition</div>
<div class="paragraph">
<p>The Asynchronous Module Definition (AMD) API specifies a mechanism for defining modules such that the module, and its dependencies, can be asynchronously loaded. This is particularly well suited for the browser where synchronous loading of modules incurs performance, usability, debugging, and cross-domain access problems.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_templating">Templating</h3>
<div class="paragraph">
<p>Instead of manipulating the DOM directly, and mixing up HTML with the JavaScript code, we create HTML markup fragments separately as templates which are applied when the application views are rendered.</p>
</div>
<div class="paragraph">
<p>In this application we use the templating support provided by "underscore.js".</p>
</div>
</div>
<div class="sect2">
<h3 id="_mobile_and_desktop_versions">Mobile and desktop versions</h3>
<div class="paragraph">
<p>The page flow and structure, as well as feature set, are slightly different for mobile and desktop, and therefore we will build two variants of the single-page-application, one for desktop and one for mobile. As the application variants are very similar, we will cover the desktop version of the application first, and then we will explain what is different in the mobile version.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_structure">Setting up the structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we start developing the user interface, we need to set up the general application structure and add the JavaScript libraries. First, we create the directory structure:</p>
</div>
<div id="ui-directory-structure" class="imageblock">
<div class="content">
<img src="gfx/ui-file-structure.png" alt="ui file structure">
</div>
<div class="title">Figure 99. File structure for our web application</div>
</div>
<div class="paragraph">
<p>We put stylesheets in <code>resources/css</code> folder, images in <code>resources/img</code>, and HTML view templates in <code>resources/templates</code>. <code>resources/js</code> contains the JavaScript code, split between <code>resources/js/libs</code> - which contains the libraries used by the application, <code>resources/js/app</code> - which contains the application code, and <code>resources/js/configurations</code> which contains module definitions for the different versions of the application - i.e. mobile and desktop. The <code>resources/js/app</code> folder will contain the application modules, in subsequent subdirectories, for models, collections, routers and views.</p>
</div>
<div class="paragraph">
<p>The first step in implementing our solution is adding the stylesheets and JavaScript libraries to the <code>resources/css</code> and <code>resources/js/libs</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">require.js</dt>
<dd>
<p>AMD support, along with the plugin:</p>
<div class="ulist">
<ul>
<li>
<p>text - for loading text files, in our case the HTML templates</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">jQuery</dt>
<dd>
<p>general purpose library for HTML traversal and manipulation</p>
</dd>
<dt class="hdlist1">Underscore</dt>
<dd>
<p>JavaScript utility library (and a dependency of Backbone)</p>
</dd>
<dt class="hdlist1">Backbone</dt>
<dd>
<p>Client-side MVC framework</p>
</dd>
<dt class="hdlist1">Bootstrap</dt>
<dd>
<p>UI components and stylesheets for page structuring</p>
</dd>
<dt class="hdlist1">Modernizr</dt>
<dd>
<p>JavaScript library for HTML5 and CSS3 feature detection</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can copy these libraries (with associated stylesheets) from the project sources. You can also copy the CSS stylesheet in <code>screen.css</code>, since we&#8217;ll include this stylesheet in the HTML. Addtionally, copy the images from the <code>src/main/webapp/resources/img</code> directory in the project sources to the equivalent one in your workspace.</p>
</div>
<div class="paragraph">
<p>Now, we create the main page of the application (which is the URL loaded by the browser):</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/index.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Ticket Monster&lt;/title&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/&gt;

    &lt;script type="text/javascript" src="resources/js/libs/modernizr-2.8.3.min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="resources/js/libs/require.js"
            data-main="resources/js/configurations/loader"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the page does not contain much. It loads Modernizr (for HTML5 and CSS3 feature detection) and RequireJS (for loading JavaScript modules in an asynchronous manner). Once RequireJS is loaded by the browser, it will configure itself to use a <code>baseUrl</code> of <code>resources/js/configurations</code> (specified via the <code>data-main</code> attribute on the <code>script</code> tag). All scripts loaded by RequireJS will use this <code>baseUrl</code> unless specified otherwise.</p>
</div>
<div class="paragraph">
<p>RequireJS will then load a script having a module ID of <code>loader</code> (again, specified via the <code>data-main</code> attribute):</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/loader.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">//detect the appropriate module to load
define(function () {

    /*
     A simple check on the client. For touch devices or small-resolution screens)
     show the mobile client. By enabling the mobile client on a small-resolution screen
     we allow for testing outside a mobile device (like for example the Mobile Browser
     simulator in JBoss Tools and JBoss Developer Studio).
     */

    var environment;

    if (Modernizr.touch || Modernizr.mq("only all and (max-width: 480px)")) {
        environment = "mobile"
    } else {
        environment = "desktop"
    }

    require([environment]);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script detects the current client (mobile or desktop) based on its capabilities (touch or not) and loads another JavaScript module (<code>desktop</code> or <code>mobile</code>) defined in the <code>resources/js/configurations</code> folder (aka the <code>baseUrl</code>) depending on the detected features. In the case of the desktop client, the code is loaded from <code>resources/js/configurations/desktop.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/desktop.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Shortcut alias definitions - will come in handy when declaring dependencies
 * Also, they allow you to keep the code free of any knowledge about library
 * locations and versions
 */
requirejs.config({
    baseUrl: "resources/js",
    paths: {
        jquery:'libs/jquery-2.0.3',
        underscore:'libs/underscore',
        text:'libs/text',
        bootstrap: 'libs/bootstrap',
        backbone: 'libs/backbone',
        utilities: 'app/utilities',
        router:'app/router/desktop/router'
    },
    // We shim Backbone.js and Underscore.js since they don't declare AMD modules
    shim: {
        'backbone': {
            deps: ['jquery', 'underscore'],
            exports: 'Backbone'
        },

        'underscore': {
            exports: '_'
        }
    }
});

define("initializer", ["jquery"],
    function ($) {
    // Configure jQuery to append timestamps to requests, to bypass browser caches
    // Important for MSIE
    $.ajaxSetup({cache:false});
    $('head').append('&lt;link rel="stylesheet" href="resources/css/bootstrap.css" type="text/css" media="all"/&gt;');
    $('head').append('&lt;link rel="stylesheet" href="resources/css/bootstrap-theme.css" type="text/css" media="all"/&gt;');
    $('head').append('&lt;link rel="stylesheet" href="resources/css/screen.css" type="text/css" media="all"/&gt;');
    $('head').append('&lt;link href="http://fonts.googleapis.com/css?family=Rokkitt" rel="stylesheet" type="text/css"&gt;');
});

// Now we load the dependencies
// This loads and runs the 'initializer' and 'router' modules.
require([
    'initializer',
    'router'
], function(){
});

define("configuration", {
    baseUrl : ""
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The module loads all the utility libraries, converting them to AMD modules where necessary (like it is the case for Backbone). It also defines two modules of its own - an initializer that loads the application stylesheets for the page, and the <code>configuration</code> module that allows customizing the REST service URLs (this will become in handy in a further tutorial).</p>
</div>
<div class="paragraph">
<p>We also define some utility JavaScript functions that are used in the rest of the front-end in a <code>utilities</code> module (also referenced in the <code>desktop</code> module above). For convenience, copy the <code>utilities.js</code> file from the <code>src/main/webapp/resources/js/app/</code> directory in the project sources.</p>
</div>
<div class="paragraph">
<p>Before we add any functionality, let us create a first landing page. We will begin by setting up a critical piece of the application, the router.</p>
</div>
<div class="sect2">
<h3 id="_routing">Routing</h3>
<div class="paragraph">
<p>The router allows for navigation in our application via bookmarkable URLs, and we will define it as follows:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
    'jquery',
    'underscore',
    'configuration',
    'utilities',
    'text!../templates/desktop/main.html'
],function ($,
            _,
            config,
            utilities,
            MainTemplate) {

    $(document).ready(new function() {
       utilities.applyTemplate($('body'), MainTemplate)
    })

    /**
     * The Router class contains all the routes within the application -
     * i.e. URLs and the actions that will be taken as a result.
     *
     * @type {Router}
     */

    var Router = Backbone.Router.extend({
        initialize: function() {
            //Begin dispatching routes
            Backbone.history.start();
        },
        routes:{
        }
    });

    // Create a router instance
    var router = new Router();

    return router;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember, this is a single page application. You can either navigate using urls such as <code><a href="http://localhost:8080/ticket-monster/index.html#events" class="bare">http://localhost:8080/ticket-monster/index.html#events</a></code> or using relative urls (from within the application, this being exactly what the main menu does). The fragment after the hash sign represents the url within the single page, on which the router will act, according to the mappings set up in the <code>routes</code> property.</p>
</div>
<div class="paragraph">
<p>During the router set up, we load the page template for the entire application. TicketMonster uses a templating library in order to separate application logic from it&#8217;s actual graphical content. The actual HTML is described in template files, which are applied by the application, when necessary, on a DOM element - effectively populating it&#8217;s content. So the general content of the page, as described in the <code>body</code> element is described in a template file too. Let us define it.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/main.html</div>
<div class="content">
<pre>&lt;!--
    The main layout of the page - contains the menu and the 'content' &amp;lt;div/&amp;gt; in which all the
    views will render the content.
--&gt;
&lt;div id="logo"&gt;&lt;div class="wrap"&gt;&lt;h1&gt;Ticket Monster&lt;/h1&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div id="container"&gt;
    &lt;div id="menu"&gt;
        &lt;div class="navbar"&gt;
            &lt;!-- Toggle get grouped for better mobile display --&gt;
            &lt;div class="navbar-header"&gt;
                &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-items"&gt;
                    &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
                    &lt;span class="icon-bar"&gt;&lt;/span&gt;
                    &lt;span class="icon-bar"&gt;&lt;/span&gt;
                    &lt;span class="icon-bar"&gt;&lt;/span&gt;
                &lt;/button&gt;
            &lt;/div&gt;

            &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;
            &lt;div id="navbar-items" class="collapse navbar-collapse"&gt;
                &lt;ul class="nav navbar-nav"&gt;
                    &lt;li&gt;&lt;a href="#about"&gt;About&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="#events"&gt;Events&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="#venues"&gt;Venues&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="#bookings"&gt;Bookings&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="#monitor"&gt;Monitor&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="admin"&gt;Administration&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div id="content" class="container"&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;footer style=""&gt;
    &lt;div style="text-align: center;"&gt;&lt;img src="resources/img/rhjb_eap_logo.png" alt="HTML5"/&gt;&lt;/div&gt;
&lt;/footer&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The actual HTML code of the template contains a menu definition which will be present on all the pages, as well as an empty element named <code>content</code>, which is the placeholder for the application views. When a view is displayed, it will apply a template and populate the <code>content</code> element.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_initial_views">Setting up the initial views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let us complete our application setup by creating an initial landing page. The first thing that we will need to do is to add a view component.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/js/app/views/desktop/home.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * The About view
 */
define([
    'utilities',
    'text!../../../../templates/desktop/home.html'
], function (utilities, HomeTemplate) {

    var HomeView = Backbone.View.extend({
        render:function () {
            utilities.applyTemplate($(this.el),HomeTemplate,{});
            return this;
        }
    });

    return HomeView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Functionally, this is a very basic component - it only renders the splash page of the application, but it helps us
introduce a new concept that will be heavily used throughout the application views. One main role of a view is to
describe the logic for manipulating the page content. It will do so by defining a function named <code>render</code> which
will be invoked by the application. In this very simple case, all that the view does is to create the content of the splash page.
You can proceed by copying the content of <code>src/main/webapp/resources/templates/desktop/home.html</code> to your project.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Backbone Views</div>
<div class="paragraph">
<p>Views are logical representations of user interface elements that can
interact with data components, such as models in an event-driven fashion.
Apart from defining the logical structure of your user interface, views handle
events resulting from the user interaction (e.g. clicking a DOM element or selecting
an element into a list), translating them into logical actions inside the
application.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we defined a view, we must tell the router to navigate to it whenever requested. We will add the following dependency and mapping to the router:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
    'jquery',
    'underscore',
    'configuration',
    'utilities',
    'app/views/desktop/home',
    'text!../templates/desktop/main.html'
],function ($,
            _,
            config,
            utilities,
            HomeView,
            MainTemplate) {

    ...
    var Router = Backbone.Router.extend({
        ...
        routes : {
            "":"home",
            "about":"home"
        },
        home : function () {
            utilities.viewManager.showView(new HomeView({el:$("#content")}));
        }
    });
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have just told the router to invoke the <code>home</code> function whenever the user navigates to the root of the application or
uses a <code>#about</code> hash. The method will simply cause the <code>HomeView</code> defined above to render.</p>
</div>
<div class="paragraph">
<p>Now you can navigate to <code><a href="http://localhost:8080/ticket-monster/#about" class="bare">http://localhost:8080/ticket-monster/#about</a></code> or <code><a href="http://localhost:8080/ticket-monster" class="bare">http://localhost:8080/ticket-monster</a></code> and see the results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_displaying_events">Displaying Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first use case that we implement is event navigation. The users will be able to view the list of events and select the one that they want to attend. After doing so, they will select a venue, and will be able to choose a performance date and time.</p>
</div>
<div class="sect2">
<h3 id="_the_event_model">The Event model</h3>
<div class="paragraph">
<p>We define a Backbone model for holding event data. Nearly all domain entities (booking, event, venue) are represented by a corresponding Backbone model:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/models/event.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Module for the Event model
 */
define([
    'configuration',
    'backbone'
], function (config) {
    /**
     * The Event model class definition
     * Used for CRUD operations against individual events
     */
    var Event = Backbone.Model.extend({
        urlRoot: config.baseUrl + 'rest/events' // the URL for performing CRUD operations
    });
    // export the Event class
    return Event;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Event</code> model can perform CRUD operations against the REST services we defined earlier.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Backbone Models</div>
<div class="paragraph">
<p>Backbone models contain data as well as much of the logic surrounding
it: conversions, validations, computed properties, and access control.
They also perform CRUD operations with the REST service.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_events_collection">The Events collection</h3>
<div class="paragraph">
<p>We define a Backbone collection for handling groups of events (like the events list):</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/collections/events.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Module for the Events collection
 */
define([
    // The collection element type and configuration are dependencies
    'app/models/event',
    'configuration'
], function (Event, config) {
    /**
     *  Here we define the Bookings collection
     *  We will use it for CRUD operations on Bookings
     */
    var Events = Backbone.Collection.extend({
        url: config.baseUrl + "rest/events", // the URL for performing CRUD operations
        model: Event,
        id:"id", // the 'id' property of the model is the identifier
        comparator:function (model) {
            return model.get('category').id;
        }
    });
    return Events;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>By mapping the model and collection to a REST endpoint you can perform CRUD operations without having to invoke the services explicitly. You will see how that works a bit later.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Backbone Collections</div>
<div class="paragraph">
<p>Collections are ordered sets of models. They can handle events which are
fired as a result of a change to a individual member, and can perform
CRUD operations for syncing up contents against RESTful services.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_eventsview_view">The EventsView view</h3>
<div class="paragraph">
<p>Now that we have implemented the data components of the example, we need to create the view that displays them.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/events.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'bootstrap',
    'text!../../../../templates/desktop/events.html'
], function (
    utilities,
    bootstrap,
    eventsTemplate) {

    var EventsView = Backbone.View.extend({
        events:{
            "click a":"update"
        },
        render:function () {
            var categories = _.uniq(
                _.map(this.model.models, function(model){
                    return model.get('category')
                }), false, function(item){
                    return item.id
                });
            utilities.applyTemplate($(this.el), eventsTemplate, {categories:categories, model:this.model})
            $(this.el).find('.item:first').addClass('active');
            $(".carousel").carousel();
            $("a[rel='popover']").popover({trigger:'hover',container:'body'});
            return this;
        },
        update:function () {
            $("a[rel='popover']").popover('hide')
        }
    });

    return  EventsView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we explained, earlier, the view is attached to a DOM element (the <code>el</code> property). When the <code>render</code> method is invoked, it manipulates the DOM and renders the view. We could have achieved this by writing these instructions directly in the method, but that would make it hard to change the page design later on. Instead, we create a template and apply it, thus separating the HTML view code from the view implementation. Note the dependency on the Bootstrap module - we initialize the Bootstrap carousel and popover components when this view is rendered.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/events.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="row"&gt;
    &lt;div class="col-md-3 col-md-offset-1"&gt;
        &lt;div class="panel" id="itemMenu"&gt;

            &lt;%
            _.each(categories, function (category) {
            %&gt;
            &lt;div class="panel panel-default"&gt;
                &lt;div class="panel-heading"&gt;
                    &lt;a class="panel-toggle"
                       data-target="#category-&lt;%=category.id%&gt;-collapsible" data-toggle="collapse"
                       data-parent="#itemMenu"&gt;&lt;%= category.description %&gt;&lt;/a&gt;
                &lt;/div&gt;
                &lt;div id="category-&lt;%=category.id%&gt;-collapsible" class="panel-collapse collapse"&gt;
                    &lt;div id="category-&lt;%- category.id%&gt;" class="panel-body"&gt;

                        &lt;%
                        _.each(model.models, function (model) {
                        if (model.get('category').id == category.id) {
                        %&gt;
                        &lt;p&gt;&lt;a href="#events/&lt;%- model.attributes.id%&gt;" rel="popover"
                              data-content="&lt;%- model.attributes.description%&gt;"
                              data-original-title="&lt;%- model.attributes.name%&gt;"&gt;&lt;%=model.attributes.name%&gt;&lt;/a&gt;&lt;/p&gt;
                        &lt;% }
                        });
                        %&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;% }); %&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div id='itemSummary' class="col-md-8 hidden-sm hidden-xs"&gt;
        &lt;div class="carousel-container"&gt;
            &lt;div id="eventCarousel" class="carousel slide"&gt;
                &lt;!-- Carousel items --&gt;
                &lt;div class="carousel-inner"&gt;
                    &lt;%_.each(model.models, function(model) {
                        if( model.get('mediaItem')) {
                    %&gt;
                    &lt;div class="item"&gt;
                        &lt;img src='rest/media/&lt;%=model.attributes.mediaItem.id%&gt;'/&gt;

                        &lt;div class="carousel-caption"&gt;
                            &lt;div class="row"&gt;
                                &lt;div class="col-md-9"&gt;
                                    &lt;h4&gt;&lt;%=model.attributes.name%&gt;&lt;/h4&gt;
                                    &lt;p&gt;&lt;%=model.attributes.description%&gt;&lt;/p&gt;
                                &lt;/div&gt;
                                &lt;div class="col-md-2"&gt;
                                    &lt;a class="btn btn-danger action" href="#events/&lt;%=model.id%&gt;"&gt;Book tickets&lt;/a&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                    &lt;%
                        }
                     });
                    %&gt;
                &lt;/div&gt;
                &lt;!-- Carousel nav --&gt;
                &lt;a class="carousel-control left" href="#eventCarousel" data-slide="prev"&gt;
                    &lt;span class="glyphicon glyphicon-chevron-left"&gt;&lt;/span&gt;
                &lt;/a&gt;
                &lt;a class="carousel-control right" href="#eventCarousel" data-slide="next"&gt;
                    &lt;span class="glyphicon glyphicon-chevron-right"&gt;&lt;/span&gt;
                &lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as applying the template and preparing the data that will be used to fill it in (the <code>categories</code> and <code>model</code> entries in the map), the <code>render</code> method also performs the JavaScript calls that are required to initialize the UI components (in this case the Bootstrap carousel and popover).</p>
</div>
<div class="paragraph">
<p>A view can also listen to events fired by the children of it&#8217;s root element (<code>el</code>). In this case, the <code>update</code> method is configured to listen to clicks on anchors. The configuration occurs within the <code>events</code> property of the class.</p>
</div>
<div class="paragraph">
<p>Now that the views are in place, we need to add another routing rule to the application.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
    ...
    'utilities',
    'app/collections/events',
    'app/views/desktop/home',
    'app/views/desktop/events',
    ...
    'text!../templates/desktop/main.html'
],function ($,
            ...
            utilities,
            Events,
            HomeView,
            EventsView,
            ...
            MainTemplate) {

    var Router = Backbone.Router.extend({
        ...
        routes : {
            ...,
            "events":"events"
        },
        ...,
        events:function () {
            var events = new Events();
            var eventsView = new EventsView({model:events, el:$("#content")});
            events.on("reset",
                function () {
                    utilities.viewManager.showView(eventsView);
                }).fetch({
                    reset : true,
                    error : function() {
                        utilities.displayAlert("Failed to retrieve events from the TicketMonster server.");
                    }
                });
        }
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>events</code> function handles the <code>#events</code> fragment and will retrieve the events in our application via a REST call. We don&#8217;t manually perform the REST call as it is triggered the by invocation of <code>fetch</code> on the <code>Events</code> collection, as discussed earlier.</p>
</div>
<div class="paragraph">
<p>The <code>reset</code> event on the collection is invoked when the data from the server is received, and the collection is populated. This triggers the rendering of the events view (which is bound to the <code>#content</code> div).</p>
</div>
<div class="paragraph">
<p>The whole process is event orientated - the models, views and controllers interact through events.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_viewing_a_single_event">Viewing a single event</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the events list view now in place, we can add a view to display the details of each individual event, allowing the user to select a venue and performance time.</p>
</div>
<div class="paragraph">
<p>We already have the models in place so all we need to do is to create the additional view and expand the router. First, we&#8217;ll implement the view:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/event-detail.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'require',
    'text!../../../../templates/desktop/event-detail.html',
    'text!../../../../templates/desktop/media.html',
    'text!../../../../templates/desktop/event-venue-description.html',
    'configuration',
    'bootstrap'
], function (
    utilities,
    require,
    eventDetailTemplate,
    mediaTemplate,
    eventVenueDescriptionTemplate,
    config,
    Bootstrap) {

    var EventDetail = Backbone.View.extend({

        events:{
            "click input[name='bookButton']":"beginBooking",
            "change select[id='venueSelector']":"refreshShows",
            "change select[id='dayPicker']":"refreshTimes"
        },

        render:function () {
            $(this.el).empty()
            utilities.applyTemplate($(this.el), eventDetailTemplate, this.model.attributes);
            $("#bookingOption").hide();
            $("#venueSelector").attr('disabled', true);
            $("#dayPicker").empty();
            $("#dayPicker").attr('disabled', true)
            $("#performanceTimes").empty();
            $("#performanceTimes").attr('disabled', true)
            var self = this
            $.getJSON(config.baseUrl + "rest/shows?event=" + this.model.get('id'), function (shows) {
                self.shows = shows
                $("#venueSelector").empty().append("&lt;option value='0' selected&gt;Select a venue&lt;/option&gt;");
                $.each(shows, function (i, show) {
                    $("#venueSelector").append("&lt;option value='" + show.id + "'&gt;" + show.venue.address.city + " : " + show.venue.name + "&lt;/option&gt;")
                });
                $("#venueSelector").removeAttr('disabled')
            })
            return this;
        },
        beginBooking:function () {
            require("router").navigate('/book/' + $("#venueSelector option:selected").val() + '/' + $("#performanceTimes").val(), true)
        },
        refreshShows:function (event) {
            event.stopPropagation();
            $("#dayPicker").empty();

            var selectedShowId = event.currentTarget.value;

            if (selectedShowId != 0) {
                var selectedShow = _.find(this.shows, function (show) {
                    return show.id == selectedShowId
                });
                this.selectedShow = selectedShow;
                utilities.applyTemplate($("#eventVenueDescription"), eventVenueDescriptionTemplate, {venue:selectedShow.venue});
                var times = _.uniq(_.sortBy(_.map(selectedShow.performances, function (performance) {
                    return (new Date(performance.date).withoutTimeOfDay()).getTime()
                }), function (item) {
                    return item
                }));
                utilities.applyTemplate($("#venueMedia"), mediaTemplate, selectedShow.venue)
                $("#dayPicker").removeAttr('disabled')
                $("#performanceTimes").removeAttr('disabled')
                _.each(times, function (time) {
                    var date = new Date(time)
                    $("#dayPicker").append("&lt;option value='" + date.toYMD() + "'&gt;" + date.toPrettyStringWithoutTime() + "&lt;/option&gt;")
                });
                this.refreshTimes()
                $("#bookingWhen").show(100)
            } else {
                $("#bookingWhen").hide(100)
                $("#bookingOption").hide()
                $("#dayPicker").empty()
                $("#venueMedia").empty()
                $("#eventVenueDescription").empty()
                $("#dayPicker").attr('disabled', true)
                $("#performanceTimes").empty()
                $("#performanceTimes").attr('disabled', true)
            }

        },
        refreshTimes:function () {
            var selectedDate = $("#dayPicker").val();
            $("#performanceTimes").empty()
            if (selectedDate) {
                $.each(this.selectedShow.performances, function (i, performance) {
                    var performanceDate = new Date(performance.date);
                    if (_.isEqual(performanceDate.toYMD(), selectedDate)) {
                        $("#performanceTimes").append("&lt;option value='" + performance.id + "'&gt;" + performanceDate.getHours().toZeroPaddedString(2) + ":" + performanceDate.getMinutes().toZeroPaddedString(2) + "&lt;/option&gt;")
                    }
                })
            }
            $("#bookingOption").show()
        }

    });

    return  EventDetail;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This view is more complex than the global events view, as portions of the page need to be updated when the user chooses a venue.</p>
</div>
<div id="ui-event-detail" class="imageblock">
<div class="content">
<img src="gfx/ui-event-details.png" alt="ui event details">
</div>
<div class="title">Figure 100. On the event details page some fragments are re-rendered when the user selects a venue</div>
</div>
<div class="paragraph">
<p>The view responds to three different events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>changing the current venue triggers a reload of the venue details and the venue image, as well as the performance times. The application retrieves the performance times through a REST call.</p>
</li>
<li>
<p>changing the day of the performance causes the performance time selector to reload.</p>
</li>
<li>
<p>once the venue and performance date and time have been selected, the user can navigate to the booking page.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The corresponding templates for the three fragments rendered above are:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/event-detail.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="row"&gt;
    &lt;h2 class="page-header special-title light-font"&gt;&lt;%=name%&gt;&lt;/h2&gt;
&lt;/div&gt;
&lt;div class="row"&gt;
    &lt;div class="col-md-4"&gt;
        &lt;div class="well"&gt;
            &lt;div class="row"&gt;
                &lt;h3 class="page-header col-md-6"&gt;What?&lt;/h3&gt;
                &lt;% if(mediaItem) { %&gt;&lt;img width="100" src='rest/media/&lt;%=mediaItem.id%&gt;'/&gt;&lt;% } %&gt;
            &lt;/div&gt;
            &lt;div class="row top5"&gt;
                &lt;div class="col-md-12"&gt;&lt;%= description %&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-4"&gt;
        &lt;div class="well"&gt;
            &lt;div class="row"&gt;
                &lt;h3 class="page-header col-md-6"&gt;Where?&lt;/h3&gt;
                &lt;div class="col-md-6" id='venueMedia'/&gt;
            &lt;/div&gt;
            &lt;div class="row top5"&gt;
                &lt;div class="col-md-12"&gt;
                    &lt;select id="venueSelector" class="form-control"/&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row top5"&gt;
                &lt;div class="col-md-12"&gt;
                    &lt;div id="eventVenueDescription"/&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div id='bookingWhen' style="display: none;" class="col-md-4"&gt;
        &lt;div class="well"&gt;
            &lt;div class="row"&gt;
                &lt;h3 class="page-header col-md-6"&gt;When?&lt;/h3&gt;
            &lt;/div&gt;

            &lt;div class="row top5"&gt;
                &lt;div class="col-md-12"&gt;
                    &lt;select class="form-control" id="dayPicker"/&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="row top5"&gt;
                &lt;div class="col-md-12"&gt;
                    &lt;select class="form-control" id="performanceTimes"/&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;div id="bookingOption" class="row top5"&gt;
                &lt;div class="col-md-6"&gt;
                    &lt;input name="bookButton" class="btn btn-primary" type="button" value="Order tickets"&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/event-venue-description.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;address&gt;
    &lt;p&gt;&lt;%= venue.description %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Address:&lt;/strong&gt;&lt;/p&gt;
    &lt;p&gt;&lt;%= venue.address.street %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;%= venue.address.city %&gt;, &lt;%= venue.address.country %&gt;&lt;/p&gt;
&lt;/address&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/media.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;%if (mediaItem) { %&gt;&lt;img width="100" src='rest/media/&lt;%=mediaItem.id%&gt;'/&gt;&lt;% } %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the view exists, we add it to the router:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
    ...
    'app/models/event',
	...,
    'app/views/desktop/event-detail',
    ...
],function (
			...
            Event,
            ...
            EventDetailView,
            ...) {

    var Router = Backbone.Router.extend({
        ...
        routes:{
            ...
            "events/:id":"eventDetail",
        },
        ...
        eventDetail:function (id) {
            var model = new Event({id:id});
            var eventDetailView = new EventDetailView({model:model, el:$("#content")});
            model.on("change",
                function () {
                    utilities.viewManager.showView(eventDetailView);
                }).fetch({
                    error : function() {
                        utilities.displayAlert("Failed to retrieve the event from the TicketMonster server.");
                    }
                });
        }
    }
    ...
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, this is very similar to the previous view and route, except that now the application can accept parameterized URLs (e.g. <code><a href="http://localhost:8080/ticket-monster/index#events/1" class="bare">http://localhost:8080/ticket-monster/index#events/1</a></code>). This URL can be entered directly into the browser, or it can be navigated to as a relative path (e.g. <code>#events/1</code>) from within the applicaton.</p>
</div>
<div class="paragraph">
<p>With this in place, all that remains is to implement the final view of this use case, creating the bookings.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_bookings">Creating Bookings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The user has chosen the event, the venue and the performance time, and must now create the booking. Users can select one of the available sections for the show&#8217;s venue, and then enter the number of tickets required for each category available for this show (Adult, Child, etc.). They then add the tickets to the current order, which causes the summary view to be updated. Users can also remove tickets from the order. When the order is complete, they enter their contact information (e-mail address) and submit the order to the server.</p>
</div>
<div class="paragraph">
<p>First, we add the new view:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/create-booking.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'require',
    'configuration',
    'text!../../../../templates/desktop/booking-confirmation.html',
    'text!../../../../templates/desktop/create-booking.html',
    'text!../../../../templates/desktop/ticket-categories.html',
    'text!../../../../templates/desktop/ticket-summary-view.html',
    'bootstrap'
],function (
    utilities,
    require,
    config,
    bookingConfirmationTemplate,
    createBookingTemplate,
    ticketEntriesTemplate,
    ticketSummaryViewTemplate){


    var TicketCategoriesView = Backbone.View.extend({
        id:'categoriesView',
        intervalDuration : 100,
        formValues : [],
        events:{
            "change input":"onChange"
        },
        render:function () {
            if (this.model != null) {
                var ticketPrices = _.map(this.model, function (item) {
                    return item.ticketPrice;
                });
                utilities.applyTemplate($(this.el), ticketEntriesTemplate, {ticketPrices:ticketPrices});
            } else {
                $(this.el).empty();
            }
            this.watchForm();
            return this;
        },
        onChange:function (event) {
            var value = event.currentTarget.value;
            var ticketPriceId = $(event.currentTarget).data("tm-id");
            var modifiedModelEntry = _.find(this.model, function (item) {
                return item.ticketPrice.id == ticketPriceId
            });
            // update model
            if ($.isNumeric(value) &amp;&amp; value &gt; 0) {
                modifiedModelEntry.quantity = parseInt(value);
            }
            else {
                delete modifiedModelEntry.quantity;
            }
            // display error messages
            if (value.length &gt; 0 &amp;&amp;
                   (!$.isNumeric(value)  // is a non-number, other than empty string
                        || value &lt;= 0 // is negative
                        || parseFloat(value) != parseInt(value))) { // is not an integer
                $("#error-input-"+ticketPriceId).empty().append("Please enter a positive integer value");
                $("#ticket-category-fieldset-"+ticketPriceId).addClass("error");
            } else {
                $("#error-input-"+ticketPriceId).empty();
                $("#ticket-category-fieldset-"+ticketPriceId).removeClass("error");
            }
            // are there any outstanding errors after this update?
            // if yes, disable the input button
            if (
               $("div[id^='ticket-category-fieldset-']").hasClass("error") ||
                   _.isUndefined(modifiedModelEntry.quantity) ) {
              $("input[name='add']").attr("disabled", true)
            } else {
              $("input[name='add']").removeAttr("disabled")
            }
        },
        watchForm: function() {
            if($("#sectionSelectorPlaceholder").length) {
                var self = this;
                $("input[name*='tickets']").each( function(index,element) {
                    if(element.value !== self.formValues[element.name]) {
                        self.formValues[element.name] = element.value;
                        $("input[name='"+element.name+"']").change();
                    }
                });
                this.timerObject = setTimeout(function() {
                    self.watchForm();
                }, this.intervalDuration);
            } else {
                this.onClose();
            }
        },
        onClose: function() {
            if(this.timerObject) {
                clearTimeout(this.timerObject);
                delete this.timerObject;
            }
        }
    });

    var TicketSummaryView = Backbone.View.extend({
        tagName:'tr',
        events:{
            "click i":"removeEntry"
        },
        render:function () {
            var self = this;
            utilities.applyTemplate($(this.el), ticketSummaryViewTemplate, this.model.bookingRequest);
        },
        removeEntry:function () {
            this.model.bookingRequest.tickets.splice(this.model.index, 1);
        }
    });

    var CreateBookingView = Backbone.View.extend({

        intervalDuration : 100,
        formValues : [],
        events:{
            "click input[name='submit']":"save",
            "change select[id='sectionSelect']":"refreshPrices",
            "keyup #email":"updateEmail",
            "change #email":"updateEmail",
            "click input[name='add']":"addQuantities",
            "click i":"updateQuantities"
        },
        render:function () {

            var self = this;
            $.getJSON(config.baseUrl + "rest/shows/" + this.model.showId, function (selectedShow) {

                self.currentPerformance = _.find(selectedShow.performances, function (item) {
                    return item.id == self.model.performanceId;
                });

                var id = function (item) {return item.id;};
                // prepare a list of sections to populate the dropdown
                var sections = _.uniq(_.sortBy(_.pluck(selectedShow.ticketPrices, 'section'), id), true, id);
                utilities.applyTemplate($(self.el), createBookingTemplate, {
                    sections:sections,
                    show:selectedShow,
                    performance:self.currentPerformance});
                self.ticketCategoriesView = new TicketCategoriesView({model:{}, el:$("#ticketCategoriesViewPlaceholder") });
                self.ticketSummaryView = new TicketSummaryView({model:self.model, el:$("#ticketSummaryView")});
                self.show = selectedShow;
                self.ticketCategoriesView.render();
                self.ticketSummaryView.render();
                $("#sectionSelector").change();
                self.watchForm();
            });
            return this;
        },
        refreshPrices:function (event) {
            var ticketPrices = _.filter(this.show.ticketPrices, function (item) {
                return item.section.id == event.currentTarget.value;
            });
            var sortedTicketPrices = _.sortBy(ticketPrices, function(ticketPrice) {
                return ticketPrice.ticketCategory.description;
            });
            var ticketPriceInputs = new Array();
            _.each(sortedTicketPrices, function (ticketPrice) {
                ticketPriceInputs.push({ticketPrice:ticketPrice});
            });
            this.ticketCategoriesView.model = ticketPriceInputs;
            this.ticketCategoriesView.render();
        },
        save:function (event) {
            var bookingRequest = {ticketRequests:[]};
            var self = this;
            bookingRequest.ticketRequests = _.map(this.model.bookingRequest.tickets, function (ticket) {
                return {ticketPrice:ticket.ticketPrice.id, quantity:ticket.quantity}
            });
            bookingRequest.email = this.model.bookingRequest.email;
            bookingRequest.performance = this.model.performanceId
            $("input[name='submit']").attr("disabled", true)
            $.ajax({url: (config.baseUrl + "rest/bookings"),
                data:JSON.stringify(bookingRequest),
                type:"POST",
                dataType:"json",
                contentType:"application/json",
                success:function (booking) {
                    this.model = {}
                    $.getJSON(config.baseUrl +'rest/shows/performance/' + booking.performance.id, function (retrievedPerformance) {
                        utilities.applyTemplate($(self.el), bookingConfirmationTemplate, {booking:booking, performance:retrievedPerformance })
                    });
                }}).error(function (error) {
                    if (error.status == 400 || error.status == 409) {
                        var errors = $.parseJSON(error.responseText).errors;
                        _.each(errors, function (errorMessage) {
                            $("#request-summary").append('&lt;div class="alert alert-error"&gt;&lt;a class="close" data-dismiss="alert"&gt;&lt;/a&gt;&lt;strong&gt;Error!&lt;/strong&gt; ' + errorMessage + '&lt;/div&gt;')
                        });
                    } else {
                        $("#request-summary").append('&lt;div class="alert alert-error"&gt;&lt;a class="close" data-dismiss="alert"&gt;&lt;/a&gt;&lt;strong&gt;Error! &lt;/strong&gt;An error has occured&lt;/div&gt;')
                    }
                    $("input[name='submit']").removeAttr("disabled");
                })

        },
        addQuantities:function () {
            var self = this;
            _.each(this.ticketCategoriesView.model, function (model) {
                if (model.quantity != undefined) {
                    var found = false;
                    _.each(self.model.bookingRequest.tickets, function (ticket) {
                        if (ticket.ticketPrice.id == model.ticketPrice.id) {
                            ticket.quantity += model.quantity;
                            found = true;
                        }
                    });
                    if (!found) {
                        self.model.bookingRequest.tickets.push({ticketPrice:model.ticketPrice, quantity:model.quantity});
                    }
                }
            });
            this.ticketCategoriesView.model = null;
            $('option:selected', 'select').removeAttr('selected');
            this.ticketCategoriesView.render();
            this.updateQuantities();
        },
        updateQuantities:function () {
            // make sure that tickets are sorted by section and ticket category
            this.model.bookingRequest.tickets.sort(function (t1, t2) {
                if (t1.ticketPrice.section.id != t2.ticketPrice.section.id) {
                    return t1.ticketPrice.section.id - t2.ticketPrice.section.id;
                }
                else {
                    return t1.ticketPrice.ticketCategory.id - t2.ticketPrice.ticketCategory.id;
                }
            });

            this.model.bookingRequest.totals = _.reduce(this.model.bookingRequest.tickets, function (totals, ticketRequest) {
                return {
                    tickets:totals.tickets + ticketRequest.quantity,
                    price:totals.price + ticketRequest.quantity * ticketRequest.ticketPrice.price
                };
            }, {tickets:0, price:0.0});

            this.ticketSummaryView.render();
            this.setCheckoutStatus();
        },
        updateEmail:function (event) {
            if ($(event.currentTarget).is(':valid')) {
                this.model.bookingRequest.email = event.currentTarget.value;
                $("#error-email").empty();
            } else {
                $("#error-email").empty().append("Please enter a valid e-mail address");
                delete this.model.bookingRequest.email;
            }
            this.setCheckoutStatus();
        },
        setCheckoutStatus:function () {
            if (this.model.bookingRequest.totals != undefined &amp;&amp; this.model.bookingRequest.totals.tickets &gt; 0 &amp;&amp; this.model.bookingRequest.email != undefined &amp;&amp; this.model.bookingRequest.email != '') {
                $('input[name="submit"]').removeAttr('disabled');
            }
            else {
                $('input[name="submit"]').attr('disabled', true);
            }
        },
        watchForm: function() {
            if($("#email").length) {
                var self = this;
                var element = $("#email");
                if(element.val() !== self.formValues["email"]) {
                    self.formValues["email"] = element.val();
                    $("#email").change();
                }
                this.timerObject = setTimeout(function() {
                    self.watchForm();
                }, this.intervalDuration);
            } else {
                this.onClose();
            }
        },
        onClose: function() {
            if(this.timerObject) {
                clearTimeout(this.timerObject);
                delete this.timerObject;
            }
            this.ticketCategoriesView.close();
        }
    });

    return CreateBookingView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above may be surprising! After all, we said that we were going to add a single view, but instead, we added three! This view makes use of two subviews (<code>TicketCategoriesView</code> and <code>TicketSummaryView</code>) for re-rendering parts of the main view. Whenever the user changes the current section, the list of available tickets is updated. Whenever the user adds the tickets to the booking, the booking summary is re-rendered. Changes in quantities or the target email may enable or disable the submission button - the booking is validated whenever changes to it are made. We do not create separate modules for the subviews, since they are not referenced outside the module itself.</p>
</div>
<div class="paragraph">
<p>The booking submission is handled by the <code>save</code> method which constructs a JSON object, as required by a POST to <code><a href="http://localhost:8080/ticket-monster/rest/bookings" class="bare">http://localhost:8080/ticket-monster/rest/bookings</a></code>, and performs the AJAX call. In case of a successful response, a confirmation view is rendered. On failure, a warning is displayed and the user may continue to edit the form.</p>
</div>
<div class="paragraph">
<p>The corresponding templates for the views above are shown below:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/booking-confirmation.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="row"&gt;
    &lt;h2 class="special-title light-font"&gt;Booking #&lt;%=booking.id%&gt; confirmed!&lt;/h2&gt;
&lt;/div&gt;
&lt;div class="row"&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="well"&gt;
            &lt;h4 class="page-header"&gt;Checkout information&lt;/h4&gt;
            &lt;p&gt;&lt;strong&gt;Email: &lt;/strong&gt;&lt;%= booking.contactEmail %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Event: &lt;/strong&gt; &lt;%= performance.event.name %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Venue: &lt;/strong&gt;&lt;%= performance.venue.name %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Date: &lt;/strong&gt;&lt;%= new Date(booking.performance.date).toPrettyString() %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Created on: &lt;/strong&gt;&lt;%= new Date(booking.createdOn).toPrettyString() %&gt;&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="col-md-6"&gt;
        &lt;div class="well"&gt;
            &lt;h4 class="page-header"&gt;Ticket allocations&lt;/h4&gt;
            &lt;table class="table table-striped table-bordered" style="background-color: #fffffa;"&gt;
                &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;Ticket #&lt;/th&gt;
                    &lt;th&gt;Category&lt;/th&gt;
                    &lt;th&gt;Section&lt;/th&gt;
                    &lt;th&gt;Row&lt;/th&gt;
                    &lt;th&gt;Seat&lt;/th&gt;
                &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
            &lt;% $.each(_.sortBy(booking.tickets, function(ticket) {return ticket.id}), function (i, ticket) { %&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;%= ticket.id %&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%=ticket.ticketCategory.description%&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%=ticket.seat.section.name%&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%=ticket.seat.rowNumber%&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;%=ticket.seat.number%&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;% }) %&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row" style="padding-bottom:30px;"&gt;
    &lt;div class="col-md-2"&gt;&lt;a href="#" class="highlight-link"&gt;Home&lt;/a&gt;&lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/create-booking.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="row"&gt;
    &lt;div class="col-md-12"&gt;
        &lt;h2 class="special-title light-font"&gt;&lt;%=show.event.name%&gt;
            &lt;small&gt;&lt;%=show.venue.name%&gt;, &lt;%=new Date(performance.date).toPrettyString()%&gt;&lt;/p&gt;&lt;/small&gt;
        &lt;/h2&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row"&gt;
    &lt;div class="col-md-4"&gt;
        &lt;div class="well"&gt;
            &lt;h3 class="page-header"&gt;Select tickets&lt;/h3&gt;
            &lt;form class="form-horizontal"&gt;
                &lt;div id="sectionSelectorPlaceholder"&gt;
                    &lt;div class="form-group"&gt;
                        &lt;label class="col-md-3 control-label" for="sectionSelect"&gt;&lt;strong&gt;Section&lt;/strong&gt;&lt;/label&gt;
                        &lt;div class="col-md-9"&gt;
                            &lt;select id="sectionSelect" class="form-control"&gt;
                                &lt;option value="-1" selected="true"&gt;Choose a section&lt;/option&gt;
                                &lt;% _.each(sections, function(section) { %&gt;
                                &lt;option value="&lt;%=section.id%&gt;"&gt;&lt;%=section.name%&gt; - &lt;%=section.description%&gt;&lt;/option&gt;
                                &lt;% }) %&gt;
                            &lt;/select&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/form&gt;
            &lt;div id="ticketCategoriesViewPlaceholder"&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div id="request-summary" class="col-md-5 col-md-offset-1"&gt;
        &lt;div class="well"&gt;
            &lt;h3 class="page-header"&gt;Order summary&lt;/h3&gt;
            &lt;div id="ticketSummaryView" class="row"/&gt;
            &lt;h3 class="page-header"&gt;Checkout&lt;/h3&gt;
            &lt;div class="row"&gt;
                &lt;div class="col-md-12"&gt;
                    &lt;form&gt;
                        &lt;div class="form-group"&gt;
                            &lt;input type='email' id="email" class="form-control" placeholder="Email" required/&gt;
                            &lt;p class="help-block error-notification"  id="error-email"&gt;&lt;/p&gt;
                        &lt;/div&gt;
                        &lt;div class="form-group"&gt;
                            &lt;input type='button' class="btn btn-primary" name="submit" value="Checkout"
                                   disabled="true"/&gt;
                        &lt;/div&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/ticket-categories.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;% if (ticketPrices.length &gt; 0) { %&gt;
&lt;form class="form-horizontal"&gt;
    &lt;% _.each(ticketPrices, function(ticketPrice) { %&gt;
    &lt;div class="form-group" id="ticket-category-fieldset-&lt;%=ticketPrice.id%&gt;"&gt;
        &lt;label class="col-md-3 control-label"&gt;&lt;strong&gt;&lt;%=ticketPrice.ticketCategory.description%&gt;&lt;/strong&gt;&lt;/label&gt;

        &lt;div class="col-md-9"&gt;
            &lt;div class="input-group"&gt;
                &lt;input class="form-control col-md-6" rel="tooltip" title="Enter value"
                       data-tm-id="&lt;%=ticketPrice.id%&gt;"
                       placeholder="Number of tickets"
                       name="tickets-&lt;%=ticketPrice.ticketCategory.id%&gt;"/&gt;
                &lt;span class="input-group-addon"&gt;@ $&lt;%=ticketPrice.price%&gt;&lt;/span&gt;

                &lt;p class="help-block" id="error-input-&lt;%=ticketPrice.id%&gt;"&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;% }) %&gt;

&lt;p&gt;&amp;nbsp;&lt;/p&gt;

&lt;div class="form-group"&gt;
    &lt;div class="col-md-offset-2"&gt;
        &lt;input type="button" class="btn btn-primary" disabled="true" name="add" value="Add tickets"/&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/form&gt;
&lt;% } %&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/ticket-summary-view.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="col-md-12"&gt;
    &lt;% if (tickets.length&gt;0) { %&gt;
    &lt;table class="table table-bordered table-condensed" style="background-color: #fffffa;"&gt;
        &lt;thead&gt;
        &lt;tr&gt;
            &lt;th colspan="7"&gt;&lt;strong&gt;Requested tickets&lt;/strong&gt;&lt;/th&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;th&gt;Section&lt;/th&gt;
            &lt;th&gt;Category&lt;/th&gt;
            &lt;th&gt;Quantity&lt;/th&gt;
            &lt;th&gt;Price&lt;/th&gt;
            &lt;th&gt;&lt;/th&gt;
        &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody id="ticketRequestSummary"&gt;
        &lt;% _.each(tickets, function (ticketRequest, index, tickets) { %&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;%= ticketRequest.ticketPrice.section.name %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%= ticketRequest.ticketPrice.ticketCategory.description %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%= ticketRequest.quantity %&gt;&lt;/td&gt;
            &lt;td&gt;$&lt;%=ticketRequest.ticketPrice.price%&gt;&lt;/td&gt;
            &lt;td&gt;&lt;span class="glyphicon glyphicon-trash" data-index='&lt;%= index %&gt;'/&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;% }); %&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;p/&gt;
    &lt;div class="row"&gt;
        &lt;div class="col-md-5"&gt;&lt;strong&gt;Total ticket count:&lt;/strong&gt; &lt;%= totals.tickets %&gt;&lt;/div&gt;
        &lt;div class="col-md-5"&gt;&lt;strong&gt;Total price:&lt;/strong&gt; $&lt;%=totals.price%&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;% } else { %&gt;
    No tickets requested.
    &lt;% } %&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, once the view is available, we can add it&#8217;s corresponding routing rule:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
    ...
    'app/views/desktop/create-booking',
	...
],function (
			...
            CreateBookingView,
            ...
            ) {

    var Router = Backbone.Router.extend({
        ...
        routes:{
            ...
            "book/:showId/:performanceId":"bookTickets",
        },
        ...
        bookTickets:function (showId, performanceId) {
            var createBookingView =
                new CreateBookingView({
                    model:{ showId:showId,
                            performanceId:performanceId,
                            bookingRequest:{tickets:[]}},
                            el:$("#content")
                           });
            utilities.viewManager.showView(createBookingView);
        }
    }
    ...
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This concludes the implementation of the booking use case. We started by listing the available events, continued by selecting a venue and performance time, and ended by choosing tickets and completing the order.</p>
</div>
<div class="paragraph">
<p>The other use cases: a booking starting from venues and view existing bookings are conceptually similar, so you can just copy the logic for the following routes from <code>src/main/webapp/resources/js/app/routers/desktop/router.js</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>venues</code></p>
</li>
<li>
<p><code>venues/:id</code></p>
</li>
<li>
<p><code>bookings</code></p>
</li>
<li>
<p><code>bookings/:id</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, copy the following files in the <code>src/main/webapp/resources/js/app/models</code>, <code>src/main/webapp/resources/js/app/collections</code>,
<code>src/main/webapp/resources/js/app/views/desktop</code> and <code>src/main/webapp/resources/templates</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>src/main/webapp/resources/js/app/models/booking.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/models/venue.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/collections/bookings.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/collections/venues.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/views/desktop/bookings.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/views/desktop/booking-detail.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/views/desktop/venues.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/js/app/views/desktop/venue-detail.js</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/templates/desktop/booking-details.html</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/templates/desktop/booking-table.html</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/templates/desktop/venues.html</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/templates/desktop/venue-detail.html</code></p>
</li>
<li>
<p><code>src/main/webapp/resources/templates/desktop/venue-event-description.html</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mobile_view">Mobile view</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The mobile version of the application uses approximately the same architecture as the desktop version. Any differences are due to the functional changes in the mobile version and the use of jQuery mobile.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_the_structure_2">Setting up the structure</h3>
<div class="paragraph">
<p>The first step in implementing our solution is to copy the CSS and JavaScript libraries to <code>resources/css</code> and <code>resources/js/libs</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">require.js</dt>
<dd>
<p>AMD support, along with the plugin:</p>
<div class="ulist">
<ul>
<li>
<p>text - for loading text files, in our case the HTML templates</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">jQuery</dt>
<dd>
<p>general purpose library for HTML traversal and manipulation</p>
</dd>
<dt class="hdlist1">Underscore</dt>
<dd>
<p>JavaScript utility library (and a dependency of Backbone)</p>
</dd>
<dt class="hdlist1">Backbone</dt>
<dd>
<p>Client-side MVC framework</p>
</dd>
<dt class="hdlist1">jQuery Mobile</dt>
<dd>
<p>user interface system for mobile devices;</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>(If you have already built the desktop application, some files may already be in place.)</p>
</div>
<div class="paragraph">
<p>For mobile clients, the main page will display the mobile version of the application, by loading the mobile AMD module of the application. Let us create it.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/mobile.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Shortcut alias definitions - will come in handy when declaring dependencies
 * Also, they allow you to keep the code free of any knowledge about library
 * locations and versions
 */
require.config({
    baseUrl:"resources/js",
    paths: {
        jquery:'libs/jquery-2.0.3',
        jquerymobile:'libs/jquery.mobile-1.4.2',
        text:'libs/text',
        underscore:'libs/underscore',
        backbone: 'libs/backbone',
        utilities: 'app/utilities',
        router:'app/router/mobile/router'
    },
    // We shim Backbone.js and Underscore.js since they don't declare AMD modules
    shim: {
        'backbone': {
            deps: ['underscore', 'jquery'],
            exports: 'Backbone'
        },

        'underscore': {
            exports: '_'
        }
    }
});

define("configuration", function() {
    if (window.TicketMonster != undefined &amp;&amp; TicketMonster.config != undefined) {
        return {
            baseUrl: TicketMonster.config.baseRESTUrl
        };
    } else {
        return {
            baseUrl: ""
        };
    }
});

define("initializer", [
    'jquery',
    'utilities',
    'text!../templates/mobile/main.html'
], function ($,
             utilities,
             MainTemplate) {
    // Configure jQuery to append timestamps to requests, to bypass browser caches
    // Important for MSIE
    $.ajaxSetup({cache:false});
    $('head').append('&lt;link rel="stylesheet" href="resources/css/jquery.mobile-1.4.2.css"/&gt;');
    $('head').append('&lt;link rel="stylesheet" href="resources/css/m.screen.css"/&gt;');
    // Bind to mobileinit before loading jQueryMobile
    $(document).bind("mobileinit", function () {
        // Prior to creating and starting the router, we disable jQuery Mobile's own routing mechanism
        $.mobile.hashListeningEnabled = false;
        $.mobile.linkBindingEnabled = false;
        $.mobile.pushStateEnabled = false;

        // Fix jQueryMobile header and footer positioning issues for iOS.
        // See: https://github.com/jquery/jquery-mobile/issues/4113 and
        // https://github.com/jquery/jquery-mobile/issues/5532
        $(document).on('blur', 'input, textarea, select', function() {
            setTimeout(function() {
            window.scrollTo(document.body.scrollLeft, document.body.scrollTop);
            }, 0);
        });

        utilities.applyTemplate($('body'), MainTemplate);
    });
    // Then (load jQueryMobile and) start the router to finally start the app
    require(['router']);
});

// Now we declare all the dependencies
// This loads and runs the 'initializer' module.
require(['initializer']);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this application, we combine Backbone and jQuery Mobile. Each framework has its own strengths; jQuery Mobile provides UI components and touch support, whilst Backbone provides MVC support. There is some overlap between the two, as jQuery Mobile provides its own navigation mechanism which we disable.</p>
</div>
<div class="paragraph">
<p>We also define a <code>configuration</code> module which allows the customization of the base URLs for RESTful invocations. This module does not play any role in the mobile web version. We will come to it, however, when discussing hybrid applications.</p>
</div>
<div class="paragraph">
<p>We also define a special initializer module (<code>initializer</code>) that, when loaded, adds the stylesheets and applies the template for the general structure of the page in the <code>body</code> element. In the initializer module we make customizations in order to get the two frameworks working together - disabling the jQuery Mobile navigation. Let us add the template definition for the template loaded by the initializer module.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/main.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!--
    The main layout of the page - contains the menu and the 'content' &amp;lt;div/&amp;gt; in which all the
    views will render the content.
--&gt;
&lt;div id="container" data-role="page" data-ajax="false"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy over the <code>m.screen.css</code> file referenced in the <code>initializer</code> module, from the project sources, to the appropriate location in the workspace.</p>
</div>
<div class="paragraph">
<p>Next, we create the application router.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/mobile/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the mobile application.
 *
 */
define("router",[
    'jquery',
    'jquerymobile',
    'underscore',
    'utilities'
],function ($,
            jqm,
            _,
            utilities) {

    /**
     * The Router class contains all the routes within the application - i.e. URLs and the actions
     * that will be taken as a result.
     *
     * @type {Router}
     */
    var Router = Backbone.Router.extend({
        initialize: function() {
            //Begin dispatching routes
            Backbone.history.start();
        },
        execute : function(callback, args) {
            $.mobile.loading("show");
            window.setTimeout(function() {
                if (callback) {
                    callback.apply(this, args);
                }
                $.mobile.loading("hide");
            }, 300);
        }
    });

    // Create a router instance
    var router = new Router();

    return router;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the router code we add the <code>execute</code> method to the router for handling transitions between routes. Here, we will display the jQuery Mobile loader widget before displaying any Backbone view, and then hide it once the view is rendered.</p>
</div>
<div class="paragraph">
<p>Next, we need to create a first page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_landing_page">The landing page</h3>
<div class="paragraph">
<p>The first page in our application is the landing page. First, we add the template for it:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/home-view.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header"&gt;
    &lt;h3&gt;Ticket Monster&lt;/h3&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;img src="resources/img/rhjb_eap_logo.png" /&gt;
    &lt;h4&gt;Find events&lt;/h4&gt;
    &lt;ul data-role="listview"&gt;
        &lt;li&gt;
            &lt;a href="#events"&gt;By Category&lt;/a&gt;
        &lt;/li&gt;
        &lt;li&gt;
            &lt;a href="#venues"&gt;By Location&lt;/a&gt;
        &lt;/li&gt;
    &lt;/ul&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have to add the page to the router:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/mobile/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the mobile application.
 *
 */
define("router",[
    ...
    'text!../templates/mobile/home-view.html'
],function (
		...
        HomeViewTemplate) {

	...
    var Router = Backbone.Router.extend({
        ...
        routes:{
            "":"home"
        },
        ...
        home:function () {
            utilities.applyTemplate($("#container"), HomeViewTemplate);
            $("#container").enhanceWithin();
    	}
    });
    ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because jQuery Mobile navigation is disabled, we must tell jQuery Mobile explicitly to enhance the page content in order to create the mobile view. Here, we enhance the page using the <code>enhanceWithin</code> method, to ensure that the page gets the appropriate look and feel.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_events_view">The events view</h3>
<div class="paragraph">
<p>First, we display a list of events (just as in the desktop view). Since mobile interfaces are more constrained, we will just show a simple list view:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/mobile/events.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'text!../../../../templates/mobile/events.html'
], function (
    utilities,
    eventsView) {

    var EventsView = Backbone.View.extend({
        render:function () {
            var categories = _.uniq(
                _.map(this.model.models, function(model){
                    return model.get('category');
                }), false, function(item){
                    return item.id;
                });
            utilities.applyTemplate($(this.el), eventsView,  {categories:categories, model:this.model});
            $(this.el).enhanceWithin();
            return this;
        }
    });

    return EventsView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the view is very similar to the desktop view, the main difference being the explicit hint to jQuery mobile through the <code>pagecreate</code> event invocation.</p>
</div>
<div class="paragraph">
<p>Next, we add the template for rendering the view:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/events.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header"&gt;
    &lt;a href="#" class="ui-btn ui-icon-home ui-btn-icon-left"&gt;Home&lt;/a&gt;
    &lt;h3&gt;Categories&lt;/h3&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;div id="itemMenu" data-role="collapsible-set" data-inset="false"&gt;
        &lt;%
        _.each(categories, function (category) {
        %&gt;
        &lt;div data-role="collapsible"&gt;
            &lt;h2&gt;&lt;%= category.description %&gt;&lt;/h2&gt;
            &lt;ul id="categoryMenu" data-role="listview" data-inset="true"&gt;
            &lt;%
            _.each(model.models, function (model) {
                if (model.get('category').id == category.id) {
                %&gt;
                &lt;li&gt;
                    &lt;a href="#events/&lt;%=model.attributes.id%&gt;"&gt;&lt;%=model.attributes.name%&gt;&lt;/a&gt;
                &lt;/li&gt;
                &lt;% }
            });
            %&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
        &lt;% }); %&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, we need to instruct the router to invoke the page:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/mobile/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application.
 *
 */
define("router",[
    ...
	'app/collections/events',
	...
	'app/views/mobile/events'
	...
],function (
	...,
	Events,
	...,
	EventsView,
	...) {

	...
    var Router = Backbone.Router.extend({
        ...
        routes:{
        	...
            "events":"events"
            ...
        },
        ...
        events:function () {
            var events = new Events;
            var eventsView = new EventsView({model:events, el:$("#container")});
            events.on("reset", function() {
                utilities.viewManager.showView(eventsView);
            }).fetch({
                reset : true,
                error : function() {
                    utilities.displayAlert("Failed to retrieve events from the TicketMonster server.");
                }
            });
        }
        ...
    });
    ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as in the case of the desktop application, the list of events will be accessible at <code>#events</code> (i.e. <code><a href="http://localhost:8080/ticket-monster/#events" class="bare">http://localhost:8080/ticket-monster/#events</a></code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_displaying_an_individual_event">Displaying an individual event</h3>
<div class="paragraph">
<p>Now, we create the view to display an event:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/mobile/event-detail.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'require',
    'configuration',
    'text!../../../../templates/mobile/event-detail.html',
    'text!../../../../templates/mobile/event-venue-description.html'
], function (
    utilities,
    require,
    config,
    eventDetail,
    eventVenueDescription) {

    var EventDetailView = Backbone.View.extend({
        events:{
            "click a[id='bookButton']":"beginBooking",
            "change select[id='showSelector']":"refreshShows",
            "change select[id='performanceTimes']":"performanceSelected",
            "change select[id='dayPicker']":'refreshTimes'
        },
        render:function () {
            $(this.el).empty()
            utilities.applyTemplate($(this.el), eventDetail, _.extend({}, this.model.attributes, config));
            $(this.el).enhanceWithin();
            $("#bookButton").addClass("ui-disabled");
            var self = this;
            $.getJSON(config.baseUrl + "rest/shows?event=" + this.model.get('id'), function (shows) {
                self.shows = shows;
                $("#showSelector").empty().append("&lt;option data-placeholder='true'&gt;Choose a venue ...&lt;/option&gt;");
                $.each(shows, function (i, show) {
                    $("#showSelector").append("&lt;option value='" + show.id + "'&gt;" + show.venue.address.city + " : " + show.venue.name + "&lt;/option&gt;");
                });
                $("#showSelector").selectmenu('refresh', true)
                $("#dayPicker").selectmenu('disable')
                $("#dayPicker").empty().append("&lt;option data-placeholder='true'&gt;Choose a show date ...&lt;/option&gt;")
                $("#performanceTimes").selectmenu('disable')
                $("#performanceTimes").empty().append("&lt;option data-placeholder='true'&gt;Choose a show time ...&lt;/option&gt;")
            });
            $("#dayPicker").empty();
            $("#dayPicker").selectmenu('disable');
            $("#performanceTimes").empty();
            $("#performanceTimes").selectmenu('disable');
            $(this.el).enhanceWithin();
            return this;
        },
        performanceSelected:function () {
            if ($("#performanceTimes").val() != 'Choose a show time ...') {
                $("#bookButton").removeClass("ui-disabled")
            } else {
                $("#bookButton").addClass("ui-disabled")
            }
        },
        beginBooking:function () {
            require('router').navigate('book/' + $("#showSelector option:selected").val() + '/' + $("#performanceTimes").val(), true)
        },
        refreshShows:function (event) {

            var selectedShowId = event.currentTarget.value;

            if (selectedShowId != 'Choose a venue ...') {
                var selectedShow = _.find(this.shows, function (show) {
                    return show.id == selectedShowId
                });
                this.selectedShow = selectedShow;
                var times = _.uniq(_.sortBy(_.map(selectedShow.performances, function (performance) {
                    return (new Date(performance.date).withoutTimeOfDay()).getTime()
                }), function (item) {
                    return item
                }));
                utilities.applyTemplate($("#eventVenueDescription"), eventVenueDescription, _.extend({},{venue:selectedShow.venue},config));
                $("#detailsCollapsible").show()
                $("#dayPicker").removeAttr('disabled')
                $("#performanceTimes").removeAttr('disabled')
                $("#dayPicker").empty().append("&lt;option data-placeholder='true'&gt;Choose a show date ...&lt;/option&gt;")
                _.each(times, function (time) {
                    var date = new Date(time)
                    $("#dayPicker").append("&lt;option value='" + date.toYMD() + "'&gt;" + date.toPrettyStringWithoutTime() + "&lt;/option&gt;")
                });
                $("#dayPicker").selectmenu('refresh')
                $("#dayPicker").selectmenu('enable')
                this.refreshTimes()
            } else {
                $("#detailsCollapsible").hide()
                $("#eventVenueDescription").empty()
                $("#dayPicker").empty()
                $("#dayPicker").selectmenu('disable')
                $("#performanceTimes").empty()
                $("#performanceTimes").selectmenu('disable')
            }


        },
        refreshTimes:function () {
            var selectedDate = $("#dayPicker").val();
            $("#performanceTimes").empty().append("&lt;option data-placeholder='true'&gt;Choose a show time ...&lt;/option&gt;")
            if (selectedDate) {
                $.each(this.selectedShow.performances, function (i, performance) {
                    var performanceDate = new Date(performance.date);
                    if (_.isEqual(performanceDate.toYMD(), selectedDate)) {
                        $("#performanceTimes").append("&lt;option value='" + performance.id + "'&gt;" + performanceDate.getHours().toZeroPaddedString(2) + ":" + performanceDate.getMinutes().toZeroPaddedString(2) + "&lt;/option&gt;")
                    }
                })
                $("#performanceTimes").selectmenu('enable')
            }
            $("#performanceTimes").selectmenu('refresh')
            this.performanceSelected()
        }

    });

    return EventDetailView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, this is very similar to the desktop version. Now we add the page templates:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/event-detail.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header" data-position="fixed"&gt;
    &lt;a href="#" class="ui-btn ui-icon-home ui-btn-icon-left"&gt;Home&lt;/a&gt;
    &lt;h3&gt;Book tickets&lt;/h3&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;h3&gt;&lt;%=name%&gt;&lt;/h3&gt;
    &lt;img width='100px' src='&lt;%=baseUrl%&gt;rest/media/&lt;%=mediaItem.id%&gt;'/&gt;
    &lt;p&gt;&lt;%=description%&gt;&lt;/p&gt;
    &lt;div class="ui-field-contain"&gt;
        &lt;label for="showSelector"&gt;&lt;strong&gt;Where&lt;/strong&gt;&lt;/label&gt;
        &lt;select id='showSelector' data-mini='true'/&gt;
    &lt;/div&gt;

    &lt;div data-role="collapsible" data-content-theme="c" style="display: none;"
         id="detailsCollapsible"&gt;
        &lt;h3&gt;Venue details&lt;/h3&gt;

        &lt;div id="eventVenueDescription"&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div data-role='fieldcontain'&gt;
        &lt;fieldset data-role='controlgroup'&gt;
            &lt;legend&gt;&lt;strong&gt;When&lt;/strong&gt;&lt;/legend&gt;
            &lt;label for="dayPicker"&gt;When:&lt;/label&gt;
            &lt;select id='dayPicker' data-mini='true'/&gt;

            &lt;label for="performanceTimes"&gt;When:&lt;/label&gt;
            &lt;select id="performanceTimes" data-mini='true'/&gt;

        &lt;/fieldset&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;div data-role="footer" data-position="fixed"&gt;
    &lt;div class="ui-grid-b"&gt;
        &lt;div class="ui-block-a"&gt;&lt;/div&gt;
        &lt;div class="ui-block-b"&gt;&lt;/div&gt;
        &lt;div class="ui-block-c"&gt;
            &lt;a id='bookButton' class="ui-btn ui-btn-b ui-icon-check ui-btn-icon-left block-btn"&gt;Book&lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/event-venue-description.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;img width="100" src="&lt;%=baseUrl%&gt;rest/media/&lt;%=venue.mediaItem.id%&gt;"/&gt;&lt;/p&gt;
&lt;%= venue.description %&gt;
&lt;address&gt;
    &lt;p&gt;&lt;strong&gt;Address:&lt;/strong&gt;&lt;/p&gt;
    &lt;p&gt;&lt;%= venue.address.street %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;%= venue.address.city %&gt;, &lt;%= venue.address.country %&gt;&lt;/p&gt;
&lt;/address&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we add this to the router, explicitly indicating to jQuery Mobile that a transition has to take place after the view is rendered - in order to allow the page to render correctly after it has been invoked from the listview.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/mobile/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application.
 *
 */
define("router",[
    ...
	'app/models/event',
	...
	'app/views/mobile/event-detail'
	...
],function (
	...,
	Event,
	...,
	EventDetailView,
	...) {

	...
    var Router = Backbone.Router.extend({
        ...
        routes:{
        	...
            "events/:id":"eventDetail",
            ...
        },
        ...
        eventDetail:function (id) {
            var model = new Event({id:id});
            var eventDetailView = new EventDetailView({model:model, el:$("#container")});
            model.on("change",
                function () {
                    utilities.viewManager.showView(eventDetailView);
                    $("body").pagecontainer("change", "#container", {transition:'slide', changeHash:false});
                }).fetch({
                    error : function() {
                        utilities.displayAlert("Failed to retrieve the event from the TicketMonster server.");
                    }
                });
        }
        ...
    });
    ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as the desktop version, the mobile event detail view allows users to choose a venue and a performance time. The next step is to allow the user to book some tickets.</p>
</div>
</div>
<div class="sect2">
<h3 id="_booking_tickets">Booking tickets</h3>
<div class="paragraph">
<p>The views to book tickets are simpler than the desktop version. Users can select a section and enter the number of tickets for each category however, there is no way to add or remove tickets from an order. Once the form is filled out, the user can only submit it.</p>
</div>
<div class="paragraph">
<p>First, we create the views:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/mobile/create-booking.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'utilities',
    'configuration',
    'require',
    'text!../../../../templates/mobile/booking-details.html',
    'text!../../../../templates/mobile/create-booking.html',
    'text!../../../../templates/mobile/confirm-booking.html',
    'text!../../../../templates/mobile/ticket-entries.html',
    'text!../../../../templates/mobile/ticket-summary-view.html'
], function (
    utilities,
    config,
    require,
    bookingDetailsTemplate,
    createBookingTemplate,
    confirmBookingTemplate,
    ticketEntriesTemplate,
    ticketSummaryViewTemplate) {

    var TicketCategoriesView = Backbone.View.extend({
        id:'categoriesView',
        events:{
            "change input":"onChange"
        },
        render:function () {
            var views = {};

            if (this.model != null) {
                var ticketPrices = _.map(this.model, function (item) {
                    return item.ticketPrice;
                });
                utilities.applyTemplate($(this.el), ticketEntriesTemplate, {ticketPrices:ticketPrices});
            } else {
                $(this.el).empty();
            }
            return this;
        },
        onChange:function (event) {
            var value = event.currentTarget.value;
            var ticketPriceId = $(event.currentTarget).data("tm-id");
            var modifiedModelEntry = _.find(this.model, function(item) { return item.ticketPrice.id == ticketPriceId});
            if ($.isNumeric(value) &amp;&amp; value &gt; 0) {
                modifiedModelEntry.quantity = parseInt(value);
            }
            else {
                delete modifiedModelEntry.quantity;
            }
        }
    });

     var TicketSummaryView = Backbone.View.extend({
        render:function () {
            utilities.applyTemplate($(this.el), ticketSummaryViewTemplate, this.model.bookingRequest)
        }
    });

    var CreateBookingView = Backbone.View.extend({

        currentView: "CreateBooking",
        intervalDuration : 100,
        formValues : [],
        events:{
            "click a[id='confirmBooking']":"checkout",
            "change select":"refreshPrices",
            "change input[type='number']":"updateForm",
            "change input[name='email']":"updateForm",
            "click a[id='saveBooking']":"saveBooking",
            "click a[id='goBack']":"back",
            "click a[data-action='delete']":"deleteBooking"
        },
        render: function() {
            if (this.currentView === "CreateBooking") {
                this.renderCreateBooking();
            } else if(this.currentView === "ConfirmBooking") {
                this.renderConfirmBooking();
            }
            return this;
        },
        renderCreateBooking:function () {

            var self = this;

            $.getJSON(config.baseUrl + "rest/shows/" + this.model.showId, function (selectedShow) {
                self.model.performance = _.find(selectedShow.performances, function (item) {
                    return item.id == self.model.performanceId;
                });
                self.model.email = self.model.email || "";
                var id = function (item) {return item.id;};
                // prepare a list of sections to populate the dropdown
                var sections = _.uniq(_.sortBy(_.pluck(selectedShow.ticketPrices, 'section'), id), true, id);

                utilities.applyTemplate($(self.el), createBookingTemplate, { show:selectedShow,
                    performance:self.model.performance,
                    sections:sections,
                    email:self.model.email});
                $(self.el).enhanceWithin();
                self.ticketCategoriesView = new TicketCategoriesView({model:{}, el:$("#ticketCategoriesViewPlaceholder") });
                self.model.show = selectedShow;
                self.ticketCategoriesView.render();
                $('a[id="confirmBooking"]').addClass('ui-disabled');
                $("#sectionSelector").change();
                self.watchForm();
            });

        },
        refreshPrices:function (event) {
            if (event.currentTarget.value != "Choose a section") {
                var ticketPrices = _.filter(this.model.show.ticketPrices, function (item) {
                    return item.section.id == event.currentTarget.value;
                });
                var ticketPriceInputs = new Array();
                _.each(ticketPrices, function (ticketPrice) {
                    var model = {};
                    model.ticketPrice = ticketPrice;
                    ticketPriceInputs.push(model);
                });
                $("#ticketCategoriesViewPlaceholder").show();
                this.ticketCategoriesView.model = ticketPriceInputs;
                this.ticketCategoriesView.render();
                $(this.el).enhanceWithin();
            } else {
                $("#ticketCategoriesViewPlaceholder").hide();
                this.ticketCategoriesView.model = new Array();
                this.updateForm();
            }
        },
        checkout:function () {
            var savedTicketRequests = this.model.bookingRequest.tickets = this.model.bookingRequest.tickets || [];
            _.each(this.ticketCategoriesView.model, function(newTicketRequest){
                var matchingRequest = _.find(savedTicketRequests, function(ticketRequest) {
                    return ticketRequest.ticketPrice.id == newTicketRequest.ticketPrice.id;
                });
                if(newTicketRequest.quantity) {
                    if(matchingRequest) {
                        matchingRequest.quantity += newTicketRequest.quantity;
                    } else {
                        savedTicketRequests.push(newTicketRequest);
                    }
                }
            });
            this.model.bookingRequest.totals = this.computeTotals(this.model.bookingRequest.tickets);
            this.currentView = "ConfirmBooking";
            this.render();
        },
        updateForm:function () {
            var valid = true;
            this.model.email = $("input[type='email']").val();
            $("input[type='number']").each(function(idx,element) {
                var quantity = $(this).val();
                if(quantity.length &gt; 0 &amp;&amp;
                    (!$.isNumeric(quantity)  // is a non-number, other than empty string
                        || quantity &lt;= 0 // is negative
                        || parseFloat(quantity) != parseInt(quantity))) {
                    $("#error-" + element.id).empty().append("Should be a positive number.");
                    valid = false;
                } else {
                    $("#error-" + element.id).empty();
                }
            });
            try {
                var validElements = document.querySelectorAll(":valid");
                var $email = $("#email");
                var emailElem = $email.get(0);
                var validEmail = false;
                for (var ctr=0; ctr &lt; validElements.length; ctr++) {
                    if (emailElem === validElements[ctr]) {
                        validEmail = true;
                    }
                }
                if(validEmail) {
                    this.model.email = $email.val();
                    $("#error-email").empty();
                } else {
                    $("#error-email").empty().append("Please enter a valid e-mail address");
                    delete this.model.email;
                    valid = false;
                }
            }
            catch(e) {
                // For browsers like IE9 that do fail on querySelectorAll for CSS pseudo selectors,
                // we use the regex defined in the HTML5 spec.
                var emailRegex = new RegExp("[a-zA-Z0-9.!#$%&amp;'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*");
                var emailValue = $("#email").val();
                if(emailRegex.test(emailValue)) {
                    this.model.email = emailValue;
                    $("#error-email").empty();
                } else {
                    $("#error-email").empty().append("Please enter a valid e-mail address");
                    delete this.model.email;
                    valid = false;
                }
            }
            var totals = this.computeTotals(this.ticketCategoriesView.model);
            if (totals.tickets &gt; 0 &amp;&amp; valid) {
                $('a[id="confirmBooking"]').removeClass('ui-disabled');
            } else {
                $('a[id="confirmBooking"]').addClass('ui-disabled');
            }
        },
        computeTotals: function(ticketRequestCollection) {
            var totals = _.reduce(ticketRequestCollection, function (partial, model) {
                if (model.quantity != undefined) {
                    partial.tickets += model.quantity;
                    partial.price += model.quantity * model.ticketPrice.price;
                    return partial;
                } else {
                    return partial;
                }
            }, {tickets:0, price:0.0});
            return totals;
        },
        renderConfirmBooking:function () {
            utilities.applyTemplate($(this.el), confirmBookingTemplate, this.model);
            this.ticketSummaryView = new TicketSummaryView({model:this.model, el:$("#ticketSummaryView")});
            this.ticketSummaryView.render();
            $(this.el).enhanceWithin();
            if (this.model.bookingRequest.totals.tickets &gt; 0) {
                $('a[id="saveBooking"]').removeClass('ui-disabled');
            } else {
                $('a[id="saveBooking"]').addClass('ui-disabled');
            }
            return this;
        },
        back:function () {
            this.currentView = "CreateBooking";
            this.render();
        },
        saveBooking:function (event) {
            var bookingRequest = {ticketRequests:[]};
            var self = this;
            _.each(this.model.bookingRequest.tickets, function (model) {
                if (model.quantity != undefined) {
                    bookingRequest.ticketRequests.push({ticketPrice:model.ticketPrice.id, quantity:model.quantity})
                }
            });

            bookingRequest.email = this.model.email;
            bookingRequest.performance = this.model.performanceId;
            $.ajax({url:(config.baseUrl + "rest/bookings"),
                data:JSON.stringify(bookingRequest),
                type:"POST",
                dataType:"json",
                contentType:"application/json",
                success:function (booking) {
                    utilities.applyTemplate($(self.el), bookingDetailsTemplate, booking);
                    $(self.el).enhanceWithin();
                }}).error(function (error) {
                    try {
                        var response = JSON.parse(error.responseText);
                        var displayMessage = "";
                        if(response &amp;&amp; response.errors) {
                            var errors = response.errors;
                            for(var idx = 0; idx &lt; errors.length; idx++) {
                                displayMessage += errors[idx] + "\n";
                            }
                            alert(displayMessage);
                        } else {
                            alert("Failed to perform the bookng.");
                        }
                    } catch (e) {
                        alert("Failed to perform the bookng.");
                    }
                });
        },
        deleteBooking: function(event) {
            var deletedIdx = $(event.currentTarget).data("ticketpriceid");
            this.model.bookingRequest.tickets = _.reject(this.model.bookingRequest.tickets, function(ticketRequest) {
                return ticketRequest.ticketPrice.id == deletedIdx;
            });
            this.model.bookingRequest.totals = this.computeTotals(this.model.bookingRequest.tickets);
            this.renderConfirmBooking();
            return false;
        },
        watchForm: function() {
            if($("#sectionSelect").length) {
                var self = this;
                $("input").each( function(index,element) {
                    if(element.value !== self.formValues[element.id]) {
                        self.formValues[element.id] = element.value;
                        $("input[id='"+element.id+"']").change();
                    }
                });
                this.timerObject = setTimeout(function() {
                    self.watchForm();
                }, this.intervalDuration);
            } else {
                this.onClose();
            }
        },
        onClose: function() {
            if(this.timerObject) {
                clearTimeout(this.timerObject);
                delete this.timerObject;
            }
        }
    });
    return CreateBookingView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The views follow the structure the desktop application, except that the summary view is not rendered inline but after a page
transition.</p>
</div>
<div class="paragraph">
<p>Next, we create the page fragment templates. First, the actual page:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/create-booking.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header" data-position="fixed"&gt;
    &lt;a href="#" class="ui-btn ui-icon-home ui-btn-icon-left"&gt;Home&lt;/a&gt;
    &lt;h1&gt;Book tickets&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;p&gt;
       &lt;h3&gt;&lt;%=show.event.name%&gt;&lt;/h3&gt;
    &lt;/p&gt;
    &lt;p&gt;
      &lt;%=show.venue.name%&gt;
    &lt;p&gt;

    &lt;p&gt;
      &lt;small&gt;&lt;%=new Date(performance.date).toPrettyString()%&gt;&lt;/small&gt;
    &lt;/p&gt;
    &lt;div id="sectionSelectorPlaceholder"&gt;
        &lt;div class="ui-field-contain"&gt;
            &lt;label for="sectionSelect"&gt;Section&lt;/label&gt;
            &lt;select id="sectionSelect"&gt;
                &lt;option value="-1" selected&gt;Choose a section&lt;/option&gt;
                &lt;% _.each(sections, function(section) { %&gt;
                &lt;option value="&lt;%=section.id%&gt;"&gt;&lt;%=section.name%&gt; - &lt;%=section.description%&gt;&lt;/option&gt;
                &lt;% }) %&gt;
            &lt;/select&gt;
        &lt;/div&gt;

    &lt;/div&gt;
    &lt;div id="ticketCategoriesViewPlaceholder" style="display:none;"&gt;&lt;/div&gt;

    &lt;div class="fieldcontain"&gt;
        &lt;label&gt;Contact email&lt;/label&gt;
        &lt;input type='email' id='email' name='email' required placeholder="Email" value="&lt;%=email%&gt;" /&gt;
        &lt;span id="error-email" class="error" /&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div data-role="footer" data-position="fixed"&gt;
    &lt;div class="ui-grid-a"&gt;
        &lt;div class="ui-block-a"&gt;&lt;a href="#" class="ui-btn ui-icon-delete ui-btn-icon-left block-btn"&gt;Cancel&lt;/a&gt;&lt;/div&gt;
        &lt;div class="ui-block-b"&gt;&lt;a id="confirmBooking" class="ui-btn ui-btn-b ui-icon-check ui-btn-icon-left block-btn" disabled&gt;Checkout&lt;/a&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, the fragment that contains the input form for tickets, which is re-rendered whenever the section is changed:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/ticket-entries.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;% if (ticketPrices.length &gt; 0) { %&gt;
    &lt;form name="ticketCategories" id="ticketCategories"&gt;
    &lt;h4&gt;Select tickets by category&lt;/h4&gt;
    &lt;% _.each(ticketPrices, function(ticketPrice) { %&gt;
      &lt;div id="ticket-category-input-&lt;%=ticketPrice.id%&gt;"/&gt;

      &lt;fieldset class="ui-field-contain"&gt;
         &lt;label for="ticket-&lt;%=ticketPrice.id%&gt;"&gt;&lt;%=ticketPrice.ticketCategory.description%&gt;($&lt;%=ticketPrice.price%&gt;)&lt;/label&gt;
         &lt;input id="ticket-&lt;%=ticketPrice.id%&gt;" data-tm-id="&lt;%=ticketPrice.id%&gt;" type="number" min="0" placeholder="Enter value"
               name="tickets"/&gt;
         &lt;span id="error-ticket-&lt;%=ticketPrice.id%&gt;" class="error" /&gt;
      &lt;/fieldset&gt;
   &lt;% }) %&gt;
   &lt;/form&gt;
&lt;% } %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before submitting the request to the server, the order is confirmed:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/confirm-booking.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header" data-position="fixed"&gt;
    &lt;a href="#" class="ui-btn ui-icon-home ui-btn-icon-left"&gt;Home&lt;/a&gt;
    &lt;h1&gt;Confirm order&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;h3&gt;&lt;%=show.event.name%&gt;&lt;/h3&gt;
    &lt;p&gt;&lt;%=show.venue.name%&gt;&lt;/p&gt;
    &lt;p&gt;&lt;small&gt;&lt;%=new Date(performance.date).toPrettyString()%&gt;&lt;/small&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Buyer:&lt;/strong&gt;  &lt;emphasis&gt;&lt;%=email%&gt;&lt;/emphasis&gt;&lt;/p&gt;
    &lt;div id="ticketSummaryView"/&gt;

&lt;/div&gt;

&lt;div data-role="footer" data-position="fixed"&gt;
    &lt;div class="ui-grid-b"&gt;
        &lt;div class="ui-block-a"&gt;&lt;a id="cancel" href="#" class="ui-btn ui-icon-delete ui-btn-icon-left block-btn"&gt;Cancel&lt;/a&gt;&lt;/div&gt;
        &lt;div class="ui-block-b"&gt;&lt;a id="goBack" class="ui-btn ui-icon-back ui-btn-icon-left block-btn"&gt;Back&lt;/a&gt;&lt;/div&gt;
        &lt;div class="ui-block-c"&gt;&lt;a id="saveBooking" class="ui-btn ui-btn-b ui-icon-check ui-btn-icon-left block-btn"&gt;Buy!&lt;/a&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The confirmation page contains a summary subview:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/ticket-summary-view.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;ul data-role="listview" data-split-icon="delete" data-split-theme="c" data-inset="true"&gt;
    &lt;% _.each(tickets, function(model) { %&gt;
    &lt;li&gt;
        &lt;a class="readonly-listview"&gt;
            &lt;p&gt;&lt;strong&gt;Section&lt;/strong&gt; &lt;%= model.ticketPrice.section.name %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Category&lt;/strong&gt; &lt;%= model.ticketPrice.ticketCategory.description %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Price&lt;/strong&gt; &lt;%= model.ticketPrice.price %&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Quantity&lt;/strong&gt; &lt;%= model.quantity %&gt;&lt;/p&gt;
        &lt;/a&gt;
        &lt;a href="#" data-action="delete" data-ticketpriceid="&lt;%= model.ticketPrice.id %&gt;"&gt;&lt;/a&gt;
    &lt;/li&gt;
    &lt;% }); %&gt;
&lt;/ul&gt;
&lt;div&gt;
    &lt;h4&gt;Totals&lt;/h4&gt;
    &lt;p&gt;&lt;strong&gt;Total tickets: &lt;/strong&gt;&lt;%= totals.tickets %&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Total price: $ &lt;/strong&gt;&lt;%= totals.price %&gt;&lt;/p&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we create the page that displays the booking confirmation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/mobile/booking-details.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div data-role="header" data-position="fixed"&gt;
    &lt;a href="#" class="ui-btn ui-icon-home ui-btn-icon-left"&gt;Home&lt;/a&gt;
    &lt;h1&gt;Booking complete&lt;/h1&gt;
&lt;/div&gt;
&lt;div class="ui-content"&gt;
    &lt;table id="confirm_tbl"&gt;
        &lt;thead&gt;
        &lt;tr&gt;
            &lt;td colspan="5" align="center"&gt;&lt;strong&gt;Booking &lt;%=id%&gt;&lt;/strong&gt;&lt;/td&gt;
        &lt;tr&gt;
        &lt;tr&gt;
            &lt;th&gt;Ticket #&lt;/th&gt;
            &lt;th&gt;Category&lt;/th&gt;
            &lt;th&gt;Section&lt;/th&gt;
            &lt;th&gt;Row&lt;/th&gt;
            &lt;th&gt;Seat&lt;/th&gt;
        &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
        &lt;% $.each(_.sortBy(tickets, function(ticket) {return ticket.id}), function (i, ticket) { %&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;%= ticket.id %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%=ticket.ticketCategory.description%&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%=ticket.seat.section.name%&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%=ticket.seat.rowNumber%&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%=ticket.seat.number%&gt;&lt;/td&gt;
        &lt;/tr&gt;
        &lt;% }) %&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;&lt;/div&gt;
&lt;div data-role="footer" data-position="fixed"&gt;

    &lt;div class="ui-block-b"&gt;
        &lt;a id="back" href="#" class="ui-btn ui-icon-back ui-btn-icon-left block-btn"&gt;Back&lt;/a&gt;
    &lt;/div&gt;

&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last step is registering the view with the router:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/mobile/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * A module for the router of the desktop application
 */
define("router", [
	...
    'app/views/mobile/create-booking',
    ...
],function (
			...
            CreateBookingView
            ...) {

    var Router = Backbone.Router.extend({
        ...
        routes:{
            ...
            "book/:showId/:performanceId":"bookTickets",
            ...
        },
        ...
        bookTickets:function (showId, performanceId) {
            var createBookingView = new CreateBookingView({model:{showId:showId, performanceId:performanceId, bookingRequest:{tickets:[]}}, el:$("#container")});
            utilities.viewManager.showView(createBookingView);
        },
        ...
        });
    ...
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other use case: a booking starting from venues is conceptually similar, so you can just copy the rest of the logic from <code>src/main/webapp/resources/js/app/routers/mobile/router.js</code>, and the rest of the files files in the <code>src/main/webapp/resources/js/app/views/mobile</code> and <code>src/main/webapp/resources/templates/mobile</code> directories.</p>
</div>
</div>
</div>
</div>
<h1 id="_building_the_administration_ui_using_forge" class="sect0">Building the Administration UI using Forge</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_4">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You&#8217;ve just defined the domain model of your application, and all the entities managed directly by the end-users. Now it&#8217;s time to build an administration GUI for the TicketMonster application using JAX-RS and AngularJS. After reading this guide, you&#8217;ll understand how to use JBoss Forge to create the JAX-RS resources from the entities and how to create an AngularJS based UI.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll round out the guide by revealing the required, yet short and sweet, configuration.</p>
</div>
<div class="paragraph">
<p>The tutorial will show you how to perform all these steps in JBoss Developer Studio, including screenshots that guide you through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_forge">Setting up Forge</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_jboss_developer_studio">JBoss Developer Studio</h3>
<div class="paragraph">
<p>Forge is available in JBoss Developer Studio 8. You would have already used Forge in the Introductory chapter.</p>
</div>
<div class="paragraph">
<p>You can start Forge in JBoss Developer Studio, using the <strong>Ctrl + 4</strong> (Windows/Linux) or <strong>Cmd + 4</strong> (Mac OS X) key stroke combination. This would launch the Forge action menu from where you can choose the desired commands to run in a particular context.</p>
</div>
<div class="paragraph">
<p>Or alternatively, to use the Forge Console, navigate to <em>Window &#8594; Show View &#8594; Other</em>, locate <em>Forge Console</em> and click <em>OK</em>. Then click the <em>Start</em> button in top right corner of the view.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started_with_forge">Getting started with Forge</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Forge is a powerful rapid application development (aimed at Java EE 6) and project comprehension tool. It can operate both on projects it creates, and on existing projects, such as TicketMonster. If you want to learn more about Forge, head over to the <a href="http://forge.jboss.org">JBoss Forge site</a>.</p>
</div>
<div class="paragraph">
<p>Forge can scaffold an entire app for you from a set of existing resources. For instance, it can generate a HTML5 scaffold with RESTful services, based on existing JPA entities. We shall see how to use this feature to generate the administration section of the TicketMonster application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_the_crud_ui">Generating the CRUD UI</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Forge Scripts</div>
<div class="paragraph">
<p>Forge supports the execution of scripts. The generation of the CRUD UI is provided
as a Forge script in TicketMonster, so you don&#8217;t need to type the commands everytime
you want to regenerate the Admin UI. The script will also prompt you to apply all
changes to the generated CRUD UI that listed later in this chapter. This would relieve
us of the need to manually type in the changes.</p>
</div>
<div class="paragraph">
<p>To run the script:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>run admin_layer.fsh</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scaffold_the_angularjs_ui_from_the_jpa_entities">Scaffold the AngularJS UI from the JPA entities</h3>
<div class="paragraph">
<p>Scaffolding capabilities are available through the "Scaffold: Setup" and "Scaffold: Generate" commands in the Forge action menu. The first command is used to set up the pre-requisites for a scaffold in a project - usually static files and libraries that can be installed separately and are not modified by subsequent scaffolding operations. The second command is used to generate various source files in a project, based on some input files (in this case JPA entities).</p>
</div>
<div class="paragraph">
<p>In the case of the AngularJS scaffold, an entire CRUD app (a HTML5 UI with a RESTful backend using a database) can be generated from JPA entities.</p>
</div>
<div class="paragraph">
<p>Forge can detect whether the scaffold was initially setup during scaffold generation and adjust for missing capabilities in the project. Let&#8217;s therefore go ahead and launch the "Scaffold: Generate" command from the Forge action menu:</p>
</div>
<div id="project_scaffold_generate_in_menu" class="imageblock">
<div class="content">
<img src="gfx/forge_scaffold_generate_action_menu.png" alt="forge scaffold generate action menu">
</div>
<div class="title">Figure 101. Filter the <code>Scaffold: Generate</code> command in the menu</div>
</div>
<div class="paragraph">
<p>We&#8217;re now prompted to select which scaffold to generate. Forge supports AngularJS and JSF out of the box. Choose <code>AngularJS</code>. The generated scaffold can be placed in any directory under the web root path (which corresponds to the <code>src/main/webapp</code> directory of the project). We&#8217;ll choose to generate the scaffold in the <code>admin</code> directory.</p>
</div>
<div id="project_scaffold_generate" class="imageblock">
<div class="content">
<img src="gfx/forge_scaffold_generate.png" alt="forge scaffold generate">
</div>
<div class="title">Figure 102. Launch the <code>Scaffold: Generate</code> command</div>
</div>
<div id="project_scaffold_generate_input_webroot" class="imageblock">
<div class="content">
<img src="gfx/forge_scaffold_generate_input_webroot.png" alt="forge scaffold generate input webroot">
</div>
<div class="title">Figure 103. Select the scaffold to generate and the web root path</div>
</div>
<div class="paragraph">
<p>Click the <code>Next</code> button, and proceed to choose the JPA entities that we would use as the basis for the scaffold. You can either scaffold the entities one-by-one, which allows you to control which UIs are generated, or you can generate a CRUD UI for all the entities. We&#8217;ll do the latter. We&#8217;ll also choose to generate REST resources for the entities, since the existing REST resources are not suitable for CRUD operations:</p>
</div>
<div id="project_scaffold_generate_select_entities" class="imageblock">
<div class="content">
<img src="gfx/forge_scaffold_generate_select_entities.png" alt="forge scaffold generate select entities">
</div>
<div class="title">Figure 104. Select the JPA entities to use for generation</div>
</div>
<div class="paragraph">
<p>Click the <code>Next</code> button, to configure the nature of the REST resources generated by the scaffold. Multiple strategies exist in Forge for generating REST resources from JPA entities. We&#8217;ll choose the option to generate and expose DTOs for the JPA entities, since it is more suitable for the TicketMonster object model. Provide a value of <code>org.jboss.examples.ticketmonster.rest</code> as the target package for the generated REST resources, if not already specified. Click <code>Finish</code> to generate the scaffold.</p>
</div>
<div id="project_scaffold_generate_rest_resources" class="imageblock">
<div class="content">
<img src="gfx/forge_scaffold_generate_choose_rest_strategy.png" alt="forge scaffold generate choose rest strategy">
</div>
<div class="title">Figure 105. Choose the REST resource generation strategy</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>Root and Nested DTO</code> resource representation enables Forge to create REST resources for complex object graphs without adding Jackson annotations to avoid cycles in the graph. Without this constrained representation, one would have to add annotations like <code>@JsonIgnore</code> (to ignore certain undesirable object properties), or <code>@JsonIdentity</code> (to represent cycles in JSON without succumbing to StackOverflowErrors or similar such errors/exceptions).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The scaffold generation command performs a multitude of activities, depending on the previous state of the project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It copies the css, images and JavaScript libraries used by the scaffold, to the project. It does this if you did not setup the scaffold in a separate step (this is optional; the generate command will do this for you).</p>
</li>
<li>
<p>It generates JAX-RS resources for all the JPA entities in the project. The resources would be represented in JSON to enable the AngularJS-based front-end to communicate with the backend services. Each resource representation is structured to contain the representation of the corresponding JPA entity (the root) and any associated entities (that are represneted as nested objects).</p>
</li>
<li>
<p>It generates the AngularJS-based front-end that contains HTML based Angular templates along with AngularJS factories, services and controllers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We now have a database-driven CRUD UI for all the entities used in TicketMonster!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_the_crud_ui">Test the CRUD UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s test our UI on our local JBoss AS instance. As usual, we&#8217;ll build and deploy using Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_make_some_changes_to_the_ui">Make some changes to the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lets add support for images to the Admin UI. <code>Events</code> and <code>Venues</code> have `MediaItem`s associated with them, but they&#8217;re only displayed as URLs. Let&#8217;s display the corresponding images in the AngularJS views, by adding the required bindings:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/views/Event/detail.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">        ...
        &lt;div id="mediaItemControls" class="controls"&gt;
        &lt;select id="mediaItem" name="mediaItem" ng-model="mediaItemSelection" ng-options="m.text for m in mediaItemSelectionList"  &gt;
            &lt;option value=""&gt;Choose a Media Item&lt;/option&gt;
        &lt;/select&gt;
        &lt;br/&gt;
        &lt;img class="img-polaroid span4" ng-hide="!mediaItemSelection.text" ng-src="{{mediaItemSelection.text}}" /&gt;
        &lt;/div&gt;
        ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/views/Venue/detail.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">        ...
        &lt;div id="mediaItemControls" class="controls"&gt;
        &lt;select id="mediaItem" name="mediaItem" ng-model="mediaItemSelection" ng-options="m.text for m in mediaItemSelectionList"  &gt;
            &lt;option value=""&gt;Choose a Media Item&lt;/option&gt;
        &lt;/select&gt;
        &lt;br/&gt;
        &lt;img class="img-polaroid span4" ng-hide="!mediaItemSelection.text" ng-src="{{mediaItemSelection.text}}" /&gt;
        &lt;/div&gt;
        ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the bindings are set, we&#8217;ll modify the underlying controllers to provide the URL of the MediaItem when the <code>{{mediaItemSelection.text}}</code> expression is evaluated:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/scripts/controllers/editEventController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">...
            MediaItemResource.queryAll(function(items) {
                $scope.mediaItemSelectionList = $.map(items, function(item) {
                    ...
                    var labelObject = {
                        value : item.id,
                        text : item.url
                    };
                    ...
                });
            });
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/scripts/controllers/editVenueController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">...
            MediaItemResource.queryAll(function(items) {
                $scope.mediaItemSelectionList = $.map(items, function(item) {
                    ...
                    var labelObject = {
                        value : item.id,
                        text : item.url
                    };
                    ...
                });
            });
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The admin site will now display the corresponding image if a media item is associated with the venue or event.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The location of the MediaItem is present in the <code>text</code> property of the <code>mediaItemSelection</code> object.
The parameter to the <code>ngSrc</code> directive is set to this value. This ensures that the browser fetches the image present at this location.
The expression <code>src={{mediaItemSelection.text}}</code> should be avoided since the browser would attempt to fetch the URL with the literal text <code>{{hash}}</code> before AngularJS replaces the expression with the actual URL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also modify the UI to make it more user-friendly. Shows and Performances are displayed in a non-intuitive manner at the moment. Shows are displayed as their object identities, while performances are displayed as date-time values. This makes it difficult to identify them in the views. Let&#8217;s modify the UI to display more semantically useful values.</p>
</div>
<div class="paragraph">
<p>These values will be computed at the server-side, since these are already available in the <code>toString()</code> implementations of these classes. This would be accomplished by adding a read-only property <code>displayTitle</code> to the <code>Show</code> and <code>Performance</code> REST resource representations:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/dto/ShowDTO.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
   private Set&lt;NestedPerformanceDTO&gt; performances = new HashSet&lt;NestedPerformanceDTO&gt;();
   private NestedVenueDTO venue;
   private String displayTitle;

   public ShowDTO()
         ...
         }
         this.venue = new NestedVenueDTO(entity.getVenue());
         this.displayTitle = entity.toString();
      }
   }
   ...
   public String getDisplayTitle()
   {
      return this.displayTitle;
   }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/dto/PerformanceDTO.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
   private NestedShowDTO show;
   private Date date;
   private String displayTitle;

   public PerformanceDTO()
         ...
         this.show = new NestedShowDTO(entity.getShow());
         this.date = entity.getDate();
         this.displayTitle = entity.toString();
      }
   }
   ...
   public String getDisplayTitle()
   {
      return this.displayTitle;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let us do the same for the nested representations:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/dto/NestedPerformanceDTO.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
   private Long id;
   private Date date;
   private String displayTitle;

   public NestedPerformanceDTO()
         ...
         this.id = entity.getId();
         this.date = entity.getDate();
         this.displayTitle = entity.toString();
      }
   }
   ...
   public String getDisplayTitle()
   {
      return this.displayTitle;
   }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/dto/NestedShowDTO.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
   private Long id;
   private String displayTitle;

   public NestedShowDTO()
      ...
      {
         this.id = entity.getId();
         this.displayTitle = entity.toString();
      }
   }
   ...
   public String getDisplayTitle()
   {
      return this.displayTitle;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We shall now proceed to modify the AngularJS views to use the new properties in the resource representations:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/editPerformanceController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    var labelObject = {
     value : item.id,
     text : item.displayTitle
    };
    if($scope.performance.show &amp;&amp; item.id == $scope.performance.show.id) {
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/editSectionAllocationController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    var labelObject = {
     value : item.id,
     text : item.displayTitle
    };
    if($scope.sectionAllocation.performance &amp;&amp; item.id == $scope.sectionAllocation.performance.id) {
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/editShowController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    var labelObject = {
     value : item.id,
     text : item.displayTitle
    };
    if($scope.show.performances){
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/editTicketPriceController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    var labelObject = {
     value : item.id,
     text : item.displayTitle
    };
    if($scope.ticketPrice.show &amp;&amp; item.id == $scope.ticketPrice.show.id) {
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/newPerformanceController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    $scope.showSelectionList = $.map(items, function(item) {
        return ( {
            value : item.id,
            text : item.displayTitle
        });
    });
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/newSectionAllocationController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    $scope.performanceSelectionList = $.map(items, function(item) {
        return ( {
            value : item.id,
            text : item.displayTitle
        });
    });
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/newShowController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    $scope.performancesSelectionList = $.map(items, function(item) {
        return ( {
            value : item.id,
            text : item.displayTitle
        });
    });
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/scripts/controllers/newTicketPriceController.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">    ...
    $scope.showSelectionList = $.map(items, function(item) {
        return ( {
            value : item.id,
            text : item.displayTitle
        });
    });
    ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/views/Performance/search.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">        &lt;label for="show" class="control-label"&gt;Show&lt;/label&gt;
        &lt;div class="controls"&gt;
            &lt;select id="show" name="show" ng-model="search.show" ng-options="s as s.displayTitle for s in showList"&gt;
                &lt;option value=""&gt;Choose a Show&lt;/option&gt;
            &lt;/select&gt;
        ...
        &lt;tbody id="search-results-body"&gt;
            &lt;tr ng-repeat="result in searchResults | searchFilter:searchResults | startFrom:currentPage*pageSize | limitTo:pageSize"&gt;
                    &lt;td&gt;&lt;a href="#/Performances/edit/{{result.id}}"&gt;{{result.show.displayTitle}}&lt;/a&gt;&lt;/td&gt;
                &lt;td&gt;&lt;a href="#/Performances/edit/{{result.id}}"&gt;{{result.date| date:'yyyy-MM-dd HH:mm:ss Z'}}&lt;/a&gt;&lt;/td&gt;
            &lt;/tr&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/views/SectionAllocation/search.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">         &lt;label for="performance" class="control-label"&gt;Performance&lt;/label&gt;
         &lt;div class="controls"&gt;
             &lt;select id="performance" name="performance" ng-model="search.performance" ng-options="p as p.displayTitle for p in performanceList"&gt;
                 &lt;option value=""&gt;Choose a Performance&lt;/option&gt;
             &lt;/select&gt;
            ...
          &lt;tbody id="search-results-body"&gt;
            &lt;tr ng-repeat="result in searchResults | searchFilter:searchResults | startFrom:currentPage*pageSize | limitTo:pageSize"&gt;
                &lt;td&gt;&lt;a href="#/SectionAllocations/edit/{{result.id}}"&gt;{{result.occupiedCount}}&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a href="#/SectionAllocations/edit/{{result.id}}"&gt;{{result.performance.displayTitle}}&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a href="#/SectionAllocations/edit/{{result.id}}"&gt;{{result.section.name}}&lt;/a&gt;&lt;/td&gt;
            &lt;/tr&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/views/TicketPrice/search.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">        &lt;label for="show" class="control-label"&gt;Show&lt;/label&gt;
        &lt;div class="controls"&gt;
            &lt;select id="show" name="show" ng-model="search.show" ng-options="s as s.displayTitle for s in showList"&gt;
                &lt;option value=""&gt;Choose a Show&lt;/option&gt;
            &lt;/select&gt;
            ...
        &lt;tbody id="search-results-body"&gt;
            &lt;tr ng-repeat="result in searchResults | searchFilter:searchResults | startFrom:currentPage*pageSize | limitTo:pageSize"&gt;
                    &lt;td&gt;&lt;a href="#/TicketPrices/edit/{{result.id}}"&gt;{{result.show.displayTitle}}&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a href="#/TicketPrices/edit/{{result.id}}"&gt;{{result.section.name}}&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a href="#/TicketPrices/edit/{{result.id}}"&gt;{{result.ticketCategory.description}}&lt;/a&gt;&lt;/td&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_fixing_the_landing_page_of_the_administration_site">Fixing the landing page of the Administration site</h3>
<div class="paragraph">
<p>The generated administration site contains a landing page - <code>app.html</code> that works well as a standalone site.
However, we need to fix this page to make it work with the rest of the site.</p>
</div>
<div class="paragraph">
<p>For brevity, the significant sections of the corrected page are listed below:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/admin/app.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html lang="en" ng-app="ticketmonster"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;Ticket-monster&lt;/title&gt;
    &lt;link href='http://fonts.googleapis.com/css?family=Rokkitt' rel='stylesheet' type='text/css'/&gt;
    &lt;link href="styles/bootstrap.css" rel="stylesheet" media="screen"&gt;
    &lt;link href="styles/bootstrap-theme.css" rel="stylesheet" media="screen"&gt;
    &lt;link href="styles/main.css" rel="stylesheet" media="screen"&gt;
    &lt;link href="styles/custom-forge.css" rel="stylesheet" media="screen"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id="wrap"&gt;

      &lt;div id="logo" class="hidden-xs"&gt;&lt;div class="wrap"&gt;&lt;h1&gt;Ticket Monster&lt;/h1&gt;&lt;/div&gt;&lt;/div&gt;
      &lt;div class="navbar"&gt;
            &lt;div class="navbar-header"&gt;
                &lt;button type="button" class="navbar-toggle pull-left" data-toggle="collapse" data-target="#navbar-items"&gt;
                    &lt;span class="glyphicon glyphicon-list"&gt; Links&lt;/span&gt;
                &lt;/button&gt;
                &lt;button type="button" class="navbar-toggle" data-toggle="offcanvas"&gt;
                    TicketMonster Entities &lt;span class="glyphicon glyphicon-th text-right"&gt;&lt;/span&gt;
                &lt;/button&gt;
            &lt;/div&gt;

            &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;
            &lt;div id="navbar-items" class="collapse navbar-collapse"&gt;
                &lt;ul class="nav navbar-nav"&gt;
                    &lt;li&gt;&lt;a href="../index.html#about"&gt;About&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="../index.html#events"&gt;Events&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="../index.html#venues"&gt;Venues&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="../index.html#bookings"&gt;Bookings&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="../index.html#monitor"&gt;Monitor&lt;/a&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;a href="#"&gt;Administration&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="container"&gt;

          ...

      &lt;/div&gt;

      ...

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is sufficient to copy the corrected page from the project sources. Additionally, do not forget to copy the <code>src/main/webapp/admin/styles/custom-forge.css</code> file, that we now reference it in the corrected page.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_the_shrinkwrap_deployment_for_the_test_suite">Updating the ShrinkWrap deployment for the test suite</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve added classes to the project that should be in the ShrinkWrap deployment used in the test suite. Let us update the ShrinkWrap deployment to reflect this.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/RESTDeployment.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class RESTDeployment {

    public static WebArchive deployment() {
        return TicketMonsterDeployment.deployment()
                .addPackage(Booking.class.getPackage())
                .addPackage(BaseEntityService.class.getPackage())
                .addPackage(MultivaluedHashMap.class.getPackage())
                .addPackage(SeatAllocationService.class.getPackage())
                .addPackage(VenueDTO.class.getPackage());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can test these changes by executing</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-managed</pre>
</div>
</div>
<div class="paragraph">
<p>or (against an already running JBoss EAP 6.2 instance)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-remote</pre>
</div>
</div>
<div class="paragraph">
<p>as usual.</p>
</div>
</div>
</div>
<h1 id="_building_the_statistics_dashboard_using_html5_and_javascript" class="sect0">Building The Statistics Dashboard Using HTML5 and JavaScript</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_5">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You&#8217;ve just built the administration view, and would like to collect real-time information about ticket sales and attendance. Now it would be good to implement a dashboard that can collect data and receive real-time updates. After reading this tutorial, you will understand our dashboard design and the choices that we made in its implementation. Topics covered include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding a RESTful API to your application for obtaining metrics</p>
</li>
<li>
<p>Adding a non-RESTful API to your application for controlling a bot</p>
</li>
<li>
<p>Creating Backbone.js models and views to interact with a non-RESTful service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this tutorial, we will create a booking monitor using Backbone.js, and add it to the TicketMonster application. It will show live updates on the booking status of all performances and shows. These live updates are powered by a short polling solution that pings the server on regular intervals to obtain updated metrics.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_metrics_api">Implementing the Metrics API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Metrics service publishes metrics for every show. These metrics include the capacity of the venue for the show, as well as the occupied count. Since these metrics are computed from persisted data, we&#8217;ll not create any classes to represent them in the data model. We shall however create new classes to serve as their representations for the REST APIs:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/ShowMetric.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.jboss.examples.ticketmonster.model.Performance;
import org.jboss.examples.ticketmonster.model.Show;

/**
 * Metric data for a Show. Contains the identifier for the Show to identify it,
 * in addition to the event name, the venue name and capacity, and the metric
 * data for the performances of the Show.
 */
class ShowMetric {

  private Long show;
  private String event;
  private String venue;
  private int capacity;
  private List&lt;PerformanceMetric&gt; performances;

  // Constructor to populate the instance with data
  public ShowMetric(Show show, Map&lt;Long, Long&gt; occupiedCounts) {
    this.show = show.getId();
    this.event = show.getEvent().getName();
    this.venue = show.getVenue().getName();
    this.capacity = show.getVenue().getCapacity();
    this.performances = convertFrom(show.getPerformances(), occupiedCounts);
  }

  private List&lt;PerformanceMetric&gt; convertFrom(Set&lt;Performance&gt; performances,
      Map&lt;Long, Long&gt; occupiedCounts) {
    List&lt;PerformanceMetric&gt; result = new ArrayList&lt;PerformanceMetric&gt;();
    for (Performance performance : performances) {
      Long occupiedCount = occupiedCounts.get(performance.getId());
      result.add(new PerformanceMetric(performance, occupiedCount));
    }
    return result;
  }

  // Getters for Jackson
  // NOTE: No setters and default constructors are defined since
  // deserialization is not required.

  public Long getShow() {
    return show;
  }

  public String getEvent() {
    return event;
  }

  public String getVenue() {
    return venue;
  }

  public int getCapacity() {
    return capacity;
  }

  public List&lt;PerformanceMetric&gt; getPerformances() {
    return performances;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ShowMetric</code> class is used to represent the structure of a <code>Show</code> in the metrics API. It contains the show identifier, the <code>Event</code> name for the <code>Show</code>, the <code>Venue</code> name for the <code>Show</code>, the capacity of the <code>Venue</code> and a collection of <code>PerformanceMetric</code> instances to represent metrics for individual <code>Performance</code> s for the <code>Show</code>.</p>
</div>
<div class="paragraph">
<p>The <code>PerformanceMetric</code> is represented as:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/PerformanceMetric.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

import java.util.Date;

import org.jboss.examples.ticketmonster.model.Performance;

/**
 * Metric data for a Performance. Contains the datetime for the performance to
 * identify the performance, as well as the occupied count for the performance.
 */
class PerformanceMetric {

  private Date date;
  private Long occupiedCount;

  // Constructor to populate the instance with data
  public PerformanceMetric(Performance performance, Long occupiedCount) {
    this.date = performance.getDate();
    this.occupiedCount = (occupiedCount == null ? 0 : occupiedCount);
  }

  // Getters for Jackson
  // NOTE: No setters and default constructors are defined since
  // deserialization is not required.

  public Date getDate() {
    return date;
  }

  public Long getOccupiedCount() {
    return occupiedCount;
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class represents the date-time instance of <code>Performance</code> in addition to the count of occupied seats for the venue.</p>
</div>
<div class="paragraph">
<p>The next class we need is the <code>MetricsService</code> class that responds with representations of <code>ShowMetric</code> instances in response to HTTP GET requests:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/MetricsService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.ejb.Stateless;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.persistence.Query;
import javax.persistence.TypedQuery;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;

import org.jboss.examples.ticketmonster.model.Show;

/**
 * A read-only REST resource that provides a collection of metrics for shows occuring in the future. Updates to metrics via
 * POST/PUT etc. are not allowed, since they are not meant to be computed by consumers.
 *
 */
@Path("/metrics")
@Stateless
public class MetricsService {

    @Inject
    private EntityManager entityManager;

    /**
     * Retrieves a collection of metrics for Shows. Each metric in the collection contains
     * &lt;ul&gt;
     * &lt;li&gt;the show id,&lt;/li&gt;
     * &lt;li&gt;the event name of the show,&lt;/li&gt;
     * &lt;li&gt;the venue for the show,&lt;/li&gt;
     * &lt;li&gt;the capacity for the venue&lt;/li&gt;
     * &lt;li&gt;the performances for the show,
     * &lt;ul&gt;
     * &lt;li&gt;the timestamp for each performance,&lt;/li&gt;
     * &lt;li&gt;the occupied count for each performance&lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @return A JSON representation of metrics for shows.
     */
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public List&lt;ShowMetric&gt; getMetrics() {
        return retrieveMetricsFromShows(retrieveShows(),
            retrieveOccupiedCounts());
    }

    private List&lt;ShowMetric&gt; retrieveMetricsFromShows(List&lt;Show&gt; shows,
        Map&lt;Long, Long&gt; occupiedCounts) {
        List&lt;ShowMetric&gt; metrics = new ArrayList&lt;ShowMetric&gt;();
        for (Show show : shows) {
            metrics.add(new ShowMetric(show, occupiedCounts));
        }
        return metrics;
    }

    private List&lt;Show&gt; retrieveShows() {
        TypedQuery&lt;Show&gt; showQuery = entityManager
            .createQuery("select DISTINCT s from Show s JOIN s.performances p WHERE p.date &gt; current_timestamp", Show.class);
        return showQuery.getResultList();
    }

    private Map&lt;Long, Long&gt; retrieveOccupiedCounts() {
        Map&lt;Long, Long&gt; occupiedCounts = new HashMap&lt;Long, Long&gt;();

        Query occupiedCountsQuery = entityManager
            .createQuery("select b.performance.id, SIZE(b.tickets) from Booking b "
                + "WHERE b.performance.date &gt; current_timestamp GROUP BY b.performance.id");

        List&lt;Object[]&gt; results = occupiedCountsQuery.getResultList();
        for (Object[] result : results) {
            occupiedCounts.put((Long) result[0],
                ((Integer) result[1]).longValue());
        }

        return occupiedCounts;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This REST resource responds to a GET request by querying the database to retrieve all the shows and the performances associated with each show. The metric for every performance is also obtained; the performance metric is simply the sum of all tickets booked for the performance. This query result is used to populate the <code>ShowMetric</code> and <code>PerformanceMetric</code> representation instances that are later serialized as JSON responses by the JAX-RS provider.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_bot_service">Creating the Bot service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;d also like to implement a <code>Bot</code> service that would mimic a set of real users. Once started, the <code>Bot</code> would attempt to book tickets at periodic intervals, until it is ordered to stop. The <code>Bot</code> should also be capable of deleting all Bookings so that the system could be returned to a clean state.</p>
</div>
<div class="paragraph">
<p>We will implement the <code>Bot</code> as an EJB that will utlize the container-provided <code>TimerService</code> to periodically perform bookings of a random number of tickets on randomly selected performances:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/Bot.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.service;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.TimeUnit;

import javax.annotation.Resource;
import javax.ejb.Stateless;
import javax.ejb.Timeout;
import javax.ejb.Timer;
import javax.ejb.TimerConfig;
import javax.ejb.TimerService;
import javax.enterprise.event.Event;
import javax.inject.Inject;
import javax.ws.rs.core.Response;

import org.jboss.examples.ticketmonster.model.Performance;
import org.jboss.examples.ticketmonster.model.Show;
import org.jboss.examples.ticketmonster.model.TicketPrice;
import org.jboss.examples.ticketmonster.rest.*;
import org.jboss.examples.ticketmonster.util.MultivaluedHashMap;
import org.jboss.examples.ticketmonster.util.qualifier.BotMessage;

@Stateless
public class Bot {

    private static final Random random = new Random(System.nanoTime());

    /** Frequency with which the bot will book **/
    public static final long DURATION = TimeUnit.SECONDS.toMillis(3);

    /** Maximum number of ticket requests that will be filed **/
    public static int MAX_TICKET_REQUESTS = 100;

    /** Maximum number of tickets per request **/
    public static int MAX_TICKETS_PER_REQUEST = 100;

    public static String [] BOOKERS = {"anne@acme.com", "george@acme.com", "william@acme.com", "victoria@acme.com", "edward@acme.com", "elizabeth@acme.com", "mary@acme.com", "charles@acme.com", "james@acme.com", "henry@acme.com", "richard@acme.com", "john@acme.com", "stephen@acme.com"};

    @Inject
    private ShowService showService;

    @Inject
    private BookingService bookingService;

    @Inject @BotMessage
    Event&lt;String&gt; event;

    @Resource
    private TimerService timerService;

    public Timer start() {
        String startMessage = new StringBuilder("==========================\n")
                .append("Bot started at ").append(new Date().toString()).append("\n")
                .toString();
        event.fire(startMessage);
        return timerService.createIntervalTimer(0, DURATION, new TimerConfig(null, false));
    }

    public void stop(Timer timer) {
        String stopMessage = new StringBuilder("==========================\n")
                .append("Bot stopped at ").append(new Date().toString()).append("\n")
                .toString();
        event.fire(stopMessage);
        timer.cancel();
    }

    @Timeout
    public void book(Timer timer) {
        // Select a show at random
        Show show = selectAtRandom(showService.getAll(MultivaluedHashMap.&lt;String, String&gt;empty()));

        // Select a performance at random
        Performance performance = selectAtRandom(show.getPerformances());

        String requestor = selectAtRandom(BOOKERS);

        BookingRequest bookingRequest = new BookingRequest(performance, requestor);

        List&lt;TicketPrice&gt; possibleTicketPrices = new ArrayList&lt;TicketPrice&gt;(show.getTicketPrices());

        List&lt;Integer&gt; indicies = selectAtRandom(MAX_TICKET_REQUESTS &lt; possibleTicketPrices.size() ? MAX_TICKET_REQUESTS : possibleTicketPrices.size());

        StringBuilder message = new StringBuilder("==========================\n")
        .append("Booking by ")
        .append(requestor)
        .append(" at ")
        .append(new Date().toString())
        .append("\n")
        .append(performance)
        .append("\n")
        .append("~~~~~~~~~~~~~~~~~~~~~~~~~\n");

        for (int index : indicies) {
            int no = random.nextInt(MAX_TICKETS_PER_REQUEST);
            TicketPrice price = possibleTicketPrices.get(index);
            bookingRequest.addTicketRequest(new TicketRequest(price, no));
            message
                .append(no)
                .append(" of ")
                .append(price.getSection())
                .append("\n");

        }
        Response response = bookingService.createBooking(bookingRequest);
        if(response.getStatus() == Response.Status.OK.getStatusCode()) {
            message.append("SUCCESSFUL\n")
                    .append("~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        }
        else {
            message.append("FAILED:\n")
                        .append(((Map&lt;String, Object&gt;) response.getEntity()).get("errors"))
                        .append("~~~~~~~~~~~~~~~~~~~~~~~~~\n");
        }
        event.fire(message.toString());
    }



    private &lt;T&gt; T selectAtRandom(List&lt;T&gt; list) {
        int i = random.nextInt(list.size());
        return list.get(i);
    }

    private &lt;T&gt; T selectAtRandom(T[] array) {
        int i = random.nextInt(array.length);
        return array[i];
    }

    private &lt;T&gt; T selectAtRandom(Collection&lt;T&gt; collection) {
        int item = random.nextInt(collection.size());
        int i = 0;
        for(T obj : collection)
        {
            if (i == item)
                return obj;
            i++;
        }
        throw new IllegalStateException();
    }

    private List&lt;Integer&gt; selectAtRandom(int max) {
        List&lt;Integer&gt; indicies = new ArrayList&lt;Integer&gt;();
        for (int i = 0; i &lt; max;) {
            int r = random.nextInt(max);
            if (!indicies.contains(r)) {
                indicies.add(r);
                i++;
            }
        }
        return indicies;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>start()</code> and <code>stop(Timer timer)</code> methods are used to control the lifecycle of the <code>Bot</code>. When invoked, the <code>start()</code> method creates an interval timer that is scheduled to execute every 3 seconds. The complementary <code>stop(Timer timer)</code> method accepts a <code>Timer</code> handle, and cancels the associated interval timer. The <code>book(Timer timer)</code> is the callback method invoked by the container when the interval timer expires; it it therefore invoked every 3 seconds. The callback method selects a show at random, an associated performance for the chosen show at random, and finally attempts to perform a booking of a random number of seats.</p>
</div>
<div class="paragraph">
<p>The Bot also fires CDI events containing log messages. To qualify the <code>String</code> messages produced by the Bot, we&#8217;ll use the <code>BotMesssage</code> qualifier:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/util/qualifier/BotMessage.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.util.qualifier;

import java.lang.annotation.Documented;
import java.lang.annotation.Retention;
import java.lang.annotation.Target;

import javax.inject.Qualifier;

import static java.lang.annotation.ElementType.FIELD;
import static java.lang.annotation.ElementType.METHOD;
import static java.lang.annotation.ElementType.PARAMETER;
import static java.lang.annotation.ElementType.TYPE;
import static java.lang.annotation.RetentionPolicy.RUNTIME;

@Qualifier
@Target({ TYPE, METHOD, PARAMETER, FIELD })
@Retention(RUNTIME)
@Documented
public @interface BotMessage {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create a facade for the Bot that invokes the Bot&#8217;s <code>start</code> and <code>stop</code> methods:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/BotService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.service;

import java.util.List;
import java.util.logging.Logger;

import javax.ejb.Asynchronous;
import javax.ejb.Singleton;
import javax.ejb.Timer;
import javax.enterprise.event.Event;
import javax.enterprise.event.Observes;
import javax.inject.Inject;

import org.jboss.examples.ticketmonster.model.Booking;
import org.jboss.examples.ticketmonster.rest.BookingService;
import org.jboss.examples.ticketmonster.util.CircularBuffer;
import org.jboss.examples.ticketmonster.util.MultivaluedHashMap;
import org.jboss.examples.ticketmonster.util.qualifier.BotMessage;

/**
 * A Bot service that acts as a Facade for the Bot, providing methods to control the Bot state as well as to obtain the current
 * state of the Bot.
 */
@Singleton
public class BotService {

    private static final int MAX_LOG_SIZE = 50;

    private CircularBuffer&lt;String&gt; log;

    @Inject
    private Bot bot;

    @Inject
    private BookingService bookingService;

    @Inject
    private Logger logger;

    @Inject
    @BotMessage
    private Event&lt;String&gt; event;

    private Timer timer;

    public BotService() {
        log = new CircularBuffer&lt;String&gt;(MAX_LOG_SIZE);
    }

    public void start() {
        synchronized (bot) {
            if (timer == null) {
                logger.info("Starting bot");
                timer = bot.start();
            }
        }
    }

    public void stop() {
        synchronized (bot) {
            if (timer != null) {
                logger.info("Stopping bot");
                bot.stop(timer);
                timer = null;
            }
        }
    }

    @Asynchronous
    public void deleteAll() {
        synchronized (bot) {
            stop();
            // Delete 10 bookings at a time
            while(true) {
                MultivaluedHashMap&lt;String,String&gt; params = new MultivaluedHashMap&lt;String, String&gt;();
                params.add("maxResults", Integer.toString(10));
                List&lt;Booking&gt; bookings = bookingService.getAll(params);
                for (Booking booking : bookings) {
                    bookingService.deleteBooking(booking.getId());
                    event.fire("Deleted booking " + booking.getId() + " for "
                            + booking.getContactEmail() + "\n");
                }
                if(bookings.size() &lt; 1) {
                    break;
                }
            }
        }
    }

    public void newBookingRequest(@Observes @BotMessage String bookingRequest) {
        log.add(bookingRequest);
    }

    public List&lt;String&gt; fetchLog() {
        return log.getContents();
    }

    public boolean isBotActive() {
        return (timer != null);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>start</code> and <code>stop</code> methods of this facade wrap calls to the <code>start</code> and <code>stop</code> methods of the Bot. These methods are synchronous by nature. The <code>deleteAll</code> method is an asynchronous business method in this EJB. It first stops the Bot, and then proceeds to delete all Bookings. Bookings can take quite a while to be deleted depending on the number of existing ones, and hence declaring this method as <code>@Asynchronous</code> would be appropriate in this situation. Moreover, retrieving all Bookings in one execution run for deletion can lead to Out-of-Memory errors with a constrained heap space. The <code>deleteAll</code> method works around this by chunking the bookings to be deleted to a batch size of 10. You shall see how Java Batch (JSR-352) will aid you here, in a future version of TicketMonster that runs on a Java EE 7 compliant app server. For now, we will manage the batching manually.</p>
</div>
<div class="paragraph">
<p>This facade also exposes the log messages produced by the Bot via the <code>fetchLog()</code> method. The contents of the log are backed by a <code>CircularBuffer</code>. The facade observes all <code>@BotMessage</code> events and adds the contents of each event to the buffer.</p>
</div>
<div class="paragraph">
<p>Finally, the facade also provides an interface to detect if the bot is active or not: <code>isBotActive</code> that returns true if a Timer handle is present.</p>
</div>
<div class="paragraph">
<p>We shall now proceed to create a <code>BotStatusService</code> class that exposes the operations on the Bot as a web-service. The <code>BotStatusService</code> will always return the current status of the Bot - whether the Bot has been started or stopped, and the messages in the Bot&#8217;s log. The service also allows the client to change the state of the bot - to start the bot, or to stop it, or even delete all the bookings.</p>
</div>
<div class="paragraph">
<p>The BotState is just an enumeration:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BotState.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

/**
 * An enumeration that represents the possible states for the Bot.
 */
public enum BotState {
    RUNNING, NOT_RUNNING, RESET
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RUNNING</code> and <code>NOT_RUNNING</code> values are obvious. The <code>RESET</code> value is used to represent the state where the Bot will be stopped and the Bookings would be deleted. Quite naturally, the Bot will eventually enter the <code>NOT_RUNNING</code> state after it is <code>RESET</code>.</p>
</div>
<div class="paragraph">
<p>The <code>BotStatusService</code> will be located at the <code>/bot</code> path. It would respond to GET requests at the <code>/messages</code> sub-path with the contents of the Bot&#8217;s log. It will respond to GET requests at the <code>/status</code> sub-path with the JSON representation of the current BotState. And finally, it will respond to PUT requests containing the JSON representation of the BotState, provided tothe <code>/status</code> sub-path, by triggering a state change; a HTTP 204 response is returned in this case.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BotStatusService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.jboss.examples.ticketmonster.rest;

import java.util.List;

import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

import org.jboss.examples.ticketmonster.service.BotService;

/**
 * A non-RESTful service for providing the current state of the Bot. This service also allows the bot to be started, stopped or
 * the existing bookings to be deleted.
 */
@Path("/bot")
public class BotStatusService {

    @Inject
    private BotService botService;

    /**
     * Produces a JSON representation of the bot's log, containing a maximum of 50 messages logged by the Bot.
     *
     * @return The JSON representation of the Bot's log
     */
    @Path("messages")
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public List&lt;String&gt; getMessages() {
        return botService.fetchLog();
    }

    /**
     * Produces a representation of the bot's current state. This is a string - "RUNNING" or "NOT_RUNNING" depending on whether
     * the bot is active.
     *
     * @return The represntation of the Bot's current state.
     */
    @Path("status")
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public Response getBotStatus() {
        BotState state = botService.isBotActive() ? BotState.RUNNING
            : BotState.NOT_RUNNING;
        return Response.ok(state).build();
    }

    /**
     * Updates the state of the Bot with the provided state. This may trigger the bot to start itself, stop itself, or stop and
     * delete all existing bookings.
     *
     * @param updatedStatus The new state of the Bot. Only the state property is considered; any messages provided are ignored.
     * @return An empty HTTP 201 response.
     */
    @Path("status")
    @PUT
    public Response updateBotStatus(BotState updatedState) {
        if (updatedState.equals(BotState.RUNNING)) {
            botService.start();
        } else if (updatedState.equals(BotState.NOT_RUNNING)) {
            botService.stop();
        } else if (updatedState.equals(BotState.RESET)) {
            botService.deleteAll();
        }
        return Response.noContent().build();
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Should the BotStatusService use JAX-RS?</div>
<div class="paragraph">
<p>The <code>BotStatusService</code> appears to be a RESTful service, but on closer examination it does not
obey the constraints of such a service. It represents a single resource - the <code>Bot</code> and not a collection of resources
where each item in the collected is uniquely identified. In other words, no resource like
<code>/bot/1</code> exists, and neither does a HTTP POST to <code>/bot</code> creates a new bot. This affects
the design of the Backbone.js models in the client, as we shall later see.</p>
</div>
<div class="paragraph">
<p>Therefore, it is not necessary to use JAX-RS in this scenario. JAX-RS certainly makes it
easier, since we can continue to use the same programming model with minor changes. There is
no need to parse requests or serialize responses or lookup EJBs; JAX-RS does this for us.
The alternative would be to use a Servlet or a JSON-RPC endpoint.</p>
</div>
<div class="paragraph">
<p>We would recommend adoption alternatives in real-life scenarios should they be more suitable.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_displaying_metrics">Displaying Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are set up now and ready to start coding the client-side section of the dashboard. The users will be able to view the list of performances and view the occupied count for that performance.</p>
</div>
<div class="sect2">
<h3 id="_the_metrics_model">The Metrics model</h3>
<div class="paragraph">
<p>We&#8217;ll define a Backbone model to represent the metric data for an individual show.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/models/metric.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Module for the Metric model
 */
define([
    // Configuration is a dependency
    'configuration',
    'backbone'
], function (config) {

    /**
     * The Metric model class definition
     * Used for CRUD operations against individual Metric
     */
    var Metric = Backbone.Model.extend({
        idAttribute: "show"
    });

    return Metric;

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve specified the <code>show</code> property as the <code>idAttribute</code> for the model. This is necessary since every resource in the collection is uniquely identified by the show property in the representation.
Also note that the Backbone model does not define a <code>urlRoot</code> property unlike other Backbone models. The representation for an individual metric resource cannot be obtained by navigating to <code>/metrics/X</code>, but the metrics for all shows can be obtained by navigating to <code>/metrics</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_metrics_collection">The Metrics collection</h3>
<div class="paragraph">
<p>We now define a Backbone collection for handling the metrics collection:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/collections/metrics.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * The module for a collection of Metrics
 */
define([
    'app/models/metric',
    'configuration',
    'backbone'
], function (Metric, config) {

    // Here we define the Metrics collection
    // We will use it for CRUD operations on Metrics

    var Metrics = Backbone.Collection.extend({
        url: config.baseUrl + 'rest/metrics',
        model: Metric
    });

    return Metrics;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have thus mapped the collection to the <code>MetricsService</code> REST resource, so we can perform CRUD operations against this resource. In practice however, we&#8217;ll need to only query this resource.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_metricsview_view">The MetricsView view</h3>
<div class="paragraph">
<p>Now that we have the model and the collection, let&#8217;s create the view to display the metrics:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/metrics.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'backbone',
  'configuration',
    'utilities',
    'text!../../../../templates/desktop/metrics.html'
], function (
    Backbone,
  config,
    utilities,
    metricsTemplate) {

    var MetricsView = Backbone.View.extend({
        intervalDuration : 3000,
        initialize : function() {
            _.bind(this.render, this);
            _.bind(this.liveUpdate, this);
            this.collection.on("add remove change", this.render, this);
            var self = this;
            $.when(this.collection.fetch({
                error : function() {
                    utilities.displayAlert("Failed to retrieve metrics from the TicketMonster server.");
                }
            })).done(function(){
                self.liveUpdate();
            });
        },
        liveUpdate : function() {
            this.collection.fetch({
                error : function() {
                    utilities.displayAlert("Failed to retrieve metrics from the TicketMonster server.");
                }
            });
            var self = this;
            this.timerObject = setTimeout(function(){
                self.liveUpdate();
            }, this.intervalDuration);
        },
        render : function () {
            utilities.applyTemplate($(this.el), metricsTemplate, {collection:this.collection});
            return this;
        },
        onClose : function() {
            if(this.timerObject) {
                clearTimeout(this.timerObject);
                delete this.timerObject;
            }
        }
    });

    return MetricsView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like other Backbone views, the view is attached to a DOM element (the el property). When the render method is invoked, it manipulates the DOM and renders the view. The <code>metricsTemplate</code> template is used to structure the HTML, thus separating the HTML view code from the view implementation.</p>
</div>
<div class="paragraph">
<p>The render method is invoked whenever the underlying collection is modified. The view is associated with a timer that is executed repeatedly with a predetermined interval of 3 seconds. When the timer is triggered, it fetches the updated state of the collection (the metrics) from the server. Any change in the collection at this point, now triggers a refresh of the view as pointed out earlier.</p>
</div>
<div class="paragraph">
<p>When the view is closed/destroyed, the associated timer if present is cleared.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/metrics.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="col-md-12"&gt;
  &lt;h3 class="page-header light-font special-title"&gt;Booking status&lt;/h3&gt;
  &lt;div id="status-content"&gt;
      &lt;%
      _.each(collection.models, function (show) {
      %&gt;
      &lt;div class="show-status"&gt;
        &lt;div class="show-status-header"&gt;&lt;%=show.get('event')%&gt; @ &lt;%=show.get('venue')%&gt;&lt;/div&gt;
        &lt;%_.each(show.get('performances'), function (performance) {%&gt;
        &lt;div class="row"&gt;
          &lt;div class="col-md-4"&gt;&lt;%=new Date(performance.date).toLocaleString()%&gt;&lt;/div&gt;
          &lt;div class="col-md-4"&gt;
            &lt;div class="progress"&gt;
              &lt;div style="width: &lt;%=(performance.occupiedCount)/(show.get('capacity'))*100%&gt;%;" class="progress-bar progress-bar-success"&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class="col-md-4"&gt;&lt;%=performance.occupiedCount%&gt; of &lt;%=show.get('capacity')%&gt; tickets booked&lt;/div&gt;
        &lt;/div&gt;
        &lt;% }); %&gt;
      &lt;/div&gt;
      &lt;% }); %&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML for the view groups the metrics by show. Every performance associated with the show is displayed in this group, with the occupied count used to populate a Bootstrap progress bar. The width of the bar is computed with the occupied count for the performance and the capacity for the show (i.e. capacity for the venue hosting the show).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_displaying_the_bot_interface">Displaying the Bot interface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_bot_model">The Bot model</h3>
<div class="paragraph">
<p>We&#8217;ll define a plain JavaScript object to represent the Bot on the client-side. Recalling the earlier discussion, the Bot service at the server is not a RESTful service. Since it cannot be identified uniquely, it would require a few bypasses in a Backbone model (like overriding the <code>url</code> property) to communicate correctly with the service. Additionally, obtaining the Bot&#8217;s log messages would require using jQuery since the log messages also cannot be represented cleanly as a REST resource. Given all these factors, it would make sense to use a plain JavaScript object to represent the Bot model.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/models/bot.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Module for the Bot model
 */
define([
    'jquery',
    'configuration',
], function ($, config) {

    /**
     * The Bot model class definition
     * Used perform operations on the Bot.
     * Note that this is not a Backbone model.
     */
    var Bot = function() {
        this.statusUrl = config.baseUrl + 'rest/bot/status';
        this.messagesUrl = config.baseUrl + 'rest/bot/messages';
    }

    /*
     * Start the Bot by sending a request to the Bot resource
     * with the new status of the Bot set to "RUNNING".
     */
    Bot.prototype.start = function() {
        $.ajax({
            type: "PUT",
            url: this.statusUrl,
            data: "\"RUNNING\"",
            dataType: "json",
            contentType: "application/json"
        });
    }

    /*
     * Stop the Bot by sending a request to the Bot resource
     * with the new status of the Bot set to "NOT_RUNNING".
     */
    Bot.prototype.stop = function() {
        $.ajax({
            type: "PUT",
            url: this.statusUrl,
            data: "\"NOT_RUNNING\"",
            dataType: "json",
            contentType: "application/json"
        });
    }

    /*
     * Stop the Bot and delete all bookings by sending a request to the Bot resource
     * with the new status of the Bot set to "RESET".
     */
    Bot.prototype.reset = function() {
        $.ajax({
            type: "PUT",
            url: this.statusUrl,
            data: "\"RESET\"",
            dataType: "json",
            contentType: "application/json"
        });
    }

    /*
     * Fetch the log messages of the Bot and invoke the callback.
     * The callback is provided with the log messages (an array of Strings).
     */
    Bot.prototype.fetchMessages = function(callback) {
        $.get(this.messagesUrl, function(data) {
            if(callback) {
                callback(data);
            }
        });
    }

    return Bot;

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The start, stop and rest methods issue HTTP requests to the Bot service at the <code>rest/bot/status</code> URL with jQuery. The fetchMessages method issues a HTTP request to the Bot service at the <code>rest/bot/messages</code> URL with jQuery; it accepts a callback method as a parameter and invokes the callback once it receives a response from the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_botview_view">The BotView view</h3>
<div class="paragraph">
<p>Now that we have the model, let&#8217;s create the view to control the Bot:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/bot.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'jquery',
    'underscore',
    'backbone',
  'configuration',
    'utilities',
    'text!../../../../templates/desktop/bot.html'
], function (
    $,
    _,
    Backbone,
  config,
    utilities,
    botTemplate) {

    var BotView = Backbone.View.extend({
        intervalDuration : 3000,
        initialize : function() {
            _.bind(this.liveUpdate, this);
            _.bind(this.startBot, this);
            _.bind(this.stopBot, this);
            _.bind(this.resetBot, this);
            utilities.applyTemplate($(this.el), botTemplate, {});
            this.liveUpdate();
        },
        events: {
            "click #start-bot" : "startBot",
            "click #stop-bot" : "stopBot",
            "click #reset" : "resetBot"
        },
        liveUpdate : function() {
            this.model.fetchMessages(this.renderMessages);
            var self = this;
            this.timerObject = setTimeout(function() {
                self.liveUpdate();
            }, this.intervalDuration);
        },
        renderMessages : function(data) {
            var displayMessages = data.reverse();
            var botLog = $("textarea").get(0);
            // The botLog textarea element may have been removed if the user navigated to a different view
            if(botLog) {
                botLog.value = displayMessages.join("");
            }
        },
        onClose : function() {
            if(this.timerObject) {
                clearTimeout(this.timerObject);
                delete this.timerObject;
            }
        },
        startBot : function() {
            this.model.start();
            // Refresh the log immediately without waiting for the live update to trigger.
            this.model.fetchMessages(this.renderMessages);
        },
        stopBot : function() {
            this.model.stop();
            // Refresh the log immediately without waiting for the live update to trigger.
            this.model.fetchMessages(this.renderMessages);
        },
        resetBot : function() {
            this.model.reset();
            // Refresh the log immediately without waiting for the live update to trigger.
            this.model.fetchMessages(this.renderMessages);
        }
    });

    return BotView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This view is similar to other Backbone views in most aspects, except for a few. When the view initialized, it manipulates the DOM and renders the view; this is unlike other views that are not rendered on initialization. The <code>botTemplate</code> template is used to structure the HTML. An interval timer with a pre-determined duration of 3 seconds is also created when the view is initialized. When the view is closed/destroyed, the timer if present is cleared out.</p>
</div>
<div class="paragraph">
<p>When the timer is triggered, it fetches the Bot&#8217;s log messages. The <code>renderMessages</code> method is provided as the callback to the <code>fetchMessages</code> invocation. The <code>renderMessages</code> callback method is provided with the log messages from the server, and it proceeds to update a textarea with these messages.</p>
</div>
<div class="paragraph">
<p>The startBot, stopBot and resetBot event handlers are setup to handle click events on the associated buttons in the view. They merely delegate to the model to perform the actual operations.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/bot.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="col-md-12"&gt;
  &lt;h3 class="page-header light-font special-title"&gt;Bot&lt;/h3&gt;
  &lt;div id="bot-content"&gt;
    &lt;div class="btn-group"&gt;
      &lt;button id="start-bot" type="button" class="btn btn-danger" title="Start the bot"&gt;Start bot&lt;/button&gt;
      &lt;button id="stop-bot" type="button" class="btn btn-danger"&gt;Stop bot&lt;/button&gt;
      &lt;button id="reset" type="button" class="btn btn-danger" title="Delete all bookings (stops the bot first)"&gt;Delete all bookings&lt;/button&gt;
    &lt;/div&gt;
    &lt;div class="bot-console"&gt;
      &lt;div class="bot-label"&gt;Bot Log&lt;/div&gt;
      &lt;textarea style="width: 400px; height: 300px;" readonly=""&gt;&lt;/textarea&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML for the view creates a button group for the actions possible on the Bot. It also carries a text area for displaying the Bot&#8217;s log messages.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_dashboard">Creating the dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have the constituent views for the dashboard, let&#8217;s wire it up into the application.</p>
</div>
<div class="sect2">
<h3 id="_creating_a_composite_monitor_view">Creating a composite Monitor view</h3>
<div class="paragraph">
<p>Let&#8217;s create a composite Backbone view to hold the MetricsView and BotView as it&#8217;s constituent sub-views.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/views/desktop/monitor.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define([
    'backbone',
  'configuration',
    'utilities',
    'app/models/bot',
    'app/collections/metrics',
    'app/views/desktop/bot',
    'app/views/desktop/metrics',
    'text!../../../../templates/desktop/monitor.html'
], function (
    Backbone,
  config,
    utilities,
    Bot,
    Metrics,
    BotView,
    MetricsView,
    monitorTemplate) {

    var MonitorView = Backbone.View.extend({
        render : function () {
            utilities.applyTemplate($(this.el), monitorTemplate, {});
            var metrics = new Metrics();
            this.metricsView = new MetricsView({collection:metrics, el:$("#metrics-view")});
            var bot = new Bot();
            this.botView = new BotView({model:bot,el:$("#bot-view")});
            return this;
        },
        onClose : function() {
            if(this.botView) {
                this.botView.close();
            }
            if(this.metricsView) {
                this.metricsView.close();
            }
        }
    });

    return MonitorView;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The render method of this Backbone view creates the two sub-views and renders them. It also initializes the necessary models and collections required by the sub-views. All other aspects of the view like event handling and updates to the DOM are handled by the sub-views. When the composite view is destroyed, it also closes the sub-views gracefully.</p>
</div>
<div class="paragraph">
<p>The HTML template used by the composite just lays out a structure for the sub-views to control two distinct areas of the DOM - a div with id <code>metrics-view</code> for displaying the metrics, and another div with id <code>bot-view</code> to control the bot:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/templates/desktop/monitor.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;div class="container"&gt;
  &lt;div class="row"&gt;
    &lt;div id="metrics-view" class="col-md-7"&gt;&lt;/div&gt;
    &lt;div id="bot-view" class="col-md-5"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configure_the_router">Configure the router</h3>
<div class="paragraph">
<p>Finally, let us wire up the router to display the monitor when the user navigates to the <code>monitor</code> route in the Backbone application:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/router/desktop/router.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">define("router", [
    ...
    'app/views/desktop/monitor',
    ...
],function (...
            MonitorView,
            ...) {

    ...

    var Router = Backbone.Router.extend({
        ...
        routes : {
            ...,
            "monitor":"displayMonitor"
        },
        ...,
        displayMonitor:function() {
            var monitorView = new MonitorView({el:$("#content")});
            utilities.viewManager.showView(monitorView);
        },
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this configuration, the user can now navigate to the monitor section of the application, where the metrics and the bot controls would be displayed. The underlying sub-views would poll against the server to update themselves in near real-time offering a dashboard solution to TicketMonster.</p>
</div>
</div>
</div>
</div>
<h1 id="_creating_hybrid_mobile_versions_of_the_application_with_apache_cordova" class="sect0">Creating hybrid mobile versions of the application with Apache Cordova</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_6">What will you learn here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You finished creating the front-end for your application, and it has mobile support. You would now like to provide native client applications that your users can download from an application store. After reading this tutorial, you will understand how to reuse the existing HTML5 code for create native mobile clients for each target platform with Apache Cordova.</p>
</div>
<div class="paragraph">
<p>You will learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>make changes to an existing web application to allow it to be deployed as a hybrid mobile application</p>
</li>
<li>
<p>create a native application for Android and iOS with Apache Cordova</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_are_hybrid_mobile_applications">What are hybrid mobile applications?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hybrid mobile applications are developed in HTML5 - unlike native applications that are compiled to platform-specific binaries. The client code - which consists exclusively of HTML, CSS, and JavaScript - is packaged and installed on the client device just as any native application, and executes in a browser process created by a surrounding native shell.</p>
</div>
<div class="paragraph">
<p>Besides wrapping the browser process, the native shell also allows access to native device capabilities, such as the accelerometer, GPS, contact list, etc., made available to the application through JavaScript libraries.</p>
</div>
<div class="paragraph">
<p>In this example, we use Apache Cordova to implement a hybrid application using the existing HTML5 mobile front-end for TicketMonster, interacting with the RESTful services of a TicketMonster deployment running on JBoss A7 or JBoss EAP.</p>
</div>
<div id="ticket_monster_hybrid" class="imageblock">
<div class="content">
<img src="gfx/ticket_monster_hybrid.png" alt="ticket monster hybrid">
</div>
<div class="title">Figure 106. Architecture of hybrid TicketMonster</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tweak_your_application_for_remote_access">Tweak your application for remote access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we make the application hybrid, we need to make some changes in the way in which it accesses remote services. Note that the changes have already been implemented in the user front end, here we show you the code that we needed to modify.</p>
</div>
<div class="paragraph">
<p>In the web version of the application the client code is deployed together with the server-side code, so the models and collections (and generally any piece of code that will perform REST service invocations) can use URLs relative to the root of the application: all resources are serviced from the same server, so the browser will do the correct invocation. This also respects the same origin policy enforced by default by browsers, to prevent cross-site scripting attacks.</p>
</div>
<div class="paragraph">
<p>If the client code is deployed separately from the services, the REST invocations must use absolute URLs (we will cover the impact on the same-origin policy later). Furthermore, since we want to be able to deploy the application to different hosts without rebuilding the source, it must be configurable.</p>
</div>
<div class="paragraph">
<p>You already caught a glimpse of this in the user front end chapter, where we defined the <code>configuration</code> module for the mobile version of the application.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/mobile.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">...
define("configuration", function() {
    if (window.TicketMonster != undefined &amp;&amp; TicketMonster.config != undefined) {
        return {
            baseUrl: TicketMonster.config.baseRESTUrl
        };
    } else {
        return {
            baseUrl: ""
        };
    }
});
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This module has a <code>baseURL</code> property that is either set to an empty string for relative URLs or to a prefix, such as a domain name, depending on whether a global variable named <code>TicketMonster</code> has already been defined, and it has a <code>baseRESTUrl</code>
property.</p>
</div>
<div class="paragraph">
<p>All our code that performs REST services invocations depends on this module, thus the base REST URL can be configured in a single place and injected throughout the code, as in the following code example:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/models/event.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">/**
 * Module for the Event model
 */
define([
    'configuration',
    'backbone'
], function (config) {
    /**
     * The Event model class definition
     * Used for CRUD operations against individual events
     */
    var Event = Backbone.Model.extend({
        urlRoot: config.baseUrl + 'rest/events' // the URL for performing CRUD operations
    });
    // export the Event class
    return Event;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The prefix is used in a similar fashion by all the other modules that perform REST service invocations. You don&#8217;t need to do anything right now, because the code we created in the user front end tutorial was written like this originally. Be warned, if you have a mobile web application that uses any relative URLs, you will need to refactor them to include some form of URL configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_hybrid_mobile_tools_and_cordovasim">Install Hybrid Mobile Tools and CordovaSim</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hybrid Mobile Tools and CordovaSim are not installed as part of JBoss Developer Studio yet. They can be installed from JBoss Central as shown below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To install these plug-ins, drag the following link into JBoss Central: <a href="https://devstudio.jboss.com/central/install?connectors=org.jboss.tools.aerogear.hybrid" class="bare">https://devstudio.jboss.com/central/install?connectors=org.jboss.tools.aerogear.hybrid</a>. Alternatively, in JBoss Central select the <strong>Software/Update</strong> tab. In the <strong>Find</strong> field, type <strong>JBoss Hybrid Mobile Tools</strong> or scroll through the list to locate <strong>JBoss Hybrid Mobile Tools + CordovaSim</strong>. Select the corresponding check box and click <strong>Install</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="gfx/start-hybrid-mobile-tools-cordovasim-installation-with-link.png" alt="start hybrid mobile tools cordovasim installation with link">
</div>
<div class="title">Figure 107. Start the Hybrid Mobile Tools and CordovaSim Installation Process with the Link</div>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/find-hybrid-mobile-tools-cordovasim.png" alt="find hybrid mobile tools cordovasim">
</div>
<div class="title">Figure 108. Find Hybrid Mobile Tools and CordovaSim in JBoss Central Software/Update Tab</div>
</div>
</li>
<li>
<p>In the <strong>Install</strong> wizard, ensure the check boxes are selected for the software you want to install and click <strong>Next</strong>. It is recommended that you install all of the selected components.</p>
</li>
<li>
<p>Review the details of the items listed for install and click Next. After reading and agreeing to the license(s), click <strong>I accept the terms of the license agreement(s)</strong> and click <strong>Finish</strong>. The <strong>Installing Software</strong> window opens and reports the progress of the installation.</p>
</li>
<li>
<p>During the installation process you may receive warnings about installing unsigned content. If this is the case, check the details of the content and if satisfied click <strong>OK</strong> to continue with the installation.</p>
<div class="imageblock">
<div class="content">
<img src="gfx/warning-prompt-unsigned-content.png" alt="warning prompt unsigned content">
</div>
<div class="title">Figure 109. Warning Prompt for Installing Unsigned Content</div>
</div>
</li>
<li>
<p>Once the installation is complete, you will be prompted to restart the IDE. Click <strong>Yes</strong> to restart now and <strong>No</strong> if you need to save any unsaved changes to open projects. Note that changes do not take effect until the IDE is restarted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once installed, you must inform Hybrid Mobile Tools of the Android SDK location before you can use Hybrid Mobile Tools actions involving Android.</p>
</div>
<div class="paragraph">
<p>To set the Android SDK location, click <strong>Window</strong>  <strong>Preferences</strong> and select <strong>Hybrid Mobile</strong>. In the <strong>Android SDK Directory</strong> field, type the path of the installed SDK or click <strong>Browse</strong> to navigate to the location. Click <strong>Apply</strong> and click <strong>OK</strong> to close the <strong>Preferences</strong> window.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/hybrid-mobile-pane-preferences-window.png" alt="hybrid mobile pane preferences window">
</div>
<div class="title">Figure 110. Hybrid Mobile Pane of Preferences Window</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_hybrid_mobile_project">Creating a Hybrid Mobile project</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To create a new Hybrid Mobile Project, click <em>File  New  Other</em> and select "Hybrid Mobile (Cordova) Application Project".</p>
<div class="imageblock">
<div class="content">
<img src="gfx/start-new-hybrid-mobile-application-project.png" alt="start new hybrid mobile application project">
</div>
<div class="title">Figure 111. Starting a new Hybrid Mobile Application project</div>
</div>
</li>
<li>
<p>Enter the project information: application name, project name, package.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Project Name</dt>
<dd>
<p>TicketMonster-Cordova</p>
</dd>
<dt class="hdlist1">Name</dt>
<dd>
<p>TicketMonster-Cordova</p>
</dd>
<dt class="hdlist1">ID</dt>
<dd>
<p>org.jboss.examples.ticketmonster.cordova</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/create-new-hybrid-mobile-application-project.png" alt="create new hybrid mobile application project">
</div>
<div class="title">Figure 112. Creating a new Hybrid Mobile Application project</div>
</div>
<div class="paragraph">
<p>Click <code>Next</code> to choose the Hybrid Mobile engine for the project. If you have never setup a Hybrid Mobile engine in JBoss Developer Studio before, you will be prompted to download or search for engines to use. We&#8217;ll click on the <code>Download</code> button to perform the former.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/setup_hybrid_mobile_engine_from_scratch.png" alt="setup hybrid mobile engine from scratch">
</div>
<div class="title">Figure 113. Setting up a Hybrid Mobile engine for the first time</div>
</div>
<div class="paragraph">
<p>You&#8217;ll be prompted with a dialog where you can download all available hybrid mobile engines.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/setup_hybrid_mobile_engine_version.png" alt="setup hybrid mobile engine version">
</div>
<div class="title">Figure 114. Choose the Hybrid Mobile engine to download</div>
</div>
<div class="paragraph">
<p>We&#8217;ll choose Android and iOS variants of version 3.4.0.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/setup_hybrid_mobile_engine_340.png" alt="setup hybrid mobile engine 340">
</div>
<div class="title">Figure 115. Select Android and iOS for 3.4.0</div>
</div>
<div class="paragraph">
<p>Now that we have downloaded and setup a hybrid mobile engine, let&#8217;s use it in our project. Select the newly configured engine and click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/select_hybrid_mobile_engine_for_project.png" alt="select hybrid mobile engine for project">
</div>
<div class="title">Figure 116. Creating a new Hybrid Mobile Application project</div>
</div>
<div class="paragraph">
<p>We will now be provided the opportunity to add Cordova plug-ins to our project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordova_choose_to_add_plugins.png" alt="cordova choose to add plugins">
</div>
<div class="title">Figure 117. Adding Cordova plugins when a new Hybrid Mobile Application project</div>
</div>
<div class="paragraph">
<p>We will be using the Status Bar plugin from Cordova, to ensure that the status bar on iOS 7 does not overlap the UI. The Device plugin will be used to obtain device information for use in device detection. We&#8217;ll also use the Notification plugin to display alerts and notifications to the end-user using the native mobile UI. We&#8217;ll proceed to add the required Cordova plugins to the project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordova_add_device_plugin.png" alt="cordova add device plugin">
</div>
<div class="title">Figure 118. Add Cordova Device plugin</div>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordova_add_notifications_plugin.png" alt="cordova add notifications plugin">
</div>
<div class="title">Figure 119. Add Cordova Notification plugin</div>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordova_add_statusbar_plugin.png" alt="cordova add statusbar plugin">
</div>
<div class="title">Figure 120. Add Cordova StatusBar plugin</div>
</div>
<div class="paragraph">
<p>Let&#8217;s proceed to add these, by searching for them and selecting them. Click <code>Next</code> once you have finished selecting the necessary plug-ins. We will now confirm the plugins to be added to the project. Click <code>Finish</code> to create the new Hybrid Mobile application project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordova_confirm_plugin_versions.png" alt="cordova confirm plugin versions">
</div>
<div class="title">Figure 121. Confirm plugins to add</div>
</div>
<div class="paragraph">
<p>Once you have finished creating the project, navigate to the <code>www</code> directory, that will contain the HTML5 code of the application. Since we are reusing the TicketMonster code you can simply replace the <code>www</code> directory with a symbolic link to the <code>webapp</code> directory of TicketMonster; the <code>config.xml</code> file and <code>res</code> directory would need to be copied over to the <code>webapp</code> directory of TicketMonster. Alternatively, you can copy the code of TicketMonster and make all necessary changes there (however, in that case you will have to maintain the code of the application in both places); on Windows, it would be easier to do this.</p>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cp config.xml $TICKET_MONSTER_HOME/demo/src/main/webapp
$ cp res $TICKET_MONSTER_HOME/demo/src/main/webapp
$ cd ..
$ rm -rf www
$ ln -s $TICKET_MONSTER_HOME/demo/src/main/webapp www</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/link-www-directory-to-webapp.png" alt="link www directory to webapp">
</div>
<div class="title">Figure 122. The result of linking www to the webapp directory</div>
</div>
<div class="paragraph">
<p>The Hybrid Mobile tooling requires that the cordova.js file be loaded in the application&#8217;s start page.
Since we do not want to load this file in the existing <code>index.html</code> file, we shall create a new start page to be used only by the Cordova app.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/mobileapp.html</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="html" class="language-html hljs">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Ticket Monster&lt;/title&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/&gt;

    &lt;script type="text/javascript" src="resources/js/libs/modernizr-2.8.3.min.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript" src="resources/js/libs/require.js"
            data-main="resources/js/configurations/loader"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now modify the Hybrid Mobile project configuration to use this page as the application start page.
Additionally, we will add our REST service URL to the domain whitelist in the config.xml file (you can use <code>"*"</code> too, for simplicity, during development) :</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/config.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;widget xmlns="http://www.w3.org/ns/widgets" xmlns:gap="http://phonegap.com/ns/1.0"
    id="org.jboss.examples.ticketmonster.cordova" version="2.0.0"&gt;

    ...

    &lt;!-- The application start page --&gt;
    &lt;content src="mobileapp.html" /&gt;

    &lt;!--
    Add the TicketMonster cloud app to the domain whitelist.
    Domains are assumed blocked unless set otherwise.
     --&gt;
    &lt;access origin="http://ticketmonster-jdf.rhcloud.com"/&gt;

    ...

&lt;/widget&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to load the library in the application. We will create a separate module, that will load the rest of the mobile application, as well as the Apache Cordova JavaScript library for Android. We also need to configure a base URL for the application. For this example, we will use the URL of the cloud deployment of TicketMonster.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/hybrid.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">// override configuration for RESTful services
var TicketMonster = {
    config:{
        baseRESTUrl:"http://ticketmonster-jdf.rhcloud.com/"
    }
};

require(['../../../cordova'], function() {

    var bootstrap = {
        initialize: function() {
            document.addEventListener('deviceready', this.onDeviceReady, false);
        },
        onDeviceReady: function() {
            // Detect if iOS 7 or higher and disable overlaying the status bar
            if(window.device &amp;&amp; window.device.platform.toLowerCase() == "ios" &amp;&amp;
                parseFloat(window.device.version) &gt;= 7.0) {
                StatusBar.overlaysWebView(false);
                StatusBar.styleDefault();
                StatusBar.backgroundColorByHexString("#e9e9e9");
            }
            // Load the mobile module
            require (["mobile"]);
        }
    };

    bootstrap.initialize();
});</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>We&#8217;ll use the OpenShift hosted version of the TicketMonster application because it is easier to access in all environments - the smartphone simulators and emulators can also access it with relatively little or no configuration. On the other hand, accessing the locally running JBoss EAP instance may require some complicated network configuration, especially if the instance needs to be opened up to the internet for access from smartphones through a mobile internet link.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above snippet of code contains a device-specific check for iOS 7.</p>
</div>
<div class="paragraph">
<p>Finally, we&#8217;ll configure the loader module launched from <code>mobileapp.html</code> to use the above defined <code>hybrid</code> module:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/loader.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">//detect the appropriate module to load
define(function () {

    /*
     A simple check on the client. For touch devices or small-resolution screens)
     show the mobile client. By enabling the mobile client on a small-resolution screen
     we allow for testing outside a mobile device (like for example the Mobile Browser
     simulator in JBoss Tools and JBoss Developer Studio).
     */

    var environment;

    if (document.URL.indexOf("mobileapp.html") &gt; -1) {
        environment = "hybrid";
    }
    else if (Modernizr.touch || Modernizr.mq("only all and (max-width: 768px)")) {
        environment = "mobile";
    } else {
        environment = "desktop";
    }

    require([environment]);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above code snippet, we detect if the URL of the page contains <code>mobileapp.html</code> or not, and then proceed to activate the <code>hybrid</code> module if so. Since Apache Cordova is configured to use <code>mobileapp.html</code> as the application start page, the desired objective is achieved. This way, we avoid loading the <code>mobile</code> or <code>desktop</code> modules that do not have any logic in them to detect the <code>deviceready</code> event of Cordova.</p>
</div>
<div class="paragraph">
<p>The final step will involve adjusting <code>src/main/webapp/resources/js/configurations/loader.js</code> to load this module when running on Android, using the query string we have already configured in the project. We&#8217;ll also tweak <code>src/main/webapp/resources/js/app/utilities.js</code> to use the Notification plugin to display alerts in the context of a Hybrid Mobile app.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/configurations/loader.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">//detect the appropriate module to load
define(function () {

    /*
     A simple check on the client. For touch devices or small-resolution screens)
     show the mobile client. By enabling the mobile client on a small-resolution screen
     we allow for testing outside a mobile device (like for example the Mobile Browser
     simulator in JBoss Tools and JBoss Developer Studio).
     */

    var environment;

    if (document.URL.indexOf("mobileapp.html") &gt; -1) {
        environment = "hybrid";
    }
    else if (Modernizr.touch || Modernizr.mq("only all and (max-width: 768px)")) {
        environment = "mobile";
    } else {
        environment = "desktop";
    }

    require([environment]);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll now examine the <code>displayAlert</code> function in the utilities object. It is set to use the Notification plugin when available:</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/resources/js/app/utilities.js</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">...
    // utility functions for rendering templates
    var utilities = {
        ...
        applyTemplate:function (target, template, data) {
            return target.empty().append(this.renderTemplate(template, data));
        },
        displayAlert: function(msg) {
            if(navigator.notification) {
                navigator.notification.alert(msg);
            } else {
                alert(msg);
            }
        }
    };
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function automatically works in non-mobile environments due to the absence of the <code>navigator.notification</code> object in such environments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_the_hybrid_mobile_application">Run the hybrid mobile application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You are now ready to run the application. The hybrid mobile application can be run on devices and simulators using the Hybrid Mobile Tools.</p>
</div>
<div class="sect2">
<h3 id="_run_on_an_android_device_or_emulator">Run on an Android device or emulator</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">What do you need for Android?</div>
<div class="paragraph">
<p>For running on an Android device or emulator, you need to install the Android
Developer Tools, which require an Eclipse instance (JBoss Developer Studio could be used), and can run on
Windows (XP, Vista, 7), Mac OS X (10.5.8 or later), Linux (with GNU C Library - glibc 2.7 or
later, 64-bit distributions having installed the libraries for running 32-bit applications).</p>
</div>
<div class="paragraph">
<p>You must have Android API 17 or later installed on your system to use the <strong>Run on Android Emulator</strong> action.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run the project on a device, in the <strong>Project Explorer</strong> view, right-click the project name and click <strong>Run As</strong>  <strong>Run on Android Device</strong>. This option calls the external Android SDK to package the workspace project and run it on an Android device if one is attached. Note that the Android SDK must be installed and the IDE correctly configured to use the Android SDK for this option to execute successfully.</p>
</div>
<div class="paragraph">
<p>To run the project on an emulator, in the <strong>Project Explorer</strong> view, right-click the project name and click <strong>Run As</strong>  <strong>Run on Android Emulator</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/run-on-android-emulator.png" alt="run on android emulator">
</div>
<div class="title">Figure 123. Running the application on an Android emulator</div>
</div>
<div class="paragraph">
<p>This requires that you create an Android AVD to run the application in a virtual device.</p>
</div>
<div class="paragraph">
<p>Once deployed, the application is now available for interaction in the emulator.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/android-emulator.png" alt="android emulator">
</div>
<div class="title">Figure 124. The app running on an Android AVD</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_on_an_ios_simulator">Run on an iOS Simulator</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">What do you need for iOS?</div>
<div class="paragraph">
<p>This option is only displayed when using OS X operating systems, for which the iOS Simulator is available.
You must install <strong>Xcode 4.5+</strong> which includes the <strong>iOS 6 SDK</strong>. You must also install a Simulator for iOS 5.x or higher, to run the project on a simulator.
Depending on various Cordova plugins that you may use, you may need higher versions of simulators to run your applications.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Project Explorer view, right-click the project name and click <strong>Run As</strong>  <strong>Run on iOS Emulator</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/run-on-ios-simulator.png" alt="run on ios simulator">
</div>
<div class="title">Figure 125. Running the application on an iOS simulator</div>
</div>
<div class="paragraph">
<p>This option calls the external iOS SDK to package the workspace project into an XCode project and run it on the iOS Simulator.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/ios-simulator.png" alt="ios simulator">
</div>
<div class="title">Figure 126. The app running on an iOS Simulator</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_on_cordovasim">Run on CordovaSim</h3>
<div class="paragraph">
<p>CordovaSim allows you to run your hybrid mobile applications in your local workspace. You can develop the application without requiring a deployment to a real device or even to emulators and simulators to realize your application&#8217;s behavior.
There are some limitations on what you can achieve with CordovaSim, for instance, some Cordova plugins may not work with CordovaSim. But for the most part, you get to experience a faster development cycle.</p>
</div>
<div class="paragraph">
<p>In the Project Explorer view, right-click the project name and click <strong>Run As</strong>  <strong>Run with CordovaSim</strong>. This opens the application in CordovaSim, which is composed of a BrowserSim simulated device and a device input panel.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="gfx/cordovasim.png" alt="cordovasim">
</div>
<div class="title">Figure 127. The app running on CordovaSim</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This concludes our tutorial for building a hybrid application with Apache Cordova. You have seen how we have turned a working HTML5 web application into one that can run natively on Android and iOS.</p>
</div>
</div>
</div>
<h1 id="_appendix_a_deploying_to_jboss_eap_locally" class="sect0">Appendix A - Deploying to JBoss EAP locally</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_7">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This appendix demonstrates how to import, develop and deploy the TicketMonster example using JBoss Developer Studio:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain and import the TicketMonster example source code</p>
</li>
<li>
<p>Deploy the application to JBoss EAP with JBoss Server Tools</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pre_requisites">Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We don&#8217;t recommend using the <strong>Internal Web Browser</strong>, although it is configured as the default web browser in the IDE.
In certain environments, it may lack features present in modern web browsers, thus providing a sub-optimal user and developer experience.</p>
</div>
<div class="paragraph">
<p>We shall therefore set the IDE default web browser to be your default system web browser. Click <strong>Window</strong>  <strong>Web
Browser</strong>  <strong>Default system web browser</strong>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_import_the_project_source_code">Import the Project source code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the TicketMonster source code is obtained and unpackaged, you must import it into JBoss
Developer Studio, as detailed in the procedure below. TicketMonster is a Maven-based project so a
specific Import Maven Project wizard is used for the import.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click <strong>File</strong>  <strong>Import</strong> to open the <strong>Import</strong> wizard.</p>
</li>
<li>
<p>Expand <strong>Maven</strong>, select <strong>Existing Maven Projects</strong> and click <strong>Next</strong>.</p>
</li>
<li>
<p>In the <strong>Root Directory</strong> field, enter the path to the TicketMonster source code. Alternatively,
click <strong>Browse</strong> to navigate to the source code location. The <strong>Import Maven Project</strong> wizard
recursively searches the path for a <strong>pom.xml</strong> file. The <strong>pom.xml</strong> file identifies the project as a
Maven project. The file is listed under <strong>Projects</strong> once it is found.</p>
<div class="imageblock">
<div class="content">
<img src="gfx/pom-file-projects-pane.png" alt="pom file projects pane">
</div>
<div class="title">Figure 128. pom.xml File Listed in the Projects Pane</div>
</div>
</li>
<li>
<p>Click <strong>Finish</strong>. When the import process is complete, the project is listed in the <strong>Project Explorer</strong> view.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_to_jboss_eap_using_jboss_developer_studio">Deploying to JBoss EAP using JBoss Developer Studio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have imported the TicketMonster source code into JBoss Developer Studio, the project
application can be deployed to the JBoss EAP server and the running application viewed in the
default system web browser, as detailed in the procedure below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <strong>Project Explorer</strong> view, right-click <strong>ticket-monster</strong> and click <strong>Run As</strong>  <strong>Run on
Server</strong>.</p>
</li>
<li>
<p>Under <strong>How do you want to select the server?</strong>, ensure <strong>Choose an existing
server</strong> is selected.</p>
</li>
<li>
<p>In the <strong>Server</strong> table, expand <strong>localhost</strong>, select <strong>jboss-eap-version</strong> where version
denotes the JBoss EAP version, and click <strong>Next</strong>.</p>
<div id="jboss-eap-selected-deployment" class="imageblock">
<div class="content">
<img src="gfx/jboss-eap-selected-deployment.png" alt="jboss eap selected deployment">
</div>
<div class="title">Figure 129. JBoss EAP 6.x Server Selected</div>
</div>
</li>
<li>
<p>Ensure <strong>ticket-monster</strong> is listed in the <strong>Configured</strong> column and click Finish. The
<strong>Console</strong> view automatically becomes the view in focus and displays the output from the
JBoss EAP server. Once deploying is complete, the web application opens in the default
system web browser.</p>
<div id="ticketmonster-configured-jboss-eap" class="imageblock">
<div class="content">
<img src="gfx/ticketmonster-configured-jboss-eap.png" alt="ticketmonster configured jboss eap">
</div>
<div class="title">Figure 130. ticket-monster Listed in the Configured Column</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_to_jboss_eap_using_the_command_line">Deploying to JBoss EAP using the command-line</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Start JBoss Enterprise Application Platform 6.3</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command line and navigate to the root of the JBoss server directory.</p>
</li>
<li>
<p>The following shows the command line to start the server with the web profile:</p>
<div class="listingblock">
<div class="content">
<pre>For Linux:   JBOSS_HOME/bin/standalone.sh
For Windows: JBOSS_HOME\bin\standalone.bat</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, <em>deploy TicketMonster</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have started the JBoss Server as described above.</p>
</li>
<li>
<p>Type this command to build and deploy the archive into a running server instance.</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy</pre>
</div>
</div>
<div class="paragraph">
<p>(You can use the <code>arq-jbossas-remote</code> profile for running tests as well)</p>
</div>
<div class="paragraph">
<p>If you have not configured the Maven settings, to use the Red Hat Enterprise Maven repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy -s TICKETMONSTER_MAVEN_PROJECT_ROOT/settings.xml</pre>
</div>
</div>
</li>
<li>
<p>This will deploy <code>target/ticket-monster.war</code> to the running instance of the server.</p>
</li>
<li>
<p>Now you can see the application running at <a href="http://localhost:8080/ticket-monster" class="bare">http://localhost:8080/ticket-monster</a>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_mysql_as_the_database">Using MySQL as the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can deploy TicketMonster to JBoss EAP, making use of a 'real' database like MySQL, instead of the default in-memory H2 database. You can follow the procedure outlined as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the MySQL JBDC driver as a new JBoss module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Define a new JBoss module named <code>com.mysql</code> under the <code>modules</code> directory of the JBoss EAP installation. Under the <code>modules/system/layers/base</code> directory structure, create a directory named <code>com</code>, containing sub-directory named <code>mysql</code>, containing a sub-directory named <code>main</code>. Place the MySQL JBDC driver in the <code>main</code> directory. Finally, define the module via a <code>module.xml</code> file with the following contents:</p>
<div class="listingblock">
<div class="title">EAP_HOME/system/layers/base/com/mysql/main/module.xml</div>
<div class="content">
<pre>&lt;module xmlns="urn:jboss:module:1.0" name="com.mysql"&gt;
   &lt;resources&gt;
     &lt;resource-root path="mysql-connector-java-5.1.34-bin.jar"/&gt;

   &lt;/resources&gt;

   &lt;dependencies&gt;
      &lt;module name="javax.api"/&gt;
      &lt;module name="javax.transaction.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This module declares the MySQL JDBC driver as a resource (from which to load classes) for the module. It also declares a dependency on the <code>javax.api</code> and <code>javax.transaction.api</code> modules, since the JDBC driver depends on classes from these modules. Remember to make corrections to the JBDC driver resource path, if you are using a driver JAR with a different name.
The JBoss EAP directory structure should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>modules
+---system
   +---layers
       +---base
           +---com
               +---mysql
                   +---main
                       +-------module.xml
                       +-------mysql-connector-java-5.1.34-bin.jar</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Register the MySQL datasource used by the application. Edit the server configuration file (<code>standalone.xml</code>), to add the datasource definition:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;datasources&gt;
   &lt;datasource jndi-name="java:jboss/datasources/TicketMonsterMySQLDS" pool-name="MySQLDS"&gt;
      &lt;connection-url&gt;jdbc:mysql://localhost:3306/ticketmonster&lt;/connection-url&gt;
      &lt;driver&gt;com.mysql&lt;/driver&gt;
      &lt;transaction-isolation&gt;TRANSACTION_READ_COMMITTED&lt;/transaction-isolation&gt;
      &lt;pool&gt;
        &lt;min-pool-size&gt;10&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;100&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
      &lt;/pool&gt;
      &lt;security&gt;
        &lt;user-name&gt;test&lt;/user-name&gt;
        &lt;password&gt;test&lt;/password&gt;
      &lt;/security&gt;
      &lt;statement&gt;
        &lt;prepared-statement-cache-size&gt;32&lt;/prepared-statement-cache-size&gt;
        &lt;share-prepared-statements/&gt;
      &lt;/statement&gt;
    &lt;/datasource&gt;
    &lt;drivers&gt;
      &lt;driver name="com.mysql" module="com.mysql"&gt;
	  	&lt;driver-class&gt;com.mysql.jdbc.Driver&lt;/driver-class&gt;
        &lt;xa-datasource-class&gt;com.mysql.jdbc.jdbc2.optional.MysqlXADataSource&lt;/xa-datasource-class&gt;
      &lt;/driver&gt;
    &lt;/drivers&gt;
&lt;/datasources&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Replace the values for the <code>connection-url</code>, <code>user-name</code> and <code>password</code> with the correct ones for your environment.</p>
</div>
</li>
<li>
<p>Build and deploy the application, using the <code>mysql</code> profile defined in the project POM :</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In JBoss Developer Studio, you can do this by opening the project&#8217;s context menu: right-click on the project, click <strong>Maven</strong>  <strong>Select Maven Profiles&#8230;&#8203;</strong>, and activate the <code>mysql</code> profile by selecting it&#8217;s checkbox. Once you have activated the profile, you can publish the project to a JBoss EAP instance from JBoss Developer Studio in the same manner described previously.</p>
</li>
<li>
<p>If you are building and deploying from the command-line, activate the <code>mysql</code> profile, by specifying it during the build command like so:</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy -Pmysql</pre>
</div>
</div>
</li>
<li>
<p>If you have not configured the Maven settings, to use the Red Hat Enterprise Maven repositories:</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy -Pmysql -s TICKETMONSTER_MAVEN_PROJECT_ROOT/settings.xml</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_postgresql_as_the_database">Using PostgreSQL as the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just like MySQL, you can deploy TicketMonster to JBoss EAP, making use of a 'real' database like PostgreSQL, instead of the default in-memory H2 database. You can follow the procedure outlined as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the PostgreSQL JBDC driver as a new JBoss module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Define a new JBoss module named <code>com.mysql</code> under the <code>modules</code> directory of the JBoss EAP installation. Under the <code>modules/system/layers/base</code> directory structure, create a directory named <code>org</code>, containing sub-directory named <code>postgresql</code>, containing a sub-directory named <code>main</code>. Place the PostgreSQL JBDC driver in the <code>main</code> directory. Finally, define the module via a <code>module.xml</code> file with the following contents:</p>
<div class="listingblock">
<div class="title">EAP_HOME/system/layers/base/com/mysql/main/module.xml</div>
<div class="content">
<pre>&lt;module xmlns="urn:jboss:module:1.0" name="org.postgresql"&gt;
   &lt;resources&gt;
     &lt;resource-root path="postgresql-9.3-1102.jdbc4.jar"/&gt;
   &lt;/resources&gt;

   &lt;dependencies&gt;
      &lt;module name="javax.api"/&gt;
      &lt;module name="javax.transaction.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This module declares the PostgreSQL JDBC driver as a resource (from which to load classes) for the module. It also declares a dependency on the <code>javax.api</code> and <code>javax.transaction.api</code> modules, since the JDBC driver depends on classes from these modules. Remember to make corrections to the JBDC driver resource path, if you are using a driver JAR with a different name.
The JBoss EAP directory structure should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>modules
+---system
   +---layers
       +---base
           +---org
               +---postgresql
                   +---main
                       +-------module.xml
                       +-------postgresql-9.3-1102.jdbc4.jar</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Register the PostgreSQL datasource used by the application. Edit the server configuration file (<code>standalone.xml</code>), to add the datasource definition:</p>
<div class="listingblock">
<div class="content">
<pre>&lt;datasources&gt;
   &lt;datasource jndi-name="java:jboss/datasources/TicketMonsterPostgreSQLDS" pool-name="PostgreSQLDS"&gt;
      &lt;connection-url&gt;jdbc:postgresql://localhost:5432/ticketmonster&lt;/connection-url&gt;
      &lt;driver&gt;org.postgresql&lt;/driver&gt;
      &lt;transaction-isolation&gt;TRANSACTION_READ_COMMITTED&lt;/transaction-isolation&gt;
      &lt;pool&gt;
        &lt;min-pool-size&gt;10&lt;/min-pool-size&gt;
        &lt;max-pool-size&gt;100&lt;/max-pool-size&gt;
        &lt;prefill&gt;true&lt;/prefill&gt;
      &lt;/pool&gt;
      &lt;security&gt;
        &lt;user-name&gt;test&lt;/user-name&gt;
        &lt;password&gt;test&lt;/password&gt;
      &lt;/security&gt;
      &lt;statement&gt;
        &lt;prepared-statement-cache-size&gt;32&lt;/prepared-statement-cache-size&gt;
        &lt;share-prepared-statements/&gt;
      &lt;/statement&gt;
    &lt;/datasource&gt;
    &lt;drivers&gt;
      &lt;driver name="org.postgresql" module="org.postgresql"&gt;
        &lt;xa-datasource-class&gt;org.postgresql.xa.PGXADataSource&lt;/xa-datasource-class&gt;
      &lt;/driver&gt;
    &lt;/drivers&gt;
&lt;/datasources&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Replace the values for the <code>connection-url</code>, <code>user-name</code> and <code>password</code> with the correct ones for your environment.</p>
</div>
</li>
<li>
<p>Build and deploy the application, using the <code>postgresql</code> profile defined in the project POM :</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In JBoss Developer Studio, you can do this by opening the project&#8217;s context menu: right-click on the project, click <strong>Maven</strong>  <strong>Select Maven Profiles&#8230;&#8203;</strong>, and activate the <code>postgresql</code> profile by selecting it&#8217;s checkbox. Once you have activated the profile, you can publish the project to a JBoss EAP instance from JBoss Developer Studio in the same manner described previously.</p>
</li>
<li>
<p>If you are building and deploying from the command-line, activate the <code>postgresql</code> profile, by specifying it during the build command like so:</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy -Ppostgresql</pre>
</div>
</div>
</li>
<li>
<p>If you have not configured the Maven settings, to use the Red Hat Enterprise Maven repositories:</p>
<div class="listingblock">
<div class="content">
<pre>mvn clean package jboss-as:deploy -Ppostgresql -s TICKETMONSTER_MAVEN_PROJECT_ROOT/settings.xml</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<h1 id="_appendix_b_deploying_to_openshift" class="sect0">Appendix B - Deploying to OpenShift</h1>
<div class="sect1">
<h2 id="_what_will_you_learn_here_8">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This appendix demonstrates how to import, develop and deploy the TicketMonster example using JBoss Developer Studio:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain and import the TicketMonster example source code</p>
</li>
<li>
<p>Deploy the application to OpenShift Online with OpenShift Tools</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_import_the_project_source_code_2">Import the Project source code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the TicketMonster source code is obtained and unpackaged, you must import it into JBoss
Developer Studio, as detailed in the procedure below. TicketMonster is a Maven-based project so a
specific Import Maven Project wizard is used for the import.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click <strong>File</strong><strong>Import</strong> to open the <strong>Import</strong> wizard.</p>
</li>
<li>
<p>Expand <strong>Maven</strong>, select <strong>Existing Maven Projects</strong> and click <strong>Next</strong>.</p>
</li>
<li>
<p>In the <strong>Root Directory</strong> field, enter the path to the TicketMonster source code. Alternatively,
click <strong>Browse</strong> to navigate to the source code location. The <strong>Import Maven Project</strong> wizard
recursively searches the path for a <strong>pom.xml</strong> file. The <strong>pom.xml</strong> file identifies the project as a
Maven project. The file is listed under <strong>Projects</strong> once it is found.</p>
<div class="imageblock">
<div class="content">
<img src="gfx/pom-file-projects-pane.png" alt="pom file projects pane">
</div>
<div class="title">Figure 131. pom.xml File Listed in the Projects Pane</div>
</div>
</li>
<li>
<p>Click <strong>Finish</strong>. When the import process is complete, the project is listed in the <strong>Project Explorer</strong> view.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pre_requisites_2">Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will be pushing the TicketMonster sources to a git repository on OpenShift, where the application would be built and deployed.
The build on OpenShift, and hence the <code>git push</code> can timeout, since Maven dependencies will have to be fetched from the Red Hat Enterprise Maven repository or other repositories.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll get around this drawback by configuring JBoss Developer Studio to not time out sooner. To do do, set the Git connection timeout to 300 seconds. Click <strong>Window</strong>  <strong>Preferences</strong>, expand <strong>Team</strong> and
select <strong>Git</strong>. In the <strong>Remote connection timeout (seconds)</strong> field, type <strong>300</strong> and click <strong>Apply</strong> and click <strong>OK</strong>.</p>
</div>
<div id="git-remote-connection-timeout" class="imageblock">
<div class="content">
<img src="gfx/git-remote-connection-timeout.png" alt="git remote connection timeout">
</div>
<div class="title">Figure 132. Modify the git remote connection timeout</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_to_openshift_using_jboss_developer_studio">Deploying to OpenShift using JBoss Developer Studio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To deploy TicketMonster to OpenShift Online, you must create a new OpenShift Online application based on the existing workspace project using OpenShift Tools, as detailed in the procedure below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This procedure documents the deploying process for first-time OpenShift Online users. This
includes one-time steps, such as signing up for an OpenShift Online account, creating an
OpenShift Online domain and uploading SSH keys. If you have previously used OpenShift
Online and OpenShift Tools, omit the one-time steps as appropriate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In JBoss Central, under Start from scratch, click OpenShift Application.</p>
</li>
<li>
<p>Click the <em>Please sign up here</em> link to create an OpenShift Online account and follow the
instructions on the OpenShift web page displayed in your default system web browser. Once
you have completed the sign-up process, restart the New OpenShift Application wizard.</p>
</li>
<li>
<p>Complete the fields about your OpenShift Online account as follows:</p>
<div class="ulist">
<ul>
<li>
<p>From the Connection list, select New Connection.</p>
</li>
<li>
<p>Ensure the Use default server check box is selected.</p>
</li>
<li>
<p>In the Username and Password fields, type your account credentials.</p>
<div id="completed-username-password-fields" class="imageblock">
<div class="content">
<img src="gfx/completed-username-password-fields.png" alt="completed username password fields">
</div>
<div class="title">Figure 133. Completed Username and Password Fields</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click Next.</p>
</li>
<li>
<p>In the <strong>Domain Name</strong> field, type a name for your new OpenShift Online domain and click Finish. The provided domain name must be unique across all domains on OpenShift Online; if it is not unique, you will be instructed to provide a unique domain name.</p>
</li>
<li>
<p>From the Type list, select JBoss Enterprise Application Platform 6 (jbosseap-6).</p>
<div id="completed-fields-application-wizard" class="imageblock">
<div class="content">
<img src="gfx/completed-fields-application-wizard.png" alt="completed fields application wizard">
</div>
<div class="title">Figure 134. Completed Fields in the New OpenShift Application Wizard</div>
</div>
</li>
<li>
<p>Click Next.</p>
</li>
<li>
<p>Complete the fields about the new OpenShift Online application as follows:</p>
<div class="ulist">
<ul>
<li>
<p>In the Domain name field, select an existing OpenShift Online domain.</p>
</li>
<li>
<p>In the Name field, type ticketmonster.</p>
</li>
<li>
<p>From the Domain list, ensure the domain you have previously created is selected.</p>
</li>
<li>
<p>From the Gear profile list, select small.</p>
<div id="completed-fields-application-wizard-step2" class="imageblock">
<div class="content">
<img src="gfx/completed-fields-application-wizard-step2.png" alt="completed fields application wizard step2">
</div>
<div class="title">Figure 135. Completed Fields in the New OpenShift Application Wizard</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click Next.</p>
<div class="ulist">
<ul>
<li>
<p>Clear the Create a new project check box.</p>
</li>
<li>
<p>In the Use existing project field, type ticket-monster. Alternatively, click Browse to select the ticket-monster project.</p>
</li>
<li>
<p>Ensure the Create and set up a server for easy publishing check box is selected.</p>
<div id="completed-fields-application-wizard-step3" class="imageblock">
<div class="content">
<img src="gfx/completed-fields-application-wizard-step3.png" alt="completed fields application wizard step3">
</div>
<div class="title">Figure 136. Completed Fields in the New OpenShift Application Wizard</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click Next.</p>
</li>
<li>
<p>Click SSH Keys wizard and click New.</p>
</li>
<li>
<p>Complete the fields about the SSH Keys to be created as follows:</p>
<div class="ulist">
<ul>
<li>
<p>In the Name field, type a name for the SSH key.</p>
</li>
<li>
<p>From the Key Type list, ensure SSH_RSA is selected.</p>
</li>
<li>
<p>In the SSH2 Home field, ensure your .ssh directory path is shown.</p>
</li>
<li>
<p>In the Private Key File Name field, type a name for the private key file name. The Public Key File Name field populates automatically with the name of the private key file name with .pub appended.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click Finish.</p>
</li>
<li>
<p>Click OK to close the Manage SSH Keys window.</p>
</li>
<li>
<p>Click Finish to create the new OpenShift application based on the existing workspace ticket-monster project. This process may take some time to complete.</p>
<div id="new-openshift-application-wizard" class="imageblock">
<div class="content">
<img src="gfx/new-openshift-application-wizard.png" alt="new openshift application wizard">
</div>
<div class="title">Figure 137. New OpenShift Application Wizard</div>
</div>
</li>
<li>
<p>At the prompt stating OpenShift application ticketmonster will be enabled on project ticket-monster &#8230;&#8203;, click OK. This configures the workspace ticket-monster project for OpenShift and connects it to the OpenShift Online Git repository system used for version control.</p>
<div id="import-openShift-application-prompt" class="imageblock">
<div class="content">
<img src="gfx/import-openShift-application-prompt.png" alt="import openShift application prompt">
</div>
<div class="title">Figure 138. Import OpenShift Application Prompt</div>
</div>
</li>
<li>
<p>At the prompt stating the authenticity of the host cannot be established and asking if you are sure you want to continue connecting, verify the host information is correct and click Yes.</p>
</li>
<li>
<p>At the prompt asking if you want to publish committed changes to OpenShift, click Yes. The Console view automatically becomes the view in focus and displays the output from the OpenShift Online server. Once the OpenShift Online ticketmonster application is created and deployed, the Console view displays the following message:</p>
<div class="paragraph">
<p><code>Deployment completed with status: success</code></p>
</div>
<div id="completed-deployment-openshift" class="imageblock">
<div class="content">
<img src="gfx/completed-deployment-openshift.png" alt="completed deployment openshift">
</div>
<div class="title">Figure 139. New OpenShift Application Wizard</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_to_openshift_using_the_command_line">Deploying to OpenShift using the command-line</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To deploy TicketMonster to OpenShift Online, you must create a new OpenShift Online application based on the existing workspace project using OpenShift Tools, as detailed in the procedure below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This procedure documents the deploying process for first-time OpenShift Online users. This
includes one-time steps, such as signing up for an OpenShift Online account, creating an
OpenShift Online domain and uploading SSH keys. If you have previously used OpenShift
Online and OpenShift Tools, omit the one-time steps as appropriate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_create_an_openshift_account_and_domain">Create an OpenShift Account and Domain</h3>
<div class="paragraph">
<p>If you do not yet have an OpenShift account and domain, <a href="https://openshift.com/">browse to OpenShift</a> to create the account and domain.</p>
</div>
<div class="paragraph">
<p><a href="https://openshift.redhat.com/app/getting_started">Get Started with OpenShift</a> details how to install the OpenShift Client tools.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_openshift_application">Create the OpenShift Application</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The following variables are used in these instructions. Be sure to replace them as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>YOUR_DOMAIN_NAME should be replaced with the OpenShift domain name.</p>
</li>
<li>
<p>APPLICATION_UUID should be replaced with the UUID generated by OpenShift for your application, for example: 52864af85973ca430200006f</p>
</li>
<li>
<p>TICKETMONSTER_MAVEN_PROJECT_ROOT is the location of the Maven project sources for the TicketMonster application.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open a shell command prompt and change to a directory of your choice. Enter the following command to create a JBoss EAP 6 application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>rhc app create -a ticketmonster -t jbosseap-6</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The domain name for this application will be <code>ticketmonster-YOUR_DOMAIN_NAME.rhcloud.com</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This command creates an OpenShift application named ticketmonster and will run the application inside the jbosseap-6 container. You should see some output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Application Options
\-------------------
Domain:     YOUR_DOMAIN
Cartridges: jbosseap-6 (addtl. costs may apply)
Gear Size:  default
Scaling:    no

Creating application 'ticketmonster' ... done


Waiting for your DNS name to be available ... done

Cloning into 'ticketmonster'...
Warning: Permanently added the RSA host key for IP address '54.90.10.115' to the list of known hosts.

Your application 'ticketmonster' is now available.

  URL:        http://ticketmonster-YOUR_DOMAIN.rhcloud.com/
  SSH to:     APPLICATION_UUID@ticketmonster-YOURDOMAIN.rhcloud.com
  Git remote: ssh://APPLICATION_UUID@ticketmonster-YOUR_DOMAIN.rhcloud.com/~/git/ticketmonster.git/
  Cloned to:  /Users/vineet/openshiftapps/ticketmonster

Run 'rhc show-app ticketmonster' for more details about your app.</pre>
</div>
</div>
<div class="paragraph">
<p>The create command creates a git repository in the current directory with the same name as the application.</p>
</div>
<div class="paragraph">
<p>You do not need the generated default application, so navigate to the new git repository directory created by the OpenShift command and tell git to remove the source and pom files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd ticketmonster
git rm -r src pom.xml</pre>
</div>
</div>
<div class="paragraph">
<p>Copy the TicketMonster application sources into this new git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cp -r TICKETMONSTER_MAVEN_PROJECT_ROOT/src .
cp -r TICKETMONSTER_MAVEN_PROJECT_ROOT/pom.xml .</pre>
</div>
</div>
<div class="paragraph">
<p>You can now deploy the changes to your OpenShift application using git as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git add src pom.xml
git commit -m "TicketMonster on OpenShift"
git push</pre>
</div>
</div>
<div class="paragraph">
<p>The final push command triggers the OpenShift infrastructure to build and deploy the changes.</p>
</div>
<div class="paragraph">
<p>Note that the <code>openshift</code> profile in pom.xml is activated by OpenShift, and causes the WAR build by OpenShift to be copied to the deployments/ directory, and deployed without a context path.</p>
</div>
<div class="paragraph">
<p>Now you can see the application running at <a href="http://ticketmonster-YOUR_DOMAIN.rhcloud.com/" class="bare">http://ticketmonster-YOUR_DOMAIN.rhcloud.com/</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_mysql_as_the_database_2">Using MySQL as the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can deploy TicketMonster to OpenShift, making use of a 'real' database like MySQL, instead of the default in-memory H2 database within the JBoss EAP cartridge. You can follow the procedure outlined as follows, to first deploy the TicketMonster application to a JBoss EAP cartridge, and to then add a :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the OpenShift application from the TicketMonster project sources, as described in the previous sections.</p>
</li>
<li>
<p>Add the MySQL cartridge to the application.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you are using JBoss Developer Studio, select the <code>ticketmonster</code> application in the <strong>OpenShift Explorer</strong> view. Open the context-menu by right-clicking on it, and navigate to the <strong>Edit Embedded Cartridges&#8230;&#8203;</strong> menu item.</p>
<div id="edit-embedded-cartridge-openshift-for-mysql" class="imageblock">
<div class="content">
<img src="gfx/edit-embedded-cartridge-openshift.png" alt="edit embedded cartridge openshift">
</div>
<div class="title">Figure 140. Edit Embedded Cartidges for an OpenShift application</div>
</div>
<div class="paragraph">
<p>Select the MySQL 5.5 cartidge, and click <strong>Finish</strong>.</p>
</div>
<div id="add-mysql-embedded-cartridge" class="imageblock">
<div class="content">
<img src="gfx/add-mysql-embedded-cartridge.png" alt="add mysql embedded cartridge">
</div>
<div class="title">Figure 141. Add MySQL cartridge</div>
</div>
</li>
<li>
<p>If you are using the command-line, execute the following command, to add the MySQL 5.5 cartridge to the <code>ticketmonster</code> application:</p>
<div class="listingblock">
<div class="content">
<pre>rhc cartridge add mysql-5.5 -a ticketmonster</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the OpenShift build process, to use the <code>mysql-openshift</code> profile within the project POM. As you would know, the Maven build on OpenShift uses the <code>openshift</code> profile by default - this profile does not contain any instructions or configuration to create a WAR file with the JPA deployment descriptor for MySQL on OpenShift. The <code>mysql-openshift</code> profile contains this configuration. Since it is not activated during the build on OpenShift, we need to instruct OpenShift to use it as well.</p>
<div class="paragraph">
<p>To do so, create a file named <code>pre_build_jbosseap</code> under the <code>.openshift/action_hooks</code> directory located in the git repository of the OpenShift application, with the following contents:</p>
</div>
<div class="listingblock">
<div class="title">TICKET_MONSTER_OPENSHIFT_GIT_REPO/.openshift/build_hooks/pre_build_jbosseap</div>
<div class="content">
<pre>export MAVEN_ARGS="clean package -Popenshift,mysql-openshift -DskipTests"</pre>
</div>
</div>
<div class="paragraph">
<p>This OpenShift action hook sets up the <code>MAVEN_ARGS</code> environment variable used by OpenShift to configure the Maven build process. The exported variable now activates the <code>mysql-openshift</code> profile, in addition to the default values originally present in the variable.</p>
</div>
</li>
<li>
<p>Publish the changes to OpenShift:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you are using JBoss Developer Studio, right-click the project, go to <strong>Team</strong>  <strong>Commit&#8230;&#8203;</strong> to commit the changes. Select the <code>pre_build_jbosseap</code> file to add to the commit. Choose the <strong>Commit and Push</strong> button during committing, to push the changes to the OpenShift repository.</p>
</li>
<li>
<p>If you are using the command line, add the <code>pre_build_jbosseap</code> file to the git index, and commit it, and push to the OpenShift repository, as follows:</p>
<div class="listingblock">
<div class="content">
<pre>cd &lt;TICKET_MONSTER_OPENSHIFT_GIT_REPO&gt;
git add .openshift/build_hooks/pre_build_jbosseap
git commit -m "Added pre-build action hook for MySQL"
git push</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>On Windows, you will need to run the following command to set the executable bit to the <code>pre_build_jbosseap</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git update-index --chmod=+x .openshift/build_hooks/pre_build_jbosseap</pre>
</div>
</div>
<div class="paragraph">
<p>This ensures the executable bit is recognized on OpenShift even though the file was committed in Windows.</p>
</div>
<div class="paragraph">
<p>Since JBoss Developer Studio does not have a git console, you will need to run this from the command line.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_postgresql_as_the_database_2">Using PostgreSQL as the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can deploy TicketMonster to OpenShift, making use of a 'real' database like PostgreSQL, instead of the default in-memory H2 database within the JBoss EAP cartridge. You can follow the procedure outlined as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the OpenShift application from the TicketMonster project sources, as described in the previous sections.</p>
</li>
<li>
<p>Add the PostgreSQL cartridge to the application.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you are using JBoss Developer Studio, select the <code>ticketmonster</code> application in the <strong>OpenShift Explorer</strong> view. Open the context-menu by right-clicking on it, and navigate to the <strong>Edit Embedded Cartridges&#8230;&#8203;</strong> menu item.</p>
<div id="edit-embedded-cartridge-openshift-for-postgres" class="imageblock">
<div class="content">
<img src="gfx/edit-embedded-cartridge-openshift.png" alt="edit embedded cartridge openshift">
</div>
<div class="title">Figure 142. Edit Embedded Cartidges for an OpenShift application</div>
</div>
<div class="paragraph">
<p>Select the PostgreSQL 9.2 cartidge, and click <strong>Finish</strong>.</p>
</div>
<div id="add-postgresql-embedded-cartridge" class="imageblock">
<div class="content">
<img src="gfx/add-postgresql-embedded-cartridge.png" alt="add postgresql embedded cartridge">
</div>
<div class="title">Figure 143. Add PostgreSQL cartridge</div>
</div>
</li>
<li>
<p>If you are using the command-line, execute the following command, to add the PostgreSQL 9.2 cartridge to the <code>ticketmonster</code> application:</p>
<div class="listingblock">
<div class="content">
<pre>rhc cartridge add postgresql-9.2 -a ticketmonster</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the OpenShift build process, to use the <code>postgresql-openshift</code> profile within the project POM. As you would know, the Maven build on OpenShift uses the <code>openshift</code> profile by default - this profile does not contain any instructions or configuration to create a WAR file with the JPA deployment descriptor for MySQL on OpenShift. The <code>postgresql-openshift</code> profile contains this configuration. Since it is not activated during the build on OpenShift, we need to instruct OpenShift to use it as well.</p>
<div class="paragraph">
<p>To do so, create a file named <code>pre_build_jbosseap</code> under the <code>.openshift/action_hooks</code> directory located in the git repository of the OpenShift application, with the following contents:</p>
</div>
<div class="listingblock">
<div class="title">TICKET_MONSTER_OPENSHIFT_GIT_REPO/.openshift/build_hooks/pre_build_jbosseap</div>
<div class="content">
<pre>export MAVEN_ARGS="clean package -Popenshift,postgresql-openshift -DskipTests"</pre>
</div>
</div>
<div class="paragraph">
<p>This OpenShift action hook sets up the <code>MAVEN_ARGS</code> environment variable used by OpenShift to configure the Maven build process. The exported variable now activates the <code>postgresql-openshift</code> profile, in addition to the default values originally present in the variable.</p>
</div>
</li>
<li>
<p>Publish the changes to OpenShift:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you are using JBoss Developer Studio, right-click the project, go to <strong>Team</strong>  <strong>Commit&#8230;&#8203;</strong> to commit the changes. Select the <code>pre_build_jbosseap</code> file to add to the commit. Choose the <strong>Commit and Push</strong> button during committing, to push the changes to the OpenShift repository.</p>
</li>
<li>
<p>If you are using the command line, add the <code>pre_build_jbosseap</code> file to the git index, and commit it, and push to the OpenShift repository, as follows:</p>
<div class="listingblock">
<div class="content">
<pre>cd &lt;TICKET_MONSTER_OPENSHIFT_GIT_REPO&gt;
git add .openshift/build_hooks/pre_build_jbosseap
git commit -m "Added pre-build action hook for PostgreSQL"
git push</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>On Windows, you will need to run the following command to set the executable bit to the <code>pre_build_jbosseap</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git update-index --chmod=+x .openshift/build_hooks/pre_build_jbosseap</pre>
</div>
</div>
<div class="paragraph">
<p>This ensures the executable bit is recognized on OpenShift even though the file was committed in Windows.</p>
</div>
<div class="paragraph">
<p>Since JBoss Developer Studio does not have a git console, you will need to run this from the command line.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-03-04 07:05:48 -0500
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>