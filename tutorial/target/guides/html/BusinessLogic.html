<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Marius Bogoevici">
<title>Building The Business Services With JAX-RS</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body id="BuildingBusinessServices" class="book toc2 toc-left">
<div id="header">
<h1>Building The Business Services With JAX-RS</h1>
<div class="details">
<span id="author" class="author">Marius Bogoevici</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_what_will_you_learn_here">What Will You Learn Here?</a></li>
<li><a href="#_business_services_and_their_relationships">Business Services And Their Relationships</a></li>
<li><a href="#_preparations">Preparations</a>
<ul class="sectlevel2">
<li><a href="#_adding_jackson_core">Adding Jackson Core</a></li>
<li><a href="#_verifying_the_versions_of_the_jboss_boms">Verifying the versions of the JBoss BOMs</a></li>
<li><a href="#_enabling_cdi">Enabling CDI</a></li>
<li><a href="#_adding_utility_classes">Adding utility classes</a></li>
</ul>
</li>
<li><a href="#_internal_services">Internal Services</a>
<ul class="sectlevel2">
<li><a href="#_the_media_manager">The Media Manager</a></li>
<li><a href="#_the_seat_allocation_service">The Seat Allocation Service</a></li>
</ul>
</li>
<li><a href="#_jax_rs_services">JAX-RS Services</a>
<ul class="sectlevel2">
<li><a href="#_initializing_jax_rs">Initializing JAX-RS</a></li>
<li><a href="#_a_base_service_for_read_operations">A Base Service For Read Operations</a></li>
<li><a href="#_retrieving_venues">Retrieving Venues</a></li>
<li><a href="#_retrieving_events">Retrieving Events</a></li>
<li><a href="#_retrieving_shows">Retrieving Shows</a></li>
<li><a href="#_creating_and_deleting_bookings">Creating and deleting bookings</a></li>
</ul>
</li>
<li><a href="#_testing_the_services">Testing the services</a>
<ul class="sectlevel2">
<li><a href="#_adding_shrinkwrap_resolvers">Adding ShrinkWrap Resolvers</a></li>
<li><a href="#_a_basic_deployment_class">A Basic Deployment Class</a></li>
<li><a href="#_writing_restful_service_tests">Writing RESTful service tests</a></li>
<li><a href="#_running_the_tests">Running the tests</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_what_will_you_learn_here">What Will You Learn Here?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve just defined the domain model of the application and created its persistence layer. Now we need to define the services that implement the business logic of the application and expose them to the front-end. After reading this, you&#8217;ll understand how to design the business layer and what choices to make while developing it. Topics covered include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encapsulating business logic in services and integrating with the persistence tier</p>
</li>
<li>
<p>Using CDI for integrating individual services</p>
</li>
<li>
<p>Integration testing using Arquillian</p>
</li>
<li>
<p>Exposing RESTful services via JAX-RS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tutorial will show you how to perform all these steps in JBoss Developer Studio, including screenshots that guide you through.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_business_services_and_their_relationships">Business Services And Their Relationships</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TicketMonster&#8217;s business logic is implemented by a number of classes, with different responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>managing media items</p>
</li>
<li>
<p>allocating tickets</p>
</li>
<li>
<p>handling information on ticket availability</p>
</li>
<li>
<p>remote access through a RESTful interface</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The services are consumed by various other layers of the application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the media management and ticket allocation services encapsulate complex functionality, which in turn is exposed externally by RESTful services that wrap them</p>
</li>
<li>
<p>RESTful services are mainly used by the HTML5 view layer</p>
</li>
<li>
<p>the ticket availability service is used by the HTML5 and JavaScript based monitor</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Where to draw the line?</div>
<div class="paragraph">
<p>A business service is an encapsulated, reusable logical component that groups
together a number of well-defined cohesive business operations. Business services
perform business operations, and may coordinate infrastructure services such as
persistence units, or even other business services as well. The boundaries drawn
between them should take into account whether the newly created services represent
, potentially reusable components.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, some of the services are intended to be consumed within the business layer of the application, while others provide an external interface as JAX-RS services. We will start by implementing the former, and we&#8217;ll finish up with the latter. During this process, you will
discover how CDI, EJB and JAX-RS make it easy to define and wire together our services.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparations">Preparations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_adding_jackson_core">Adding Jackson Core</h3>
<div class="paragraph">
<p>The first step for setting up our service architecture is to add Jackson Core as a dependency in the project. Adding Jackson Core as a provided dependency will enable you to use the Jackson annotations in the project. This is necessary to obtain a certain degree of control over the content of the JSON responses. We can bring in the same version of Jackson Core as the one used in RESTEasy, by adding <code>org.jboss.resteasy:resteasy-jackson-provider</code> and <code>org.jboss.resteasy:resteasy-jaxrs</code> as provided-scope dependencies, through the <code>org.jboss.bom.eap:jboss-javaee-6.0-with-resteasy</code> BOM. The versions of these dependencies would depend on the version of the JBoss BOMs we use in our project. Using the same version of the JBoss BOM as the one we will deploy to production, will ensure that we use the right dependencies during compilation and build.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...

    &lt;dependencyManagement&gt;
        ...

        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.bom.eap&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-javaee-6.0-with-resteasy&lt;/artifactId&gt;
            &lt;version&gt;${version.jboss.bom.eap}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;

    &lt;dependencies&gt;

        ...

        &lt;!-- RESTEasy dependencies that bring in Jackson Core and RESTEasy APIs+SPIs, which we use for
            fine tuning the content of the JSON responses --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.resteasy&lt;/groupId&gt;
            &lt;artifactId&gt;resteasy-jackson-provider&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.resteasy&lt;/groupId&gt;
            &lt;artifactId&gt;resteasy-jaxrs&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Why do you need the Jackson annotations?</div>
<div class="paragraph">
<p>JAX-RS does not specify mediatype-agnostic annotations for certain use cases. You will
encounter atleast one of them in the project. The object graph contains
cyclic/bi-directional relationships among entities like <code>Venue</code>, <code>Section</code>, <code>Show</code>,
<code>Performance</code> and <code>TicketPrice</code>. JSON representations for these objects will need
tweaking to avoid stack oVerflow errors and the like, at runtime.</p>
</div>
<div class="paragraph">
<p>JBoss Enterprise Application 6 uses Jackson to perform serialization and
dserialization of objects, thus requiring use of Jackson annotations to modify this
behavior. <code>@JsonIgnoreProperties</code> from Jackson will be used to suppress serialization
and deserialization of one of the fields involved in the cycle.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_verifying_the_versions_of_the_jboss_boms">Verifying the versions of the JBoss BOMs</h3>
<div class="paragraph">
<p>The next step is to verify if we&#8217;re using the right version of the JBoss BOMs in the project.
Using the right versions of the BOMs ensures that you work against a known set of tested dependencies.
Verify that the property <code>version.jboss.bom.eap</code> contains the value <code>6.3.2.GA</code> or higher:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...
    &lt;properties&gt;
        ...
        &lt;version.jboss.bom.eap&gt;6.3.2.GA&lt;/version.jboss.bom.eap&gt;
        ...
    &lt;/properties&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_cdi">Enabling CDI</h3>
<div class="paragraph">
<p>The next step is to enable CDI in the deployment by creating a <code>beans.xml</code> file in the <code>WEB-INF</code> folder of the web application.</p>
</div>
<div class="listingblock">
<div class="title">src/main/webapp/WEB-INF/beans.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;beans xmlns="http://java.sun.com/xml/ns/javaee"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
	                       http://java.sun.com/xml/ns/javaee/beans_1_0.xsd"&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">If you used the Maven archetype</div>
<div class="paragraph">
<p>If you used the Maven archetype to create the project, this file will exist already
in the project - it is added automatically.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may wonder why the file is empty! Whilst <code>beans.xml</code> can specify various deployment-time configuration (e.g. activation of interceptors,
decorators or alternatives), it can also act as a marker file, telling the container to enable CDI for the deployment (which it doesn&#8217;t do, unless <code>beans.xml</code> is present).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Contexts and Dependency Injection (CDI)</div>
<div class="paragraph">
<p>As it&#8217;s name suggests, CDI is the contexts and dependency injection standard for Java
EE. By enabling CDI in your application, deployed classes become managed components
and their lifecycle and wiring becomes the responsibility of the Java EE server.</p>
</div>
<div class="paragraph">
<p>In this way, we can reduce coupling between components, which is a requirement o a
well-designed architecture. Now, we can focus on implementing the responsibilities of
the components and describing their dependencies in a declarative fashion. The
runtime will do the rest for you: instantiating and wiring them together, as well as
disposing of them as needed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_utility_classes">Adding utility classes</h3>
<div class="paragraph">
<p>Next, we add some helper classes providing low-level utilities for the application. We won&#8217;t get in their implementation details here, but you can study their source code for details.</p>
</div>
<div class="paragraph">
<p>Copy the following classes from the original example to <code>src/main/java/org/jboss/examples/ticketmonster/util</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Base64</code></p>
</li>
<li>
<p><code>CircularBuffer</code></p>
</li>
<li>
<p><code>ForwardingMap</code></p>
</li>
<li>
<p><code>MultivaluedHashMap</code></p>
</li>
<li>
<p><code>Reflections</code></p>
</li>
<li>
<p><code>Resources</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internal_services">Internal Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We begin the service implementation by implementing some helper services.</p>
</div>
<div class="sect2">
<h3 id="_the_media_manager">The Media Manager</h3>
<div class="paragraph">
<p>First, let&#8217;s add support for managing media items, such as images. The persistence layer simply stores URLs, referencing media items stored by online services. The URL look like <a href="http://dl.dropbox.com/u/65660684/640px-Roy_Thomson_Hall_Toronto.jpg" class="bare">http://dl.dropbox.com/u/65660684/640px-Roy_Thomson_Hall_Toronto.jpg</a>.</p>
</div>
<div class="paragraph">
<p>Now, we could use the URLs in our application, and retrieve these media items from the provider. However, we would prefer to cache these media items in order to improve application performance and increase resilience to external failures - this will allow us to run the application
successfully even if the provider is down. The <code>MediaManager</code> is a good illustration of a business service; it performs the retrieval and caching of media objects, encapsulating the operation from the rest of the application.</p>
</div>
<div class="paragraph">
<p>We begin by creating <code>MediaManager</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaManager.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 * The media manager is responsible for taking a media item, and returning either the URL
 * of the cached version (if the application cannot load the item from the URL), or the
 * original URL.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The media manager also transparently caches the media items on first load.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * The computed URLs are cached for the duration of a request. This provides a good balance
 * between consuming heap space, and computational time.
 * &lt;/p&gt;
 *
 */
public class MediaManager {

    /**
     * Locate the tmp directory for the machine
     */
    private static final File tmpDir;

    static {
        String dataDir = System.getenv("OPENSHIFT_DATA_DIR");
        String parentDir = dataDir != null ? dataDir : System.getProperty("java.io.tmpdir");
        tmpDir = new File(parentDir, "org.jboss.examples.ticket-monster");
        if (tmpDir.exists()) {
            if (tmpDir.isFile())
                throw new IllegalStateException(tmpDir.getAbsolutePath() + " already exists, and is a file. Remove it.");
        } else {
            tmpDir.mkdir();
        }
    }

    /**
     * A request scoped cache of computed URLs of media items.
     */
    private final Map&lt;MediaItem, MediaPath&gt; cache;

    public MediaManager() {

        this.cache = new HashMap&lt;MediaItem, MediaPath&gt;();
    }

    /**
     * Load a cached file by name
     *
     * @param fileName
     * @return
     */
    public File getCachedFile(String fileName) {
        return new File(tmpDir, fileName);
    }

    /**
     * Obtain the URL of the media item. If the URL h has already been computed in this
	 * request, it will be looked up in the request scoped cache, otherwise it will be
	 * computed, and placed in the request scoped cache.
     */
    public MediaPath getPath(MediaItem mediaItem) {
        if (cache.containsKey(mediaItem)) {
            return cache.get(mediaItem);
        } else {
            MediaPath mediaPath = createPath(mediaItem);
            cache.put(mediaItem, mediaPath);
            return mediaPath;
        }
    }

    /**
     * Compute the URL to a media item. If the media item is not cacheable, then, as long
	 * as the resource can be loaded, the original URL is returned. If the resource is not
	 * available, then a placeholder image replaces it. If the media item is cachable, it
	 * is first cached in the tmp directory, and then path to load it is returned.
     */
    private MediaPath createPath(MediaItem mediaItem) {
        if(mediaItem == null) {
            return createCachedMedia(Reflections.getResource("not_available.jpg").toExternalForm(), IMAGE);
        } else if (!mediaItem.getMediaType().isCacheable()) {
            if (checkResourceAvailable(mediaItem)) {
                return new MediaPath(mediaItem.getUrl(), false, mediaItem.getMediaType());
            } else {
                return createCachedMedia(Reflections.getResource("not_available.jpg").toExternalForm(), IMAGE);
            }
        } else {
            return createCachedMedia(mediaItem);
        }
    }

    /**
     * Check if a media item can be loaded from it's URL, using the JDK URLConnection classes.
     */
    private boolean checkResourceAvailable(MediaItem mediaItem) {
        URL url = null;
        try {
            url = new URL(mediaItem.getUrl());
        } catch (MalformedURLException e) {
        }

        if (url != null) {
            try {
                URLConnection connection = url.openConnection();
                if (connection instanceof HttpURLConnection) {
                    return ((HttpURLConnection) connection).getResponseCode() == HttpURLConnection.HTTP_OK;
                } else {
                    return connection.getContentLength() &gt; 0;
                }
            } catch (IOException e) {
            }
        }
        return false;
    }

    /**
     * The cached file name is a base64 encoded version of the URL. This means we don't need to maintain a database of cached
     * files.
     */
    private String getCachedFileName(String url) {
        return Base64.encodeToString(url.getBytes(), false);
    }

    /**
     * Check to see if the file is already cached.
     */
    private boolean alreadyCached(String cachedFileName) {
        File cache = getCachedFile(cachedFileName);
        if (cache.exists()) {
            if (cache.isDirectory()) {
                throw new IllegalStateException(cache.getAbsolutePath() + " already exists, and is a directory. Remove it.");
            }
            return true;
        } else {
            return false;
        }
    }

    /**
     * To cache a media item we first load it from the net, then write it to disk.
     */
    private MediaPath createCachedMedia(String url, MediaType mediaType) {
        String cachedFileName = getCachedFileName(url);
        if (!alreadyCached(cachedFileName)) {
            URL _url = null;
            try {
                _url = new URL(url);
            } catch (MalformedURLException e) {
                throw new IllegalStateException("Error reading URL " + url);
            }

            try {
                InputStream is = null;
                OutputStream os = null;
                try {
                    is = new BufferedInputStream(_url.openStream());
                    os = new BufferedOutputStream(getCachedOutputStream(cachedFileName));
                    while (true) {
                        int data = is.read();
                        if (data == -1)
                            break;
                        os.write(data);
                    }
                } finally {
                    if (is != null)
                        is.close();
                    if (os != null)
                        os.close();
                }
            } catch (IOException e) {
                throw new IllegalStateException("Error caching " + mediaType.getDescription(), e);
            }
        }
        return new MediaPath(cachedFileName, true, mediaType);
    }

    private MediaPath createCachedMedia(MediaItem mediaItem) {
        return createCachedMedia(mediaItem.getUrl(), mediaItem.getMediaType());
    }

    private OutputStream getCachedOutputStream(String fileName) {
        try {
            return new FileOutputStream(getCachedFile(fileName));
        } catch (FileNotFoundException e) {
            throw new IllegalStateException("Error creating cached file", e);
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service delegates to a number of internal methods that do the heavy lifting, but exposes a simple API, to the external observer it simply converts the <code>MediaItem</code> entities into <code>MediaPath</code> data structures, that can be used by the application to load the binary data of the media item. The service will retrieve and cache the data locally in the filesystem, if possible (e.g. streamed videos aren&#8217;t cacheable!).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaPath.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MediaPath {

    private final String url;
    private final boolean cached;
    private final MediaType mediaType;

    public MediaPath(String url, boolean cached, MediaType mediaType) {
        this.url = url;
        this.cached = cached;
        this.mediaType = mediaType;
    }

    public String getUrl() {
        return url;
    }

    public boolean isCached() {
        return cached;
    }

    public MediaType getMediaType() {
        return mediaType;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service can be injected by type into the components that depend on it.</p>
</div>
<div class="paragraph">
<p>We should also control the lifecycle of this service. The <code>MediaManager</code> stores request-specific state, so should be scoped to the web request, the CDI <code>@RequestScoped</code> is perfect.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/MediaManager.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
@RequestScoped
public class MediaManager {
   ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_seat_allocation_service">The Seat Allocation Service</h3>
<div class="paragraph">
<p>The seat allocation service finds free seats at booking time, in a given section of the venue. It is a good example of how a service can coordinate infrastructure services (using the injected persistence unit to get access to the <code>SeatAllocation</code> instance) and domain objects (by invoking the <code>allocateSeats</code> method on a concrete allocation instance).</p>
</div>
<div class="paragraph">
<p>Isolating this functionality in a service class makes it possible to write simpler, self-explanatory code in the layers above and opens the possibility of replacing this code at a later date with a more advanced implementation (for example one using an in-memory cache).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/SeatAllocationService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SuppressWarnings("serial")
public class SeatAllocationService implements Serializable {

    @Inject
    EntityManager entityManager;

    public AllocatedSeats allocateSeats(Section section, Performance performance, int seatCount, boolean contiguous) {
        SectionAllocation sectionAllocation = retrieveSectionAllocationExclusively(section, performance);
        List&lt;Seat&gt; seats = sectionAllocation.allocateSeats(seatCount, contiguous);
        return new AllocatedSeats(sectionAllocation, seats);
    }

    public void deallocateSeats(Section section, Performance performance, List&lt;Seat&gt; seats) {
        SectionAllocation sectionAllocation = retrieveSectionAllocationExclusively(section, performance);
        for (Seat seat : seats) {
            if (!seat.getSection().equals(section)) {
                throw new SeatAllocationException("All seats must be in the same section!");
            }
            sectionAllocation.deallocate(seat);
        }
    }

    private SectionAllocation retrieveSectionAllocationExclusively(Section section, Performance performance) {
        SectionAllocation sectionAllocationStatus = null;
        try {
            sectionAllocationStatus = (SectionAllocation) entityManager.createQuery(
                "select s from SectionAllocation s where " +
                    "s.performance.id = :performanceId and " +
                    "s.section.id = :sectionId")
                .setParameter("performanceId", performance.getId())
                .setParameter("sectionId", section.getId())
                .getSingleResult();
        } catch (NoResultException noSectionEx) {
            // Create the SectionAllocation since it doesn't exist
            sectionAllocationStatus = new SectionAllocation(performance, section);
            entityManager.persist(sectionAllocationStatus);
            entityManager.flush();
        }
        entityManager.lock(sectionAllocationStatus, LockModeType.PESSIMISTIC_WRITE);
        return sectionAllocationStatus;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we define the <code>AllocatedSeats</code> class that we use for storing seat reservations for a booking, before they are made persistent.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/service/AllocatedSeats.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class AllocatedSeats {

    private final SectionAllocation sectionAllocation;

    private final List&lt;Seat&gt; seats;

    public AllocatedSeats(SectionAllocation sectionAllocation, List&lt;Seat&gt; seats) {
        this.sectionAllocation = sectionAllocation;
        this.seats = seats;
    }

    public SectionAllocation getSectionAllocation() {
        return sectionAllocation;
    }

    public List&lt;Seat&gt; getSeats() {
        return seats;
    }

    public void markOccupied() {
        sectionAllocation.markOccupied(seats);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jax_rs_services">JAX-RS Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The majority of services in the application are JAX-RS web services. They are critical part of the design, as they next service is used for provide communication with the HTML5 view layer. The JAX-RS services range from simple CRUD to processing bookings and media items.</p>
</div>
<div class="paragraph">
<p>To pass data across the wire we use JSON as the data marshalling format, as it is less verbose and easier to process than XML by the JavaScript client-side framework.</p>
</div>
<div class="sect2">
<h3 id="_initializing_jax_rs">Initializing JAX-RS</h3>
<div class="paragraph">
<p>We shall ensure that the required dependencies are present in the project POM, to setup JAX-RS in the project:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
    ...
    &lt;dependencies&gt;
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.spec.javax.ws.rs&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-jaxrs-api_1.1_spec&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.spec.javax.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-servlet-api_3.0_spec&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of these may already be present in the project POM, and should not be added again.</p>
</div>
<div class="paragraph">
<p>To activate JAX-RS we add the class below, which instructs the container to look for JAX-RS
annotated classes and install them as endpoints. This class should exist already in your
project, as it is generated by the archetype, so make sure that it is there and it contains the
code below:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/JaxRsActivator.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ApplicationPath("/rest")
public class JaxRsActivator extends Application {
   /* class body intentionally left blank */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the JAX-RS services are mapped relative to the <code>/rest</code> path, as defined by the <code>@ApplicationPath</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_base_service_for_read_operations">A Base Service For Read Operations</h3>
<div class="paragraph">
<p>Most JAX-RS services must provide both a (filtered) list of entities or individual entity (e.g. events, venues and bookings). Instead of duplicating the implementation into each individual service we create a base service class and wire the helper objects in.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *   A number of RESTful services implement GET operations on a particular type of entity. For
 *   observing the DRY principle, the generic operations are implemented in the &lt;code&gt;BaseEntityService&lt;/code&gt;
 *   class, and the other services can inherit from here.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 *    Subclasses will declare a base path using the JAX-RS {@link Path} annotation, for example:
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 * &lt;code&gt;
 * &amp;#064;Path("/widgets")
 * public class WidgetService extends BaseEntityService&lt;Widget&gt; {
 * ...
 * }
 * &lt;/code&gt;
 * &lt;/pre&gt;
 *
 * &lt;p&gt;
 *   will support the following methods:
 * &lt;/p&gt;
 *
 * &lt;pre&gt;
 * &lt;code&gt;
 *   GET /widgets
 *   GET /widgets/:id
 *   GET /widgets/count
 * &lt;/code&gt;
 * &lt;/pre&gt;
 *
 *  &lt;p&gt;
 *     Subclasses may specify various criteria for filtering entities when retrieving a list of them, by supporting
 *     custom query parameters. Pagination is supported by default through the query parameters &lt;code&gt;first&lt;/code&gt;
 *     and &lt;code&gt;maxResults&lt;/code&gt;.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 *     The class is abstract because it is not intended to be used directly, but subclassed by actual JAX-RS
 *     endpoints.
 * &lt;/p&gt;
 *
 */
public abstract class BaseEntityService&lt;T&gt; {

    @Inject
    private EntityManager entityManager;

    private Class&lt;T&gt; entityClass;

    public BaseEntityService() {}

    public BaseEntityService(Class&lt;T&gt; entityClass) {
        this.entityClass = entityClass;
    }

    public EntityManager getEntityManager() {
        return entityManager;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we add a method to retrieve all entities of a given type:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *   A method for retrieving all entities of a given type. Supports the query parameters
     *  &lt;code&gt;first&lt;/code&gt;
     *   and &lt;code&gt;maxResults&lt;/code&gt; for pagination.
     * &lt;/p&gt;
     *
     *  @param uriInfo application and request context information (see {@see UriInfo} class
     *  information for more details)
     *  @return
     */
    @GET
    @Produces(MediaType.APPLICATION_JSON)
    public List&lt;T&gt; getAll(@Context UriInfo uriInfo) {
        return getAll(uriInfo.getQueryParameters());
    }

    public List&lt;T&gt; getAll(MultivaluedMap&lt;String, String&gt; queryParameters) {
        final CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        final CriteriaQuery&lt;T&gt; criteriaQuery = criteriaBuilder.createQuery(entityClass);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        Predicate[] predicates = extractPredicates(queryParameters, criteriaBuilder, root);
        criteriaQuery.select(criteriaQuery.getSelection()).where(predicates);
        criteriaQuery.orderBy(criteriaBuilder.asc(root.get("id")));
        TypedQuery&lt;T&gt; query = entityManager.createQuery(criteriaQuery);
        if (queryParameters.containsKey("first")) {
        	Integer firstRecord = Integer.parseInt(queryParameters.getFirst("first"))-1;
        	query.setFirstResult(firstRecord);
        }
        if (queryParameters.containsKey("maxResults")) {
        	Integer maxResults = Integer.parseInt(queryParameters.getFirst("maxResults"));
        	query.setMaxResults(maxResults);
        }
		return query.getResultList();
    }

    /**
     * &lt;p&gt;
     *     Subclasses may choose to expand the set of supported query parameters (for adding more filtering
     *     criteria) by overriding this method.
     * &lt;/p&gt;
     * @param queryParameters - the HTTP query parameters received by the endpoint
     * @param criteriaBuilder - @{link CriteriaBuilder} used by the invoker
     * @param root  @{link Root} used by the invoker
     * @return a list of {@link Predicate}s that will added as query parameters
     */
    protected Predicate[] extractPredicates(MultivaluedMap&lt;String, String&gt; queryParameters,
                                             CriteriaBuilder criteriaBuilder, Root&lt;T&gt; root) {
        return new Predicate[]{};
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly added method <code>getAll</code> is annotated with <code>@GET</code> which instructs JAX-RS to call it when a <code>GET</code> HTTP requests on the JAX-RS' endpoint base URL '/rest/&lt;entityRoot&gt;' is performed. But remember, this is not a true JAX-RS endpoint. It is an abstract class and it is not mapped to a path. The classes that extend it are JAX-RS endpoints, and will have to be mapped to a path, and are able to process requests.</p>
</div>
<div class="paragraph">
<p>The <code>@Produces</code> annotation defines that the response sent back by the server is in JSON format. The JAX-RS implementation will automatically convert the result returned by the method (a list of entities) into JSON format.</p>
</div>
<div class="paragraph">
<p>As well as configuring the marshaling strategy, the annotation affects content negotiation and method resolution. If the client requests JSON content specifically, this method will be invoked.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Even though it is not shown in this example, you may have multiple methods that
handle a specific URL and HTTP method, whilst consuming and producing different types
of content (JSON, HTML, XML or others).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Subclasses can also override the <code>extractPredicates</code> method and add own support for additional query parameters to <code>GET /rest/&lt;entityRoot&gt;</code> which can act as filter criteria.</p>
</div>
<div class="paragraph">
<p>The <code>getAll</code> method supports retrieving a range of entities, which is especially useful when we need to handle very large sets of data, and use pagination. In those cases, we need to support counting entities as well, so we add a method that retrieves the entity count:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *   A method for counting all entities of a given type
     * &lt;/p&gt;
     *
     * @param uriInfo application and request context information (see {@see UriInfo} class information for more details)
     * @return
     */
    @GET
    @Path("/count")
    @Produces(MediaType.APPLICATION_JSON)
    public Map&lt;String, Long&gt; getCount(@Context UriInfo uriInfo) {
        CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        CriteriaQuery&lt;Long&gt; criteriaQuery = criteriaBuilder.createQuery(Long.class);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        criteriaQuery.select(criteriaBuilder.count(root));
        Predicate[] predicates = extractPredicates(uriInfo.getQueryParameters(), criteriaBuilder, root);
        criteriaQuery.where(predicates);
        Map&lt;String, Long&gt; result = new HashMap&lt;String, Long&gt;();
        result.put("count", entityManager.createQuery(criteriaQuery).getSingleResult());
        return result;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>@Path</code> annotation to map the new method to a sub-path of '/rest/&lt;entityRoot&gt;. Now all the JAX-RS endpoints that subclass <code>BaseEntityService</code> will be able to get entity counts from '/rest/&lt;entityRoot&gt;/count'. Just like <code>getAll</code>, this method also delegates to <code>extractPredicates</code>, so any customizations done there by subclasses</p>
</div>
<div class="paragraph">
<p>Next, we add a method for retrieving individual entities.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BaseEntityService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">   ...
public abstract class BaseEntityService&lt;T&gt; {

    ...

    /**
     * &lt;p&gt;
     *     A method for retrieving individual entity instances.
     * &lt;/p&gt;
     * @param id entity id
     * @return
     */
    @GET
    @Path("/{id:[0-9][0-9]*}")
    @Produces(MediaType.APPLICATION_JSON)
    public T getSingleInstance(@PathParam("id") Long id) {
        final CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        final CriteriaQuery&lt;T&gt; criteriaQuery = criteriaBuilder.createQuery(entityClass);
        Root&lt;T&gt; root = criteriaQuery.from(entityClass);
        Predicate condition = criteriaBuilder.equal(root.get("id"), id);
        criteriaQuery.select(criteriaBuilder.createQuery(entityClass).getSelection()).where(condition);
        return entityManager.createQuery(criteriaQuery).getSingleResult();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is similar to <code>getAll</code> and <code>getCount</code>, and we use the <code>@Path</code> annotation to map it to a sub-path of '/rest/&lt;entityRoot&gt;'. The annotation attribute identifies the expected format of the URL (here, the last segment has to be a number) and binds a  portion of the URL to a variable (here named <code>id</code>). The <code>@PathParam</code> annotation allows the value of the variable to be passed as a method argument. Data conversion is performed automatically.</p>
</div>
<div class="paragraph">
<p>Now, all the JAX-RS endpoints that subclass <code>BaseEntityService</code> will get two operations for free:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>GET /rest/&lt;entityRoot&gt;</code></dt>
<dd>
<p>retrieves all entities of a given type</p>
</dd>
<dt class="hdlist1"><code>GET /rest/&lt;entityRoot&gt;/&lt;id&gt;</code></dt>
<dd>
<p>retrieves an entity with a given id</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_venues">Retrieving Venues</h3>
<div class="paragraph">
<p>Adding support for retrieving venues is now extremely simple. We refactor the class we created during the introduction, and make it extend <code>BaseEntityService</code>, passing the entity type to the superclass constructor. We remove the old retrieval code, which is not needed anymore.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/VenueService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Venue}s. Inherits the actual
 *     methods from {@link BaseEntityService}.
 * &lt;/p&gt;
 */
@Path("/venues")
/**
 * &lt;p&gt;
 *     This is a stateless service, so a single shared instance can be used in this case.
 * &lt;/p&gt;
 */
@Stateless
public class VenueService extends BaseEntityService&lt;Venue&gt; {

    public VenueService() {
        super(Venue.class);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add the <code>@Path</code> annotation to the class, to indicate that this is a JAX-RS resource which can serve URLs starting with <code>/rest/venues</code>.</p>
</div>
<div class="paragraph">
<p>We define this service (along with all the other JAX-RS services) as an EJB (see how simple is that in Java EE 6!) to benefit from automatic transaction enrollment. Since the service is fundamentally stateless, we take advantage of the new EJB 3.1 singleton feature.</p>
</div>
<div class="paragraph">
<p>Before we proceed, . Retrieving shows from URLs like <code>/rest/venues</code> or <code>/rest/venues/1</code> almost always results in invalid JSON responses.
The root cause is the presence of a bi-directional relationship in the <code>Venue</code> entity. A <code>Venue</code> contains a 1:M relationship with <code>Section</code> s that also links back to a <code>Venue</code>. JSON serialiers like Jackson (the one used in JBoss Enterprise Application Platform) need to be instructed on how to handle such cycles in object graphs, failing which the serializer will traverse between the entities in the cycle, resulting in an infinite loop (and often an <code>OutOfMemoryError</code> or a <code>StackOverflowError</code>). We&#8217;ll address this, by instructing Jackson to not serialize the <code>venue</code> field in a <code>Section</code>, through the <code>@JsonIgnoreProperties</code> annotation on the <code>Section</code> entity:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Section.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("venue")
public class Section implements Serializable {

...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can retrieve venues from URLs like <code>/rest/venues</code> or <code>rest/venues/1</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_events">Retrieving Events</h3>
<div class="paragraph">
<p>Just like <code>VenueService</code>, the <code>EventService</code> implementation we use for TicketMonster is a direct subclass of <code>BaseEntityService</code>. Refactor the existing class, remove the old retrieval code and make it extend <code>BaseEntityService</code>.</p>
</div>
<div class="paragraph">
<p>One additional functionality we will implement is querying events by category. We can use URLs like <code>/rest/events?category=1</code> to retrieve all concerts, for example (<code>1</code> is the category id of concerts). This is done by overriding the <code>extractPredicates</code> method to handle any query parameters (in this case, the <code>category</code> parameter).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/EventService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Event}s. Inherits the actual
 *     methods from {@link BaseEntityService}, but implements additional search
 *     criteria.
 * &lt;/p&gt;
 */
@Path("/events")
/**
 * &lt;p&gt;
 *     This is a stateless service, we declare it as an EJB for transaction demarcation
 * &lt;/p&gt;
 */
@Stateless
public class EventService extends BaseEntityService&lt;Event&gt; {

    public EventService() {
        super(Event.class);
    }

    /**
     * &lt;p&gt;
     *    We override the method from parent in order to add support for additional search
     *    criteria for events.
     * &lt;/p&gt;
     * @param queryParameters - the HTTP query parameters received by the endpoint
     * @param criteriaBuilder - @{link CriteriaBuilder} used by the invoker
     * @param root  @{link Root} used by the invoker
     * @return
     */
    @Override
    protected Predicate[] extractPredicates(
            MultivaluedMap&lt;String, String&gt; queryParameters,
            CriteriaBuilder criteriaBuilder,
            Root&lt;Event&gt; root) {
        List&lt;Predicate&gt; predicates = new ArrayList&lt;Predicate&gt;() ;

        if (queryParameters.containsKey("category")) {
            String category = queryParameters.getFirst("category");
            predicates.add(criteriaBuilder.equal(root.get("category").get("id"), category));
        }

        return predicates.toArray(new Predicate[]{});
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_shows">Retrieving Shows</h3>
<div class="paragraph">
<p>The <code>ShowService</code> follows the same pattern and we leave the implementation as an exercise to the reader (knowing that its contents can always be copied over to the appropriate folder).</p>
</div>
<div class="paragraph">
<p>Just like the <code>Venue</code> entity, a <code>Show</code> also contains bi-directional relationships that need to be handled as a special case for the JSON serializer. A <code>Show</code> contains a 1:M relationship with <code>Performance</code> s that also links back to a <code>Show</code>; a <code>Show</code> also contains a 1:M relationship with <code>TicketPrice</code> s that also links back to a <code>Show</code>. We&#8217;ll address this, by instructing Jackson to not serialize the <code>show</code> field in a <code>Performance</code>, through the <code>@JsonIgnoreProperties</code> annotation on the <code>Performance</code> entity:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/Performance.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("show")
public class Performance implements Serializable {

...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise, we&#8217;ll also instruct Jackson to not serialize the <code>Show</code> in a <code>TicketPrice</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/model/TicketPrice.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@JsonIgnoreProperties("show")
public class TicketPrice implements Serializable {

...

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_and_deleting_bookings">Creating and deleting bookings</h3>
<div class="paragraph">
<p>Of course, we also want to change data with our services - we want to create and delete bookings as well!</p>
</div>
<div class="paragraph">
<p>To create a booking, we add a new method, which handles <code>POST</code> requests to <code>/rest/bookings</code>. This is not a simple CRUD method, as the client does not send a booking, but a booking request. It is the responsibility of the service to process the request, reserve the seats and return the full booking details to the invoker.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BookingService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * &lt;p&gt;
 *     A JAX-RS endpoint for handling {@link Booking}s. Inherits the GET
 *     methods from {@link BaseEntityService}, and implements additional REST methods.
 * &lt;/p&gt;
 */
@Path("/bookings")
/**
 * &lt;p&gt;
 *     This is a stateless service, we declare it as an EJB for transaction demarcation
 * &lt;/p&gt;
 */
@Stateless
public class BookingService extends BaseEntityService&lt;Booking&gt; {

    @Inject
    SeatAllocationService seatAllocationService;

    @Inject @Created
    private Event&lt;Booking&gt; newBookingEvent;

    public BookingService() {
        super(Booking.class);
    }

   /**
     * &lt;p&gt;
     *   Create a booking. Data is contained in the bookingRequest object
     * &lt;/p&gt;
     * @param bookingRequest
     * @return
     */
    @SuppressWarnings("unchecked")
    @POST
    /**
     * &lt;p&gt; Data is received in JSON format. For easy handling, it will be unmarshalled in the support
     * {@link BookingRequest} class.
     */
    @Consumes(MediaType.APPLICATION_JSON)
    public Response createBooking(BookingRequest bookingRequest) {
        try {
            // identify the ticket price categories in this request
            Set&lt;Long&gt; priceCategoryIds = bookingRequest.getUniquePriceCategoryIds();

            // load the entities that make up this booking's relationships
            Performance performance = getEntityManager().find(Performance.class, bookingRequest.getPerformance());

            // As we can have a mix of ticket types in a booking, we need to load all of them that are relevant,
            // id
            Map&lt;Long, TicketPrice&gt; ticketPricesById = loadTicketPrices(priceCategoryIds);

            // Now, start to create the booking from the posted data
            // Set the simple stuff first!
            Booking booking = new Booking();
            booking.setContactEmail(bookingRequest.getEmail());
            booking.setPerformance(performance);
            booking.setCancellationCode("abc");

            // Now, we iterate over each ticket that was requested, and organize them by section and category
            // we want to allocate ticket requests that belong to the same section contiguously
            Map&lt;Section, Map&lt;TicketCategory, TicketRequest&gt;&gt; ticketRequestsPerSection
                    = new TreeMap&lt;Section, java.util.Map&lt;TicketCategory, TicketRequest&gt;&gt;(SectionComparator.instance());
            for (TicketRequest ticketRequest : bookingRequest.getTicketRequests()) {
                final TicketPrice ticketPrice = ticketPricesById.get(ticketRequest.getTicketPrice());
                if (!ticketRequestsPerSection.containsKey(ticketPrice.getSection())) {
                    ticketRequestsPerSection
                            .put(ticketPrice.getSection(), new HashMap&lt;TicketCategory, TicketRequest&gt;());
                }
                ticketRequestsPerSection.get(ticketPrice.getSection()).put(
                        ticketPricesById.get(ticketRequest.getTicketPrice()).getTicketCategory(), ticketRequest);
            }

            // Now, we can allocate the tickets
            // Iterate over the sections, finding the candidate seats for allocation
            // The process will acquire a write lock for a given section and performance
            // Use deterministic ordering of sections to prevent deadlocks
            Map&lt;Section, AllocatedSeats&gt; seatsPerSection =
			       new TreeMap&lt;Section, org.jboss.examples.ticketmonster.service.AllocatedSeats&gt;(SectionComparator.instance());
            List&lt;Section&gt; failedSections = new ArrayList&lt;Section&gt;();
            for (Section section : ticketRequestsPerSection.keySet()) {
                int totalTicketsRequestedPerSection = 0;
                // Compute the total number of tickets required (a ticket category doesn't impact the actual seat!)
                final Map&lt;TicketCategory, TicketRequest&gt; ticketRequestsByCategories = ticketRequestsPerSection.get(section);
                // calculate the total quantity of tickets to be allocated in this section
                for (TicketRequest ticketRequest : ticketRequestsByCategories.values()) {
                    totalTicketsRequestedPerSection += ticketRequest.getQuantity();
                }
                // try to allocate seats

                AllocatedSeats allocatedSeats =
				      seatAllocationService.allocateSeats(section, performance, totalTicketsRequestedPerSection, true);
                if (allocatedSeats.getSeats().size() == totalTicketsRequestedPerSection) {
                    seatsPerSection.put(section, allocatedSeats);
                } else {
                    failedSections.add(section);
                }
            }
            if (failedSections.isEmpty()) {
                for (Section section : seatsPerSection.keySet()) {
                    // allocation was successful, begin generating tickets
                    // associate each allocated seat with a ticket, assigning a price category to it
                    final Map&lt;TicketCategory, TicketRequest&gt; ticketRequestsByCategories = ticketRequestsPerSection.get(section);
                    AllocatedSeats allocatedSeats = seatsPerSection.get(section);
                    allocatedSeats.markOccupied();
                    int seatCounter = 0;
                    // Now, add a ticket for each requested ticket to the booking
                    for (TicketCategory ticketCategory : ticketRequestsByCategories.keySet()) {
                        final TicketRequest ticketRequest = ticketRequestsByCategories.get(ticketCategory);
                        final TicketPrice ticketPrice = ticketPricesById.get(ticketRequest.getTicketPrice());
                        for (int i = 0; i &lt; ticketRequest.getQuantity(); i++) {
                            Ticket ticket =
							      new Ticket(allocatedSeats.getSeats().get(seatCounter + i), ticketCategory, ticketPrice.getPrice());
                            // getEntityManager().persist(ticket);
                            booking.getTickets().add(ticket);
                        }
                        seatCounter += ticketRequest.getQuantity();
                    }
                }
                // Persist the booking, including cascaded relationships
                booking.setPerformance(performance);
                booking.setCancellationCode("abc");
                getEntityManager().persist(booking);
                newBookingEvent.fire(booking);
                return Response.ok().entity(booking).type(MediaType.APPLICATION_JSON_TYPE).build();
            } else {
                Map&lt;String, Object&gt; responseEntity = new HashMap&lt;String, Object&gt;();
                responseEntity.put("errors", Collections.singletonList("Cannot allocate the requested number of seats!"));
                return Response.status(Response.Status.BAD_REQUEST).entity(responseEntity).build();
            }
        } catch (ConstraintViolationException e) {
            // If validation of the data failed using Bean Validation, then send an error
            Map&lt;String, Object&gt; errors = new HashMap&lt;String, Object&gt;();
            List&lt;String&gt; errorMessages = new ArrayList&lt;String&gt;();
            for (ConstraintViolation&lt;?&gt; constraintViolation : e.getConstraintViolations()) {
                errorMessages.add(constraintViolation.getMessage());
            }
            errors.put("errors", errorMessages);
            // A WebApplicationException can wrap a response
            // Throwing the exception causes an automatic rollback
            throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).entity(errors).build());
        } catch (Exception e) {
            // Finally, handle unexpected exceptions
            Map&lt;String, Object&gt; errors = new HashMap&lt;String, Object&gt;();
            errors.put("errors", Collections.singletonList(e.getMessage()));
            // A WebApplicationException can wrap a response
            // Throwing the exception causes an automatic rollback
            throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).entity(errors).build());
        }
    }

    /**
     * Utility method for loading ticket prices
     * @param priceCategoryIds
     * @return
     */
    private Map&lt;Long, TicketPrice&gt; loadTicketPrices(Set&lt;Long&gt; priceCategoryIds) {
        List&lt;TicketPrice&gt; ticketPrices = (List&lt;TicketPrice&gt;) getEntityManager()
                .createQuery("select p from TicketPrice p where p.id in :ids")
                .setParameter("ids", priceCategoryIds).getResultList();
        // Now, map them by id
        Map&lt;Long, TicketPrice&gt; ticketPricesById = new HashMap&lt;Long, TicketPrice&gt;();
        for (TicketPrice ticketPrice : ticketPrices) {
            ticketPricesById.put(ticketPrice.getId(), ticketPrice);
        }
        return ticketPricesById;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should also copy over the <code>BookingRequest</code>, <code>TicketRequest</code> and <code>SectionComparator</code> classes referenced in these methods, from the project sources.</p>
</div>
<div class="paragraph">
<p>We won&#8217;t get into the details of the inner workings of the method - it implements a fairly complex algorithm - but we&#8217;d like to draw attention to a few particular items.</p>
</div>
<div class="paragraph">
<p>We use the <code>@POST</code> annotation to indicate that this method is executed on inbound HTTP POST requests. When implementing a set of RESTful services, it is important that the semantic of HTTP methods are observed in the mappings. Creating new resources (e.g. bookings) is typically associated with HTTP POST invocations. The <code>@Consumes</code> annotation indicates that the type of the request content is JSON and identifies the correct unmarshalling strategy, as well as content negotiation.</p>
</div>
<div class="paragraph">
<p>The <code>BookingService</code> delegates to the <code>SeatAllocationService</code> to find seats in the requested section, the required <code>SeatAllocationService</code> instance is initialized and supplied by the container as needed. The only thing that our service does is to specify the dependency in form
of an injection point - the field annotated with <code>@Inject</code>.</p>
</div>
<div class="paragraph">
<p>We would like other parts of the application to be aware of the fact that a new booking has been created, therefore we use the CDI to fire an event. We do so by injecting an <code>Event&lt;Booking&gt;</code> instance into the service (indicating that its payload will be a booking). In order to individually identify this event as referring to event creation, we use a CDI qualifier, which we need to add:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/util/qualifier/Created.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * {@link Qualifier} to mark a Booking as new (created).
 */
@Qualifier
@Target({ElementType.FIELD,ElementType.PARAMETER,ElementType.METHOD,ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Created {

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">What are qualifiers?</div>
<div class="paragraph">
<p>CDI uses a type-based resolution mechanism for injection and observers. In order to
distinguish between implementations of an interface, you can use qualifiers, a type
of annotations, to disambiguate. Injection points and event observers can use
qualifiers to narrow down the set of candidates</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also need allow the removal of bookings, so we add a method:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/rest/BookingService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Singleton
public class BookingService extends BaseEntityService&lt;Booking&gt; {
	...

    @Inject @Cancelled
    private Event&lt;Booking&gt; cancelledBookingEvent;
    ...
    /**
     * &lt;p&gt;
     * Delete a booking by id
     * &lt;/p&gt;
     * @param id
     * @return
     */
    @DELETE
    @Path("/{id:[0-9][0-9]*}")
    public Response deleteBooking(@PathParam("id") Long id) {
        Booking booking = getEntityManager().find(Booking.class, id);
        if (booking == null) {
            return Response.status(Response.Status.NOT_FOUND).build();
        }
        getEntityManager().remove(booking);
        cancelledBookingEvent.fire(booking);
        return Response.noContent().build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>@DELETE</code> annotation to indicate that it will be executed as the result of an HTTP DELETE request (again, the use of the DELETE HTTP verb is a matter of convention).</p>
</div>
<div class="paragraph">
<p>We need to notify the other components of the cancellation of the booking, so we fire an event, with a different qualifier.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/org/jboss/examples/ticketmonster/util/qualifier/Cancelled.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">/**
 * {@link Qualifier} to mark a Booking as cancelled.
 */
@Qualifier
@Target({ElementType.FIELD,ElementType.PARAMETER,ElementType.METHOD,ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Cancelled {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other services, including the <code>MediaService</code> that handles media items follow roughly the same patterns as above, so we leave them as an exercise to the reader.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_services">Testing the services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve now finished implementing the services and there is a significant amount of functionality in the application. Before taking any step forward, you need to make sure the services work correctly: we need to test them.</p>
</div>
<div class="paragraph">
<p>Testing enterprise services be a complex task as the implementation is based on services provided by a container: dependency injection, access to infrastructure services such as persistence, transactions etc. Unit testing frameworks, whilst offering a valuable infrastructure for running tests, do not provide these capabilities.</p>
</div>
<div class="paragraph">
<p>One of the traditional approaches has been the use of mocking frameworks to simulate 'what will happen' in the runtime environment. While certainly providing a solution mocking brings its own set of problems (e.g.  the additional effort required to provide a proper simulation or the risk of introducing errors in the test suite by incorrectly implemented mocks.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">What to test?</div>
<div class="paragraph">
<p>A common asked question is: how much application functionality should we test? The
truth is, you can never test too much. That being said, resources are always limited
and tradeoffs are part of an engineer&#8217;s work. Generally speaking, trivial
functionality (setters/getters/toString methods) is a big concern compared to  the
actual business code, so you probably want to focus your efforts on the business
code. Testing should include individual parts (unit testing), as well as
aggregates (integration testing).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fortunately, Arquillian provides the means to testing your application code within the container, with access to all the services and container features. In this section we will show you how to create a few Arquillian tests for your business services.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">New to Arquillian?</div>
<div class="paragraph">
<p>The Arquillian project site contains several tutorials to help you get started.
If you&#8217;re new to Arquillian and Shrinkwrap, we recommend going through the
<a href="http://arquillian.org/guides/">beginner-level Arquillian guides</a>, at the very least.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_adding_shrinkwrap_resolvers">Adding ShrinkWrap Resolvers</h3>
<div class="paragraph">
<p>We&#8217;ll need to use an updated version of the ShrinkWrap Resolvers project, that is not provided by the existing <code>org.jboss.bom.eap:jboss-javaee-6.0-with-tools</code> BOM. Fortunately, the JBoss WFK project provides this for us. It provides us with the <code>shrinkwrap-resolver-depchain</code> module, which allows us to use ShrinkWrap resolvers in our project through a single dependency. We can bring in the required version of ShrinkWrap Resolvers, by merely using the <code>org.jboss.bom.wfk:jboss-javaee-6.0-with-tools</code> BOM instead of the pre-existing tools BOM from EAP:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;project ...&gt;
    ...
	&lt;properties&gt;
		...
		&lt;version.jboss.bom.wfk&gt;2.7.0-redhat-1&lt;/version.jboss.bom.wfk&gt;
		...
	&lt;/properties&gt;


    &lt;dependencyManagement&gt;
        ...

        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.bom.wfk&lt;/groupId&gt;
            &lt;artifactId&gt;jboss-javaee-6.0-with-resteasy&lt;/artifactId&gt;
            &lt;version&gt;${version.jboss.bom.wfk}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;

	...

    &lt;dependencies&gt;
        ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.jboss.shrinkwrap.resolver&lt;/groupId&gt;
            &lt;artifactId&gt;shrinkwrap-resolver-depchain&lt;/artifactId&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    ...

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to remove the original Tools BOM with the <code>org.jboss.bom.eap</code> groupId.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_basic_deployment_class">A Basic Deployment Class</h3>
<div class="paragraph">
<p>In order to create Arquillian tests, we need to define the deployment. The code under test, as well as its dependencies is packaged and deployed in the container.</p>
</div>
<div class="paragraph">
<p>Much of the deployment contents is common for all tests, so we create a helper class with a method that creates the base deployment with all the general content.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/TicketMonsterDeployment.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class TicketMonsterDeployment {

    public static WebArchive deployment() {
        return ShrinkWrap
                .create(WebArchive.class, "test.war")
                .addPackage(Resources.class.getPackage())
                .addAsResource("META-INF/test-persistence.xml", "META-INF/persistence.xml")
                .addAsResource("import.sql")
                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml")
                // Deploy our test datasource
                .addAsWebInfResource("test-ds.xml");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to copy over the <code>test-persistence.xml</code> file into the <code>src/test/resources</code> directory of your project.</p>
</div>
<div class="paragraph">
<p>Arquillian uses Shrinkwrap to define the contents of the deployment. At runtime, when the test executes, Arquillian employs Shrinkwrap to create a WAR file that will be deployed to a running instance of JBoss Enterprise Application Platform. The WAR file would be composed of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all classes from the <code>org.jboss.examples.ticketmonster.util</code> package,</p>
</li>
<li>
<p>the test <code>persistence.xml</code> file that defines a JPA persistence unit against a test datasource,</p>
</li>
<li>
<p>the <code>import.sql</code> file,</p>
</li>
<li>
<p>an empty <code>beans.xml</code> file to activate CDI</p>
</li>
<li>
<p>and, a test data source definition.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We use a separate data source for our integration tests, and we recommend the same for real applications. This would allow you to run your tests against a pristine test environment, without having to clean your development, or worse, your production environment!</p>
</div>
</div>
<div class="sect2">
<h3 id="_writing_restful_service_tests">Writing RESTful service tests</h3>
<div class="paragraph">
<p>For testing our JAX-RS RESTful services, we need to add the corresponding application classes to the deployment. Since we need to do that for each test we create, we abide by the DRY principles and create a utility class.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/RESTDeployment.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class RESTDeployment {

    public static WebArchive deployment() {
        return TicketMonsterDeployment.deployment()
                .addPackage(Booking.class.getPackage())
                .addPackage(BaseEntityService.class.getPackage())
                .addPackage(MultivaluedHashMap.class.getPackage())
                .addPackage(SeatAllocationService.class.getPackage());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we create the first test to validate the proper retrieval of individual events.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/VenueServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RunWith(Arquillian.class)
public class VenueServiceTest {

    @Deployment
    public static WebArchive deployment() {
        return RESTDeployment.deployment();
    }

    @Inject
    private VenueService venueService;

    @Test
    public void testGetVenueById() {

        // Test loading a single venue
        Venue venue = venueService.getSingleInstance(1l);
        assertNotNull(venue);
        assertEquals("Roy Thomson Hall", venue.getName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the class above we specify the deployment, and we define the test method. The test supports CDI injection - one of the strengths of Arquillian is the ability to inject the object being tested.</p>
</div>
<div class="paragraph">
<p>Now, we test a more complicated use cases, query parameters for pagination.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/VenueServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">...
@RunWith(Arquillian.class)
public class VenueServiceTest {

    ...

    @Test
    public void testPagination() {

        // Test pagination logic
        MultivaluedMap&lt;String, String&gt; queryParameters = new MultivaluedHashMap&lt;String, String&gt;();

        queryParameters.add("first", "2");
        queryParameters.add("maxResults", "1");

        List&lt;Venue&gt; venues = venueService.getAll(queryParameters);
        assertNotNull(venues);
        assertEquals(1, venues.size());
        assertEquals("Sydney Opera House", venues.get(0).getName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add another test method (<code>testPagination</code>), which tests the retrieval of all venues, passing the
search criteria as parameters. We use a Map to simulate the passing of query parameters.</p>
</div>
<div class="paragraph">
<p>Now, we test more advanced use cases such as the creation of a new booking. We do so by adding a new test for bookings</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/org/jboss/examples/ticketmonster/test/rest/BookingServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RunWith(Arquillian.class)
public class BookingServiceTest {

    @Deployment
    public static WebArchive deployment() {
        return RESTDeployment.deployment();
    }

    @Inject
    private BookingService bookingService;

    @Inject
    private ShowService showService;

    @Test
    @InSequence(1)
    public void testCreateBookings() {
        BookingRequest br = createBookingRequest(1l, 0, new int[]{4, 1}, new int[]{1,1}, new int[]{3,1});
        bookingService.createBooking(br);

        BookingRequest br2 = createBookingRequest(2l, 1, new int[]{6,1}, new int[]{8,2}, new int[]{10,2});
        bookingService.createBooking(br2);

        BookingRequest br3 = createBookingRequest(3l, 0, new int[]{4,1}, new int[]{2,1});
        bookingService.createBooking(br3);
    }

    @Test
    @InSequence(10)
    public void testGetBookings() {
        checkBooking1();
        checkBooking2();
        checkBooking3();
    }

    private void checkBooking1() {
        Booking booking = bookingService.getSingleInstance(1l);
        assertNotNull(booking);
        assertEquals("Roy Thomson Hall", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        // Test the ticket requests created

        assertEquals(3 + 2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("A @ 219.5 (Adult)");
        requiredTickets.add("A @ 219.5 (Adult)");
        requiredTickets.add("D @ 149.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");
        requiredTickets.add("C @ 179.5 (Adult)");

        checkTickets(requiredTickets, booking);
    }

    private void checkBooking2() {
        Booking booking = bookingService.getSingleInstance(2l);
        assertNotNull(booking);
        assertEquals("Sydney Opera House", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        assertEquals(3 + 2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("S2 @ 197.75 (Adult)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S4 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S6 @ 145.0 (Child 0-14yrs)");
        requiredTickets.add("S4 @ 145.0 (Child 0-14yrs)");

        checkTickets(requiredTickets, booking);
    }

    private void checkBooking3() {
        Booking booking = bookingService.getSingleInstance(3l);
        assertNotNull(booking);
        assertEquals("Roy Thomson Hall", booking.getPerformance().getShow().getVenue().getName());
        assertEquals("Shane's Sock Puppets", booking.getPerformance().getShow().getEvent().getName());
        assertEquals("bob@acme.com", booking.getContactEmail());

        assertEquals(2 + 1, booking.getTickets().size());

        List&lt;String&gt; requiredTickets = new ArrayList&lt;String&gt;();
        requiredTickets.add("B @ 199.5 (Adult)");
        requiredTickets.add("D @ 149.5 (Adult)");
        requiredTickets.add("B @ 199.5 (Adult)");

        checkTickets(requiredTickets, booking);
    }

    @Test
    @InSequence(10)
    public void testPagination() {

        // Test pagination logic
        MultivaluedMap&lt;String, String&gt; queryParameters = new MultivaluedHashMap&lt;java.lang.String, java.lang.String&gt;();

        queryParameters.add("first", "2");
        queryParameters.add("maxResults", "1");

        List&lt;Booking&gt; bookings = bookingService.getAll(queryParameters);
        assertNotNull(bookings);
        assertEquals(1, bookings.size());
        assertEquals("Sydney Opera House", bookings.get(0).getPerformance().getShow().getVenue().getName());
        assertEquals("Rock concert of the decade", bookings.get(0).getPerformance().getShow().getEvent().getName());
    }

    @Test
    @InSequence(20)
    public void testDelete() {
        bookingService.deleteBooking(2l);
        checkBooking1();
        checkBooking3();
        try {
            bookingService.getSingleInstance(2l);
        } catch (Exception e) {
            if (e.getCause() instanceof NoResultException) {
                return;
            }
        }
        fail("Expected NoResultException did not occur.");
    }

    private BookingRequest createBookingRequest(Long showId, int performanceNo, int[]... sectionAndCategories) {
        Show show = showService.getSingleInstance(showId);

        Performance performance = new ArrayList&lt;Performance&gt;(show.getPerformances()).get(performanceNo);

        BookingRequest bookingRequest = new BookingRequest(performance, "bob@acme.com");

        List&lt;TicketPrice&gt; possibleTicketPrices = new ArrayList&lt;TicketPrice&gt;(show.getTicketPrices());
        int i = 1;
        for (int[] sectionAndCategory : sectionAndCategories) {
            for (TicketPrice ticketPrice : possibleTicketPrices) {
                int sectionId = sectionAndCategory[0];
                int categoryId = sectionAndCategory[1];
                if(ticketPrice.getSection().getId() == sectionId &amp;&amp; ticketPrice.getTicketCategory().getId() == categoryId) {
                    bookingRequest.addTicketRequest(new TicketRequest(ticketPrice, i));
                    i++;
                    break;
                }
            }
        }

        return bookingRequest;
    }

    private void checkTickets(List&lt;String&gt; requiredTickets, Booking booking) {
        List&lt;String&gt; bookedTickets = new ArrayList&lt;String&gt;();
        for (Ticket t : booking.getTickets()) {
            bookedTickets.add(new StringBuilder().append(t.getSeat().getSection()).append(" @ ").append(t.getPrice()).append(" (").append(t.getTicketCategory()).append(")").toString());
        }
        System.out.println(bookedTickets);
        for (String requiredTicket : requiredTickets) {
            Assert.assertTrue("Required ticket not present: " + requiredTicket, bookedTickets.contains(requiredTicket));
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First we test booking creation in a test method of its own (<code>testCreateBookings</code>). Then, we test that the previously created bookings
are retrieved correctly (<code>testGetBookings</code> and <code>testPagination</code>). Finally, we test that deletion takes place correctly (<code>testDelete</code>).</p>
</div>
<div class="paragraph">
<p>The other tests in the application follow roughly the same pattern and are left as an exercise to the reader. You could in fact copy over the <code>EventServiceTest</code> and <code>ShowServiceTest</code> classes from the project sources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_tests">Running the tests</h3>
<div class="paragraph">
<p>If you have followed the instructions in the introduction and used the Maven archetype to generate the project structure, you should have two profiles already defined in your application.</p>
</div>
<div class="listingblock">
<div class="title">/pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

        ...
        &lt;profile&gt;
            &lt;!-- An optional Arquillian testing profile that executes tests
                in your JBoss AS instance --&gt;
            &lt;!-- This profile will start a new JBoss AS instance, and execute
                the test, shutting it down when done --&gt;
            &lt;!-- Run with: mvn clean test -Parq-jbossas-managed --&gt;
            &lt;id&gt;arq-jbossas-managed&lt;/id&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;
                    &lt;artifactId&gt;jboss-as-arquillian-container-managed&lt;/artifactId&gt;
                    &lt;scope&gt;test&lt;/scope&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/profile&gt;

        &lt;profile&gt;
            &lt;!-- An optional Arquillian testing profile that executes tests
                in a remote JBoss AS instance --&gt;
            &lt;!-- Run with: mvn clean test -Parq-jbossas-remote --&gt;
            &lt;id&gt;arq-jbossas-remote&lt;/id&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;
                    &lt;artifactId&gt;jboss-as-arquillian-container-remote&lt;/artifactId&gt;
                    &lt;scope&gt;test&lt;/scope&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/profile&gt;

    &lt;/profiles&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you haven&#8217;t used the archetype, or the profiles don&#8217;t exist, create them.</p>
</div>
<div class="paragraph">
<p>Each profile defines a different Arquillian container. In both cases the tests execute in an application server instance. In one case (<code>arq-jbossas-managed</code>) the server instance is started and stopped by the test suite, while in the other (<code>arq-jbossas-remote</code>), the test suite expects an already started server instance.</p>
</div>
<div class="paragraph">
<p>Once these profiles are defined, we can execute the tests in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>from the command-line build</p>
</li>
<li>
<p>from an IDE</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_executing_tests_from_the_command_line">Executing tests from the command line</h4>
<div class="paragraph">
<p>You can now execute the test suite from the command line by running the Maven build with the appropriate target and profile, as in one of the following examples.</p>
</div>
<div class="paragraph">
<p>After ensuring that the <code>JBOSS_HOME</code> environment variable is set to a valid JBoss EAP 6.2 installation directory), you can run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-managed</pre>
</div>
</div>
<div class="paragraph">
<p>Or, after starting a JBoss EAP 6.2 instance, you can run the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean test -Parq-jbossas-remote</pre>
</div>
</div>
<div class="paragraph">
<p>These tests execute as part of the Maven build and can be easily included in an automated build and test harness.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_arquillian_tests_from_within_eclipse">Running Arquillian tests from within Eclipse</h4>
<div class="paragraph">
<p>Running the entire test suite as part of the build is an important part of the development process - you may want to make sure that everything is working fine before releasing a new milestone, or just before committing new code. However, running the entire test suite all the time
can be a productivity drain, especially when you&#8217;re trying to focus on a particular problem. Also, when debugging, you don&#8217;t want to leave the comfort of your IDE for running the tests.</p>
</div>
<div class="paragraph">
<p>Running Arquillian tests from JBoss Developer Studio or JBoss tools is very simple as Arquillian builds on JUnit (or TestNG).</p>
</div>
<div class="paragraph">
<p>First enable one of the two profiles in the project. In Eclipse, select the project, right-click on it to open the context menu, drill down into the <em>Maven</em> sub-menu:</p>
</div>
<div id="eclipse-select-maven-profiles" class="imageblock">
<div class="content">
<img src="gfx/eclipse-project-maven-profiles.png" alt="eclipse project maven profiles">
</div>
<div class="title">Figure 1. Select the Maven profiles for the project</div>
</div>
<div class="paragraph">
<p>Activate the profile as shown in the picture below.</p>
</div>
<div id="eclipse-update-profiles" class="imageblock">
<div class="content">
<img src="gfx/eclipse-maven-profile-update.png" alt="eclipse maven profile update">
</div>
<div class="title">Figure 2. Update Maven profiles in Eclipse</div>
</div>
<div class="paragraph">
<p>The project configuration will be updated automatically.</p>
</div>
<div class="paragraph">
<p>Now, you can click right on one of your test classes, and select <strong>Run As &#8594; JUnit Test</strong>.</p>
</div>
<div class="paragraph">
<p>The test suite will run, deploying the test classes to the application server, executing the tests and finally producing the much coveted green bar.</p>
</div>
<div id="eclipse-green-bar" class="imageblock">
<div class="content">
<img src="gfx/eclipse-green-bar.png" alt="eclipse green bar">
</div>
<div class="title">Figure 3. Running the tests</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-03-04 07:05:48 -0500
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>